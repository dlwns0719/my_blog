<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Junhyun Lee</title>
<link>https://dlwns0719.github.io/my_blog/docs/blog/</link>
<atom:link href="https://dlwns0719.github.io/my_blog/docs/blog/index.xml" rel="self" type="application/rss+xml"/>
<description>blog</description>
<generator>quarto-1.8.25</generator>
<lastBuildDate>Fri, 31 Oct 2025 15:00:00 GMT</lastBuildDate>
<item>
  <title>Azure Cloud</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/</link>
  <description><![CDATA[ 






<section id="azure-cloud" class="level2" data-number="1">

<section id="클라우드-인프라-설정" class="level3" data-number="1.1">

<ol type="1">
<li><a href="../../../../docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/01-Data_Lake_Storage.html">01-Data Lake Storage</a></li>
</ol>


</section>
</section>

 ]]></description>
  <category>Azure Cloud</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/</guid>
  <pubDate>Fri, 31 Oct 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>RAG</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/</link>
  <description><![CDATA[ 






<section id="rag" class="level2" data-number="1">

<section id="retriever" class="level3" data-number="1.1">

<ol type="1">
<li><a href="../../../../docs/blog/posts/RAG/10-Retriever/01-VectorStoreRetriever.html">01-VectorStoreRetriever</a></li>
<li><a href="../../../../docs/blog/posts/RAG/10-Retriever/02-ContextualCompressionRetriever.html">02-ContextualCompressionRetriever</a></li>
</ol>
</section>
<section id="agent" class="level3" data-number="1.2">

<ol type="1">
<li><a href="../../../../docs/blog/posts/RAG/15-Agent/01-Tools.html">01-Tools</a></li>
<li><a href="../../../../docs/blog/posts/RAG/15-Agent/02-Bind-Tools.html">02-Bind-Tools</a></li>
<li><a href="../../../../docs/blog/posts/RAG/15-Agent/03-Agent.html">03-Agent</a></li>
<li><a href="../../../../docs/blog/posts/RAG/15-Agent/04-Agent-More-LLMs.html">04-Agent-More-LLMs</a></li>
<li><a href="../../../../docs/blog/posts/RAG/15-Agent/05-Iter-Human-In-the-Loop.html">05-Iter-Human-In-the-Loop</a></li>
</ol>


</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>LangChain</category>
  <category>RAG</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/</guid>
  <pubDate>Fri, 31 Oct 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Prompt_Engineering</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/Prompt_Engineering/</link>
  <description><![CDATA[ 






<section id="prompt_engineering" class="level2" data-number="1">

<section id="prompt-structure" class="level3" data-number="1.1">

<ol type="1">
<li><a href="../../../../docs/blog/posts/Prompt_Engineering/01-Prompt-Structure/01-Prompt-Structure.html">01-프롬프트 구조(1)</a></li>
<li><a href="../../../../docs/blog/posts/Prompt_Engineering/01-Prompt-Structure/02-Prompt-Structure.html">02-프롬프트 구조(2)</a></li>
</ol>
</section>
<section id="프롬프트의-이해" class="level3" data-number="1.2">

<ol type="1">
<li><a href="../../../../docs/blog/posts/Prompt_Engineering/02-프롬프트의_이해/01-프롬프트분석.html">01-프롬프트 분석의 필요성과 가치</a></li>
<li><a href="../../../../docs/blog/posts/Prompt_Engineering/02-프롬프트의_이해/02-사용자언어읽기.html">02-사용자 언어 읽기(프롬프트 구조와 유형)</a></li>
<li><a href="../../../../docs/blog/posts/Prompt_Engineering/02-프롬프트의_이해/03-대화분석.html">03-대화 분석(사용자-AI 상호작용 매커니즘)</a></li>
</ol>
</section>
<section id="세그먼트별-프롬프트-기획" class="level3" data-number="1.3">

<ol type="1">
<li><a href="../../../../docs/blog/posts/Prompt_Engineering/03-프롬프트_기획_전략/01-세그먼트별_프롬프트_기획.html">01-세그먼트별 프롬프트 기획</a></li>
</ol>


</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>Prompt_Engineering</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/Prompt_Engineering/</guid>
  <pubDate>Fri, 31 Oct 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>01-Data Lake Storage</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/01-Data_Lake_Storage.html</link>
  <description><![CDATA[ 






<section id="스토리지-계정-생성" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> 스토리지 계정 생성</h1>
<p>Azure Portal에서 Storage Account를 생성합니다.</p>
<section id="기본-설정" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="기본-설정"><span class="header-section-number">1.1</span> 기본 설정</h2>
<section id="프로젝트-세부-정보" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="프로젝트-세부-정보"><span class="header-section-number">1.1.1</span> 프로젝트 세부 정보</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/images/01-Data_Lake_Storage/1.png" class="img-fluid figure-img"></p>
<figcaption>image</figcaption>
</figure>
</div>
<p><strong>구독(Subscription)</strong> - 설명: 사용할 Azure 구독을 선택합니다. - 입력 값: <code>swlab-test-subs</code></p>
<p><strong>리소스 그룹(Resource Group)</strong> - 설명: 스토리지 계정을 포함할 리소스 그룹을 선택하거나 새로 만듭니다. - 입력 값: <code>rg-aipoc-test-krc-001</code></p>
</section>
<section id="인스턴스-세부-정보" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="인스턴스-세부-정보"><span class="header-section-number">1.1.2</span> 인스턴스 세부 정보</h3>
<p><strong>스토리지 계정 이름</strong> - 설명: 전역적으로 고유한 스토리지 계정 이름을 입력합니다 (3-24자, 소문자와 숫자만 사용 가능). - 입력 값: <code>saaipoctestkrc001</code></p>
<p><strong>지역(Region)</strong> - 설명: 스토리지 계정이 생성될 Azure 데이터 센터 위치를 선택합니다. - 입력 값: <code>(Asia Pacific) Korea Central</code></p>
<p><strong>기본 스토리지 유형</strong> - 설명: 사용할 스토리지 서비스 유형을 선택합니다. - 입력 값: <code>Azure Blob Storage 또는 Azure Data Lake Storage Gen 2</code> - 참고: 관련 지침을 제공하는 데 도움이 됩니다. 스토리지를 이 리스크 유형으로 제한하지 않습니다.</p>
<p><strong>기본 워크로드</strong> - 설명: 빅 데이터 분석을 위해 데이터 레이크를 호스트하는 데 가장 적합한 워크로드와 가장 일치하는 항목을 선택하여 모범 사례를 기반으로 구축된 권장 구성을 가져옵니다. 안제든지 이 구성을 변경할 수 있습니다. - 입력 값: <code>빅 데이터 분석</code> - 참고: 📊 빅 데이터 분석을 위해 데이터 레이크를 호스트하는 데 가장 적합</p>
<p><strong>성능(Performance)</strong> - 설명: 스토리지 계정의 성능 계층을 선택합니다. - <strong>표준</strong>: 대부분 시나리오에 권장됨 (범용 v2 계정) - <strong>프리미엄</strong>: 짧은 대기 시간이 필요한 경우에 권장됨 - 선택 값: <code>표준: 대부분 시나리오에 권장됨(범용 v2 계정)</code> - 참고: 📊 표준 성능 워크로드에는 빅 데이터 분석(를) 사용하는 것이 좋습니다.</p>
<p><strong>중복도(Redundancy)</strong> - 설명: 데이터 내구성을 위한 복제 전략을 선택합니다. - <strong>LRS</strong>: 로컬 중복 스토리지 - <strong>ZRS</strong>: 영역 중복 스토리지 - <strong>GRS</strong>: 지역 중복 스토리지 - <strong>RA-GRS</strong>: 읽기 액세스 지역 중복 스토리지 - 선택 값: <code>LRS(로컬 중복 스토리지)</code> - 참고: 📊 ZRS 워크로드에는 빅 데이터 분석(를) 사용하는 것이 좋습니다.</p>
</section>
</section>
<section id="고급-설정" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="고급-설정"><span class="header-section-number">1.2</span> 고급 설정</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/images/01-Data_Lake_Storage/2.png" class="img-fluid figure-img"></p>
<figcaption>image</figcaption>
</figure>
</div>
<section id="보안" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="보안"><span class="header-section-number">1.2.1</span> 보안</h3>
<p><strong>REST API 작업을 위한 보안 전송 필요</strong> - 설명: HTTPS를 통한 보안 연결만 허용합니다. - 선택 값: ☑ 체크됨</p>
<p><strong>개별 컨테이너에 대한 익명 액세스 허용</strong> - 설명: 익명 Blob 액세스를 컨테이너 수준에서 허용할지 여부를 설정합니다. - 선택 값: ☐ 체크 안 됨</p>
<p><strong>스토리지 계정 키 액세스 사용</strong> - 설명: 공유 키를 통한 스토리지 계정 액세스를 허용합니다. - 선택 값: ☑ 체크됨</p>
<p><strong>Azure Portal에서 Microsoft Entra 인증 기본값 사용</strong> - 설명: Azure Portal 액세스 시 Microsoft Entra ID를 기본 인증 방법으로 사용합니다. - 선택 값: ☐ 체크 안 됨</p>
<p><strong>최소 TLS 버전</strong> - 설명: 클라이언트에서 요청하는 최소 TLS(전송 계층 보안) 버전을 설정합니다. - 선택 값: <code>버전 1.2</code></p>
<p><strong>복사 작업에 대해 허용된 범위(미리 보기)</strong> - 설명: 데이터 복사 작업의 허용 범위를 지정합니다. - 선택 값: <code>모든 스토리지 계정에서</code></p>
</section>
<section id="계층-구조-네임스페이스" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="계층-구조-네임스페이스"><span class="header-section-number">1.2.2</span> 계층 구조 네임스페이스</h3>
<p>Data Lake Storage Gen2 엔드포인트로 보안되는 계층 구조 네임스페이스는 파일 및 디렉터리 의미 체계를 사용하고, 빅 데이터 분석 워크로드를 가속화하고, ACL(액세스 제어 목록)을 사용합니다.</p>
<p><strong>계층 구조 네임스페이스 사용</strong> - 설명: Data Lake Storage Gen2 엔드포인트를 보안되는 계층 구조 네임스페이스입니다. 파일 및 디렉터리 의미 체계를 사용하고, ACL(액세스 제어 목록)을 사용합니다. - 선택 값: ☑ 체크됨 - 참고: 📊 계층 구조 네임스페이스 워크로드에는 빅 데이터 분석(를) 사용하는 것이 좋습니다.</p>
</section>
<section id="액세스-프로토콜" class="level3" data-number="1.2.3">
<h3 data-number="1.2.3" class="anchored" data-anchor-id="액세스-프로토콜"><span class="header-section-number">1.2.3</span> 액세스 프로토콜</h3>
<p>BLOB 및 Data Lake Gen2 엔드포인트는 기본적으로 프로토비전됨</p>
<p><strong>SFTP 사용</strong> - 설명: SFTP 프로토콜을 통한 파일 전송을 활성화합니다. - 선택 값: ☑ 체크됨 - 참고: ℹ️ 로컬 사용자 기능은 SFTP로 활성화됩니다. 스토리지 계정을 만든 후 SFTP 끝점에 액세스할 로컬 사용자 ID를 만듭니다.</p>
<p><strong>네트워크 파일 시스템 v3 사용</strong> - 설명: NFS v3 프로토콜을 사용하여 파일 시스템을 마운트합니다. - 선택 값: ☑ 체크됨</p>
</section>
<section id="blob-storage" class="level3" data-number="1.2.4">
<h3 data-number="1.2.4" class="anchored" data-anchor-id="blob-storage"><span class="header-section-number">1.2.4</span> Blob Storage</h3>
<p><strong>테넌트 간 복제 허용</strong> - 설명: 다른 Azure AD 테넌트 간 Blob 복제를 허용합니다. - 선택 값: ☐ 체크 안 됨 - 참고: ℹ️ 테넌트 간 복제 및 계층 구조 네임스페이스를 동시에 사용하도록 설정할 수 없습니다.</p>
<p><strong>액세스 계층</strong> - 설명: 데이터 액세스 빈도에 따른 기본 저장소 계층을 선택합니다. - <strong>핫</strong>: 자주 액세스하는 데이터 및 일상적인 사용 시나리오에 최적화됨 - <strong>쿨</strong>: 자주 액세스하지 않는 데이터 및 백업 시나리오에 최적화됨 - <strong>콜드</strong>: 거의 액세스하지 않는 데이터 및 백업 시나리오에 최적화됨 - 선택 값: <code>핫</code> - 참고: 📊 핫 Blob 액세스 계층 워크로드에는 빅 데이터 분석(를) 사용하는 것이 좋습니다.</p>
</section>
<section id="azure-files" class="level3" data-number="1.2.5">
<h3 data-number="1.2.5" class="anchored" data-anchor-id="azure-files"><span class="header-section-number">1.2.5</span> Azure Files</h3>
<p><strong>큰 파일 공유 사용</strong> - 설명: 최대 100TiB 용량의 대용량 파일 공유를 지원합니다. - 선택 값: ☑ 체크됨 (비활성화됨)</p>
</section>
</section>
<section id="네트워킹-설정" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="네트워킹-설정"><span class="header-section-number">1.3</span> 네트워킹 설정</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/images/01-Data_Lake_Storage/3.png" class="img-fluid figure-img"></p>
<figcaption>image</figcaption>
</figure>
</div>
<section id="공용-액세스" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="공용-액세스"><span class="header-section-number">1.3.1</span> 공용 액세스</h3>
<p>공용 네트워크를 통해 어디서나 리소스에 액세스합니다.</p>
<p>참고: 공용 네트워크를 통해 리소스에 액세스할 수 있게 되면 보안 위험이 증가합니다.</p>
<p><strong>공용 네트워크 액세스</strong> - 설명: 공용 인터넷에서 스토리지 계정에 대한 액세스 권한을 설정합니다. - 선택 값: <code>사용</code> - 이 리소스에 대한 리스크 액세스 구성을 사용하여 선택 인바운드 엔드포인트를 제한하는 옵션을 사용하며 인바운드 및 아웃바운드 엔드포인트를 허용합니다. - 옵션: - ⭕ <strong>사용</strong>: 이 리소스에 대한 리스크 액세스 구성을 사용하여 선택 인바운드 엔드포인트를 제한하는 옵션을 사용하며 인바운드 및 아웃바운드 엔드포인트를 허용합니다. - ⚪ <strong>사용 안 함</strong>: 아웃바운드 엔드포인트를 허용하면서 인바운드 엔드포인트를 제한합니다. - ⚪ <strong>경계로 보호(가장 제한됨)</strong>: 네트워크 보안 경계를 사용하여 인바운드 및 아웃바운드 엔드포인트를 제한합니다. 경계로 보호는 리소스를 보호하기 위해 가장 높은 수준의 인바운드 및 아웃바운드 제한을 제공합니다.</p>
<p><strong>공용 네트워크 액세스 범위</strong> - 설명: 공용 네트워크를 통해 액세스할 수 있는 리소스의 범위를 지정합니다. - 선택 값: <code>선택한 가상 네트워크 및 IP 주소에서 사용</code> - 옵션: - ⚪ <strong>모든 네트워크에서 사용</strong> - ⭕ <strong>선택한 가상 네트워크 및 IP 주소에서 사용</strong></p>
</section>
<section id="가상-네트워크" class="level3" data-number="1.3.2">
<h3 data-number="1.3.2" class="anchored" data-anchor-id="가상-네트워크"><span class="header-section-number">1.3.2</span> 가상 네트워크</h3>
<p>선택한 네트워크만 이 스토리지 계정에 액세스할 수 있습니다.</p>
<p><strong>가상 네트워크 구독</strong> - 설명: 가상 네트워크가 속한 Azure 구독을 선택합니다. - 입력 값: <code>swlab-test-subs</code></p>
<p><strong>가상 네트워크</strong> - 설명: 스토리지 계정에 액세스할 수 있는 가상 네트워크를 선택합니다. - 입력 값: <code>vnet-aipoc-test-krc-insilico-001</code> - 링크: [가상 네트워크 만들기] / [선택한 가상 네트워크 관리]</p>
<p><strong>서브넷</strong> - 설명: 가상 네트워크 내에서 액세스를 허용할 서브넷을 선택합니다. - 입력 값: <code>subnet-aipoc-test-krc-insilico-001(172.16.0.0/24)</code></p>
</section>
<section id="ipv4-addresses" class="level3" data-number="1.3.3">
<h3 data-number="1.3.3" class="anchored" data-anchor-id="ipv4-addresses"><span class="header-section-number">1.3.3</span> IPv4 Addresses</h3>
<p>Allow select public internet IP addresses to access your resource.</p>
<p><strong>허용된 IP 주소</strong> - 설명: 스토리지 계정에 액세스할 수 있는 공용 IP 주소를 지정합니다. - 입력 값: <code>61.74.175.54</code></p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">경고</span>⚠️ 중요
</div>
</div>
<div class="callout-body-container callout-body">
<p>이 값을 <strong>자신의 로컬 PC Public IP</strong>로 설정을 해 주어야지만, 추후 <strong>Azure Portal을 통해 파일 업로드가 가능</strong>합니다.</p>
</div>
</div>
</section>
<section id="프라이빗-엔드포인트" class="level3" data-number="1.3.4">
<h3 data-number="1.3.4" class="anchored" data-anchor-id="프라이빗-엔드포인트"><span class="header-section-number">1.3.4</span> 프라이빗 엔드포인트</h3>
<p><strong>프라이빗 엔드포인트</strong> - 설명: 프라이빗 엔드포인트를 만들어 이 리소스에 대한 프라이빗 연결을 허용합니다. 추가 프라이빗 엔드포인트 연결은 스토리지 계정 또는 프라이빗 링크 센터 내에서 만들 수 있습니다. - 선택 값: [+ 프라이빗 엔드포인트 추가] 클릭 가능 - 상태: 프라이빗 엔드포인트를 만들려면 (추가를 클릭합니다)</p>
</section>
<section id="네트워크-라우팅" class="level3" data-number="1.3.5">
<h3 data-number="1.3.5" class="anchored" data-anchor-id="네트워크-라우팅"><span class="header-section-number">1.3.5</span> 네트워크 라우팅</h3>
<p>트래픽이 원본에서 Azure 엔드포인트로 이동하는 과정에서 트래픽을 라우팅할 방법을 결정하세요. 대부분의 고객의 경우 Microsoft 네트워크 라우팅이 권장됩니다.</p>
<p><strong>라우팅 기본 설정</strong> - 설명: 트래픽이 원본에서 Azure 엔드포인트로 이동하는 과정에서 트래픽을 라우팅할 방법을 결정합니다. - 선택 값: <code>Microsoft 네트워크 라우팅</code> - 옵션: - ⭕ <strong>Microsoft 네트워크 라우팅</strong> - ⚪ <strong>인터넷 라우팅</strong></p>
</section>
</section>
<section id="데이터-보호-설정" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="데이터-보호-설정"><span class="header-section-number">1.4</span> 데이터 보호 설정</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/images/01-Data_Lake_Storage/4.png" class="img-fluid figure-img"></p>
<figcaption>image</figcaption>
</figure>
</div>
<section id="복구" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="복구"><span class="header-section-number">1.4.1</span> 복구</h3>
<ul>
<li>전부 디폴트 설정으로 진행</li>
</ul>
<p><strong>Blob에 일시 삭제 사용</strong> - 설명: 일시 삭제를 사용하면 덮어쓴 Blob을 포함하여 이전에 삭제로 표시되었던 Blob을 복구할 수 있습니다. - 선택 값: ☑ 체크됨 - <strong>삭제된 Blob 보존 기간(일)</strong>: <code>7</code></p>
<p><strong>컨테이너에 일시 삭제 사용</strong> - 설명: 일시 삭제를 사용하면 이전에 삭제로 표시된 컨테이너를 복구할 수 있습니다. - 선택 값: ☑ 체크됨 - <strong>삭제된 컨테이너 보존 기간(일)</strong>: <code>7</code> - 참고: 자주 덮어쓰는 데이터에 대해 일시 삭제를 사용하도록 설정하면 스토리지 비용이 증가할 수 있습니다.</p>
<p><strong>파일 공유에 일시 삭제 사용</strong> - 설명: 일시 삭제를 사용하면 이전에 삭제로 표시된 파일 공유를 복구할 수 있습니다. - 선택 값: ☑ 체크됨 - <strong>삭제된 파일 공유 보존 기간(일)</strong>: <code>7</code></p>
</section>
<section id="추적" class="level3" data-number="1.4.2">
<h3 data-number="1.4.2" class="anchored" data-anchor-id="추적"><span class="header-section-number">1.4.2</span> 추적</h3>
<p><strong>Blob에 버전 관리 사용</strong> - 설명: 버전 관리를 사용하여 Blob의 이전 버전을 자동으로 유지합니다. - 선택 값: ☐ 체크 안 됨 - 참고: 워크로드, 생성된 버전 수에 미치는 영향, 결과 비용을 고려하세요. 데이터 수명 주기를 자동으로 관리하여 비용을 최적화합니다.</p>
<p><strong>Blob 변경 피드 사용</strong> - 설명: 계정의 Blob에 대한 만들기, 수정 및 삭제 변경 내용을 추적합니다. - 선택 값: ☐ 체크 안 됨</p>
</section>
<section id="액세스-제어" class="level3" data-number="1.4.3">
<h3 data-number="1.4.3" class="anchored" data-anchor-id="액세스-제어"><span class="header-section-number">1.4.3</span> 액세스 제어</h3>
<p><strong>버전 수준 불변성 지원 사용</strong> - 설명: 모든 Blob 버전에 적용할 계정 수준에서 시간 기반 보존 정책을 설정할 수 있습니다. - 선택 값: ☐ 체크 안 됨 - 참고: 계정 수준에서 기본 정책을 설정하려면 이 기능을 사용하여 도록 설정합니다. 이 기능을 사용하지 않고도 컨테이너 수준에서 기본 정책을 설정하거나 특정 Blob 버전에 대한 정책을 설정할 수 있습니다. 이 속성을 사용하려면 버전 관리를 필요합니다.</p>
</section>
</section>
</section>
<section id="컨테이너-생성-blob-파일-업로드" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> 컨테이너 생성 &amp; Blob 파일 업로드</h1>
<section id="azure-portal에서-컨테이너를-생성합니다." class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="azure-portal에서-컨테이너를-생성합니다."><span class="header-section-number">2.1</span> Azure Portal에서 컨테이너를 생성합니다.</h2>
<p>bc-aipoc-test-krc001 이름의 컨테이너가 이미 존재하여 생성되지 않지만 아래와 같은 방법으로 컨테이너를 생성할 수 있습니다. <img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/images/01-Data_Lake_Storage/5.png" class="img-fluid" alt="image"></p>
</section>
<section id="디렉터리-추가" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="디렉터리-추가"><span class="header-section-number">2.2</span> 디렉터리 추가</h2>
<p>컨테이너 내부로 접속하여 디렉터리를 추가할 수 있습니다. ::: {.callout-important} ## ⚠️ 주의사항</p>
<p>네트워크 설정 중 <strong>Public network access</strong>가 <strong>Enabled from selected networks</strong>로 설정되어 있어야 합니다.</p>
<p><code>Disable</code> 또는 <code>Secured by perimeter(Most restricted)</code>로 설정되어 있으면 <strong>컨테이너 내부로 접속할 수 없습니다</strong>. :::</p>
<p>폴더 구조는 아래와 같은 구조로 되어있습니다.</p>
<pre><code>rag-container
 ├─ code
 │   ├─ moduleA
 │   ├─ moduleB
 │   └─ moduleC
 └─ docs
     ├─ moduleA
     ├─ moduleB
     └─ moduleC</code></pre>
</section>
<section id="blob-파일을-업로드합니다." class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="blob-파일을-업로드합니다."><span class="header-section-number">2.3</span> Blob 파일을 업로드합니다.</h2>
<p><img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/images/01-Data_Lake_Storage/6.png" class="img-fluid" alt="image"> 업로드 버튼을 이용해서 미리 다운로드 받은 코드 파일을 업로드합니다.</p>
</section>
</section>
<section id="vm-내부에서-blob-파일-접근" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> VM 내부에서 Blob 파일 접근</h1>
<p>vm 내부에 접속 후 아래와 같은 작업을 통해 영구적으로 Blob 파일에 마운트를 할 수 있습니다.</p>
<p>Azure nfs 패키지를 설치합니다.</p>
<pre><code>sudo apt-get update
sudo apt-get install nfs-common</code></pre>
<p>fstab 파일에 아래와 같이 추가합니다.</p>
<pre><code>sudo vi /etc/fstab

saaipoctestkrc001.blob.core.windows.net:/saaipoctestkrc001/bc-aipoc-test-krc001 /mnt/bc-aipoc-test-krc001 aznfs defaults,sec=sys,vers=3,nolock,proto=tcp,nofail,_netdev    0 0</code></pre>
<p>saaipoctestkrc001 : Storage Account 이름 bc-aipoc-test-krc001 : Container 이름 /mnt/bc-aipoc-test-krc001 : 마운트 폴더 aznfs : Azure NFS 패키지 defaults,sec=sys,vers=3,nolock,proto=tcp,nofail,_netdev : NFS 패키지 설정 0 0 : 마운트 설정</p>
<p>마운트를 합니다.</p>
<pre><code>sudo mount -a</code></pre>


</section>

 ]]></description>
  <category>Azure Cloud</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/01-Data_Lake_Storage.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>OpenAI 외 도구 호출 에이전트(Tool Calling Agent)</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/04-Agent-More-LLMs.html</link>
  <description><![CDATA[ 






<p>OpenAI 외에도 <code>Anthropic</code>, <code>Google Gemini</code>, <code>Together.ai</code>, <code>Ollama</code>, <code>Mistral</code>과 같은 더 광범위한 공급자 구현을 지원합니다.</p>
<p>이번 챕터에서는 다양한 LLM 을 사용하여 도구 호출 에이전트를 생성하고 실행하는 방법을 살펴보겠습니다.</p>
<p><strong>참고 링크</strong></p>
<ul>
<li><a href="https://python.langchain.com/v0.1/docs/modules/agents/agent_types/tool_calling/">LangChain 공식 도큐먼트</a></li>
</ul>
<div id="22f90e6c" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="fe2ad291" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install -qU langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH15-Agents"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="18768361" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tool</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> List, Dict</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> GoogleNews</span>
<span id="cb3-4"></span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 정의</span></span>
<span id="cb3-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb3-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> search_news(query: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]]:</span>
<span id="cb3-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Search Google News by input keyword"""</span></span>
<span id="cb3-10">    news_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GoogleNews()</span>
<span id="cb3-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> news_tool.search_by_keyword(query, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb3-12"></span>
<span id="cb3-13"></span>
<span id="cb3-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"도구 이름: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>search_news<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"도구 설명: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>search_news<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>description<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="1259208a" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tools 정의</span></span>
<span id="cb4-2">tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [search_news]</span></code></pre></div></div>
</details>
</div>
<section id="agent-용-프롬프트-생성" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="agent-용-프롬프트-생성"><span class="header-section-number">1</span> Agent 용 프롬프트 생성</h2>
<ul>
<li><code>chat_history</code> : 이전 대화 내용을 저장하는 변수 (멀티턴을 지원하지 않는다면, 생략 가능합니다.)</li>
<li><code>agent_scratchpad</code> : 에이전트가 임시로 저장하는 변수</li>
<li><code>input</code> : 사용자의 입력</li>
</ul>
<div id="f2a23c1c" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate</span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> create_tool_calling_agent</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트 생성</span></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트는 에이전트에게 모델이 수행할 작업을 설명하는 텍스트를 제공합니다. (도구의 이름과 역할을 입력)</span></span>
<span id="cb5-6">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_messages(</span>
<span id="cb5-7">    [</span>
<span id="cb5-8">        (</span>
<span id="cb5-9">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>,</span>
<span id="cb5-10">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant. "</span></span>
<span id="cb5-11">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Make sure to use the `search_news` tool for searching keyword related news."</span>,</span>
<span id="cb5-12">        ),</span>
<span id="cb5-13">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"placeholder"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{chat_history}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb5-14">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"human"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{input}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb5-15">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"placeholder"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{agent_scratchpad}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb5-16">    ]</span>
<span id="cb5-17">)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="tool-calling-을-지원하는-다양한-llm-목록" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="tool-calling-을-지원하는-다양한-llm-목록"><span class="header-section-number">2</span> Tool Calling 을 지원하는 다양한 LLM 목록</h2>
<p>실습 진행을 위해서는 아래 내용을 설정해야 합니다.</p>
<p><strong>Anthropic</strong></p>
<ul>
<li><a href="https://console.anthropic.com/settings/keys">Anthropic API 키 발급 관련</a></li>
<li><code>.env</code> 파일 내 <code>ANTHROPIC_API_KEY</code> 에 발급받은 키를 설정하세요</li>
</ul>
<p><strong>Gemini</strong></p>
<ul>
<li><a href="https://aistudio.google.com/app/apikey?hl=ko">Gemini API 키 발급 관련</a></li>
<li><code>.env</code> 파일 내 <code>GOOGLE_API_KEY</code> 에 발급받은 키를 설정하세요</li>
</ul>
<p><strong>Together AI</strong></p>
<ul>
<li><a href="https://api.together.ai/">Together AI API 키 발급 관련</a></li>
<li><code>.env</code> 파일 내 <code>TOGETHER_API_KEY</code> 에 발급받은 키를 설정하세요</li>
</ul>
<p><strong>Ollama</strong></p>
<ul>
<li><a href="https://ollama.com/search?c=tools">Ollama Tool Calling 지원 모델 리스트</a></li>
<li><a href="https://ollama.com/library/llama3.1">이번 실습에 사용할 llama3.1 모델</a></li>
<li>터미널 창에 <code>ollama pull llama3.1</code> 명령어를 입력하여 모델을 다운로드 받습니다.</li>
<li>이전에 Ollama 를 사용하지 않았다면, <a href="https://wikidocs.net/233805">Ollama</a> 를 참고해 주세요.</li>
</ul>
<p>langchain-ollama 설치를 한 뒤 진행해 주세요.</p>
<div id="b94cad71" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install -qU langchain-ollama==0.1.3</span></span></code></pre></div></div>
</details>
</div>
<div id="efd4a3ed" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_anthropic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatAnthropic</span>
<span id="cb7-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_google_genai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatGoogleGenerativeAI</span>
<span id="cb7-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb7-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_ollama <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOllama</span>
<span id="cb7-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb7-6"></span>
<span id="cb7-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># GPT-4o-mini</span></span>
<span id="cb7-8">gpt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>)</span>
<span id="cb7-9"></span>
<span id="cb7-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Claude-3-5-sonnet</span></span>
<span id="cb7-11">claude <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatAnthropic(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"claude-3-5-sonnet-20240620"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-12"></span>
<span id="cb7-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Gemini-1.5-pro-latest</span></span>
<span id="cb7-14">gemini <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatGoogleGenerativeAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gemini-1.5-pro"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-15"></span>
<span id="cb7-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Llama-3.1-70B-Instruct-Turbo</span></span>
<span id="cb7-17">llama <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(</span>
<span id="cb7-18">    base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://api.together.xyz/v1"</span>,</span>
<span id="cb7-19">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TOGETHER_API_KEY"</span>],</span>
<span id="cb7-20">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"meta-llama/Meta-Llama-3.1-70B-Instruct-Turbo"</span>,</span>
<span id="cb7-21">)</span>
<span id="cb7-22"></span>
<span id="cb7-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Llama-3.1</span></span>
<span id="cb7-24">ollama <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOllama(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llama3.1"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-25"></span>
<span id="cb7-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Qwen2.5 7B (한글 성능 괜찮은 편)</span></span>
<span id="cb7-27">qwen <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOllama(</span>
<span id="cb7-28">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen2.5:latest"</span>,</span>
<span id="cb7-29">)</span></code></pre></div></div>
</details>
</div>
<p>LLM 기반으로 Agent 를 생성합니다.</p>
<div id="fc717e7d" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> create_tool_calling_agent</span>
<span id="cb8-2"></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Agent 생성</span></span>
<span id="cb8-4">gpt_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(gpt, tools, prompt)</span>
<span id="cb8-5">claude_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(claude, tools, prompt)</span>
<span id="cb8-6">gemini_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(gemini, tools, prompt)</span>
<span id="cb8-7">llama_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(llama, tools, prompt)</span>
<span id="cb8-8">ollama_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(ollama, tools, prompt)</span>
<span id="cb8-9">qwen_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(qwen, tools, prompt)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="agentexecutor-생성-후-실행-및-결과-확인" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="agentexecutor-생성-후-실행-및-결과-확인"><span class="header-section-number">3</span> AgentExecutor 생성 후 실행 및 결과 확인</h2>
<div id="0e56d590" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AgentExecutor</span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gpt_agent 실행</span></span>
<span id="cb9-4">agent_executor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AgentExecutor(</span>
<span id="cb9-5">    agent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gpt_agent,</span>
<span id="cb9-6">    tools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tools,</span>
<span id="cb9-7">    verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb9-8">    handle_parsing_errors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb9-9">)</span>
<span id="cb9-10"></span>
<span id="cb9-11">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_executor.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI 투자와 관련된 뉴스를 검색해 주세요."</span>})</span>
<span id="cb9-12"></span>
<span id="cb9-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Agent 실행 결과:"</span>)</span>
<span id="cb9-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>])</span></code></pre></div></div>
</details>
</div>
<p>다양한 llm을 사용하여 에이전트를 실행합니다.</p>
<p>다음은 입력받은 llm을 사용하여 Agent 를 생성하고 실행하여 결과를 출력하는 함수입니다.</p>
<div id="48d62f30" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> execute_agent(llm, tools, input_text, label):</span>
<span id="cb10-2">    agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(llm, tools, prompt)</span>
<span id="cb10-3">    executor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AgentExecutor(agent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>agent, tools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tools, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb10-4">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> executor.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: input_text})</span>
<span id="cb10-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"[</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>label<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">] 결과입니다."</span>)</span>
<span id="cb10-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>], <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb10-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> item <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>]:</span>
<span id="cb10-8">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> item:</span>
<span id="cb10-9">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(item[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>])</span>
<span id="cb10-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>], <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb10-11">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>])</span>
<span id="cb10-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb10-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>])</span></code></pre></div></div>
</details>
</div>
<p>각 llm 별로 에이전트를 생성하고 실행하여 결과를 출력합니다.</p>
<div id="ae5371d1" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb11-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI 투자와 관련된 뉴스를 검색하고, 결과를 Instagram 게시글 형식으로 작성해 주세요."</span></span>
<span id="cb11-3">)</span></code></pre></div></div>
</details>
</div>
<div id="8d47e6a7" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gpt</span></span>
<span id="cb12-2">execute_agent(gpt, tools, query, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="89e363a1" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># claude</span></span>
<span id="cb13-2">execute_agent(claude, tools, query, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"claude"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="58944514" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gemini</span></span>
<span id="cb14-2">execute_agent(gemini, tools, query, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gemini"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="2283f0c4" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># llama3.1 70B (Together.ai)</span></span>
<span id="cb15-2">execute_agent(</span>
<span id="cb15-3">    llama,</span>
<span id="cb15-4">    tools,</span>
<span id="cb15-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Search AI related news and write it in Instagram post format"</span>,</span>
<span id="cb15-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llama3.1 70B"</span>,</span>
<span id="cb15-7">)</span></code></pre></div></div>
</details>
</div>
<div id="fe70f105" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># llama3.1 8B (ollama)</span></span>
<span id="cb16-2">execute_agent(ollama, tools, query, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llama3.1(Ollama)"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="baef686c" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># qwen2.5 7B (ollama)</span></span>
<span id="cb17-2">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI 투자와 관련된 뉴스를 검색하고, 결과를 Instagram 게시글 형식으로 작성해 주세요. 한글로 답변하세요!"</span></span>
<span id="cb17-3"></span>
<span id="cb17-4">execute_agent(qwen, tools, query, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen2.5(Ollama)"</span>)</span></code></pre></div></div>
</details>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/04-Agent-More-LLMs.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>도구 (Tools)</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/01-Tools.html</link>
  <description><![CDATA[ 






<p>도구(Tool)는 에이전트, 체인 또는 LLM이 외부 세계와 상호작용하기 위한 인터페이스입니다.</p>
<p>LangChain 에서 기본 제공하는 도구를 사용하여 쉽게 도구를 활용할 수 있으며, 사용자 정의 도구(Custom Tool) 를 쉽게 구축하는 것도 가능합니다.</p>
<p><strong>LangChain 에 통합된 도구 리스트는 아래 링크에서 확인할 수 있습니다.</strong></p>
<ul>
<li><a href="https://python.langchain.com/v0.1/docs/integrations/tools/">LangChain 통합된 도구 리스트</a></li>
</ul>
<div id="162928bb" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="adba0a4e" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install -qU langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH15-Tools"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="73f66311" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> warnings</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 경고 메시지 무시</span></span>
<span id="cb3-4">warnings.filterwarnings(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ignore"</span>)</span></code></pre></div></div>
</details>
</div>
<section id="빌트인-도구built-in-tools" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="빌트인-도구built-in-tools"><span class="header-section-number">1</span> 빌트인 도구(built-in tools)</h2>
<p>랭체인에서 제공하는 사전에 정의된 도구(tool) 와 툴킷(toolkit) 을 사용할 수 있습니다.</p>
<p>tool 은 단일 도구를 의미하며, toolkit 은 여러 도구를 묶어서 하나의 도구로 사용할 수 있습니다.</p>
<p>관련 도구는 아래의 링크에서 참고하실 수 있습니다.</p>
<p><strong>참고</strong> - <a href="https://python.langchain.com/docs/integrations/tools/">LangChain Tools/Toolkits</a></p>
<section id="python-repl-도구" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="python-repl-도구"><span class="header-section-number">1.1</span> Python REPL 도구</h3>
<p>이 도구는 Python 코드를 REPL(Read-Eval-Print Loop) 환경에서 실행하기 위한 클래스를 제공합니다 어떤 코드를 만들어서 실행하는 것이다. - PythonREPLTool</p>
<p><strong>설명</strong></p>
<ul>
<li>Python 셸 환경을 제공합니다.</li>
<li>유효한 Python 명령어를 입력으로 받아 실행합니다.</li>
<li>결과를 보려면 print(…) 함수를 사용해야 합니다.</li>
</ul>
<p><strong>주요 특징</strong></p>
<ul>
<li>sanitize_input: 입력을 정제하는 옵션 (기본값: True)</li>
<li>python_repl: PythonREPL 인스턴스 (기본값: 전역 범위에서 실행)</li>
</ul>
<p><strong>사용 방법</strong></p>
<ul>
<li>PythonREPLTool 인스턴스 생성</li>
<li>run 또는 arun, invoke 메서드를 사용하여 Python 코드 실행</li>
</ul>
<p><strong>입력 정제</strong></p>
<ul>
<li>입력 문자열에서 불필요한 공백, 백틱, ‘python’ 키워드 등을 제거합니다.</li>
</ul>
<div id="d943ee9e" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_experimental.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PythonREPLTool</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 파이썬 코드를 실행하는 도구를 생성합니다.</span></span>
<span id="cb4-4">python_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PythonREPLTool()</span></code></pre></div></div>
</details>
</div>
<div id="5c92c03c" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 파이썬 코드를 실행하고 결과를 반환합니다.</span></span>
<span id="cb5-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(python_tool.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"print(100 + 200)"</span>))</span></code></pre></div></div>
</details>
</div>
<p>아래는 LLM 에게 파이썬 코드를 작성하도록 요청하고 결과를 반환하는 예제입니다.</p>
<p><strong>흐름 정리</strong> 1. LLM 모델에게 특정 작업을 수행하는 Python 코드를 작성하도록 요청합니다. 2. 작성된 코드를 실행하여 결과를 얻습니다. 3. 결과를 출력합니다.</p>
<div id="544403e4" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate</span>
<span id="cb6-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.output_parsers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StrOutputParser</span>
<span id="cb6-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.runnables <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RunnableLambda</span>
<span id="cb6-5"></span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 파이썬 코드를 실행하고 중간 과정을 출력하고 도구 실행 결과를 반환하는 함수</span></span>
<span id="cb6-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> print_and_execute(code, debug<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb6-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> debug:</span>
<span id="cb6-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CODE:"</span>)</span>
<span id="cb6-11">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(code)</span>
<span id="cb6-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> python_tool.invoke(code)</span>
<span id="cb6-13"></span>
<span id="cb6-14"></span>
<span id="cb6-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 파이썬 코드를 작성하도록 요청하는 프롬프트</span></span>
<span id="cb6-16">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_messages(</span>
<span id="cb6-17">    [</span>
<span id="cb6-18">        (</span>
<span id="cb6-19">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>,</span>
<span id="cb6-20">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are Raymond Hetting, an expert python programmer, well versed in meta-programming and elegant, concise and short but well documented code. You follow the PEP8 style guide. "</span></span>
<span id="cb6-21">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Return only the code, no intro, no explanation, no chatty, no markdown, no code block, no nothing. Just the code."</span>,</span>
<span id="cb6-22">        ),</span>
<span id="cb6-23">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"human"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{input}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb6-24">    ]</span>
<span id="cb6-25">)</span>
<span id="cb6-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLM 모델 생성</span></span>
<span id="cb6-27">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb6-28"></span>
<span id="cb6-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트와 LLM 모델을 사용하여 체인 생성</span></span>
<span id="cb6-30">chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> RunnableLambda(print_and_execute)</span></code></pre></div></div>
</details>
</div>
<div id="407d9735" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 결과 출력</span></span>
<span id="cb7-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(chain.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"로또 번호 생성기를 출력하는 코드를 작성하세요."</span>))</span></code></pre></div></div>
</details>
</div>
</section>
<section id="검색-api-도구" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="검색-api-도구"><span class="header-section-number">1.2</span> 검색 API 도구</h3>
<p>Tavily 검색 API를 활용하여 검색 기능을 구현하는 도구입니다. 이 도구는 두 가지 주요 클래스를 제공합니다: <code>TavilySearchResults</code>와 <code>TavilyAnswer</code>.</p>
<p><strong>API 키 발급 주소</strong> - https://app.tavily.com/</p>
<p>발급한 API 키를 환경변수에 설정합니다.</p>
<p><code>.env</code> 파일에 아래와 같이 설정합니다.</p>
<pre><code>TAVILY_API_KEY=tvly-abcdefghijklmnopqrstuvwxyz</code></pre>
</section>
<section id="tavilysearchresults" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="tavilysearchresults"><span class="header-section-number">1.3</span> TavilySearchResults</h3>
<p><strong>설명</strong> - Tavily 검색 API를 쿼리하고 JSON 형식의 결과를 반환합니다. - 포괄적이고 정확하며 신뢰할 수 있는 결과에 최적화된 검색 엔진입니다. - 현재 이벤트에 대한 질문에 답변할 때 유용합니다. - 사용자가 LLM/RAG 에서도 없는 최신 정보가 불만족스럽거나, 그럴때 사용하는것.</p>
<p><strong>주요 매개변수</strong> - <code>max_results</code> (int): 반환할 최대 검색 결과 수 (기본값: 5) - <code>search_depth</code> (str): 검색 깊이 (“basic” 또는 “advanced”) - <code>include_domains</code> (List[str]): 검색 결과에 포함할 도메인 목록 - <code>exclude_domains</code> (List[str]): 검색 결과에서 제외할 도메인 목록 - <code>include_answer</code> (bool): 원본 쿼리에 대한 짧은 답변 포함 여부 - <code>include_raw_content</code> (bool): 각 사이트의 정제된 HTML 콘텐츠 포함 여부 - <code>include_images</code> (bool): 쿼리 관련 이미지 목록 포함 여부</p>
<p><strong>반환 값</strong> - 검색 결과를 포함하는 JSON 형식의 문자열(url, content)</p>
<p>혹은 아래의 주석을 해제하고 발급받은 API 키를 입력합니다.</p>
<div id="2bb4df80" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import os</span></span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># os.environ["TAVILY_API_KEY"] = "TAVILY API 키 입력"</span></span></code></pre></div></div>
</details>
</div>
<div id="7d2ec10b" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.tools.tavily_search <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TavilySearchResults</span>
<span id="cb10-2"></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 생성</span></span>
<span id="cb10-4">tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TavilySearchResults(</span>
<span id="cb10-5">    max_results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,</span>
<span id="cb10-6">    include_answer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb10-7">    include_raw_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb10-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># include_images=True,</span></span>
<span id="cb10-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># search_depth="advanced", # or "basic"</span></span>
<span id="cb10-10">    include_domains<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"github.io"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wikidocs.net"</span>],</span>
<span id="cb10-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># exclude_domains = []</span></span>
<span id="cb10-12">)</span></code></pre></div></div>
</details>
</div>
<div id="a640a496" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 실행</span></span>
<span id="cb11-2">tool.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"query"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LangChain Tools 에 대해서 알려주세요"</span>})</span></code></pre></div></div>
</details>
</div>
</section>
<section id="image-생성-도구-dall-e" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="image-생성-도구-dall-e"><span class="header-section-number">1.4</span> Image 생성 도구 (DALL-E)</h3>
<ul>
<li><code>DallEAPIWrapper 클래스</code>: OpenAI의 DALL-E 이미지 생성기를 위한 래퍼(wrapper)입니다.</li>
</ul>
<p>이 도구를 사용하면 DALL-E API를 쉽게 통합하여 텍스트 기반 이미지 생성 기능을 구현할 수 있습니다. 다양한 설정 옵션을 통해 유연하고 강력한 이미지 생성 도구로 활용할 수 있습니다.</p>
<p><strong>주요 속성</strong></p>
<ul>
<li><p><code>model</code>: 사용할 DALL-E 모델 이름 (기본값: “dall-e-2”, “dall-e-3”)</p></li>
<li><p><code>n</code>: 생성할 이미지 수 (기본값: 1)</p></li>
<li><p><code>size</code>: 생성할 이미지 크기</p>
<ul>
<li>“dall-e-2”: “1024x1024”, “512x512”, “256x256”</li>
<li>“dall-e-3”: “1024x1024”, “1792x1024”, “1024x1792”</li>
</ul></li>
<li><p><code>style</code>: 생성될 이미지의 스타일 (기본값: “natural”, “vivid”)</p></li>
<li><p><code>quality</code>: 생성될 이미지의 품질 (기본값: “standard”, “hd”)</p></li>
<li><p><code>max_retries</code>: 생성 시 최대 재시도 횟수</p></li>
</ul>
<p><strong>주요 기능</strong> - DALL-E API를 사용하여 텍스트 설명에 기반한 이미지 생성</p>
<p><strong>흐름 정리</strong></p>
<p>다음은 DALL-E Image Generator 를 사용하여 이미지를 생성하는 예제입니다.</p>
<p>이번에는 <code>DallEAPIWrapper</code> 를 사용하여 이미지를 생성해 보겠습니다.</p>
<p>이때 입력 프롬프트는 LLM 모델에게 이미지를 생성하는 프롬프트를 작성하도록 요청합니다.</p>
<div id="ce07ac5e" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.output_parsers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StrOutputParser</span>
<span id="cb12-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PromptTemplate</span>
<span id="cb12-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb12-4"></span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ChatOpenAI 모델 초기화</span></span>
<span id="cb12-6">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span>
<span id="cb12-7"></span>
<span id="cb12-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DALL-E 이미지 생성을 위한 프롬프트 템플릿 정의</span></span>
<span id="cb12-9">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PromptTemplate.from_template(</span>
<span id="cb12-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Generate a detailed IMAGE GENERATION prompt for DALL-E based on the following description. "</span></span>
<span id="cb12-11">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Return only the prompt, no intro, no explanation, no chatty, no markdown, no code block, no nothing. Just the prompt"</span></span>
<span id="cb12-12">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Output should be less than 1000 characters. Write in English only."</span></span>
<span id="cb12-13">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Image Description: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{image_desc}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb12-14">)</span>
<span id="cb12-15"></span>
<span id="cb12-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트, LLM, 출력 파서를 연결하는 체인 생성</span></span>
<span id="cb12-17">chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser()</span>
<span id="cb12-18"></span>
<span id="cb12-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 체인 실행</span></span>
<span id="cb12-20">image_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chain.invoke(</span>
<span id="cb12-21">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_desc"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"스마트폰을 바라보는 사람들을 풍자한 neo-classicism painting"</span>}</span>
<span id="cb12-22">)</span>
<span id="cb12-23"></span>
<span id="cb12-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 이미지 프롬프트 출력</span></span>
<span id="cb12-25"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(image_prompt)</span></code></pre></div></div>
</details>
</div>
<p>그럼, 이전에 생성한 이미지 프롬프트를 <code>DallEAPIWrapper</code> 에 입력하여 이미지를 생성해 보겠습니다.</p>
<p><strong><code>DallEAPIWrapper</code> 에 대한 임시 버그 안내사항</strong> (작성일: 2024-10-13)</p>
<ul>
<li>현재 langchain 0.3.x 이상 버전에서 <code>DallEAPIWrapper</code> 에 대한 임시 버그가 있습니다. (<code>401 오류: invalid API key</code>)</li>
</ul>
<p>따라서, 아래의 코드를 오류 없이 실행하기 위해서는 LangChain 버전을 0.2.16 으로 변경해야 합니다.</p>
<p>아래의 주석을 해제하고 실행하면 LangChain 버전을 0.2.16 으로 변경됩니다.</p>
<p>하지만, 이후 내용에서는 LangChain 버전을 0.3.x 이상으로 변경하여 사용하기 때문에</p>
<p><code>poetry shell</code> 명령어를 통해 다시 최신 langchain 버전으로 변경해야 합니다.</p>
<p>이 과정이 번거로운 분들은 일단 <code>DallEAPIWrapper</code> 를 사용하지 않고 진행하셔도 무방합니다.</p>
<p><strong>업그레이드/다운그레이드</strong> 후에는 반드시 상단 메뉴의 “Restart” 버튼을 클릭한 뒤 진행해야 합니다.</p>
<div id="b2aaca2d" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임시 버전 다운그레이드 명령어 (실행 후 restart)</span></span>
<span id="cb13-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain==0.2.16 langchain-community==0.2.16 langchain-text-splitters==0.2.4 langchain-experimental==0.0.65 langchain-openai==0.1.20</span></span></code></pre></div></div>
</details>
</div>
<div id="669cbaae" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DALL-E API 래퍼 가져오기</span></span>
<span id="cb14-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.utilities.dalle_image_generator <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DallEAPIWrapper</span>
<span id="cb14-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> IPython.display <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb14-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb14-5"></span>
<span id="cb14-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DALL-E API 래퍼 초기화</span></span>
<span id="cb14-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># model: 사용할 DALL-E 모델 버전</span></span>
<span id="cb14-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># size: 생성할 이미지 크기</span></span>
<span id="cb14-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># quality: 이미지 품질</span></span>
<span id="cb14-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># n: 생성할 이미지 수</span></span>
<span id="cb14-11">dalle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DallEAPIWrapper(</span>
<span id="cb14-12">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dall-e-3"</span>,</span>
<span id="cb14-13">    size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1024x1024"</span>,</span>
<span id="cb14-14">    quality<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"standard"</span>,</span>
<span id="cb14-15">    n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb14-16">)</span>
<span id="cb14-17"></span>
<span id="cb14-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질문</span></span>
<span id="cb14-19">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"스마트폰을 바라보는 사람들을 풍자한 neo-classicism painting"</span></span>
<span id="cb14-20"></span>
<span id="cb14-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 이미지 생성 및 URL 받기</span></span>
<span id="cb14-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># chain.invoke()를 사용하여 이미지 설명을 DALL-E 프롬프트로 변환</span></span>
<span id="cb14-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dalle.run()을 사용하여 실제 이미지 생성</span></span>
<span id="cb14-24">image_url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dalle.run(chain.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_desc"</span>: query}))</span>
<span id="cb14-25"></span>
<span id="cb14-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 생성된 이미지를 표시합니다.</span></span>
<span id="cb14-27">Image(url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>image_url, width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="사용자-정의-도구custom-tool" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="사용자-정의-도구custom-tool"><span class="header-section-number">2</span> 사용자 정의 도구(Custom Tool)</h2>
<p>LangChain 에서 제공하는 빌트인 도구 외에도 사용자가 직접 도구를 정의하여 사용할 수 있습니다.</p>
<p>이를 위해서는 <code>langchain.tools</code> 모듈에서 제공하는 <code>tool</code> 데코레이터를 사용하여 함수를 도구로 변환합니다.</p>
<section id="tool-데코레이터" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="tool-데코레이터"><span class="header-section-number">2.1</span> <span class="citation" data-cites="tool">@tool</span> 데코레이터</h3>
<p>이 데코레이터는 함수를 도구로 변환하는 기능을 제공합니다. 다양한 옵션을 통해 도구의 동작을 커스터마이즈할 수 있습니다.</p>
<p><strong>사용 방법</strong> 1. 함수 위에 <code>@tool</code> 데코레이터 적용 2. 필요에 따라 데코레이터 매개변수 설정</p>
<p>이 데코레이터를 사용하면 일반 Python 함수를 강력한 도구로 쉽게 변환할 수 있으며, 자동화된 문서화와 유연한 인터페이스 생성이 가능합니다.</p>
<div id="bb173b35" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tool</span>
<span id="cb15-2"></span>
<span id="cb15-3"></span>
<span id="cb15-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 데코레이터를 사용하여 함수를 도구로 변환합니다.</span></span>
<span id="cb15-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb15-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> add_numbers(a: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, b: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>:</span>
<span id="cb15-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Add two numbers"""</span></span>
<span id="cb15-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span>
<span id="cb15-9"></span>
<span id="cb15-10"></span>
<span id="cb15-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb15-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> multiply_numbers(a: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, b: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>:</span>
<span id="cb15-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Multiply two numbers"""</span></span>
<span id="cb15-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b</span></code></pre></div></div>
</details>
</div>
<div id="58c9189a" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 실행</span></span>
<span id="cb16-2">add_numbers.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>})</span></code></pre></div></div>
</details>
</div>
<div id="dd962b45" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 실행</span></span>
<span id="cb17-2">multiply_numbers.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>})</span></code></pre></div></div>
</details>
</div>
</section>
<section id="구글-뉴스기사-검색-도구" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="구글-뉴스기사-검색-도구"><span class="header-section-number">2.2</span> 구글 뉴스기사 검색 도구</h3>
<p><code>langchain-teddynote</code> 패키지에서 제공하는 <code>GoogleNews</code> 도구를 사용하여 구글 뉴스기사를 검색하는 도구입니다.</p>
<p><strong>참고</strong> - API 키가 필요하지 않습니다. (RSS 피드를 사용하기 때문)</p>
<p>news.google.com 에서 제공하는 뉴스기사를 검색하는 도구입니다.</p>
<p><strong>설명</strong> - 구글 뉴스 검색 API를 사용하여 최신 뉴스를 검색합니다. - 키워드를 기반으로 뉴스를 검색할 수 있습니다. - 최신 뉴스를 검색할 수 있습니다.</p>
<p><strong>주요 매개변수</strong> - <code>k</code> (int): 반환할 최대 검색 결과 수 (기본값: 5)</p>
<p>사용하기 전 패키지를 업데이트 해주세요.</p>
<div id="d1d36cd5" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install -qU langchain-teddynote</span></span></code></pre></div></div>
</details>
</div>
<div id="91d4596c" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> GoogleNews</span>
<span id="cb19-2"></span>
<span id="cb19-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 생성</span></span>
<span id="cb19-4">news_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GoogleNews()</span></code></pre></div></div>
</details>
</div>
<div id="28908a00" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 최신 뉴스 검색</span></span>
<span id="cb20-2">news_tool.search_latest(k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
</details>
</div>
<div id="38f973dd" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 키워드로 뉴스 검색</span></span>
<span id="cb21-2">news_tool.search_by_keyword(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI 투자"</span>, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div></div>
</details>
</div>
<div id="5b5c4a92" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> GoogleNews</span>
<span id="cb22-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tool</span>
<span id="cb22-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> List, Dict</span>
<span id="cb22-4"></span>
<span id="cb22-5"></span>
<span id="cb22-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 키워드로 뉴스 검색하는 도구 생성</span></span>
<span id="cb22-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb22-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> search_keyword(query: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]]:</span>
<span id="cb22-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Look up news by keyword"""</span></span>
<span id="cb22-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(query)</span>
<span id="cb22-11">    news_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GoogleNews()</span>
<span id="cb22-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> news_tool.search_by_keyword(query, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
</details>
</div>
<div id="5db5b311" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 실행 결과</span></span>
<span id="cb23-2">search_keyword.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"query"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LangChain AI"</span>})</span></code></pre></div></div>
</details>
</div>


</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>LangChain</category>
  <category>Prompt_Engineering</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/01-Tools.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>Iteration 기능과 사람 개입(Human-in-the-loop)</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/05-Iter-Human-In-the-Loop.html</link>
  <description><![CDATA[ 






<p><code>iter()</code> 메서드는 에이전트의 실행 과정을 단계별로 반복할 수 있게 해주는 반복자(iterator)를 생성합니다.</p>
<p>중간 과정에서 사용자의 입력을 받아 계속 진행할지 묻는 기능을 제공합니다. 이를 <code>Human-in-the-loop</code> 라고 합니다.</p>
<div id="2bc8a97c" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API KEY를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API KEY 정보로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="24adf030" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install -qU langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH15-Agents"</span>)</span></code></pre></div></div>
</details>
</div>
<p>먼저, 도구(tool) 를 정의합니다.</p>
<div id="dc419bf7" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tool</span>
<span id="cb3-2"></span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb3-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> add_function(a: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, b: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb3-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Adds two numbers together."""</span></span>
<span id="cb3-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span></code></pre></div></div>
</details>
</div>
<p>다음으로는 <code>add_function</code> 을 사용하여 덧셈 계산을 수행하는 Agent 를 정의합니다.</p>
<div id="a0abec97" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate, MessagesPlaceholder</span>
<span id="cb4-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb4-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> create_tool_calling_agent, AgentExecutor</span>
<span id="cb4-4"></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 정의</span></span>
<span id="cb4-6">tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [add_function]</span>
<span id="cb4-7"></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLM 생성</span></span>
<span id="cb4-9">gpt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>)</span>
<span id="cb4-10"></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prompt 생성</span></span>
<span id="cb4-12">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_messages(</span>
<span id="cb4-13">    [</span>
<span id="cb4-14">        (</span>
<span id="cb4-15">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>,</span>
<span id="cb4-16">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant."</span>,</span>
<span id="cb4-17">        ),</span>
<span id="cb4-18">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"human"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{input}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb4-19">        MessagesPlaceholder(variable_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"agent_scratchpad"</span>),</span>
<span id="cb4-20">    ]</span>
<span id="cb4-21">)</span>
<span id="cb4-22"></span>
<span id="cb4-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Agent 생성</span></span>
<span id="cb4-24">gpt_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(gpt, tools, prompt)</span>
<span id="cb4-25"></span>
<span id="cb4-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AgentExecutor 생성</span></span>
<span id="cb4-27">agent_executor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AgentExecutor(</span>
<span id="cb4-28">    agent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gpt_agent,</span>
<span id="cb4-29">    tools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tools,</span>
<span id="cb4-30">    verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb4-31">    max_iterations<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb4-32">    handle_parsing_errors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb4-33">)</span></code></pre></div></div>
</details>
</div>
<section id="agentexecutor의-iter" class="level3" data-number="0.1">
<h3 data-number="0.1" class="anchored" data-anchor-id="agentexecutor의-iter"><span class="header-section-number">0.1</span> AgentExecutor의 iter()</h3>
<p>이 메서드는 AgentExecutor의 실행 과정을 단계별로 반복할 수 있게 해주는 반복자(iterator)를 생성합니다.</p>
<p><strong>함수 설명</strong> <code>iter()</code> 는 에이전트가 최종 출력에 도달하기까지 거치는 단계들을 순차적으로 접근할 수 있는 <code>AgentExecutorIterator</code> 객체를 반환합니다.</p>
<p><strong>주요 기능</strong> - <strong>단계별 실행 접근</strong>: 에이전트의 실행 과정을 단계별로 살펴볼 수 있습니다.</p>
<p><strong>흐름 정리</strong></p>
<p><code>"114.5 + 121.2 + 34.2 + 110.1"</code> 의 덧셈 계산을 수행하기 위해서는 단계별로 계산이 수행되게 됩니다.</p>
<ol type="1">
<li>114.5 + 121.2 = 235.7</li>
<li>235.7 + 34.2 = 270.9</li>
<li>270.9 + 110.1 = 381.0</li>
</ol>
<p>이러한 계산 과정을 단계별로 살펴볼 수 있습니다.</p>
<p>이때,</p>
<p>단계별로 계산 결과를 사용자에게 보여주고, 사용자가 계속 진행할지 묻습니다. (<strong>Human-in-the-loop</strong>)</p>
<p>사용자가 ’y’가 아닌 다른 입력을 하면 반복 중단됩니다.</p>
<div id="101628de" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 계산할 질문 설정</span></span>
<span id="cb5-2">question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"114.5 + 121.2 + 34.2 + 110.1 의 계산 결과는?"</span></span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># agent_executor를 반복적으로 실행</span></span>
<span id="cb5-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> step <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> agent_executor.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">iter</span>({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: question}):</span>
<span id="cb5-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:=</span> step.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"intermediate_step"</span>):</span>
<span id="cb5-7">        action, value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> output[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb5-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> action.tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"add_function"</span>:</span>
<span id="cb5-9">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tool 실행 결과 출력</span></span>
<span id="cb5-10">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Tool Name: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>action<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>tool<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, 실행 결과: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 사용자에게 계속 진행할지 묻습니다.</span></span>
<span id="cb5-12">        _continue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"계속 진행하시겠습니다? (y/n)?:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span></span>
<span id="cb5-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 사용자가 'y'가 아닌 다른 입력을 하면 반복 중단</span></span>
<span id="cb5-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> _continue.lower() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>:</span>
<span id="cb5-15">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb5-16"></span>
<span id="cb5-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 최종 결과 출력</span></span>
<span id="cb5-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> step:</span>
<span id="cb5-19">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(step[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>])</span></code></pre></div></div>
</details>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/05-Iter-Human-In-the-Loop.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>LLM 에 도구 바인딩(Binding Tools)</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/02-Bind-Tools.html</link>
  <description><![CDATA[ 






<p>LLM 모델이 도구(tool) 를 호출할 수 있으려면 chat 요청을 할 때 모델에 도구 스키마(tool schema) 를 전달해야 합니다.</p>
<p>도구 호출(tool calling) 기능을 지원하는 LangChain Chat Model 은 <code>.bind_tools()</code> 메서드를 구현하여 LangChain 도구 객체, Pydantic 클래스 또는 JSON 스키마 목록을 수신하고 공급자별 예상 형식으로 채팅 모델에 바인딩(binding) 합니다.</p>
<p>바인딩된 Chat Model 의 후속 호출은 모델 API에 대한 모든 호출에 도구 스키마를 포함합니다.</p>
<div id="52916810" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API KEY를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API KEY 정보로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="1d313af7" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install -qU langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH15-Bind-Tools"</span>)</span></code></pre></div></div>
</details>
</div>
<section id="llm에-바인딩할-tool-정의" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="llm에-바인딩할-tool-정의"><span class="header-section-number">1</span> LLM에 바인딩할 Tool 정의</h2>
<p>실험을 위한 도구(tool) 를 정의합니다.</p>
<ul>
<li><code>get_word_length</code> : 단어의 길이를 반환하는 함수</li>
<li><code>add_function</code> : 두 숫자를 더하는 함수</li>
<li><code>naver_news_crawl</code> : 네이버 뉴스 기사를 크롤링하여 본문 내용을 반환하는 함수</li>
</ul>
<p><strong>참고</strong> - 도구를 정의할 때 <code>@tool</code> 데코레이터를 사용하여 도구를 정의합니다. - docstring 은 가급적 영어로 작성하는 것을 권장합니다.</p>
<div id="d73aa88d" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> bs4 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BeautifulSoup</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tool</span>
<span id="cb3-5"></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구를 정의합니다.</span></span>
<span id="cb3-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb3-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_word_length(word: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>:</span>
<span id="cb3-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Returns the length of a word."""</span></span>
<span id="cb3-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(word)</span>
<span id="cb3-12"></span>
<span id="cb3-13"></span>
<span id="cb3-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb3-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> add_function(a: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, b: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb3-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Adds two numbers together."""</span></span>
<span id="cb3-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span>
<span id="cb3-18"></span>
<span id="cb3-19"></span>
<span id="cb3-20"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb3-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> naver_news_crawl(news_url: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb3-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Crawls a 네이버 (naver.com) news article and returns the body content."""</span></span>
<span id="cb3-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># HTTP GET 요청 보내기</span></span>
<span id="cb3-24">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.get(news_url)</span>
<span id="cb3-25"></span>
<span id="cb3-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 요청이 성공했는지 확인</span></span>
<span id="cb3-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> response.status_code <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>:</span>
<span id="cb3-28">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BeautifulSoup을 사용하여 HTML 파싱</span></span>
<span id="cb3-29">        soup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BeautifulSoup(response.text, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"html.parser"</span>)</span>
<span id="cb3-30"></span>
<span id="cb3-31">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 원하는 정보 추출</span></span>
<span id="cb3-32">        title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> soup.find(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"h2"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"title_area"</span>).get_text()</span>
<span id="cb3-33">        content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> soup.find(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"div"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"contents"</span>).get_text()</span>
<span id="cb3-34">        cleaned_title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.sub(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{2,}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, title)</span>
<span id="cb3-35">        cleaned_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.sub(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{2,}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, content)</span>
<span id="cb3-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb3-37">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"HTTP 요청 실패. 응답 코드: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>response<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>status_code<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-38"></span>
<span id="cb3-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>cleaned_title<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>cleaned_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb3-40"></span>
<span id="cb3-41"></span>
<span id="cb3-42">tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [get_word_length, add_function, naver_news_crawl]</span></code></pre></div></div>
</details>
</div>
</section>
<section id="bind_tools-로-llm-에-도구-바인딩" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="bind_tools-로-llm-에-도구-바인딩"><span class="header-section-number">2</span> bind_tools() 로 LLM 에 도구 바인딩</h2>
<p>llm 모델에 <code>bind_tools()</code> 를 사용하여 도구를 바인딩합니다.</p>
<div id="5e2eb45f" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 모델 생성</span></span>
<span id="cb4-4">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 바인딩</span></span>
<span id="cb4-7">llm_with_tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm.bind_tools(tools)</span></code></pre></div></div>
</details>
</div>
<p>실행결과를 확인합니다.</p>
<p>결과는 <code>tool_calls</code> 에 저장됩니다. 따라서, <code>.tool_calls</code> 를 확인하여 도구 호출 결과를 확인할 수 있습니다.</p>
<p><strong>참고</strong> - <code>name</code> 은 도구의 이름을 의미합니다. - <code>args</code> 는 도구에 전달되는 인자를 의미합니다.</p>
<div id="4d229c08" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 실행 결과</span></span>
<span id="cb5-2">llm_with_tools.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is the length of the word 'teddynote'?"</span>).tool_calls</span></code></pre></div></div>
</details>
</div>
<p>다음으로는 <code>llm_with_tools</code> 와 <code>JsonOutputToolsParser</code> 를 연결하여 <code>tool_calls</code> 를 parsing 하여 결과를 확인합니다.</p>
<div id="6cf60047" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.output_parsers.openai_tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> JsonOutputToolsParser</span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 바인딩 + 도구 파서</span></span>
<span id="cb6-4">chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm_with_tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> JsonOutputToolsParser(tools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tools)</span>
<span id="cb6-5"></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 실행 결과</span></span>
<span id="cb6-7">tool_call_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chain.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is the length of the word 'teddynote'?"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="ecad2bdb" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(tool_call_results)</span></code></pre></div></div>
</details>
</div>
<p>실행 결과는 다음과 같습니다.</p>
<p><strong>참고</strong> - <code>type</code>: 도구의 이름 - <code>args</code>: 도구에 전달되는 인자</p>
<div id="96cd7ed4" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(tool_call_results, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">==========</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 첫 번째 도구 호출 결과</span></span>
<span id="cb8-3">single_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tool_call_results[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 이름</span></span>
<span id="cb8-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(single_result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>])</span>
<span id="cb8-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 인자</span></span>
<span id="cb8-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(single_result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"args"</span>])</span></code></pre></div></div>
</details>
</div>
<p>도구 이름과 일치하는 도구를 찾아 실행합니다.</p>
<div id="3daea688" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1">tool_call_results[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>], tools[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].name</span></code></pre></div></div>
</details>
</div>
<p><code>execute_tool_calls</code> 함수는 도구를 찾아 args 를 전달하여 도구를 실행합니다.</p>
<p>즉, <code>type</code> 은 도구의 이름을 의미하고 <code>args</code> 는 도구에 전달되는 인자를 의미합니다.</p>
<div id="a91886f1" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> execute_tool_calls(tool_call_results):</span>
<span id="cb10-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    도구 호출 결과를 실행하는 함수</span></span>
<span id="cb10-4"></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    :param tool_call_results: 도구 호출 결과 리스트</span></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    :param tools: 사용 가능한 도구 리스트</span></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb10-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 호출 결과 리스트를 순회합니다.</span></span>
<span id="cb10-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tool_call_result <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tool_call_results:</span>
<span id="cb10-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구의 이름과 인자를 추출합니다.</span></span>
<span id="cb10-11">        tool_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tool_call_result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구의 이름(함수명)</span></span>
<span id="cb10-12">        tool_args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tool_call_result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"args"</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구에 전달되는 인자</span></span>
<span id="cb10-13"></span>
<span id="cb10-14">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 이름과 일치하는 도구를 찾아 실행합니다.</span></span>
<span id="cb10-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># next() 함수를 사용하여 일치하는 첫 번째 도구를 찾습니다.</span></span>
<span id="cb10-16">        matching_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>((tool <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tool <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tools <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> tool.name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> tool_name), <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb10-17"></span>
<span id="cb10-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> matching_tool:</span>
<span id="cb10-19">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 일치하는 도구를 찾았다면 해당 도구를 실행합니다.</span></span>
<span id="cb10-20">            result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matching_tool.invoke(tool_args)</span>
<span id="cb10-21">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 실행 결과를 출력합니다.</span></span>
<span id="cb10-22">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"[실행도구] </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tool_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> [Argument] </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tool_args<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">[실행결과] </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb10-24">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 일치하는 도구를 찾지 못했다면 경고 메시지를 출력합니다.</span></span>
<span id="cb10-25">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"경고: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tool_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">에 해당하는 도구를 찾을 수 없습니다."</span>)</span>
<span id="cb10-26"></span>
<span id="cb10-27"></span>
<span id="cb10-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 호출 실행</span></span>
<span id="cb10-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 이전에 얻은 tool_call_results를 인자로 전달하여 함수를 실행합니다.</span></span>
<span id="cb10-30">execute_tool_calls(tool_call_results)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="bind_tools-parser-execution" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="bind_tools-parser-execution"><span class="header-section-number">3</span> bind_tools + Parser + Execution</h2>
<p>이번에는 일련의 과정을 한 번에 실행합니다.</p>
<ul>
<li><code>llm_with_tools</code> : 도구를 바인딩한 모델</li>
<li><code>JsonOutputToolsParser</code> : 도구 호출 결과를 파싱하는 파서</li>
<li><code>execute_tool_calls</code> : 도구 호출 결과를 실행하는 함수</li>
</ul>
<p><strong>흐름 정리</strong> 1. 모델에 도구를 바인딩 2. 도구 호출 결과를 파싱 3. 도구 호출 결과를 실행</p>
<div id="b40398e0" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.output_parsers.openai_tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> JsonOutputToolsParser</span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bind_tools + Parser + Execution</span></span>
<span id="cb11-4">chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm_with_tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> JsonOutputToolsParser(tools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tools) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> execute_tool_calls</span></code></pre></div></div>
</details>
</div>
<div id="58212a70" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 실행 결과</span></span>
<span id="cb12-2">chain.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is the length of the word 'teddynote'?"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="e23021d3" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 실행 결과</span></span>
<span id="cb13-2">chain.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"114.5 + 121.2"</span>)</span>
<span id="cb13-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">114.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">121.2</span>)</span></code></pre></div></div>
</details>
</div>
<div id="8f594c9b" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 실행 결과</span></span>
<span id="cb14-2">chain.invoke(</span>
<span id="cb14-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"뉴스 기사 내용을 크롤링해줘: https://n.news.naver.com/mnews/hotissue/article/092/0002347672?type=series&amp;cid=2000065"</span></span>
<span id="cb14-4">)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="bind_tools-agent-agentexecutor-로-대체" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="bind_tools-agent-agentexecutor-로-대체"><span class="header-section-number">4</span> bind_tools &gt; Agent &amp; AgentExecutor 로 대체</h2>
<p><code>bind_tools()</code> 는 모델에 사용할 수 있는 스키마(도구)를 제공합니다.</p>
<p><code>AgentExecutor</code> 는 실제로 llm 호출, 올바른 도구로 라우팅, 실행, 모델 재호출 등을 위한 실행 루프를 생성합니다.</p>
<p><strong>참고</strong> - <code>Agent</code> 와 <code>AgentExecutor</code> 에 대해서는 다음 장에서 자세히 다룹니다.</p>
<div id="cc4b818e" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate, MessagesPlaceholder</span>
<span id="cb15-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb15-3"></span>
<span id="cb15-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Agent 프롬프트 생성</span></span>
<span id="cb15-5">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_messages(</span>
<span id="cb15-6">    [</span>
<span id="cb15-7">        (</span>
<span id="cb15-8">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>,</span>
<span id="cb15-9">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are very powerful assistant, but don't know current events"</span>,</span>
<span id="cb15-10">        ),</span>
<span id="cb15-11">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{input}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb15-12">        MessagesPlaceholder(variable_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"agent_scratchpad"</span>),</span>
<span id="cb15-13">    ]</span>
<span id="cb15-14">)</span>
<span id="cb15-15"></span>
<span id="cb15-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 모델 생성</span></span>
<span id="cb15-17">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div></div>
</details>
</div>
<div id="2883f8c5" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> create_tool_calling_agent</span>
<span id="cb16-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AgentExecutor</span>
<span id="cb16-3"></span>
<span id="cb16-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 이전에 정의한 도구 사용</span></span>
<span id="cb16-5">tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [get_word_length, add_function, naver_news_crawl]</span>
<span id="cb16-6"></span>
<span id="cb16-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Agent 생성</span></span>
<span id="cb16-8">agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(llm, tools, prompt)</span>
<span id="cb16-9"></span>
<span id="cb16-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AgentExecutor 생성</span></span>
<span id="cb16-11">agent_executor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AgentExecutor(</span>
<span id="cb16-12">    agent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>agent,</span>
<span id="cb16-13">    tools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tools,</span>
<span id="cb16-14">    verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb16-15">    handle_parsing_errors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb16-16">)</span></code></pre></div></div>
</details>
</div>
<div id="e195bd56" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Agent 실행</span></span>
<span id="cb17-2">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_executor.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"How many letters in the word `teddynote`?"</span>})</span>
<span id="cb17-3"></span>
<span id="cb17-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 결과 확인</span></span>
<span id="cb17-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>])</span></code></pre></div></div>
</details>
</div>
<div id="e9f52c8b" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Agent 실행</span></span>
<span id="cb18-2">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_executor.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"114.5 + 121.2 의 계산 결과는?"</span>})</span>
<span id="cb18-3"></span>
<span id="cb18-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 결과 확인</span></span>
<span id="cb18-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>])</span></code></pre></div></div>
</details>
</div>
<p>한 번의 실행으로 끝나는 것이 아닌, 모델이 자신의 결과를 확인하고 다시 자신을 호출하는 과정을 거칩니다.</p>
<div id="63b0a35b" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Agent 실행</span></span>
<span id="cb19-2">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_executor.invoke(</span>
<span id="cb19-3">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"114.5 + 121.2 + 34.2 + 110.1 의 계산 결과는?"</span>}</span>
<span id="cb19-4">)</span>
<span id="cb19-5"></span>
<span id="cb19-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 결과 확인</span></span>
<span id="cb19-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>])</span>
<span id="cb19-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"==========</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">114.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">121.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">34.2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">110.1</span>)</span></code></pre></div></div>
</details>
</div>
<p>이번에는 뉴스 결과를 크롤링 해서 요약 해달라는 요청을 수행합니다.</p>
<div id="f7f7059e" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_executor.invoke(</span>
<span id="cb20-2">    {</span>
<span id="cb20-3">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"뉴스 기사를 요약해 줘: https://n.news.naver.com/mnews/hotissue/article/092/0002347672?type=series&amp;cid=2000065"</span></span>
<span id="cb20-4">    }</span>
<span id="cb20-5">)</span>
<span id="cb20-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>])</span></code></pre></div></div>
</details>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/02-Bind-Tools.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>도구 호출 에이전트(Tool Calling Agent)</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/03-Agent.html</link>
  <description><![CDATA[ 






<p>도구 호출을 사용하면 모델이 하나 이상의 <strong>도구(tool)</strong> 가 <strong>호출되어야 하는 시기를 감지하고 해당 도구에 전달해야 하는 입력</strong> 으로 전달할 수 있습니다.</p>
<p>API 호출에서 도구를 설명하고 모델이 이러한 도구를 호출하기 위한 인수가 포함된 JSON과 같은 구조화된 객체를 출력하도록 지능적으로 선택할 수 있습니다.</p>
<p>도구 API 의 목표는 일반 텍스트 완성이나 채팅 API를 사용하여 수행할 수 있는 것보다 더 안정적으로 유효하고 유용한 <strong>도구 호출(tool call)</strong> 을 반환하는 것입니다.</p>
<p>이러한 구조화된 출력을 도구 호출 채팅 모델에 여러 도구를 바인딩하고 모델이 호출할 도구를 선택할 수 있다는 사실과 결합하여 쿼리가 해결될 때까지 반복적으로 도구를 호출하고 결과를 수신하는 에이전트를 만들 수 있습니다.</p>
<p>이것은 OpenAI 의 특정 도구 호출 스타일에 맞게 설계된 OpenAI 도구 에이전트의 보다 <strong>일반화된 버전</strong> 입니다.</p>
<p>이 에이전트는 LangChain의 ToolCall 인터페이스를 사용하여 OpenAI 외에도 <code>Anthropic</code>, <code>Google Gemini</code>, <code>Mistral</code>과 같은 더 광범위한 공급자 구현을 지원합니다.</p>
<p><strong>참고 링크</strong></p>
<ul>
<li><a href="https://python.langchain.com/v0.1/docs/modules/agents/agent_types/tool_calling/">LangChain 공식 도큐먼트</a></li>
</ul>
<p><img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/assets/agent-concept.png" class="img-fluid"></p>
<div id="a7c58715" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="6e56c40a" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install -qU langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH15-Agents"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="2047d1e0" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tool</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> List, Dict, Annotated</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> GoogleNews</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_experimental.utilities <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PythonREPL</span>
<span id="cb3-5"></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 생성</span></span>
<span id="cb3-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb3-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> search_news(query: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]]:</span>
<span id="cb3-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Search Google News by input keyword"""</span></span>
<span id="cb3-11">    news_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GoogleNews()</span>
<span id="cb3-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> news_tool.search_by_keyword(query, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb3-13"></span>
<span id="cb3-14"></span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 생성</span></span>
<span id="cb3-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb3-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> python_repl_tool(</span>
<span id="cb3-18">    code: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The python code to execute to generate your chart."</span>],</span>
<span id="cb3-19">):</span>
<span id="cb3-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Use this to execute python code. If you want to see the output of a value,</span></span>
<span id="cb3-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    you should print it out with `print(...)`. This is visible to the user."""</span></span>
<span id="cb3-22">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb3-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb3-24">        result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PythonREPL().run(code)</span>
<span id="cb3-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">BaseException</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb3-26">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Failed to execute. Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">repr</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">finally</span>:</span>
<span id="cb3-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> result</span>
<span id="cb3-29"></span>
<span id="cb3-30"></span>
<span id="cb3-31"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"도구 이름: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>search_news<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-32"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"도구 설명: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>search_news<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>description<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-33"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"도구 이름: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>python_repl_tool<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-34"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"도구 설명: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>python_repl_tool<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>description<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="ee789017" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tools 정의</span></span>
<span id="cb4-2">tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [search_news, python_repl_tool]</span></code></pre></div></div>
</details>
</div>
<section id="agent-프롬프트-생성" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="agent-프롬프트-생성"><span class="header-section-number">1</span> Agent 프롬프트 생성</h2>
<ul>
<li><code>chat_history</code> : 이전 대화 내용을 저장하는 변수 (멀티턴을 지원하지 않는다면, 생략 가능합니다.)</li>
<li><code>agent_scratchpad</code> : 에이전트가 임시로 저장하는 변수</li>
<li><code>input</code> : 사용자의 입력</li>
</ul>
<div id="b9ab9d67" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate</span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트 생성</span></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트는 에이전트에게 모델이 수행할 작업을 설명하는 텍스트를 제공합니다. (도구의 이름과 역할을 입력)</span></span>
<span id="cb5-5">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_messages(</span>
<span id="cb5-6">    [</span>
<span id="cb5-7">        (</span>
<span id="cb5-8">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>,</span>
<span id="cb5-9">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant. "</span></span>
<span id="cb5-10">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Make sure to use the `search_news` tool for searching keyword related news."</span>,</span>
<span id="cb5-11">        ),</span>
<span id="cb5-12">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"placeholder"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{chat_history}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb5-13">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"human"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{input}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb5-14">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"placeholder"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{agent_scratchpad}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb5-15">    ]</span>
<span id="cb5-16">)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="agent-생성" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="agent-생성"><span class="header-section-number">2</span> Agent 생성</h2>
<div id="b26ef43d" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> create_tool_calling_agent</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLM 정의</span></span>
<span id="cb6-5">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Agent 생성</span></span>
<span id="cb6-8">agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(llm, tools, prompt)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="agentexecutor" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="agentexecutor"><span class="header-section-number">3</span> AgentExecutor</h2>
<p>AgentExecutor는 도구를 사용하는 에이전트를 실행하는 클래스입니다.</p>
<p><strong>주요 속성</strong> - <code>agent</code>: 실행 루프의 각 단계에서 계획을 생성하고 행동을 결정하는 에이전트 - <code>tools</code>: 에이전트가 사용할 수 있는 유효한 도구 목록 - <code>return_intermediate_steps</code>: 최종 출력과 함께 에이전트의 중간 단계 경로를 반환할지 여부 - <code>max_iterations</code>: 실행 루프를 종료하기 전 최대 단계 수 - <code>max_execution_time</code>: 실행 루프에 소요될 수 있는 최대 시간 - <code>early_stopping_method</code>: 에이전트가 <code>AgentFinish</code>를 반환하지 않을 때 사용할 조기 종료 방법. (“force” or “generate”) - <code>"force"</code> 는 시간 또는 반복 제한에 도달하여 중지되었다는 문자열을 반환합니다. - <code>"generate"</code> 는 에이전트의 LLM 체인을 마지막으로 한 번 호출하여 이전 단계에 따라 최종 답변을 생성합니다. - <code>handle_parsing_errors</code>: 에이전트의 출력 파서에서 발생한 오류 처리 방법. (True, False, 또는 오류 처리 함수) - <code>trim_intermediate_steps</code>: 중간 단계를 트리밍하는 방법. (-1 trim 하지 않음, 또는 트리밍 함수)</p>
<p><strong>주요 메서드</strong> 1. <code>invoke</code>: 에이전트 실행 2. <code>stream</code>: 최종 출력에 도달하는 데 필요한 단계를 스트리밍</p>
<p><strong>주요 기능</strong> 1. <strong>도구 검증</strong>: 에이전트와 호환되는 도구인지 확인 2. <strong>실행 제어</strong>: 최대 반복 횟수 및 실행 시간 제한 설정 가능 3. <strong>오류 처리</strong>: 출력 파싱 오류에 대한 다양한 처리 옵션 제공 4. <strong>중간 단계 관리</strong>: 중간 단계 트리밍 및 반환 옵션 5. <strong>비동기 지원</strong>: 비동기 실행 및 스트리밍 지원</p>
<p><strong>최적화 팁</strong> - <code>max_iterations</code>와 <code>max_execution_time</code>을 적절히 설정하여 실행 시간 관리 - <code>trim_intermediate_steps</code>를 활용하여 메모리 사용량 최적화 - 복잡한 작업의 경우 <code>stream</code> 메서드를 사용하여 단계별 결과 모니터링</p>
<div id="c14d2a84" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AgentExecutor</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AgentExecutor 생성</span></span>
<span id="cb7-4">agent_executor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AgentExecutor(</span>
<span id="cb7-5">    agent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>agent,</span>
<span id="cb7-6">    tools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tools,</span>
<span id="cb7-7">    verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb7-8">    max_iterations<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb7-9">    max_execution_time<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb7-10">    handle_parsing_errors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb7-11">)</span>
<span id="cb7-12"></span>
<span id="cb7-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AgentExecutor 실행</span></span>
<span id="cb7-14">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_executor.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI 투자와 관련된 뉴스를 검색해 주세요."</span>})</span>
<span id="cb7-15"></span>
<span id="cb7-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Agent 실행 결과:"</span>)</span>
<span id="cb7-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>])</span></code></pre></div></div>
</details>
</div>
</section>
<section id="stream-출력으로-단계별-결과-확인" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="stream-출력으로-단계별-결과-확인"><span class="header-section-number">4</span> Stream 출력으로 단계별 결과 확인</h2>
<p>AgentExecutor의 <code>stream()</code> 메소드를 사용하여 에이전트의 중간 단계를 스트리밍할 것입니다.</p>
<p><code>stream()</code>의 출력은 (Action, Observation) 쌍 사이에서 번갈아 나타나며, 최종적으로 에이전트가 목표를 달성했다면 답변으로 마무리됩니다.</p>
<p>다음과 같은 형태로 보일 것입니다.</p>
<ol type="1">
<li>Action 출력</li>
<li>Observation 출력</li>
<li>Action 출력</li>
<li>Observation 출력</li>
</ol>
<p>… (목표 달성까지 계속) …</p>
<p>그 다음, 최종 목표가 달성되면 에이전트는 최종 답변을 출력할 것입니다.</p>
<p>이러한 출력의 내용은 다음과 같이 요약됩니다.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 44%">
<col style="width: 55%">
</colgroup>
<thead>
<tr class="header">
<th>출력</th>
<th>내용</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Action</td>
<td><code>actions</code>: AgentAction 또는 그 하위 클래스<br><code>messages</code>: 액션 호출에 해당하는 채팅 메시지</td>
</tr>
<tr class="even">
<td>Observation</td>
<td><code>steps</code>: 현재 액션과 그 관찰을 포함한 에이전트가 지금까지 수행한 작업의 기록<br><code>messages</code>: 함수 호출 결과(즉, 관찰)를 포함한 채팅 메시지</td>
</tr>
<tr class="odd">
<td>Final Answer</td>
<td><code>output</code>: AgentFinish<br><code>messages</code>: 최종 출력을 포함한 채팅 메시지</td>
</tr>
</tbody>
</table>
<pre><code>
::: {#bf7b4031 .cell execution_count=8}
``` {.python .cell-code}
from langchain.agents import AgentExecutor

# AgentExecutor 생성
agent_executor = AgentExecutor(
    agent=agent,
    tools=tools,
    verbose=False,
    handle_parsing_errors=True,
)</code></pre>
<p>:::</p>
<div id="642b7a0f" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 스트리밍 모드로 실행합니다</span></span>
<span id="cb9-2">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_executor.stream({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI 투자와 관련된 뉴스를 검색해 주세요."</span>})</span>
<span id="cb9-3"></span>
<span id="cb9-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> step <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> result:</span>
<span id="cb9-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 중간 단계 출력</span></span>
<span id="cb9-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(step)</span>
<span id="cb9-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"==="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div></div>
</details>
</div>
<section id="중간-단계-출력을-사용자-정의-함수로-출력" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="중간-단계-출력을-사용자-정의-함수로-출력"><span class="header-section-number">4.1</span> 중간 단계 출력을 사용자 정의 함수로 출력</h3>
<p>다음의 3개 함수를 정의하고 이를 통해 중간 단계 출력을 사용자 정의합니다.</p>
<ul>
<li><code>tool_callback</code>: 도구 호출 출력을 처리하는 함수</li>
<li><code>observation_callback</code>: 관찰(Observation) 출력을 처리하는 함수</li>
<li><code>result_callback</code>: 최종 답변 출력을 처리하는 함수</li>
</ul>
<div id="90683519" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 업데이트</span></span>
<span id="cb10-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install -U langchain-teddynote</span></span></code></pre></div></div>
</details>
</div>
<p>아래는 Agent 의 중간 단계 과정을 깔끔하게 출력하기 위하여 사용되는 콜백 함수입니다.</p>
<p>이 콜백 함수는 Streamlit 에서 중간 단계를 출력하여 사용자에게 제공할 때 유용할 수 있습니다.</p>
<div id="16505aa1" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.messages <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AgentStreamParser</span>
<span id="cb11-2"></span>
<span id="cb11-3">agent_stream_parser <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AgentStreamParser()</span></code></pre></div></div>
</details>
</div>
<p>스트리밍 방식으로 Agent 의 응답 과정을 확인합니다.</p>
<div id="a23a18cc" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질의에 대한 답변을 스트리밍으로 출력 요청</span></span>
<span id="cb12-2">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_executor.stream(</span>
<span id="cb12-3">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"matplotlib 을 사용하여 pie 차트를 그리는 코드를 작성하고 실행하세요."</span>}</span>
<span id="cb12-4">)</span>
<span id="cb12-5"></span>
<span id="cb12-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> step <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> result:</span>
<span id="cb12-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 중간 단계를 parser 를 사용하여 단계별로 출력</span></span>
<span id="cb12-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print(step)</span></span>
<span id="cb12-9">    agent_stream_parser.process_agent_steps(step)</span></code></pre></div></div>
</details>
</div>
<p>다음은 callback 을 수정하여 사용하는 방법입니다.</p>
<div id="d52ccb95" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AgentCallbacks와 AgentStreamParser를 langchain_teddynote.messages에서 가져옵니다.</span></span>
<span id="cb13-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.messages <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AgentCallbacks, AgentStreamParser</span>
<span id="cb13-3"></span>
<span id="cb13-4"></span>
<span id="cb13-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 호출 시 실행되는 콜백 함수입니다.</span></span>
<span id="cb13-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> tool_callback(tool) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb13-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;&lt;&lt;&lt;&lt;&lt;&lt; 도구 호출 &gt;&gt;&gt;&gt;&gt;&gt;"</span>)</span>
<span id="cb13-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Tool: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tool<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tool'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 사용된 도구의 이름을 출력합니다.</span></span>
<span id="cb13-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;&lt;&lt;&lt;&lt;&lt;&lt; 도구 호출 &gt;&gt;&gt;&gt;&gt;&gt;"</span>)</span>
<span id="cb13-10"></span>
<span id="cb13-11"></span>
<span id="cb13-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관찰 결과를 출력하는 콜백 함수입니다.</span></span>
<span id="cb13-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> observation_callback(observation) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb13-14">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;&lt;&lt;&lt;&lt;&lt;&lt; 관찰 내용 &gt;&gt;&gt;&gt;&gt;&gt;"</span>)</span>
<span id="cb13-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb13-16">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Observation: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>observation<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'observation'</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb13-17">    )  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관찰 내용을 출력합니다.</span></span>
<span id="cb13-18">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;&lt;&lt;&lt;&lt;&lt;&lt; 관찰 내용 &gt;&gt;&gt;&gt;&gt;&gt;"</span>)</span>
<span id="cb13-19"></span>
<span id="cb13-20"></span>
<span id="cb13-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 최종 결과를 출력하는 콜백 함수입니다.</span></span>
<span id="cb13-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> result_callback(result: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb13-23">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;&lt;&lt;&lt;&lt;&lt;&lt; 최종 답변 &gt;&gt;&gt;&gt;&gt;&gt;"</span>)</span>
<span id="cb13-24">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 최종 답변을 출력합니다.</span></span>
<span id="cb13-25">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;&lt;&lt;&lt;&lt;&lt;&lt; 최종 답변 &gt;&gt;&gt;&gt;&gt;&gt;"</span>)</span>
<span id="cb13-26"></span>
<span id="cb13-27"></span>
<span id="cb13-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AgentCallbacks 객체를 생성하여 각 단계별 콜백 함수를 설정합니다.</span></span>
<span id="cb13-29">agent_callbacks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AgentCallbacks(</span>
<span id="cb13-30">    tool_callback<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tool_callback,</span>
<span id="cb13-31">    observation_callback<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>observation_callback,</span>
<span id="cb13-32">    result_callback<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>result_callback,</span>
<span id="cb13-33">)</span>
<span id="cb13-34"></span>
<span id="cb13-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AgentStreamParser 객체를 생성하여 에이전트의 실행 과정을 파싱합니다.</span></span>
<span id="cb13-36">agent_stream_parser <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AgentStreamParser(agent_callbacks)</span></code></pre></div></div>
</details>
</div>
<p>아래의 출력 내용을 확인해 보면 중간 내용의 출력 값이 내가 변경한 콜백 함수의 출력 값으로 변경된 것을 확인할 수 있습니다.</p>
<div id="9bc6f347" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질의에 대한 답변을 스트리밍으로 출력 요청</span></span>
<span id="cb14-2">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_executor.stream({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI 투자관련 뉴스를 검색해 주세요."</span>})</span>
<span id="cb14-3"></span>
<span id="cb14-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> step <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> result:</span>
<span id="cb14-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 중간 단계를 parser 를 사용하여 단계별로 출력</span></span>
<span id="cb14-6">    agent_stream_parser.process_agent_steps(step)</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="이전-대화내용-기억하는-agent" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="이전-대화내용-기억하는-agent"><span class="header-section-number">5</span> 이전 대화내용 기억하는 Agent</h2>
<p>이전의 대화내용을 기억하기 위해서는 <code>RunnableWithMessageHistory</code> 를 사용하여 <code>AgentExecutor</code> 를 감싸줍니다.</p>
<p><code>RunnableWithMessageHistory</code> 에 대한 자세한 내용은 아래 링크를 참고해 주세요.</p>
<p><strong>참고</strong> - <a href="https://wikidocs.net/254682">RunnableWithMessageHistory</a></p>
<div id="b306df6b" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.chat_message_histories <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatMessageHistory</span>
<span id="cb15-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.runnables.history <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RunnableWithMessageHistory</span>
<span id="cb15-3"></span>
<span id="cb15-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># session_id 를 저장할 딕셔너리 생성</span></span>
<span id="cb15-5">store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb15-6"></span>
<span id="cb15-7"></span>
<span id="cb15-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># session_id 를 기반으로 세션 기록을 가져오는 함수</span></span>
<span id="cb15-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_session_history(session_ids):</span>
<span id="cb15-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> session_ids <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> store:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># session_id 가 store에 없는 경우</span></span>
<span id="cb15-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 새로운 ChatMessageHistory 객체를 생성하여 store에 저장</span></span>
<span id="cb15-12">        store[session_ids] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatMessageHistory()</span>
<span id="cb15-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> store[session_ids]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 해당 세션 ID에 대한 세션 기록 반환</span></span>
<span id="cb15-14"></span>
<span id="cb15-15"></span>
<span id="cb15-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 채팅 메시지 기록이 추가된 에이전트를 생성합니다.</span></span>
<span id="cb15-17">agent_with_chat_history <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RunnableWithMessageHistory(</span>
<span id="cb15-18">    agent_executor,</span>
<span id="cb15-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 대화 session_id</span></span>
<span id="cb15-20">    get_session_history,</span>
<span id="cb15-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트의 질문이 입력되는 key: "input"</span></span>
<span id="cb15-22">    input_messages_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>,</span>
<span id="cb15-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트의 메시지가 입력되는 key: "chat_history"</span></span>
<span id="cb15-24">    history_messages_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"chat_history"</span>,</span>
<span id="cb15-25">)</span></code></pre></div></div>
</details>
</div>
<div id="300db801" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질의에 대한 답변을 스트리밍으로 출력 요청</span></span>
<span id="cb16-2">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_with_chat_history.stream(</span>
<span id="cb16-3">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"안녕? 내 이름은 테디야!"</span>},</span>
<span id="cb16-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># session_id 설정</span></span>
<span id="cb16-5">    config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"session_id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"abc123"</span>}},</span>
<span id="cb16-6">)</span>
<span id="cb16-7"></span>
<span id="cb16-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 출력 확인</span></span>
<span id="cb16-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> step <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> response:</span>
<span id="cb16-10">    agent_stream_parser.process_agent_steps(step)</span></code></pre></div></div>
</details>
</div>
<div id="f6f55bd5" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질의에 대한 답변을 스트리밍으로 출력 요청</span></span>
<span id="cb17-2">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_with_chat_history.stream(</span>
<span id="cb17-3">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"내 이름이 뭐라고?"</span>},</span>
<span id="cb17-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># session_id 설정</span></span>
<span id="cb17-5">    config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"session_id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"abc123"</span>}},</span>
<span id="cb17-6">)</span>
<span id="cb17-7"></span>
<span id="cb17-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 출력 확인</span></span>
<span id="cb17-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> step <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> response:</span>
<span id="cb17-10">    agent_stream_parser.process_agent_steps(step)</span></code></pre></div></div>
</details>
</div>
<div id="e73e5e75" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질의에 대한 답변을 스트리밍으로 출력 요청</span></span>
<span id="cb18-2">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_with_chat_history.stream(</span>
<span id="cb18-3">    {</span>
<span id="cb18-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"내 이메일 주소는 teddy@teddynote.com 이야. 회사 이름은 테디노트 주식회사야."</span></span>
<span id="cb18-5">    },</span>
<span id="cb18-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># session_id 설정</span></span>
<span id="cb18-7">    config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"session_id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"abc123"</span>}},</span>
<span id="cb18-8">)</span>
<span id="cb18-9"></span>
<span id="cb18-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 출력 확인</span></span>
<span id="cb18-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> step <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> response:</span>
<span id="cb18-12">    agent_stream_parser.process_agent_steps(step)</span></code></pre></div></div>
</details>
</div>
<div id="cdf4fde2" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질의에 대한 답변을 스트리밍으로 출력 요청</span></span>
<span id="cb19-2">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_with_chat_history.stream(</span>
<span id="cb19-3">    {</span>
<span id="cb19-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"최신 뉴스 5개를 검색해서 이메일의 본문으로 작성해줘. "</span></span>
<span id="cb19-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"수신인에는 `셜리 상무님` 그리고, 발신인에는 내 인적정보를 적어줘."</span></span>
<span id="cb19-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"정중한 어조로 작성하고, 메일의 시작과 끝에는 적절한 인사말과 맺음말을 적어줘."</span></span>
<span id="cb19-7">    },</span>
<span id="cb19-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># session_id 설정</span></span>
<span id="cb19-9">    config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"session_id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"abc123"</span>}},</span>
<span id="cb19-10">)</span>
<span id="cb19-11"></span>
<span id="cb19-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 출력 확인</span></span>
<span id="cb19-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> step <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> response:</span>
<span id="cb19-14">    agent_stream_parser.process_agent_steps(step)</span></code></pre></div></div>
</details>
</div>
<div id="4417861b" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질의에 대한 답변을 스트리밍으로 출력 요청</span></span>
<span id="cb20-2">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_with_chat_history.stream(</span>
<span id="cb20-3">    {</span>
<span id="cb20-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"내 이름이 뭐야?"</span></span>
<span id="cb20-5">    },</span>
<span id="cb20-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># session_id 설정</span></span>
<span id="cb20-7">    config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"session_id"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"def456"</span>}},</span>
<span id="cb20-8">)</span>
<span id="cb20-9"></span>
<span id="cb20-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 출력 확인</span></span>
<span id="cb20-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> step <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> response:</span>
<span id="cb20-12">    agent_stream_parser.process_agent_steps(step)</span></code></pre></div></div>
</details>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/03-Agent.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>문맥 압축 검색기(ContextualCompressionRetriever)</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/02-ContextualCompressionRetriever.html</link>
  <description><![CDATA[ 






<p>검색 시스템에서 직면하는 어려움 중 하나는 데이터를 시스템에 수집할 때 어떤 특정 질의를 처리해야 할지 미리 알 수 없다는 점입니다.</p>
<p>이는 질의와 가장 관련성이 높은 정보가 많은 양의 무관한 텍스트를 포함한 문서에 묻혀 있을 수 있음을 의미합니다.</p>
<p>이러한 전체 문서를 애플리케이션에 전달하면 더 비용이 많이 드는 LLM 호출과 품질이 낮은 응답으로 이어질 수 있습니다.</p>
<p><code>ContextualCompressionRetriever</code> 은 이 문제를 해결하기 위해 고안되었습니다.</p>
<p>아이디어는 간단합니다. 검색된 문서를 그대로 즉시 반환하는 대신, 주어진 질의의 맥락을 사용하여 문서를 압축함으로써 관련 정보만 반환되도록 할 수 있습니다.</p>
<p>여기서 “압축”은 개별 문서의 내용을 압축하는 것과 문서를 전체적으로 필터링하는 것 모두를 의미합니다.</p>
<p><code>ContextualCompressionRetriever</code> 는 질의를 base retriever에 전달하고, 초기 문서를 가져와 Document Compressor를 통과시킵니다.</p>
<p>Document Compressor는 문서 목록을 가져와 문서의 내용을 줄이거나 문서를 완전히 삭제하여 목록을 축소합니다.</p>
<blockquote class="blockquote">
<p>출처: https://drive.google.com/uc?id=1CtNgWODXZudxAWSRiWgSGEoTNrUFT98v</p>
</blockquote>
<p><img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/images/01-Contextual-Compression.jpeg" class="img-fluid"></p>
<div id="a50f6a05" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="e7acc1df" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="3fd1078f" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 패키지 업데이트</span></span>
<span id="cb3-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>qU langchain<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>teddynote</span></code></pre></div></div>
</details>
</div>
<p><code>pretty_print_docs</code> 함수는 문서 리스트를 예쁘게 출력하는 헬퍼 함수입니다.</p>
<div id="826a3625" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 예쁘게 출력하기 위한 도우미 함수</span></span>
<span id="cb4-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> pretty_print_docs(docs):</span>
<span id="cb4-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb4-4">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join(</span>
<span id="cb4-5">            [<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"문서 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> d.page_content <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(docs)]</span>
<span id="cb4-6">        )</span>
<span id="cb4-7">    )</span></code></pre></div></div>
</details>
</div>
<section id="기본-retriever-설정" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="기본-retriever-설정"><span class="header-section-number">1</span> 기본 Retriever 설정</h2>
<p>간단한 벡터 스토어 retriever를 초기화하고 텍스트 문서를 청크 단위로 저장하는 것부터 시작해 보겠습니다.</p>
<p>예시 질문을 던졌을 때, retriever는 관련 있는 문서 1~2개와 관련 없는 문서 몇 개를 반환하는 것을 확인할 수 있습니다.</p>
<div id="066500cd" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TextLoader</span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb5-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb5-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> CharacterTextSplitter</span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TextLoader를 사용하여 "appendix-keywords.txt" 파일에서 문서를 로드합니다.</span></span>
<span id="cb5-7">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TextLoader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./data/appendix-keywords.txt"</span>)</span>
<span id="cb5-8"></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CharacterTextSplitter를 사용하여 문서를 청크 크기 300자와 청크 간 중복 0으로 분할합니다.</span></span>
<span id="cb5-10">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb5-11">texts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loader.load_and_split(text_splitter)</span>
<span id="cb5-12"></span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># OpenAIEmbeddings를 사용하여 FAISS 벡터 저장소를 생성하고 검색기로 변환합니다.</span></span>
<span id="cb5-14">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS.from_documents(texts, OpenAIEmbeddings()).as_retriever()</span>
<span id="cb5-15"></span>
<span id="cb5-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 쿼리에 질문을 정의하고 관련 문서를 검색합니다.</span></span>
<span id="cb5-17">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Semantic Search 에 대해서 알려줘."</span>)</span>
<span id="cb5-18"></span>
<span id="cb5-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서를 예쁘게 출력합니다.</span></span>
<span id="cb5-20">pretty_print_docs(docs)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="맥락적-압축contextualcompression" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="맥락적-압축contextualcompression"><span class="header-section-number">2</span> 맥락적 압축(ContextualCompression)</h2>
<p><code>LLMChainExtractor</code> 를 활용하여 생성한 <code>DocumentCompressor</code> 를 retriever 에 적용한 것이 바로 <code>ContextualCompressionRetriever</code> 입니다.</p>
<div id="b5464a6b" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.document_compressors <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LLMChainExtractor</span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ContextualCompressionRetriever</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># from langchain.retrievers.document_compressors import LLMChainExtractor</span></span>
<span id="cb6-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb6-6"></span>
<span id="cb6-7">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># OpenAI 언어 모델 초기화</span></span>
<span id="cb6-8"></span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLM을 사용하여 문서 압축기 생성</span></span>
<span id="cb6-10">compressor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LLMChainExtractor.from_llm(llm)</span>
<span id="cb6-11">compression_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ContextualCompressionRetriever(</span>
<span id="cb6-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 압축기와 리트리버를 사용하여 컨텍스트 압축 리트리버 생성</span></span>
<span id="cb6-13">    base_compressor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>compressor,</span>
<span id="cb6-14">    base_retriever<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>retriever,</span>
<span id="cb6-15">)</span>
<span id="cb6-16"></span>
<span id="cb6-17">pretty_print_docs(retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Semantic Search 에 대해서 알려줘."</span>))</span>
<span id="cb6-18"></span>
<span id="cb6-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span>
<span id="cb6-20"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"============== LLMChainExtractor 적용 후 =================="</span>)</span>
<span id="cb6-21"></span>
<span id="cb6-22">compressed_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb6-23">    compression_retriever.invoke(  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 컨텍스트 압축 리트리버를 사용하여 관련 문서 검색</span></span>
<span id="cb6-24">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Semantic Search 에 대해서 알려줘."</span></span>
<span id="cb6-25">    )</span>
<span id="cb6-26">)</span>
<span id="cb6-27">pretty_print_docs(compressed_docs)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서를 예쁘게 출력</span></span></code></pre></div></div>
</details>
</div>
</section>
<section id="llm-을-활용한-문서-필터링" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="llm-을-활용한-문서-필터링"><span class="header-section-number">3</span> LLM 을 활용한 문서 필터링</h2>
<p>–&gt; LLM 으로 할까? 임베딩으로 할까?</p>
<section id="llmchainfilter" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="llmchainfilter"><span class="header-section-number">3.1</span> <code>LLMChainFilter</code></h3>
<p><code>LLMChainFilter</code>는 초기에 검색된 문서 중 어떤 문서를 필터링하고 어떤 문서를 반환할지 결정하기 위해 LLM 체인을 사용하는 보다 단순하지만 강력한 압축기입니다.</p>
<p>이 필터는 문서 내용을 변경(압축)하지 않고 문서를 <strong>선택적으로 반환</strong> 합니다.</p>
<div id="59ec2a95" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.document_compressors <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LLMChainFilter</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLM을 사용하여 LLMChainFilter 객체를 생성합니다.</span></span>
<span id="cb7-4">_filter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LLMChainFilter.from_llm(llm)</span>
<span id="cb7-5"></span>
<span id="cb7-6">compression_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ContextualCompressionRetriever(</span>
<span id="cb7-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLMChainFilter와 retriever를 사용하여 ContextualCompressionRetriever 객체를 생성합니다.</span></span>
<span id="cb7-8">    base_compressor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>_filter,</span>
<span id="cb7-9">    base_retriever<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>retriever,</span>
<span id="cb7-10">)</span>
<span id="cb7-11"></span>
<span id="cb7-12">compressed_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> compression_retriever.invoke(</span>
<span id="cb7-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 쿼리</span></span>
<span id="cb7-14">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Semantic Search 에 대해서 알려줘."</span></span>
<span id="cb7-15">)</span>
<span id="cb7-16">pretty_print_docs(compressed_docs)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 압축된 문서를 예쁘게 출력합니다.</span></span></code></pre></div></div>
</details>
</div>
</section>
<section id="embeddingsfilter" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="embeddingsfilter"><span class="header-section-number">3.2</span> <code>EmbeddingsFilter</code></h3>
<p>각각의 검색된 문서에 대해 추가적인 LLM 호출을 수행하는 것은 비용이 많이 들고 속도가 느립니다.</p>
<p><code>EmbeddingsFilter</code>는 문서와 쿼리를 임베딩하고 쿼리와 충분히 유사한 임베딩을 가진 문서만 반환함으로써 더 저렴하고 빠른 옵션을 제공합니다.</p>
<p>이를 통해 검색 결과의 관련성을 유지하면서도 계산 비용과 시간을 절약할 수 있습니다.</p>
<p><code>EmbeddingsFilter</code> 와 <code>ContextualCompressionRetriever</code> 를 사용하여 관련 문서를 압축하고 검색하는 과정입니다.</p>
<ul>
<li><code>EmbeddingsFilter</code> 를 사용하여 지정된 <strong>유사도 임계값(0.86)</strong> 이상인 문서를 필터링 합니다.</li>
</ul>
<div id="f30565ca" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.document_compressors <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> EmbeddingsFilter</span>
<span id="cb8-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb8-3"></span>
<span id="cb8-4">embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings()</span>
<span id="cb8-5"></span>
<span id="cb8-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 유사도 임계값이 0.76인 EmbeddingsFilter 객체를 생성합니다.</span></span>
<span id="cb8-7">embeddings_filter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EmbeddingsFilter(embeddings<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings, similarity_threshold<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.86</span>)</span>
<span id="cb8-8"></span>
<span id="cb8-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 기본 압축기로 embeddings_filter를, 기본 검색기로 retriever를 사용하여 ContextualCompressionRetriever 객체를 생성합니다.</span></span>
<span id="cb8-10">compression_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ContextualCompressionRetriever(</span>
<span id="cb8-11">    base_compressor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings_filter, base_retriever<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>retriever</span>
<span id="cb8-12">)</span>
<span id="cb8-13"></span>
<span id="cb8-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ContextualCompressionRetriever 객체를 사용하여 관련 문서를 검색합니다.</span></span>
<span id="cb8-15">compressed_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> compression_retriever.invoke(</span>
<span id="cb8-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 쿼리</span></span>
<span id="cb8-17">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Semantic Search 에 대해서 알려줘."</span></span>
<span id="cb8-18">)</span>
<span id="cb8-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 압축된 문서를 예쁘게 출력합니다.</span></span>
<span id="cb8-20">pretty_print_docs(compressed_docs)</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="파이프라인-생성압축기문서-변환기" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="파이프라인-생성압축기문서-변환기"><span class="header-section-number">4</span> 파이프라인 생성(압축기+문서 변환기)</h2>
<p><code>DocumentCompressorPipeline</code> 을 사용하면 여러 compressor를 순차적으로 결합할 수 있습니다.</p>
<p>Compressor와 함께 <code>BaseDocumentTransformer</code>를 파이프라인에 추가할 수 있는데, 이는 맥락적 압축을 수행하지 않고 단순히 문서 집합에 대한 변환을 수행합니다.</p>
<p>예를 들어, <code>TextSplitter</code>는 문서를 더 작은 조각으로 분할하기 위해 document transformer로 사용될 수 있으며, <code>EmbeddingsRedundantFilter</code>는 문서 간의 임베딩 유사성(기본값: 0.95 유사도 이상을 중복 문서로 간주) 을 기반으로 중복 문서를 필터링하는 데 사용될 수 있습니다.</p>
<p>아래에서는 먼저 문서를 더 작은 청크로 분할한 다음, 중복 문서를 제거하고, 쿼리와의 관련성을 기준으로 필터링하여 compressor pipeline을 생성합니다.</p>
<div id="a00fde5a" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.document_compressors <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DocumentCompressorPipeline</span>
<span id="cb9-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> EmbeddingsRedundantFilter</span>
<span id="cb9-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> CharacterTextSplitter</span>
<span id="cb9-4"></span>
<span id="cb9-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문자 기반 텍스트 분할기를 생성하고, 청크 크기를 300으로, 청크 간 중복을 0으로 설정합니다.</span></span>
<span id="cb9-6">splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb9-7"></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임베딩을 사용하여 중복 필터를 생성합니다.</span></span>
<span id="cb9-9">redundant_filter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EmbeddingsRedundantFilter(embeddings<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings)</span>
<span id="cb9-10"></span>
<span id="cb9-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임베딩을 사용하여 관련성 필터를 생성하고, 유사도 임계값을 0.86으로 설정합니다.</span></span>
<span id="cb9-12">relevant_filter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EmbeddingsFilter(embeddings<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings, similarity_threshold<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.86</span>)</span>
<span id="cb9-13"></span>
<span id="cb9-14">pipeline_compressor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DocumentCompressorPipeline(</span>
<span id="cb9-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 압축 파이프라인을 생성하고, 분할기, 중복 필터, 관련성 필터, LLMChainExtractor를 변환기로 설정합니다.</span></span>
<span id="cb9-16">    transformers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb9-17">        splitter,</span>
<span id="cb9-18">        redundant_filter,</span>
<span id="cb9-19">        relevant_filter,</span>
<span id="cb9-20">        LLMChainExtractor.from_llm(llm),</span>
<span id="cb9-21">    ]</span>
<span id="cb9-22">)</span></code></pre></div></div>
</details>
</div>
<p><code>ContextualCompressionRetriever</code>를 초기화하며, <code>base_compressor</code>로 <code>pipeline_compressor</code>를, <code>base_retriever</code>로 <code>retriever</code>를 사용합니다.</p>
<div id="022626dd" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1">compression_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ContextualCompressionRetriever(</span>
<span id="cb10-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 기본 압축기로 pipeline_compressor를 사용하고, 기본 검색기로 retriever를 사용하여 ContextualCompressionRetriever를 초기화합니다.</span></span>
<span id="cb10-3">    base_compressor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>pipeline_compressor,</span>
<span id="cb10-4">    base_retriever<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>retriever,</span>
<span id="cb10-5">)</span>
<span id="cb10-6"></span>
<span id="cb10-7">compressed_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> compression_retriever.invoke(</span>
<span id="cb10-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 쿼리</span></span>
<span id="cb10-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Semantic Search 에 대해서 알려줘."</span></span>
<span id="cb10-10">)</span>
<span id="cb10-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 압축된 문서를 예쁘게 출력합니다.</span></span>
<span id="cb10-12">pretty_print_docs(compressed_docs)</span></code></pre></div></div>
</details>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/02-ContextualCompressionRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>앙상블 검색기(Ensemble Retriever)</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/03-EnsembleRetriever.html</link>
  <description><![CDATA[ 






<p><code>EnsembleRetriever</code>는 여러 검색기를 결합하여 더 강력한 검색 결과를 제공하는 LangChain의 기능입니다. 이 검색기는 다양한 검색 알고리즘의 장점을 활용하여 단일 알고리즘보다 더 나은 성능을 달성할 수 있습니다.</p>
<p><strong>주요 특징</strong> 1. 여러 검색기 통합: 다양한 유형의 검색기를 입력으로 받아 결과를 결합합니다. 2. 결과 재순위화: <a href="https://plg.uwaterloo.ca/~gvcormac/cormacksigir09-rrf.pdf">Reciprocal Rank Fusion</a> 알고리즘을 사용하여 결과의 순위를 조정합니다. 3. 하이브리드 검색: 주로 <code>sparse retriever</code>(예: BM25)와 <code>dense retriever</code>(예: 임베딩 유사도)를 결합하여 사용합니다.</p>
<p><strong>장점</strong> - Sparse retriever: 키워드 기반 검색에 효과적 - Dense retriever: 의미적 유사성 기반 검색에 효과적</p>
<p>이러한 상호 보완적인 특성으로 인해 <code>EnsembleRetriever</code>는 다양한 검색 시나리오에서 향상된 성능을 제공할 수 있습니다.</p>
<p>자세한 내용은 <a href="https://python.langchain.com/docs/modules/data_connection/retrievers/ensemble">LangChain 공식 문서</a>를 참조하세요.</p>
<div id="19224b47" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="75d27ac8" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
<ul>
<li><code>EnsembleRetriever</code>를 초기화하여 <code>BM25Retriever</code>와 <code>FAISS</code> 검색기를 결합합니다. 각 검색기의 가중치를 설정됩니다.</li>
</ul>
<div id="3f2b299c" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BM25Retriever, EnsembleRetriever</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 샘플 문서 리스트</span></span>
<span id="cb3-6">doc_list <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb3-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I like apples"</span>,</span>
<span id="cb3-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I like apple company"</span>,</span>
<span id="cb3-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I like apple's iphone"</span>,</span>
<span id="cb3-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Apple is my favorite company"</span>,</span>
<span id="cb3-11">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I like apple's ipad"</span>,</span>
<span id="cb3-12">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I like apple's macbook"</span>,</span>
<span id="cb3-13">]</span>
<span id="cb3-14"></span>
<span id="cb3-15"></span>
<span id="cb3-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bm25 retriever와 faiss retriever를 초기화합니다.</span></span>
<span id="cb3-17">bm25_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BM25Retriever.from_texts(</span>
<span id="cb3-18">    doc_list,</span>
<span id="cb3-19">)</span>
<span id="cb3-20">bm25_retriever.k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BM25Retriever의 검색 결과 개수를 1로 설정합니다.</span></span>
<span id="cb3-21"></span>
<span id="cb3-22">embedding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># OpenAI 임베딩을 사용합니다.</span></span>
<span id="cb3-23">faiss_vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS.from_texts(</span>
<span id="cb3-24">    doc_list,</span>
<span id="cb3-25">    embedding,</span>
<span id="cb3-26">)</span>
<span id="cb3-27">faiss_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> faiss_vectorstore.as_retriever(search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>})</span>
<span id="cb3-28"></span>
<span id="cb3-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 앙상블 retriever를 초기화합니다.</span></span>
<span id="cb3-30">ensemble_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EnsembleRetriever(</span>
<span id="cb3-31">    retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[bm25_retriever, faiss_retriever],</span>
<span id="cb3-32">    weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>],</span>
<span id="cb3-33">)</span></code></pre></div></div>
</details>
</div>
<p><code>ensemble_retriever</code> 객체의 <code>get_relevant_documents()</code> 메서드를 호출하여 관련성 높은 문서를 검색합니다.</p>
<div id="cfacdd8d" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과 문서를 가져옵니다.</span></span>
<span id="cb4-2">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my favorite fruit is apple"</span></span>
<span id="cb4-3">ensemble_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ensemble_retriever.invoke(query)</span>
<span id="cb4-4">bm25_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bm25_retriever.invoke(query)</span>
<span id="cb4-5">faiss_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> faiss_retriever.invoke(query)</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 가져온 문서를 출력합니다.</span></span>
<span id="cb4-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[Ensemble Retriever]"</span>)</span>
<span id="cb4-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ensemble_result:</span>
<span id="cb4-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Content: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb4-12"></span>
<span id="cb4-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[BM25 Retriever]"</span>)</span>
<span id="cb4-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> bm25_result:</span>
<span id="cb4-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Content: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb4-17"></span>
<span id="cb4-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[FAISS Retriever]"</span>)</span>
<span id="cb4-19"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> faiss_result:</span>
<span id="cb4-20">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Content: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span></code></pre></div></div>
</details>
</div>
<div id="dac4523b" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과 문서를 가져옵니다.</span></span>
<span id="cb5-2">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Apple company makes my favorite iphone"</span></span>
<span id="cb5-3">ensemble_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ensemble_retriever.invoke(query)</span>
<span id="cb5-4">bm25_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bm25_retriever.invoke(query)</span>
<span id="cb5-5">faiss_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> faiss_retriever.invoke(query)</span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 가져온 문서를 출력합니다.</span></span>
<span id="cb5-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[Ensemble Retriever]"</span>)</span>
<span id="cb5-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ensemble_result:</span>
<span id="cb5-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Content: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb5-12"></span>
<span id="cb5-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[BM25 Retriever]"</span>)</span>
<span id="cb5-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> bm25_result:</span>
<span id="cb5-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Content: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb5-17"></span>
<span id="cb5-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[FAISS Retriever]"</span>)</span>
<span id="cb5-19"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> faiss_result:</span>
<span id="cb5-20">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Content: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span></code></pre></div></div>
</details>
</div>
<section id="런타임-config-변경" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="런타임-config-변경"><span class="header-section-number">1</span> 런타임 Config 변경</h2>
<p>런타임에서도 retriever 의 속성을 변경할 수 있습니다. 이는 <code>ConfigurableField</code> 클래스를 사용하여 가능합니다.</p>
<ul>
<li><code>weights</code> 매개변수를 <code>ConfigurableField</code> 객체로 정의합니다.
<ul>
<li>필드의 ID는 “ensemble_weights”로 설정합니다.</li>
</ul></li>
</ul>
<div id="84a34e4b" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.runnables <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ConfigurableField</span>
<span id="cb6-2"></span>
<span id="cb6-3"></span>
<span id="cb6-4">ensemble_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EnsembleRetriever(</span>
<span id="cb6-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 리트리버 목록을 설정합니다. 여기서는 bm25_retriever와 faiss_retriever를 사용합니다.</span></span>
<span id="cb6-6">    retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[bm25_retriever, faiss_retriever],</span>
<span id="cb6-7">).configurable_fields(</span>
<span id="cb6-8">    weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ConfigurableField(</span>
<span id="cb6-9">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 매개변수의 고유 식별자를 설정합니다.</span></span>
<span id="cb6-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ensemble_weights"</span>,</span>
<span id="cb6-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 매개변수의 이름을 설정합니다.</span></span>
<span id="cb6-12">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ensemble Weights"</span>,</span>
<span id="cb6-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 매개변수에 대한 설명을 작성합니다.</span></span>
<span id="cb6-14">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ensemble Weights"</span>,</span>
<span id="cb6-15">    )</span>
<span id="cb6-16">)</span></code></pre></div></div>
</details>
</div>
<ul>
<li>검색 시 <code>config</code> 매개변수를 통해 검색 설정을 지정합니다.
<ul>
<li><code>ensemble_weights</code> 옵션의 가중치를 [1, 0]으로 설정하여 <strong>모든 검색 결과의 가중치가 BM25 retriever 에 더 많이 부여</strong> 되도록 합니다.</li>
</ul></li>
</ul>
<div id="1bee1000" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ensemble_weights"</span>: [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]}}</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># config 매개변수를 사용하여 검색 설정을 지정합니다.</span></span>
<span id="cb7-4">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ensemble_retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my favorite fruit is apple"</span>, config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config)</span>
<span id="cb7-5">docs  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과인 docs를 출력합니다.</span></span></code></pre></div></div>
</details>
</div>
<p>이번에는 검색시 모든 검색 결과의 가중치가 <strong>FAISS retriever 에 더 많이 부여</strong> 되도록 합니다.</p>
<div id="5d95922b" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ensemble_weights"</span>: [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]}}</span>
<span id="cb8-2"></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># config 매개변수를 사용하여 검색 설정을 지정합니다.</span></span>
<span id="cb8-4">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ensemble_retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my favorite fruit is apple"</span>, config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config)</span>
<span id="cb8-5">docs  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과인 docs를 출력합니다.</span></span></code></pre></div></div>
</details>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/03-EnsembleRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>Parent Document Retriever</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/05-ParentDocumentRetriever.html</link>
  <description><![CDATA[ 






<p><strong>문서 검색과 문서 분할의 균형 잡기</strong></p>
<p>문서 검색 과정에서 문서를 적절한 크기의 조각(청크)으로 나누는 것은 다음의 <strong>상충되는 두 가지 중요한 요소를 고려</strong>해야 합니다.</p>
<ol type="1">
<li>작은 문서를 원하는 경우: 이렇게 하면 문서의 임베딩이 그 의미를 가장 정확하게 반영할 수 있습니다. 문서가 너무 길면 임베딩이 의미를 잃어버릴 수 있습니다.</li>
<li>각 청크의 맥락이 유지되도록 충분히 긴 문서를 원하는 경우입니다.</li>
</ol>
<p><strong><code>ParentDocumentRetriever</code>의 역할</strong></p>
<p>이 두 요구 사항 사이의 균형을 맞추기 위해 <code>ParentDocumentRetriever</code>라는 도구가 사용됩니다. 이 도구는 문서를 작은 조각으로 나누고, 이 조각들을 관리합니다. 검색을 진행할 때는, 먼저 이 작은 조각들을 찾아낸 다음, 이 조각들이 속한 원본 문서(또는 더 큰 조각)의 식별자(ID)를 통해 전체적인 맥락을 파악할 수 있습니다.</p>
<p>여기서 ’부모 문서’란, 작은 조각이 나누어진 원본 문서를 말합니다. 이는 전체 문서일 수도 있고, 비교적 큰 다른 조각일 수도 있습니다. 이 방식을 통해 문서의 의미를 정확하게 파악하면서도, 전체적인 맥락을 유지할 수 있게 됩니다.</p>
<p><strong>정리</strong></p>
<ul>
<li><strong>문서 간의 계층 구조 활용</strong>: <code>ParentDocumentRetriever</code>는 문서 검색의 효율성을 높이기 위해 문서 간의 계층 구조를 활용합니다.</li>
<li><strong>검색 성능 향상</strong>: 관련성 높은 문서를 빠르게 찾아내며, 주어진 질문에 대한 가장 적합한 답변을 제공하는 문서를 효과적으로 찾아낼 수 있습니다. 문서를 검색할 때 자주 발생하는 두 가지 상충되는 요구 사항이 있습니다:</li>
</ul>
<p>여러 개의 텍스트 파일을 로드하기 위해 <code>TextLoader</code> 객체를 생성하고 데이터를 로드합니다.</p>
<div id="d14d13cd" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="514e4b90" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="9c12ba1e" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.storage <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> InMemoryStore</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TextLoader</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_chroma <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chroma</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb3-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb3-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ParentDocumentRetriever</span></code></pre></div></div>
</details>
</div>
<div id="68f6a054" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">loaders <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb4-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 파일을 로드합니다.</span></span>
<span id="cb4-3">    TextLoader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./data/appendix-keywords.txt"</span>),</span>
<span id="cb4-4">]</span>
<span id="cb4-5"></span>
<span id="cb4-6">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb4-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> loader <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> loaders:</span>
<span id="cb4-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 로더를 사용하여 문서를 로드하고 docs 리스트에 추가합니다.</span></span>
<span id="cb4-9">    docs.extend(loader.load())</span></code></pre></div></div>
</details>
</div>
<section id="전체-문서-검색" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="전체-문서-검색"><span class="header-section-number">1</span> 전체 문서 검색</h2>
<p>이 모드에서는 전체 문서를 검색하고자 합니다. 따라서 <code>child_splitter</code> 만 지정하도록 하겠습니다.</p>
<ul>
<li>나중에는 <code>parent_splitter</code> 도 지정하여 결과를 비교해 보겠습니다.</li>
</ul>
<div id="812dfdfe" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 자식 분할기를 생성합니다.</span></span>
<span id="cb5-2">child_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DB를 생성합니다.</span></span>
<span id="cb5-5">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma(</span>
<span id="cb5-6">    collection_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"full_documents"</span>, embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>OpenAIEmbeddings()</span>
<span id="cb5-7">)</span>
<span id="cb5-8"></span>
<span id="cb5-9">store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> InMemoryStore()</span>
<span id="cb5-10"></span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Retriever 를 생성합니다.</span></span>
<span id="cb5-12">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ParentDocumentRetriever(</span>
<span id="cb5-13">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,</span>
<span id="cb5-14">    docstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>store,</span>
<span id="cb5-15">    child_splitter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>child_splitter,</span>
<span id="cb5-16">)</span></code></pre></div></div>
</details>
</div>
<p><code>retriever.add_documents(docs, ids=None)</code> 함수로 문서목록을 추가합니다.</p>
<ul>
<li><code>ids</code> 가 <code>None</code> 이면 자동으로 생성됩니다.</li>
<li><code>add_to_docstore=False</code> 로 설정시 document 를 중복으로 추가하지 않습니다. 단, 중복을 체크하기 위한 <code>ids</code> 값이 필수 값으로 요구됩니다.</li>
</ul>
<div id="c737c91d" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 검색기에 추가합니다. docs는 문서 목록이고, ids는 문서의 고유 식별자 목록입니다.</span></span>
<span id="cb6-2">retriever.add_documents(docs, ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, add_to_docstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
</details>
</div>
<p>이 코드는 두 개의 키를 반환해야 합니다. 그 이유는 우리가 두 개의 문서를 추가했기 때문입니다.</p>
<ul>
<li><code>store</code> 객체의 <code>yield_keys()</code> 메서드를 호출하여 반환된 키(key) 값들을 리스트로 변환합니다.</li>
</ul>
<div id="6875b63a" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 저장소의 모든 키를 리스트로 반환합니다.</span></span>
<span id="cb7-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(store.yield_keys())</span></code></pre></div></div>
</details>
</div>
<p>이제 벡터 스토어 검색 기능을 호출해 보겠습니다.</p>
<p>우리가 작은 청크(chunk)들을 저장하고 있기 때문에, 검색 결과로 작은 청크들이 반환되는 것을 확인할 수 있을 것입니다.</p>
<p><code>vectorstore</code> 객체의 <code>similarity_search</code> 메서드를 사용하여 유사도 검색을 수행합니다.</p>
<div id="d6ed9a29" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 유사도 검색을 수행합니다.</span></span>
<span id="cb8-2">sub_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vectorstore.similarity_search(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Word2Vec"</span>)</span></code></pre></div></div>
</details>
</div>
<p><code>sub_docs[0].page_content</code>를 출력합니다.</p>
<div id="4db52fa3" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sub_docs 리스트의 첫 번째 요소의 page_content 속성을 출력합니다.</span></span>
<span id="cb9-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(sub_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>
<p>이제 전체 retriever에서 검색해 보겠습니다. 이 과정에서는 작은 청크(chunk)들이 위치한 <strong>문서를 반환</strong> 하기 때문에 상대적으로 큰 문서들이 반환될 것입니다.</p>
<p><code>retriever</code> 객체의 <code>invoke()</code> 메서드를 사용하여 쿼리와 관련된 문서를 검색합니다.</p>
<div id="bd845482" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 검색하여 가져옵니다.</span></span>
<span id="cb10-2">retrieved_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Word2Vec"</span>)</span></code></pre></div></div>
</details>
</div>
<p>검색된 문서(<code>retrieved_docs[0]</code>)의 일부 내용을 출력합니다.</p>
<div id="531585d6" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서의 문서의 페이지 내용의 길이를 출력합니다.</span></span>
<span id="cb11-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb11-3">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"문서의 길이: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(retrieved_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb11-4">    end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">=====================</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb11-5">)</span>
<span id="cb11-6"></span>
<span id="cb11-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서의 일부를 출력합니다.</span></span>
<span id="cb11-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(retrieved_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2500</span>])</span></code></pre></div></div>
</details>
</div>
</section>
<section id="더-큰-chunk-의-크기를-조절" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="더-큰-chunk-의-크기를-조절"><span class="header-section-number">2</span> 더 큰 Chunk 의 크기를 조절</h2>
<p>이전의 결과처럼 <strong>전체 문서가 너무 커서 있는 그대로 검색하기에는 부적합</strong> 할 수 있습니다.</p>
<p>이런 경우, 실제로 우리가 하고 싶은 것은 먼저 원시 문서를 더 큰 청크로 분할한 다음, 더 작은 청크로 분할하는 것입니다.</p>
<p>그런 다음 작은 청크들을 인덱싱하지만, 검색 시에는 더 큰 청크를 검색합니다 (그러나 여전히 전체 문서는 아닙니다).</p>
<ul>
<li><code>RecursiveCharacterTextSplitter</code>를 사용하여 부모 문서와 자식 문서를 생성합니다.
<ul>
<li>부모 문서는 <code>chunk_size</code>가 1000으로 설정되어 있습니다.</li>
<li>자식 문서는 <code>chunk_size</code>가 200으로 설정되어 있으며, 부모 문서보다 작은 크기로 생성됩니다.</li>
</ul></li>
</ul>
<div id="29662c13" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 부모 문서를 생성하는 데 사용되는 텍스트 분할기입니다.</span></span>
<span id="cb12-2">parent_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span>
<span id="cb12-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 자식 문서를 생성하는 데 사용되는 텍스트 분할기입니다.</span></span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 부모보다 작은 문서를 생성해야 합니다.</span></span>
<span id="cb12-5">child_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb12-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 자식 청크를 인덱싱하는 데 사용할 벡터 저장소입니다.</span></span>
<span id="cb12-7">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma(</span>
<span id="cb12-8">    collection_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"split_parents"</span>, embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>OpenAIEmbeddings()</span>
<span id="cb12-9">)</span>
<span id="cb12-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 부모 문서의 저장 계층입니다.</span></span>
<span id="cb12-11">store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> InMemoryStore()</span></code></pre></div></div>
</details>
</div>
<p><code>ParentDocumentRetriever</code>를 초기화하는 코드입니다.</p>
<ul>
<li><code>vectorstore</code> 매개변수는 문서 벡터를 저장하는 벡터 저장소를 지정합니다.</li>
<li><code>docstore</code> 매개변수는 문서 데이터를 저장하는 문서 저장소를 지정합니다.</li>
<li><code>child_splitter</code> 매개변수는 하위 문서를 분할하는 데 사용되는 문서 분할기를 지정합니다.</li>
<li><code>parent_splitter</code> 매개변수는 상위 문서를 분할하는 데 사용되는 문서 분할기를 지정합니다.</li>
</ul>
<p><code>ParentDocumentRetriever</code>는 계층적 문서 구조를 처리하며, 상위 문서와 하위 문서를 별도로 분할하고 저장합니다. 이를 통해 검색 시 상위 문서와 하위 문서를 효과적으로 활용할 수 있습니다.</p>
<div id="c3cacb06" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ParentDocumentRetriever(</span>
<span id="cb13-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소를 지정합니다.</span></span>
<span id="cb13-3">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,</span>
<span id="cb13-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 저장소를 지정합니다.</span></span>
<span id="cb13-5">    docstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>store,</span>
<span id="cb13-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 하위 문서 분할기를 지정합니다.</span></span>
<span id="cb13-7">    child_splitter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>child_splitter,</span>
<span id="cb13-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 상위 문서 분할기를 지정합니다.</span></span>
<span id="cb13-9">    parent_splitter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>parent_splitter,</span>
<span id="cb13-10">)</span></code></pre></div></div>
</details>
</div>
<p><code>retriever</code> 객체에 <code>docs</code>를 추가합니다. <code>retriever</code>가 검색할 수 있는 문서 집합에 새로운 문서들을 추가하는 역할을 합니다.</p>
<div id="6f95883b" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1">retriever.add_documents(docs)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 retriever에 추가합니다.</span></span></code></pre></div></div>
</details>
</div>
<p>이제 문서의 수가 훨씬 더 많아진 것을 볼 수 있습니다. 이는 더 큰 청크(chunk)들입니다.</p>
<div id="7d0989cc" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 저장소에서 키를 생성하고 리스트로 변환한 후 길이를 반환합니다.</span></span>
<span id="cb15-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(store.yield_keys()))</span></code></pre></div></div>
</details>
</div>
<p>기본 벡터 저장소가 여전히 작은 청크를 검색하는지 확인해 보겠습니다.</p>
<p><code>vectorstore</code> 객체의 <code>similarity_search</code> 메서드를 사용하여 유사도 검색을 수행합니다.</p>
<div id="ec52ff30" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 유사도 검색을 수행합니다.</span></span>
<span id="cb16-2">sub_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vectorstore.similarity_search(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Word2Vec"</span>)</span>
<span id="cb16-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sub_docs 리스트의 첫 번째 요소의 page_content 속성을 출력합니다.</span></span>
<span id="cb16-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(sub_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>
<p>이번에는 <code>retriever</code> 객체의 <code>invoke()</code> 메서드를 사용하여 문서를 검색합니다.</p>
<div id="9944a690" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 검색하여 가져옵니다.</span></span>
<span id="cb17-2">retrieved_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Word2Vec"</span>)</span>
<span id="cb17-3"></span>
<span id="cb17-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서의 첫 번째 문서의 페이지 내용의 길이를 반환합니다.</span></span>
<span id="cb17-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(retrieved_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/05-ParentDocumentRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>MultiQueryRetriever</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/06-MultiQueryRetriever.html</link>
  <description><![CDATA[ 






<p>거리 기반 벡터 데이터베이스 검색은 고차원 공간에서의 쿼리 임베딩(표현)과 ’거리’를 기준으로 유사한 임베딩을 가진 문서를 찾는 방식입니다. 하지만 쿼리의 <strong>세부적인 차이나 임베딩이 데이터의 의미를 제대로 포착하지 못할 경우, 검색 결과가 달라질 수</strong> 있습니다. 또한, 이를 수동으로 조정하는 프롬프트 엔지니어링이나 튜닝 작업은 번거로울 수 있습니다.</p>
<p>이런 문제를 해결하기 위해, <code>MultiQueryRetriever</code> 는 주어진 사용자 입력 쿼리에 대해 다양한 관점에서 여러 쿼리를 자동으로 생성하는 LLM(Language Learning Model)을 활용해 프롬프트 튜닝 과정을 자동화합니다.</p>
<p>이 방식은 각각의 쿼리에 대해 관련 문서 집합을 검색하고, 모든 쿼리를 아우르는 고유한 문서들의 합집합을 추출해, 잠재적으로 관련된 더 큰 문서 집합을 얻을 수 있게 해줍니다.</p>
<p>여러 관점에서 동일한 질문을 생성함으로써, <code>MultiQueryRetriever</code> 는 거리 기반 검색의 제한을 일정 부분 극복하고, 더욱 풍부한 검색 결과를 제공할 수 있습니다.</p>
<div id="8ee62e07" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="ce16f0bd" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="dae75cb3" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 샘플 벡터DB 구축</span></span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> WebBaseLoader</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb3-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 블로그 포스트 로드</span></span>
<span id="cb3-8">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> WebBaseLoader(</span>
<span id="cb3-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://teddylee777.github.io/openai/openai-assistant-tutorial/"</span>, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span></span>
<span id="cb3-10">)</span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 분할</span></span>
<span id="cb3-13">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-14">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loader.load_and_split(text_splitter)</span>
<span id="cb3-15"></span>
<span id="cb3-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임베딩 정의</span></span>
<span id="cb3-17">openai_embedding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings()</span>
<span id="cb3-18"></span>
<span id="cb3-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터DB 생성</span></span>
<span id="cb3-20">db <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS.from_documents(docs, openai_embedding)</span>
<span id="cb3-21"></span>
<span id="cb3-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># retriever 생성</span></span>
<span id="cb3-23">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.as_retriever()</span>
<span id="cb3-24"></span>
<span id="cb3-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 검색</span></span>
<span id="cb3-26">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OpenAI Assistant API의 Functions 사용법에 대해 알려주세요."</span></span>
<span id="cb3-27">relevant_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(query)</span>
<span id="cb3-28"></span>
<span id="cb3-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서의 개수 출력</span></span>
<span id="cb3-30"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(relevant_docs)</span></code></pre></div></div>
</details>
</div>
<p>검색된 결과 중 1개 문서의 내용을 출력합니다.</p>
<div id="d8ea9548" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1번 문서를 출력합니다.</span></span>
<span id="cb4-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(relevant_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].page_content)</span></code></pre></div></div>
</details>
</div>
<section id="사용방법" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="사용방법"><span class="header-section-number">1</span> 사용방법</h2>
<p><code>MultiQueryRetriever</code> 에 사용할 LLM을 지정하고 질의 생성에 사용하면, retriever가 나머지 작업을 처리합니다.</p>
<div id="1637815b" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.multi_query <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> MultiQueryRetriever</span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb5-3"></span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ChatOpenAI 언어 모델을 초기화합니다. temperature는 0으로 설정합니다.</span></span>
<span id="cb5-6">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>)</span>
<span id="cb5-7"></span>
<span id="cb5-8">multiquery_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MultiQueryRetriever.from_llm(  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MultiQueryRetriever를 언어 모델을 사용하여 초기화합니다.</span></span>
<span id="cb5-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 데이터베이스의 retriever와 언어 모델을 전달합니다.</span></span>
<span id="cb5-10">    retriever<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>db.as_retriever(),</span>
<span id="cb5-11">    llm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm,</span>
<span id="cb5-12">)</span></code></pre></div></div>
</details>
</div>
<p>아래는 다중 쿼리를 생성하는 중간 과정을 디버깅하기 위하여 실행하는 코드입니다.</p>
<p>먼저 <code>"langchain.retrievers.multi_query"</code> 로거를 가져옵니다.</p>
<p>이는 <code>logging.getLogger()</code> 함수를 사용하여 수행됩니다. 그 다음, 이 로거의 로그 레벨을 <code>INFO</code>로 설정하여, <code>INFO</code> 레벨 이상의 로그 메시지만 출력되도록 할 수 있습니다.</p>
<div id="901d1749" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 쿼리에 대한 로깅 설정</span></span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb6-3"></span>
<span id="cb6-4">logging.basicConfig()</span>
<span id="cb6-5">logging.getLogger(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"langchain.retrievers.multi_query"</span>).setLevel(logging.INFO)</span></code></pre></div></div>
</details>
</div>
<p>이 코드는 <code>retriever_from_llm</code> 객체의 <code>invoke</code> 메서드를 사용하여 주어진 <code>question</code>과 관련된 문서를 검색합니다.</p>
<p>검색된 문서들은 <code>unique_docs</code>라는 변수에 저장되며, 이 변수의 길이를 확인함으로써 검색된 관련 문서의 총 개수를 알 수 있습니다. 이 과정을 통해 사용자의 질문에 대한 관련 정보를 효과적으로 찾아내고 그 양을 파악할 수 있습니다.</p>
<div id="e2e305f8" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질문을 정의합니다.</span></span>
<span id="cb7-2">question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OpenAI Assistant API의 Functions 사용법에 대해 알려주세요."</span></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 검색</span></span>
<span id="cb7-4">relevant_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> multiquery_retriever.invoke(question)</span>
<span id="cb7-5"></span>
<span id="cb7-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 고유한 문서의 개수를 반환합니다.</span></span>
<span id="cb7-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb7-8">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"===============</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">검색된 문서 개수: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(relevant_docs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb7-9">    end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">===============</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb7-10">)</span>
<span id="cb7-11"></span>
<span id="cb7-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서의 내용을 출력합니다.</span></span>
<span id="cb7-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(relevant_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="lcel-chain-활용하는-방법" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="lcel-chain-활용하는-방법"><span class="header-section-number">2</span> LCEL Chain 활용하는 방법</h2>
<ul>
<li>사용자 정의 프롬프트 정의하고, 정의한 프롬프트와 함께 Chain 을 생성합니다.</li>
<li>Chain 은 사용자의 질문을 입력 받으면 (아래의 예제에서는) 5개의 질문을 생성한 뒤 <code>"\n"</code> 구분자로 구분하여 생성된 5개 질문을 반환합니다.</li>
</ul>
<div id="0ab98687" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.runnables <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RunnablePassthrough</span>
<span id="cb8-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PromptTemplate</span>
<span id="cb8-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.output_parsers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StrOutputParser</span>
<span id="cb8-4"></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트 템플릿을 정의합니다.(5개의 질문을 생성하도록 프롬프트를 작성하였습니다)</span></span>
<span id="cb8-6">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PromptTemplate.from_template(</span>
<span id="cb8-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""You are an AI language model assistant. </span></span>
<span id="cb8-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Your task is to generate five different versions of the given user question to retrieve relevant documents from a vector database. </span></span>
<span id="cb8-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">By generating multiple perspectives on the user question, your goal is to help the user overcome some of the limitations of the distance-based similarity search. </span></span>
<span id="cb8-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Your response should be a list of values separated by new lines, eg: `foo</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">bar</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">baz</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span></span>
<span id="cb8-11"></span>
<span id="cb8-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#ORIGINAL QUESTION: </span></span>
<span id="cb8-13"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{question}</span></span>
<span id="cb8-14"></span>
<span id="cb8-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#Answer in Korean:</span></span>
<span id="cb8-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb8-17">)</span>
<span id="cb8-18"></span>
<span id="cb8-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 언어 모델 인스턴스를 생성합니다.</span></span>
<span id="cb8-20">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>)</span>
<span id="cb8-21"></span>
<span id="cb8-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLMChain을 생성합니다.</span></span>
<span id="cb8-23">custom_multiquery_chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb8-24">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: RunnablePassthrough()} <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser()</span>
<span id="cb8-25">)</span>
<span id="cb8-26"></span>
<span id="cb8-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질문을 정의합니다.</span></span>
<span id="cb8-28">question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OpenAI Assistant API의 Functions 사용법에 대해 알려주세요."</span></span>
<span id="cb8-29"></span>
<span id="cb8-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 체인을 실행하여 생성된 다중 쿼리를 확인합니다.</span></span>
<span id="cb8-31">multi_queries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> custom_multiquery_chain.invoke(question)</span>
<span id="cb8-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 결과를 확인합니다.(5개 질문 생성)</span></span>
<span id="cb8-33">multi_queries</span></code></pre></div></div>
</details>
</div>
<p>이전에 생성한 Chain을 <code>MultiQueryRetriever</code> 에 전달하여 retrieve 할 수 있습니다.</p>
<div id="5f3cac81" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1">multiquery_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MultiQueryRetriever.from_llm(</span>
<span id="cb9-2">    llm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>custom_multiquery_chain, retriever<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>db.as_retriever()</span>
<span id="cb9-3">)</span></code></pre></div></div>
</details>
</div>
<p><code>MultiQueryRetriever</code>를 사용하여 문서를 검색하고 결과를 확인합니다.</p>
<div id="6eaffe30" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 결과</span></span>
<span id="cb10-2">relevant_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> multiquery_retriever.invoke(question)</span>
<span id="cb10-3"></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 고유한 문서의 개수를 반환합니다.</span></span>
<span id="cb10-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb10-6">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"===============</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">검색된 문서 개수: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(relevant_docs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb10-7">    end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">===============</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb10-8">)</span>
<span id="cb10-9"></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서의 내용을 출력합니다.</span></span>
<span id="cb10-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(relevant_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/06-MultiQueryRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>Ensemble Retriever Convex Combination(CC) 추가</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/11-CC-EnsembleRetriever.html</link>
  <description><![CDATA[ 






<p><a href="https://github.com/teddylee777/langchain-teddynote">written by@teddynote</a></p>
<ul>
<li>참고글: <a href="https://velog.io/@autorag/%EB%9E%AD%EC%B2%B4%EC%9D%B8%EC%9D%98-Ensemble-Retriever-%EC%9D%B4%EA%B2%8C-%EB%8C%80%EC%B2%B4-%EB%AD%90%EC%A7%80">AutoRAG 가 게재한 알고리즘 방식의 차이 설명</a></li>
</ul>
<p>아래의 주석을 풀고 패키지를 업데이트 후 진행합니다.</p>
<div id="cell-3" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 업데이트 후 진행</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install -qU langchain-teddynote</span></span></code></pre></div></div>
</details>
</div>
<div id="cell-4" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb2-2"></span>
<span id="cb2-3">load_dotenv()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>True</code></pre>
</div>
</div>
<section id="실험을-위한-사전-셋업" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="실험을-위한-사전-셋업"><span class="header-section-number">1</span> 실험을 위한 사전 셋업</h2>
<div id="cell-6" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> EnsembleRetriever <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> OriginalEnsembleRetriever</span>
<span id="cb4-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb4-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PDFPlumberLoader</span>
<span id="cb4-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb4-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb4-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.retrievers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> KiwiBM25Retriever</span>
<span id="cb4-7"></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 로드(Load Documents)</span></span>
<span id="cb4-9">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PDFPlumberLoader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/디지털정부혁신 추진계획.pdf"</span>)</span>
<span id="cb4-10"></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 분할(Split Documents): 테스트를 위하여 작은 Chunk Size로 설정</span></span>
<span id="cb4-12">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb4-13">split_documents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loader.load_and_split(text_splitter)</span>
<span id="cb4-14"></span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임베딩(Embedding) 생성</span></span>
<span id="cb4-16">embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-embedding-3-small"</span>)</span>
<span id="cb4-17"></span>
<span id="cb4-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># FaissRetriever 생성</span></span>
<span id="cb4-19">faiss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS.from_documents(</span>
<span id="cb4-20">    documents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>split_documents, embedding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings</span>
<span id="cb4-21">).as_retriever(search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>})</span>
<span id="cb4-22"></span>
<span id="cb4-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># KiwiBM25Retriever 생성(한글 형태소 분석기 + BM25 알고리즘)</span></span>
<span id="cb4-24">bm25 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> KiwiBM25Retriever.from_documents(documents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>split_documents, embedding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings)</span>
<span id="cb4-25">bm25.k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb4-26"></span>
<span id="cb4-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangChain 버전의 EnsembleRetriever</span></span>
<span id="cb4-28">original_ensemble_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OriginalEnsembleRetriever(retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[faiss, bm25])</span></code></pre></div></div>
</details>
</div>
<p>CC 방식과 RRF 방식의 EnsembleRetriever 생성</p>
<div id="cell-8" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.retrievers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> (</span>
<span id="cb5-2">    EnsembleRetriever,</span>
<span id="cb5-3">    EnsembleMethod,</span>
<span id="cb5-4">)</span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># RRF 방식의 EnsembleRetriever (기본값으로 RRF 가 설정되어 있음)</span></span>
<span id="cb5-7">rrf_ensemble_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EnsembleRetriever(</span>
<span id="cb5-8">    retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[faiss, bm25], method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>EnsembleMethod.RRF</span>
<span id="cb5-9">)</span>
<span id="cb5-10"></span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CC 방식의 EnsembleRetriever</span></span>
<span id="cb5-12">cc_ensemble_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EnsembleRetriever(</span>
<span id="cb5-13">    retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[faiss, bm25], method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>EnsembleMethod.CC  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># method 지정: CC</span></span>
<span id="cb5-14">)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="검색-결과-비교" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="검색-결과-비교"><span class="header-section-number">2</span> 검색 결과 비교</h2>
<div id="cell-10" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> pretty_print(query):</span>
<span id="cb6-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, (original_doc, cc_doc, rrf_doc) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(</span>
<span id="cb6-3">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(</span>
<span id="cb6-4">            original_ensemble_retriever.invoke(query),</span>
<span id="cb6-5">            cc_ensemble_retriever.invoke(query),</span>
<span id="cb6-6">            rrf_ensemble_retriever.invoke(query),</span>
<span id="cb6-7">        )</span>
<span id="cb6-8">    ):</span>
<span id="cb6-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"[</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">] [Original] Q: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>query<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(original_doc.page_content)</span>
<span id="cb6-11">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb6-12">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"[</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">] [RRF] Q: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>query<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(rrf_doc.page_content)</span>
<span id="cb6-14">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb6-15">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"[</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">] [CC] Q: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>query<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-16">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(cc_doc.page_content)</span>
<span id="cb6-17">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
</div>
<ul>
<li>검색 결과에 <code>"Original"</code> 과 <code>"RRF"</code> 는 차이가 없어야 합니다. (LangChain 그대로 구현)</li>
<li>검색 결과에 <code>"CC"</code> 는 <code>"RRF"</code> 와 차이가 있을 수 있습니다.</li>
</ul>
<p><code>RRF</code> 와 <code>CC</code> 방식의 검색 결과 비교하여 문서에 적합한 방식을 차용하시길 바랍니다.</p>
<div id="cell-12" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과 비교</span></span>
<span id="cb7-2">pretty_print(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"디지털 트랜스포메이션이란 무엇인가요?"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[0] [Original] Q: 디지털 트랜스포메이션이란 무엇인가요?

참고 1 디지털 정부혁신 추진전략
디지털로 여는 좋은 세상
□ 비전
※ 부제 : 대한민국이 먼저 갑니다.
□ 추진원칙 △ 최종 이용자의 관점에서
△ 공공서비스 수준 향상을 목표로
----------------------------------------------------------------------------------------------------
[0] [RRF] Q: 디지털 트랜스포메이션이란 무엇인가요?

참고 1 디지털 정부혁신 추진전략
디지털로 여는 좋은 세상
□ 비전
※ 부제 : 대한민국이 먼저 갑니다.
□ 추진원칙 △ 최종 이용자의 관점에서
△ 공공서비스 수준 향상을 목표로
----------------------------------------------------------------------------------------------------
[0] [CC] Q: 디지털 트랜스포메이션이란 무엇인가요?

○ (시스템) 디지털 신기술의 적기 도입과 활용 곤란
- 기존 복잡한 용역개발 방식은 혁신주기가 짧은 디지털 전환에 부적합
====================================================================================================

[1] [Original] Q: 디지털 트랜스포메이션이란 무엇인가요?

○ (시스템) 디지털 신기술의 적기 도입과 활용 곤란
- 기존 복잡한 용역개발 방식은 혁신주기가 짧은 디지털 전환에 부적합
----------------------------------------------------------------------------------------------------
[1] [RRF] Q: 디지털 트랜스포메이션이란 무엇인가요?

○ (시스템) 디지털 신기술의 적기 도입과 활용 곤란
- 기존 복잡한 용역개발 방식은 혁신주기가 짧은 디지털 전환에 부적합
----------------------------------------------------------------------------------------------------
[1] [CC] Q: 디지털 트랜스포메이션이란 무엇인가요?

○ (디지털 고지‧수납) 각종 고지서·안내문* 등을 온라인(공공‧민간)
으로 받고, 간편하게 납부할 수 있도록 디지털 고지‧수납 활성화
====================================================================================================

[2] [Original] Q: 디지털 트랜스포메이션이란 무엇인가요?

Ⅰ. 개 요
□ 추진 배경
○ 우리나라는 국가적 초고속 정보통신망 투자와 적극적인 공공정보화
사업 추진에 힘입어 세계 최고수준의 전자정부를 구축‧운영
----------------------------------------------------------------------------------------------------
[2] [RRF] Q: 디지털 트랜스포메이션이란 무엇인가요?

Ⅰ. 개 요
□ 추진 배경
○ 우리나라는 국가적 초고속 정보통신망 투자와 적극적인 공공정보화
사업 추진에 힘입어 세계 최고수준의 전자정부를 구축‧운영
----------------------------------------------------------------------------------------------------
[2] [CC] Q: 디지털 트랜스포메이션이란 무엇인가요?

참고 1 디지털 정부혁신 추진전략
디지털로 여는 좋은 세상
□ 비전
※ 부제 : 대한민국이 먼저 갑니다.
□ 추진원칙 △ 최종 이용자의 관점에서
△ 공공서비스 수준 향상을 목표로
====================================================================================================

[3] [Original] Q: 디지털 트랜스포메이션이란 무엇인가요?

○ (디지털 고지‧수납) 각종 고지서·안내문* 등을 온라인(공공‧민간)
으로 받고, 간편하게 납부할 수 있도록 디지털 고지‧수납 활성화
----------------------------------------------------------------------------------------------------
[3] [RRF] Q: 디지털 트랜스포메이션이란 무엇인가요?

○ (디지털 고지‧수납) 각종 고지서·안내문* 등을 온라인(공공‧민간)
으로 받고, 간편하게 납부할 수 있도록 디지털 고지‧수납 활성화
----------------------------------------------------------------------------------------------------
[3] [CC] Q: 디지털 트랜스포메이션이란 무엇인가요?

○ 오픈소스 중심의 디지털정부 생태계와 공공시장 수요를 바탕으로
첨단 디지털 산업의 혁신 가속화와 글로벌 도약을 위한 전기 마련
====================================================================================================

[4] [Original] Q: 디지털 트랜스포메이션이란 무엇인가요?

보다 안정성‧편의성이 높은 스마트폰 기반 디지털 신분증 도입
* 학생증, 공무원증 등 이용대상과 목적이 명확한 분야부터 안전성 점검 후 단계적 확대
----------------------------------------------------------------------------------------------------
[4] [RRF] Q: 디지털 트랜스포메이션이란 무엇인가요?

보다 안정성‧편의성이 높은 스마트폰 기반 디지털 신분증 도입
* 학생증, 공무원증 등 이용대상과 목적이 명확한 분야부터 안전성 점검 후 단계적 확대
----------------------------------------------------------------------------------------------------
[4] [CC] Q: 디지털 트랜스포메이션이란 무엇인가요?

디지털 정부혁신 추진계획
2019. 10. 29.
관계부처 합동
====================================================================================================

[5] [Original] Q: 디지털 트랜스포메이션이란 무엇인가요?

○ 오픈소스 중심의 디지털정부 생태계와 공공시장 수요를 바탕으로
첨단 디지털 산업의 혁신 가속화와 글로벌 도약을 위한 전기 마련
----------------------------------------------------------------------------------------------------
[5] [RRF] Q: 디지털 트랜스포메이션이란 무엇인가요?

○ 오픈소스 중심의 디지털정부 생태계와 공공시장 수요를 바탕으로
첨단 디지털 산업의 혁신 가속화와 글로벌 도약을 위한 전기 마련
----------------------------------------------------------------------------------------------------
[5] [CC] Q: 디지털 트랜스포메이션이란 무엇인가요?

Ⅰ. 개 요
□ 추진 배경
○ 우리나라는 국가적 초고속 정보통신망 투자와 적극적인 공공정보화
사업 추진에 힘입어 세계 최고수준의 전자정부를 구축‧운영
====================================================================================================

[6] [Original] Q: 디지털 트랜스포메이션이란 무엇인가요?

디지털기기 사용이 어려운 분들이 차별없이 서비스를 받도록 지원하겠습니다.
권익위,
□1 국민의 소리 청취·분석 시스템 개선 (22년)
각부처·지자체
----------------------------------------------------------------------------------------------------
[6] [RRF] Q: 디지털 트랜스포메이션이란 무엇인가요?

디지털기기 사용이 어려운 분들이 차별없이 서비스를 받도록 지원하겠습니다.
권익위,
□1 국민의 소리 청취·분석 시스템 개선 (22년)
각부처·지자체
----------------------------------------------------------------------------------------------------
[6] [CC] Q: 디지털 트랜스포메이션이란 무엇인가요?

보다 안정성‧편의성이 높은 스마트폰 기반 디지털 신분증 도입
* 학생증, 공무원증 등 이용대상과 목적이 명확한 분야부터 안전성 점검 후 단계적 확대
====================================================================================================

[7] [Original] Q: 디지털 트랜스포메이션이란 무엇인가요?

디지털 정부혁신 추진계획
2019. 10. 29.
관계부처 합동
----------------------------------------------------------------------------------------------------
[7] [RRF] Q: 디지털 트랜스포메이션이란 무엇인가요?

디지털 정부혁신 추진계획
2019. 10. 29.
관계부처 합동
----------------------------------------------------------------------------------------------------
[7] [CC] Q: 디지털 트랜스포메이션이란 무엇인가요?

디지털기기 사용이 어려운 분들이 차별없이 서비스를 받도록 지원하겠습니다.
권익위,
□1 국민의 소리 청취·분석 시스템 개선 (22년)
각부처·지자체
====================================================================================================

[8] [Original] Q: 디지털 트랜스포메이션이란 무엇인가요?

참고 3 디지털 정부혁신 기대효과
◈ 동 방안을 성공적으로 추진하는 경우, 정부 디지털 서비스에서 세계 최고
----------------------------------------------------------------------------------------------------
[8] [RRF] Q: 디지털 트랜스포메이션이란 무엇인가요?

참고 3 디지털 정부혁신 기대효과
◈ 동 방안을 성공적으로 추진하는 경우, 정부 디지털 서비스에서 세계 최고
----------------------------------------------------------------------------------------------------
[8] [CC] Q: 디지털 트랜스포메이션이란 무엇인가요?

참고 3 디지털 정부혁신 기대효과
◈ 동 방안을 성공적으로 추진하는 경우, 정부 디지털 서비스에서 세계 최고
====================================================================================================
</code></pre>
</div>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/11-CC-EnsembleRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>셀프 쿼리(Self-querying)</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/08-SelfQueryRetriever.html</link>
  <description><![CDATA[ 






<p><code>SelfQueryRetriever</code> 는 자체적으로 질문을 생성하고 해결할 수 있는 기능을 갖춘 검색 도구입니다.</p>
<p>이는 사용자가 제공한 자연어 질의를 바탕으로, <code>query-constructing</code> LLM chain을 사용해 구조화된 질의를 만듭니다. 그 후, 이 구조화된 질의를 기본 벡터 데이터 저장소(VectorStore)에 적용하여 검색을 수행합니다.</p>
<p>이 과정을 통해, <code>SelfQueryRetriever</code> 는 단순히 사용자의 입력 질의를 저장된 문서의 내용과 의미적으로 비교하는 것을 넘어서, 사용자의 질의에서 문서의 메타데이터에 대한 <strong>필터를 추출</strong> 하고, 이 필터를 실행하여 관련된 문서를 찾을 수 있습니다.</p>
<p>[참고]</p>
<ul>
<li>LangChain 이 지원하는 셀프 쿼리 검색기(Self-query Retriever) 목록은 <a href="https://python.langchain.com/docs/integrations/retrievers/self_query">여기</a> 에서 확인해 주시기 바랍니다.</li>
</ul>
<div id="dd5cfe5f" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="a2e8e07c" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
<section id="샘플-데이터-생성" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="샘플-데이터-생성"><span class="header-section-number">1</span> 샘플 데이터 생성</h2>
<p>화장품 상품의 설명과 메타데이터를 기반으로 유사도 검색이 가능한 벡터 저장소를 구축합니다.</p>
<div id="19f836a1" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_chroma <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chroma</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.documents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Document</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 화장품 상품의 설명과 메타데이터 생성</span></span>
<span id="cb3-6">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb3-7">    Document(</span>
<span id="cb3-8">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"수분 가득한 히알루론산 세럼으로 피부 속 깊은 곳까지 수분을 공급합니다."</span>,</span>
<span id="cb3-9">        metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"스킨케어"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_rating"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.7</span>},</span>
<span id="cb3-10">    ),</span>
<span id="cb3-11">    Document(</span>
<span id="cb3-12">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"24시간 지속되는 매트한 피니시의 파운데이션, 모공을 커버하고 자연스러운 피부 표현이 가능합니다."</span>,</span>
<span id="cb3-13">        metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2023</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"메이크업"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_rating"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>},</span>
<span id="cb3-14">    ),</span>
<span id="cb3-15">    Document(</span>
<span id="cb3-16">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"식물성 성분으로 만든 저자극 클렌징 오일, 메이크업과 노폐물을 부드럽게 제거합니다."</span>,</span>
<span id="cb3-17">        metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2023</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"클렌징"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_rating"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.8</span>},</span>
<span id="cb3-18">    ),</span>
<span id="cb3-19">    Document(</span>
<span id="cb3-20">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"비타민 C 함유 브라이트닝 크림, 칙칙한 피부톤을 환하게 밝혀줍니다."</span>,</span>
<span id="cb3-21">        metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2023</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"스킨케어"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_rating"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.6</span>},</span>
<span id="cb3-22">    ),</span>
<span id="cb3-23">    Document(</span>
<span id="cb3-24">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"롱래스팅 립스틱, 선명한 발색과 촉촉한 사용감으로 하루종일 편안하게 사용 가능합니다."</span>,</span>
<span id="cb3-25">        metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"메이크업"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_rating"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.4</span>},</span>
<span id="cb3-26">    ),</span>
<span id="cb3-27">    Document(</span>
<span id="cb3-28">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"자외선 차단 기능이 있는 톤업 선크림, SPF50+/PA++++ 높은 자외선 차단 지수로 피부를 보호합니다."</span>,</span>
<span id="cb3-29">        metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"선케어"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_rating"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.9</span>},</span>
<span id="cb3-30">    ),</span>
<span id="cb3-31">]</span>
<span id="cb3-32"></span>
<span id="cb3-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소 생성</span></span>
<span id="cb3-34">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma.from_documents(</span>
<span id="cb3-35">    docs, OpenAIEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-embedding-3-small"</span>)</span>
<span id="cb3-36">)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="selfqueryretriever" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="selfqueryretriever"><span class="header-section-number">2</span> SelfQueryRetriever</h2>
<p>이제 retriever를 인스턴스화할 수 있습니다. 이를 위해서는 문서가 지원하는 <strong>메타데이터 필드</strong> 와 문서 내용에 대한 <strong>간단한 설명을 미리 제공</strong> 해야 합니다.</p>
<p><code>AttributeInfo</code> 클래스를 사용하여 화장품 메타데이터 필드에 대한 정보를 정의합니다.</p>
<ul>
<li>카테고리(<code>category</code>): 문자열 타입, 화장품의 카테고리를 나타내며 [‘스킨케어’, ‘메이크업’, ‘클렌징’, ‘선케어’] 중 하나의 값을 가집니다.</li>
<li>연도(<code>year</code>): 정수 타입, 화장품이 출시된 연도를 나타냅니다.</li>
<li>사용자 평점(<code>user_rating</code>): 실수 타입, 1-5 범위의 사용자 평점을 나타냅니다.</li>
</ul>
<div id="8dd17e37" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.chains.query_constructor.base <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AttributeInfo</span>
<span id="cb4-2"></span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 메타데이터 필드 정보 생성</span></span>
<span id="cb4-5">metadata_field_info <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb4-6">    AttributeInfo(</span>
<span id="cb4-7">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>,</span>
<span id="cb4-8">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The category of the cosmetic product. One of ['스킨케어', '메이크업', '클렌징', '선케어']"</span>,</span>
<span id="cb4-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span>,</span>
<span id="cb4-10">    ),</span>
<span id="cb4-11">    AttributeInfo(</span>
<span id="cb4-12">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>,</span>
<span id="cb4-13">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The year the cosmetic product was released"</span>,</span>
<span id="cb4-14">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"integer"</span>,</span>
<span id="cb4-15">    ),</span>
<span id="cb4-16">    AttributeInfo(</span>
<span id="cb4-17">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_rating"</span>,</span>
<span id="cb4-18">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A user rating for the cosmetic product, ranging from 1 to 5"</span>,</span>
<span id="cb4-19">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float"</span>,</span>
<span id="cb4-20">    ),</span>
<span id="cb4-21">]</span></code></pre></div></div>
</details>
</div>
<p><code>SelfQueryRetriever.from_llm()</code> 메서드를 사용하여 <code>retriever</code> 객체를 생성합니다.</p>
<ul>
<li><code>llm</code>: 언어 모델</li>
<li><code>vectorstore</code>: 벡터 저장소</li>
<li><code>document_contents</code>: 문서들의 내용 설명</li>
<li><code>metadata_field_info</code>: 메타데이터 필드 정보</li>
</ul>
<div id="b1fb20bf" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.self_query.base <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SelfQueryRetriever</span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLM 정의</span></span>
<span id="cb5-5">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># SelfQueryRetriever 생성</span></span>
<span id="cb5-8">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SelfQueryRetriever.from_llm(</span>
<span id="cb5-9">    llm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm,</span>
<span id="cb5-10">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,</span>
<span id="cb5-11">    document_contents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Brief summary of a cosmetic product"</span>,</span>
<span id="cb5-12">    metadata_field_info<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>metadata_field_info,</span>
<span id="cb5-13">)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="query-테스트" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="query-테스트"><span class="header-section-number">3</span> Query 테스트</h2>
<p>필터를 걸 수 있는 질의를 입력하여 검색을 수행합니다.</p>
<div id="a59b1e5c" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Self-query 검색</span></span>
<span id="cb6-2">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"평점이 4.8 이상인 제품을 추천해주세요"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="0cf6368b" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Self-query 검색</span></span>
<span id="cb7-2">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023년에 출시된 상품을 추천해주세요"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="172ddf61" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Self-query 검색</span></span>
<span id="cb8-2">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"카테고리가 선케어인 상품을 추천해주세요"</span>)</span></code></pre></div></div>
</details>
</div>
<p>복합 필터를 사용하여 검색을 수행할 수 있습니다.</p>
<div id="20f38f98" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Self-query 검색</span></span>
<span id="cb9-2">retriever.invoke(</span>
<span id="cb9-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"카테고리가 메이크업인 상품 중에서 평점이 4.5 이상인 상품을 추천해주세요"</span></span>
<span id="cb9-4">)</span></code></pre></div></div>
</details>
</div>
<p><code>k</code>는 가져올 문서의 수를 의미합니다.</p>
<p><code>SelfQueryRetriever</code>를 사용하여 <code>k</code>를 지정할 수도 있습니다. 이는 생성자에 <code>enable_limit=True</code>를 전달하여 수행할 수 있습니다.</p>
<div id="959cc5f4" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SelfQueryRetriever.from_llm(</span>
<span id="cb10-2">    llm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm,</span>
<span id="cb10-3">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,</span>
<span id="cb10-4">    document_contents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Brief summary of a cosmetic product"</span>,</span>
<span id="cb10-5">    metadata_field_info<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>metadata_field_info,</span>
<span id="cb10-6">    enable_limit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과 제한 기능을 활성화합니다.</span></span>
<span id="cb10-7">    search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>},  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># k 의 값을 2로 지정하여 검색 결과를 2개로 제한합니다.</span></span>
<span id="cb10-8">)</span></code></pre></div></div>
</details>
</div>
<p>2023년도 출시된 상품은 3개가 있지만 “k” 값을 2로 지정하여 2개만 반환하도록 합니다.</p>
<div id="4628ffbc" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Self-query 검색</span></span>
<span id="cb11-2">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023년에 출시된 상품을 추천해주세요"</span>)</span></code></pre></div></div>
</details>
</div>
<p>하지만 코드로 명시적으로 <code>search_kwargs</code>를 지정하지 않고 query 에서 <code>1개, 2개</code> 등의 숫자를 사용하여 검색 결과를 제한할 수 있습니다.</p>
<div id="9b4cabe1" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SelfQueryRetriever.from_llm(</span>
<span id="cb12-2">    llm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm,</span>
<span id="cb12-3">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,</span>
<span id="cb12-4">    document_contents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Brief summary of a cosmetic product"</span>,</span>
<span id="cb12-5">    metadata_field_info<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>metadata_field_info,</span>
<span id="cb12-6">    enable_limit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과 제한 기능을 활성화합니다.</span></span>
<span id="cb12-7">)</span>
<span id="cb12-8"></span>
<span id="cb12-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Self-query 검색</span></span>
<span id="cb12-10">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023년에 출시된 상품 1개를 추천해주세요"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="9af3a1ab" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Self-query 검색</span></span>
<span id="cb13-2">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023년에 출시된 상품 2개를 추천해주세요"</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="더-깊게-들어가기" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="더-깊게-들어가기"><span class="header-section-number">4</span> 더 깊게 들어가기</h2>
<p>내부에서 어떤 일이 일어나는지 확인하고 더 많은 사용자 정의 제어를 하기 위해, 우리는 retriever를 처음부터 재구성할 수 있습니다.</p>
<p>이 과정은 <code>query-construction chain</code> 을 생성하는 것부터 시작합니다.</p>
<ul>
<li><a href="https://github.com/langchain-ai/langchain/blob/master/cookbook/self_query_hotel_search.ipynb">참고 튜토리얼</a></li>
</ul>
<section id="query_constructor-chain-생성" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="query_constructor-chain-생성"><span class="header-section-number">4.1</span> <code>query_constructor</code> chain 생성</h3>
<p>구조화된 쿼리를 생성하는 <code>query_constructor</code> chain 을 생성합니다.</p>
<p><code>get_query_constructor_prompt</code> 함수를 사용하여 쿼리 생성기 프롬프트를 가져옵니다.</p>
<div id="8e9b180d" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.chains.query_constructor.base <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> (</span>
<span id="cb14-2">    StructuredQueryOutputParser,</span>
<span id="cb14-3">    get_query_constructor_prompt,</span>
<span id="cb14-4">)</span>
<span id="cb14-5"></span>
<span id="cb14-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 내용 설명과 메타데이터 필드 정보를 사용하여 쿼리 생성기 프롬프트를 가져옵니다.</span></span>
<span id="cb14-7">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_query_constructor_prompt(</span>
<span id="cb14-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Brief summary of a cosmetic product"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 내용 설명</span></span>
<span id="cb14-9">    metadata_field_info,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 메타데이터 필드 정보</span></span>
<span id="cb14-10">)</span>
<span id="cb14-11"></span>
<span id="cb14-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># StructuredQueryOutputParser 를 생성</span></span>
<span id="cb14-13">output_parser <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StructuredQueryOutputParser.from_components()</span>
<span id="cb14-14"></span>
<span id="cb14-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># query_constructor chain 을 생성</span></span>
<span id="cb14-16">query_constructor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> output_parser</span></code></pre></div></div>
</details>
</div>
<p><code>prompt.format()</code> 메서드를 사용하여 <code>query</code> 매개변수에 “dummy question” 문자열을 전달하고, 그 결과를 출력하여 Prompt 내용을 확인해 보겠습니다.</p>
<div id="74bc86da" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prompt 출력</span></span>
<span id="cb15-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(prompt.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(query<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dummy question"</span>))</span></code></pre></div></div>
</details>
</div>
<p><code>query_constructor.invoke()</code> 메서드를 호출하여 주어진 쿼리에 대한 처리를 수행합니다.</p>
<div id="bc33a7ac" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1">query_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query_constructor.invoke(</span>
<span id="cb16-2">    {</span>
<span id="cb16-3">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 쿼리 생성기를 호출하여 주어진 질문에 대한 쿼리를 생성합니다.</span></span>
<span id="cb16-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"query"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023년도에 출시한 상품 중 평점이 4.5 이상인 상품중에서 스킨케어 제품을 추천해주세요"</span></span>
<span id="cb16-5">    }</span>
<span id="cb16-6">)</span></code></pre></div></div>
</details>
</div>
<p>생성된 쿼리를 확인해 보겠습니다.</p>
<div id="c5d13f2f" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 쿼리 출력</span></span>
<span id="cb17-2">query_output.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>.arguments</span></code></pre></div></div>
</details>
</div>
<p>Self-query retriever의 핵심 요소는 query constructor입니다. 훌륭한 검색 시스템을 만들기 위해서는 query constructor가 잘 작동하도록 해야 합니다.</p>
<p>이를 위해서는 <strong>프롬프트(Prompt), 프롬프트 내의 예시, 속성 설명 등을 조정</strong> 해야 합니다.</p>
</section>
<section id="구조화된-쿼리-변환기structured-query-translator를-사용하여-구조화된-쿼리로-변환" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="구조화된-쿼리-변환기structured-query-translator를-사용하여-구조화된-쿼리로-변환"><span class="header-section-number">4.2</span> 구조화된 쿼리 변환기(Structured Query Translator)를 사용하여 구조화된 쿼리로 변환</h3>
<p>다음으로 중요한 요소는 structured query translator입니다.</p>
<p>이는 일반적인 <code>StructuredQuery</code> 객체를 사용 중인 vector store의 구문에 맞는 메타데이터 필터로 변환하는 역할을 담당합니다.</p>
<div id="a4d228d3" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.self_query.chroma <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChromaTranslator</span>
<span id="cb18-2"></span>
<span id="cb18-3">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SelfQueryRetriever(</span>
<span id="cb18-4">    query_constructor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>query_constructor,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 이전에 생성한 query_constructor chain 을 지정</span></span>
<span id="cb18-5">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소를 지정</span></span>
<span id="cb18-6">    structured_query_translator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ChromaTranslator(),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 쿼리 변환기</span></span>
<span id="cb18-7">)</span></code></pre></div></div>
</details>
</div>
<p><code>retriever.invoke()</code> 메서드를 사용하여 주어진 질문에 대한 답변을 생성합니다.</p>
<div id="ad4b4199" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1">retriever.invoke(</span>
<span id="cb19-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질문</span></span>
<span id="cb19-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023년도에 출시한 상품 중 평점이 4.5 이상인 상품중에서 스킨케어 제품을 추천해주세요"</span></span>
<span id="cb19-4">)</span></code></pre></div></div>
</details>
</div>


</section>
</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/08-SelfQueryRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>한글 단어 리트리버 튜닝</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/10-Kiwi-BM25Retriever.html</link>
  <description><![CDATA[ 






<p>한글 형태소 분석기 라이브러리인 <code>kiwipiepy</code> 를 설치합니다. - <a href="https://github.com/bab2min/kiwipiepy"><code>kiwipiepy</code> 프로젝트 링크</a></p>
<div id="cell-3" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>True</code></pre>
</div>
</div>
<div id="cell-4" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb3-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>LangSmith 추적을 시작합니다.
[프로젝트명]
CH10-Retriever</code></pre>
</div>
</div>
<div id="cell-5" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install kiwipiepy</span></span></code></pre></div></div>
</details>
</div>
<div id="cell-6" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> kiwipiepy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Kiwi</span>
<span id="cb6-2"></span>
<span id="cb6-3">kiwi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Kiwi()</span></code></pre></div></div>
</details>
</div>
<p>토큰화를 진행합니다.</p>
<div id="cell-8" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">kiwi.tokenize(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"안녕하세요? 형태소 분석기 키위입니다"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>[Token(form='안녕', tag='NNG', start=0, len=2),
 Token(form='하', tag='XSA', start=2, len=1),
 Token(form='세요', tag='EF', start=3, len=2),
 Token(form='?', tag='SF', start=5, len=1),
 Token(form='형태소', tag='NNG', start=7, len=3),
 Token(form='분석기', tag='NNG', start=11, len=3),
 Token(form='키위', tag='NNG', start=15, len=2),
 Token(form='이', tag='VCP', start=17, len=1),
 Token(form='ᆸ니다', tag='EF', start=17, len=3)]</code></pre>
</div>
</div>
<section id="다양한-문장으로-테스트" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="다양한-문장으로-테스트"><span class="header-section-number">1</span> 다양한 문장으로 테스트</h2>
<div id="cell-10" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> EnsembleRetriever</span>
<span id="cb9-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.retrievers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BM25Retriever</span>
<span id="cb9-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.documents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Document</span>
<span id="cb9-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb9-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb9-6"></span>
<span id="cb9-7">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb9-8">    Document(</span>
<span id="cb9-9">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다."</span></span>
<span id="cb9-10">    ),</span>
<span id="cb9-11">    Document(</span>
<span id="cb9-12">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"금융저축보험은 규칙적인 저축을 통해 목돈을 마련할 수 있으며, 생명보험 기능도 겸비하고 있습니다."</span></span>
<span id="cb9-13">    ),</span>
<span id="cb9-14">    Document(</span>
<span id="cb9-15">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다."</span></span>
<span id="cb9-16">    ),</span>
<span id="cb9-17">    Document(</span>
<span id="cb9-18">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다."</span></span>
<span id="cb9-19">    ),</span>
<span id="cb9-20">    Document(</span>
<span id="cb9-21">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"금융단폭격보험은 저축은 커녕 위험 대비에 초점을 맞춘 상품입니다. 높은 위험을 감수하고자 하는 고객에게 적합합니다."</span></span>
<span id="cb9-22">    ),</span>
<span id="cb9-23">    Document(</span>
<span id="cb9-24">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"금보험은 저축성과를 극대화합니다. 특히 노후 대비 저축에 유리하게 구성되어 있습니다."</span></span>
<span id="cb9-25">    ),</span>
<span id="cb9-26">    Document(</span>
<span id="cb9-27">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요."</span></span>
<span id="cb9-28">    ),</span>
<span id="cb9-29">]</span></code></pre></div></div>
</details>
</div>
<div id="cell-11" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs:</span>
<span id="cb10-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>.join([token.form <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> token <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> kiwi.tokenize(doc.page_content)]))</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>금융 보험 은 장기 적 이 ᆫ 자산 관리 와 위험 대비 를 목적 으로 고안 되 ᆫ 금융 상품 이 ᆸ니다 .
금융 저축 보험 은 규칙 적 이 ᆫ 저축 을 통하 어 목돈 을 마련 하 ᆯ 수 있 으며 , 생명 보험 기능 도 겸비 하 고 있 습니다 .
저축 금융 보험 은 저축 과 금융 을 통하 어 목돈 마련 에 도움 을 주 는 보험 이 ᆸ니다 . 또한 , 사망 보장 기능 도 제공 하 ᆸ니다 .
금융 저 축산물 보험 은 장기 적 이 ᆫ 저축 목적 과 더불 어 , 축산물 제공 기능 을 갖추 고 있 는 특별 금융 상품 이 ᆸ니다 .
금융 단 폭격 보험 은 저축 은 커녕 위험 대비 에 초점 을 맞추 ᆫ 상품 이 ᆸ니다 . 높 은 위험 을 감수 하 고자 하 는 고객 에게 적합 하 ᆸ니다 .
금 보험 은 저축 성과 를 극대 화 하 ᆸ니다 . 특히 노후 대비 저축 에 유리 하 게 구성 되 어 있 습니다 .
금융 보 씨 험하 ᆫ 말 좀 하 지 말 시 고 , 저축 이나 좀 하 시 던가요 . 뭐 가 그리 급하 시 ᆫ지 모르 겠 네요 .</code></pre>
</div>
</div>
<div id="cell-12" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 토큰화 함수를 생성</span></span>
<span id="cb12-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> kiwi_tokenize(text):</span>
<span id="cb12-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [token.form <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> token <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> kiwi.tokenize(text)]</span></code></pre></div></div>
</details>
</div>
<section id="실험-다양한-종류의-검색기를-사용하여-검색-결과를-비교" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="실험-다양한-종류의-검색기를-사용하여-검색-결과를-비교"><span class="header-section-number">1.1</span> 실험: 다양한 종류의 검색기를 사용하여 검색 결과를 비교</h3>
<div id="cell-14" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1">bm25 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BM25Retriever.from_documents(docs)</span>
<span id="cb13-2"></span>
<span id="cb13-3">kiwi_bm25 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BM25Retriever.from_documents(docs, preprocess_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kiwi_tokenize)</span>
<span id="cb13-4"></span>
<span id="cb13-5">faiss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS.from_documents(docs, OpenAIEmbeddings()).as_retriever()</span>
<span id="cb13-6"></span>
<span id="cb13-7">bm25_faiss_73 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EnsembleRetriever(</span>
<span id="cb13-8">    retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[bm25, faiss],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 사용할 검색 모델의 리스트</span></span>
<span id="cb13-9">    weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 각 검색 모델의 결과에 적용할 가중치</span></span>
<span id="cb13-10">    search_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmr"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과의 다양성을 증진시키는 MMR 방식을 사용</span></span>
<span id="cb13-11">)</span>
<span id="cb13-12">bm25_faiss_37 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EnsembleRetriever(</span>
<span id="cb13-13">    retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[bm25, faiss],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 사용할 검색 모델의 리스트</span></span>
<span id="cb13-14">    weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 각 검색 모델의 결과에 적용할 가중치</span></span>
<span id="cb13-15">    search_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmr"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과의 다양성을 증진시키는 MMR 방식을 사용</span></span>
<span id="cb13-16">)</span>
<span id="cb13-17">kiwibm25_faiss_73 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EnsembleRetriever(</span>
<span id="cb13-18">    retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[kiwi_bm25, faiss],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 사용할 검색 모델의 리스트</span></span>
<span id="cb13-19">    weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 각 검색 모델의 결과에 적용할 가중치</span></span>
<span id="cb13-20">    search_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmr"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과의 다양성을 증진시키는 MMR 방식을 사용</span></span>
<span id="cb13-21">)</span>
<span id="cb13-22">kiwibm25_faiss_37 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EnsembleRetriever(</span>
<span id="cb13-23">    retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[kiwi_bm25, faiss],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 사용할 검색 모델의 리스트</span></span>
<span id="cb13-24">    weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 각 검색 모델의 결과에 적용할 가중치</span></span>
<span id="cb13-25">    search_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmr"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과의 다양성을 증진시키는 MMR 방식을 사용</span></span>
<span id="cb13-26">)</span>
<span id="cb13-27"></span>
<span id="cb13-28">retrievers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb13-29">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bm25"</span>: bm25,</span>
<span id="cb13-30">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kiwi_bm25"</span>: kiwi_bm25,</span>
<span id="cb13-31">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"faiss"</span>: faiss,</span>
<span id="cb13-32">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bm25_faiss_73"</span>: bm25_faiss_73,</span>
<span id="cb13-33">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bm25_faiss_37"</span>: bm25_faiss_37,</span>
<span id="cb13-34">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kiwi_bm25_faiss_73"</span>: kiwibm25_faiss_73,</span>
<span id="cb13-35">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kiwi_bm25_faiss_37"</span>: kiwibm25_faiss_37,</span>
<span id="cb13-36">}</span></code></pre></div></div>
</details>
</div>
<div id="cell-15" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> print_search_results(retrievers, query):</span>
<span id="cb14-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Query: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>query<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb14-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> name, retriever <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> retrievers.items():</span>
<span id="cb14-4">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>retriever<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>invoke(query)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb14-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"==="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div></div>
</details>
</div>
<p>검색 결과를 출력합니다.</p>
<div id="cell-17" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1">print_search_results(retrievers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"금융보험"</span>)</span>
<span id="cb15-2">print_search_results(retrievers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"금융 보험"</span>)</span>
<span id="cb15-3">print_search_results(retrievers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"금융저축보험"</span>)</span>
<span id="cb15-4">print_search_results(retrievers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"축산물 보험"</span>)</span>
<span id="cb15-5">print_search_results(retrievers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"저축금융보험"</span>)</span>
<span id="cb15-6">print_search_results(retrievers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"금융보씨 개인정보 조회"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Query: 금융보험
bm25        : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
kiwi_bm25       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
faiss       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
bm25_faiss_73       : 금융단폭격보험은 저축은 커녕 위험 대비에 초점을 맞춘 상품입니다. 높은 위험을 감수하고자 하는 고객에게 적합합니다.
bm25_faiss_37       : 금융단폭격보험은 저축은 커녕 위험 대비에 초점을 맞춘 상품입니다. 높은 위험을 감수하고자 하는 고객에게 적합합니다.
kiwi_bm25_faiss_73      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
kiwi_bm25_faiss_37      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
============================================================
Query: 금융 보험
bm25        : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
kiwi_bm25       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
faiss       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
bm25_faiss_73       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
bm25_faiss_37       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
kiwi_bm25_faiss_73      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
kiwi_bm25_faiss_37      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
============================================================
Query: 금융저축보험
bm25        : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
kiwi_bm25       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
faiss       : 금융저축보험은 규칙적인 저축을 통해 목돈을 마련할 수 있으며, 생명보험 기능도 겸비하고 있습니다.
bm25_faiss_73       : 금융단폭격보험은 저축은 커녕 위험 대비에 초점을 맞춘 상품입니다. 높은 위험을 감수하고자 하는 고객에게 적합합니다.
bm25_faiss_37       : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
kiwi_bm25_faiss_73      : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
kiwi_bm25_faiss_37      : 금융저축보험은 규칙적인 저축을 통해 목돈을 마련할 수 있으며, 생명보험 기능도 겸비하고 있습니다.
============================================================
Query: 축산물 보험
bm25        : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
kiwi_bm25       : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
faiss       : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
bm25_faiss_73       : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
bm25_faiss_37       : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
kiwi_bm25_faiss_73      : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
kiwi_bm25_faiss_37      : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
============================================================
Query: 저축금융보험
bm25        : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
kiwi_bm25       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
faiss       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
bm25_faiss_73       : 금융단폭격보험은 저축은 커녕 위험 대비에 초점을 맞춘 상품입니다. 높은 위험을 감수하고자 하는 고객에게 적합합니다.
bm25_faiss_37       : 금융단폭격보험은 저축은 커녕 위험 대비에 초점을 맞춘 상품입니다. 높은 위험을 감수하고자 하는 고객에게 적합합니다.
kiwi_bm25_faiss_73      : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
kiwi_bm25_faiss_37      : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
============================================================
Query: 금융보씨 개인정보 조회
bm25        : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
kiwi_bm25       : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
faiss       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
bm25_faiss_73       : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
bm25_faiss_37       : 금융단폭격보험은 저축은 커녕 위험 대비에 초점을 맞춘 상품입니다. 높은 위험을 감수하고자 하는 고객에게 적합합니다.
kiwi_bm25_faiss_73      : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
kiwi_bm25_faiss_37      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
============================================================</code></pre>
</div>
</div>
</section>
</section>
<section id="konlpy" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="konlpy"><span class="header-section-number">2</span> Konlpy</h2>
<div id="cell-19" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install konlpy</span></span></code></pre></div></div>
</details>
</div>
<div id="cell-20" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> konlpy.tag <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Kkma, Okt, Komoran, Hannanum</span>
<span id="cb18-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> kiwipiepy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Kiwi</span>
<span id="cb18-3"></span>
<span id="cb18-4">kkma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Kkma()</span>
<span id="cb18-5">okt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Okt()</span>
<span id="cb18-6">komoran <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Komoran()</span>
<span id="cb18-7">hannanum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Hannanum()</span>
<span id="cb18-8">kiwi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Kiwi()</span></code></pre></div></div>
</details>
</div>
<div id="cell-21" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1">text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"안녕하세요? 형태소 분석기 테스트베드입니다."</span></span></code></pre></div></div>
</details>
</div>
<div id="cell-22" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kkma    : </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb20-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>.join(kkma.morphs(text)))</span>
<span id="cb20-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"okt     : </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb20-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>.join(okt.morphs(text)))</span>
<span id="cb20-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"komoran : </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb20-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>.join(komoran.morphs(text)))</span>
<span id="cb20-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hannanum: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb20-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>.join(hannanum.morphs(text)))</span>
<span id="cb20-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kiwi    : </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb20-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>.join([tok.form <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tok <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> kiwi.tokenize(text)]))</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>kkma    :   안녕 하 세요 ? 형태소 분석기 테스트 베드 이 ㅂ니다 .
okt     :   안녕하세요 ? 형태소 분석 기 테스트 베드 입니다 .
komoran :   안녕하세요 ? 형태소 분석기 테스트 베드 이 ㅂ니다 .
hannanum:   안녕 하 세 요 ? 형태소 분석기 테스트베드 이 ㅂ니다 .
kiwi    :   안녕 하 세요 ? 형태소 분석기 테스트 베드 이 ᆸ니다 .</code></pre>
</div>
</div>
<div id="cell-23" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1">kiwi.add_user_word(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"안녕하세요 반가워요"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NNP"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>True</code></pre>
</div>
</div>
<div id="cell-24" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kiwi    : </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb24-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>.join([tok.form <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tok <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> kiwi.tokenize(text)]))</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>kiwi    :   안녕 하 세요 ? 형태소 분석기 테스트 베드 이 ᆸ니다 .</code></pre>
</div>
</div>
<div id="cell-25" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> kkma_tokenize(text):</span>
<span id="cb26-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [token <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> token <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> kkma.morphs(text)]</span></code></pre></div></div>
</details>
</div>
<div id="cell-26" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> okt_tokenize(text):</span>
<span id="cb27-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [token <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> token <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> okt.morphs(text)]</span></code></pre></div></div>
</details>
</div>
<div id="cell-27" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1">kkma_bm25 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BM25Retriever.from_documents(docs, preprocess_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kkma_tokenize)</span>
<span id="cb28-2">kkma_bm25_faiss_73 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EnsembleRetriever(</span>
<span id="cb28-3">    retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[kkma_bm25, faiss],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 사용할 검색 모델의 리스트</span></span>
<span id="cb28-4">    weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 각 검색 모델의 결과에 적용할 가중치</span></span>
<span id="cb28-5">    search_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmr"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과의 다양성을 증진시키는 MMR 방식을 사용</span></span>
<span id="cb28-6">)</span>
<span id="cb28-7">kkma_bm25_faiss_37 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EnsembleRetriever(</span>
<span id="cb28-8">    retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[kkma_bm25, faiss],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 사용할 검색 모델의 리스트</span></span>
<span id="cb28-9">    weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 각 검색 모델의 결과에 적용할 가중치</span></span>
<span id="cb28-10">    search_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmr"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과의 다양성을 증진시키는 MMR 방식을 사용</span></span>
<span id="cb28-11">)</span>
<span id="cb28-12"></span>
<span id="cb28-13">okt_bm25 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BM25Retriever.from_documents(docs, preprocess_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>okt_tokenize)</span>
<span id="cb28-14">okt_bm25_faiss_73 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EnsembleRetriever(</span>
<span id="cb28-15">    retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[okt_bm25, faiss],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 사용할 검색 모델의 리스트</span></span>
<span id="cb28-16">    weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 각 검색 모델의 결과에 적용할 가중치</span></span>
<span id="cb28-17">    search_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmr"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과의 다양성을 증진시키는 MMR 방식을 사용</span></span>
<span id="cb28-18">)</span>
<span id="cb28-19">okt_bm25_faiss_37 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EnsembleRetriever(</span>
<span id="cb28-20">    retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[okt_bm25, faiss],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 사용할 검색 모델의 리스트</span></span>
<span id="cb28-21">    weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 각 검색 모델의 결과에 적용할 가중치</span></span>
<span id="cb28-22">    search_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmr"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과의 다양성을 증진시키는 MMR 방식을 사용</span></span>
<span id="cb28-23">)</span>
<span id="cb28-24"></span>
<span id="cb28-25">retrievers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb28-26">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bm25"</span>: bm25,</span>
<span id="cb28-27">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kiwi_bm25"</span>: kiwi_bm25,</span>
<span id="cb28-28">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"faiss"</span>: faiss,</span>
<span id="cb28-29">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bm25_faiss_73"</span>: bm25_faiss_73,</span>
<span id="cb28-30">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bm25_faiss_37"</span>: bm25_faiss_37,</span>
<span id="cb28-31">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kiwi_bm25_faiss_73"</span>: kiwibm25_faiss_73,</span>
<span id="cb28-32">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kiwi_bm25_faiss_37"</span>: kiwibm25_faiss_37,</span>
<span id="cb28-33">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kkma_bm25"</span>: kkma_bm25,</span>
<span id="cb28-34">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kkma_bm25_faiss_73"</span>: kkma_bm25_faiss_73,</span>
<span id="cb28-35">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kkma_bm25_faiss_37"</span>: kkma_bm25_faiss_37,</span>
<span id="cb28-36">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"okt_bm25"</span>: okt_bm25,</span>
<span id="cb28-37">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"okt_bm25_faiss_73"</span>: okt_bm25_faiss_73,</span>
<span id="cb28-38">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"okt_bm25_faiss_37"</span>: okt_bm25_faiss_37,</span>
<span id="cb28-39">}</span></code></pre></div></div>
</details>
</div>
<div id="cell-28" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1">print_search_results(retrievers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"금융보험"</span>)</span>
<span id="cb29-2">print_search_results(retrievers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"금융 보험"</span>)</span>
<span id="cb29-3">print_search_results(retrievers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"금융저축보험"</span>)</span>
<span id="cb29-4">print_search_results(retrievers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"축산물 보험"</span>)</span>
<span id="cb29-5">print_search_results(retrievers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"저축금융보험"</span>)</span>
<span id="cb29-6">print_search_results(retrievers, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"금융보씨 개인정보 조회"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Query: 금융보험
bm25        : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
kiwi_bm25       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
faiss       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
bm25_faiss_73       : 금융단폭격보험은 저축은 커녕 위험 대비에 초점을 맞춘 상품입니다. 높은 위험을 감수하고자 하는 고객에게 적합합니다.
bm25_faiss_37       : 금융단폭격보험은 저축은 커녕 위험 대비에 초점을 맞춘 상품입니다. 높은 위험을 감수하고자 하는 고객에게 적합합니다.
kiwi_bm25_faiss_73      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
kiwi_bm25_faiss_37      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
kkma_bm25       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
kkma_bm25_faiss_73      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
kkma_bm25_faiss_37      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
okt_bm25        : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
okt_bm25_faiss_73       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
okt_bm25_faiss_37       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
============================================================
Query: 금융 보험
bm25        : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
kiwi_bm25       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
faiss       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
bm25_faiss_73       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
bm25_faiss_37       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
kiwi_bm25_faiss_73      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
kiwi_bm25_faiss_37      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
kkma_bm25       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
kkma_bm25_faiss_73      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
kkma_bm25_faiss_37      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
okt_bm25        : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
okt_bm25_faiss_73       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
okt_bm25_faiss_37       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
============================================================
Query: 금융저축보험
bm25        : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
kiwi_bm25       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
faiss       : 금융저축보험은 규칙적인 저축을 통해 목돈을 마련할 수 있으며, 생명보험 기능도 겸비하고 있습니다.
bm25_faiss_73       : 금융단폭격보험은 저축은 커녕 위험 대비에 초점을 맞춘 상품입니다. 높은 위험을 감수하고자 하는 고객에게 적합합니다.
bm25_faiss_37       : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
kiwi_bm25_faiss_73      : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
kiwi_bm25_faiss_37      : 금융저축보험은 규칙적인 저축을 통해 목돈을 마련할 수 있으며, 생명보험 기능도 겸비하고 있습니다.
kkma_bm25       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
kkma_bm25_faiss_73      : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
kkma_bm25_faiss_37      : 금융저축보험은 규칙적인 저축을 통해 목돈을 마련할 수 있으며, 생명보험 기능도 겸비하고 있습니다.
okt_bm25        : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
okt_bm25_faiss_73       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
okt_bm25_faiss_37       : 금융저축보험은 규칙적인 저축을 통해 목돈을 마련할 수 있으며, 생명보험 기능도 겸비하고 있습니다.
============================================================
Query: 축산물 보험
bm25        : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
kiwi_bm25       : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
faiss       : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
bm25_faiss_73       : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
bm25_faiss_37       : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
kiwi_bm25_faiss_73      : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
kiwi_bm25_faiss_37      : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
kkma_bm25       : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
kkma_bm25_faiss_73      : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
kkma_bm25_faiss_37      : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
okt_bm25        : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
okt_bm25_faiss_73       : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
okt_bm25_faiss_37       : 금융저축산물보험은 장기적인 저축 목적과 더불어, 축산물 제공 기능을 갖추고 있는 특별 금융 상품입니다.
============================================================
Query: 저축금융보험
bm25        : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
kiwi_bm25       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
faiss       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
bm25_faiss_73       : 금융단폭격보험은 저축은 커녕 위험 대비에 초점을 맞춘 상품입니다. 높은 위험을 감수하고자 하는 고객에게 적합합니다.
bm25_faiss_37       : 금융단폭격보험은 저축은 커녕 위험 대비에 초점을 맞춘 상품입니다. 높은 위험을 감수하고자 하는 고객에게 적합합니다.
kiwi_bm25_faiss_73      : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
kiwi_bm25_faiss_37      : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
kkma_bm25       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
kkma_bm25_faiss_73      : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
kkma_bm25_faiss_37      : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
okt_bm25        : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
okt_bm25_faiss_73       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
okt_bm25_faiss_37       : 저축금융보험은 저축과 금융을 통해 목돈 마련에 도움을 주는 보험입니다. 또한, 사망 보장 기능도 제공합니다.
============================================================
Query: 금융보씨 개인정보 조회
bm25        : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
kiwi_bm25       : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
faiss       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
bm25_faiss_73       : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
bm25_faiss_37       : 금융단폭격보험은 저축은 커녕 위험 대비에 초점을 맞춘 상품입니다. 높은 위험을 감수하고자 하는 고객에게 적합합니다.
kiwi_bm25_faiss_73      : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
kiwi_bm25_faiss_37      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
kkma_bm25       : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
kkma_bm25_faiss_73      : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
kkma_bm25_faiss_37      : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
okt_bm25        : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
okt_bm25_faiss_73       : 금융보씨 험한말 좀 하지마시고, 저축이나 좀 하시던가요. 뭐가 그리 급하신지 모르겠네요.
okt_bm25_faiss_37       : 금융보험은 장기적인 자산 관리와 위험 대비를 목적으로 고안된 금융 상품입니다.
============================================================</code></pre>
</div>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/10-Kiwi-BM25Retriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>시간 가중 벡터저장소 리트리버(TimeWeightedVectorStoreRetriever)</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/09-TimeWeightedVectorStoreRetriever.html</link>
  <description><![CDATA[ 






<p><code>TimeWeightedVectorStoreRetriever</code> 는 의미론적 유사성과 시간에 따른 감쇠를 결합해 사용하는 검색 도구입니다. 이를 통해 문서 또는 데이터의 <strong>“신선함”</strong> 과 <strong>“관련성”</strong> 을 모두 고려하여 결과를 제공합니다.</p>
<p>스코어링 알고리즘은 다음과 같이 구성됩니다</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bsemantic%5C_similarity%7D%20+%20(1.0%20-%20%5Ctext%7Bdecay%5C_rate%7D)%5E%7Bhours%5C_passed%7D"></p>
<p>여기서 <code>semantic_similarity</code> 는 문서 또는 데이터 간의 의미적 유사도를 나타내고, <code>decay_rate</code> 는 시간이 지남에 따라 점수가 얼마나 감소하는지를 나타내는 비율입니다. <code>hours_passed</code> 는 객체가 마지막으로 접근된 후부터 현재까지 경과한 시간(시간 단위)을 의미합니다.</p>
<p>이 방식의 주요 특징은, 객체가 마지막으로 접근된 시간을 기준으로 하여 <strong>“정보의 신선함”</strong> 을 평가한다는 점입니다. 즉, <strong>자주 접근되는 객체는 시간이 지나도 높은 점수</strong>를 유지하며, 이를 통해 <strong>자주 사용되거나 중요하게 여겨지는 정보가 검색 결과 상위에 위치할 가능성이 높아집니다.</strong> 이런 방식은 최신성과 관련성을 모두 고려하는 동적인 검색 결과를 제공합니다.</p>
<p>특히, <code>decay_rate</code> 는 리트리버의 객체가 생성된 이후가 아니라 <strong>마지막으로 액세스된 이후 경과된 시간</strong> 을 의미합니다. 즉, 자주 액세스하는 객체는 ’최신’으로 유지됩니다.</p>
<div id="4885fe96" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="4ff4366d" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
<section id="낮은-감쇠율low-decay_rate" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="낮은-감쇠율low-decay_rate"><span class="header-section-number">1</span> 낮은 감쇠율(low decay_rate)</h2>
<ul>
<li><p><code>decay rate</code> 가 낮다는 것은 (여기서는 극단적으로 0에 가깝게 설정할 것입니다) <strong>기억이 더 오래 “기억될”</strong> 것임을 의미합니다.</p></li>
<li><p><code>decay rate</code> 가 <strong>0 이라는 것은 기억이 절대 잊혀지지 않는다</strong>는 것을 의미하며, 이는 이 retriever를 vector lookup과 동등하게 만듭니다.</p></li>
</ul>
<p><code>TimeWeightedVectorStoreRetriever</code>를 초기화하며, 벡터 저장소, 감쇠율(<code>decay_rate</code>)을 매우 작은 값으로 설정하고, 검색할 벡터의 개수(k)를 1로 지정합니다.</p>
<div id="7c335260" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datetime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime, timedelta</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> faiss</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.docstore <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> InMemoryDocstore</span>
<span id="cb3-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TimeWeightedVectorStoreRetriever</span>
<span id="cb3-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb3-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.documents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Document</span>
<span id="cb3-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb3-9"></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임베딩 모델을 정의합니다.</span></span>
<span id="cb3-11">embeddings_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-embedding-3-small"</span>)</span>
<span id="cb3-12"></span>
<span id="cb3-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소를 빈 상태로 초기화합니다.</span></span>
<span id="cb3-14">embedding_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1536</span></span>
<span id="cb3-15">index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> faiss.IndexFlatL2(embedding_size)</span>
<span id="cb3-16">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS(embeddings_model, index, InMemoryDocstore({}), {})</span>
<span id="cb3-17"></span>
<span id="cb3-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 시간 가중치가 적용된 벡터 저장소 검색기를 초기화합니다. (여기서는, 낮은 감쇠율을 적용합니다)</span></span>
<span id="cb3-19">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TimeWeightedVectorStoreRetriever(</span>
<span id="cb3-20">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore, decay_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0000000000000000000000001</span>, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-21">)</span></code></pre></div></div>
</details>
</div>
<p>간단한 예제 데이터를 추가합니다.</p>
<div id="51d7ad5d" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 어제 날짜를 계산합니다.</span></span>
<span id="cb4-2">yesterday <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.now() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> timedelta(days<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-3"></span>
<span id="cb4-4">retriever.add_documents(</span>
<span id="cb4-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 추가하고, metadata에 어제 날짜를 설정합니다.</span></span>
<span id="cb4-6">    [</span>
<span id="cb4-7">        Document(</span>
<span id="cb4-8">            page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트 구독해 주세요."</span>,</span>
<span id="cb4-9">            metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"last_accessed_at"</span>: yesterday},</span>
<span id="cb4-10">        )</span>
<span id="cb4-11">    ]</span>
<span id="cb4-12">)</span>
<span id="cb4-13"></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 다른 문서를 추가합니다. metadata는 별도로 설정하지 않았습니다.</span></span>
<span id="cb4-15">retriever.add_documents([Document(page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트 구독 해주실꺼죠? Please!"</span>)])</span></code></pre></div></div>
</details>
</div>
<p><code>retriever.invoke()</code> 를 호출하여 검색을 수행합니다.</p>
<ul>
<li>이는 가장 두드러진(salient) 문서이기 때문입니다.</li>
<li><code>decay_rate</code> 가 <strong>0에 가깝기 때문</strong> 에 문서는 여전히 최신(recent)으로 간주됩니다.</li>
</ul>
<div id="63912716" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># "테디노트 구독해 주세요." 가 가장 먼저 반환되는 이유는 가장 두드러지기 때문이며</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 감쇠율이 0에 가깝기 때문에 여전히 최신 상태를 유지하고 있음을 의미합니다.</span></span>
<span id="cb5-3">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트"</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="높음-감쇠율high-decay_rate" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="높음-감쇠율high-decay_rate"><span class="header-section-number">2</span> 높음 감쇠율(high decay_rate)</h2>
<p>높은 <code>decay_rate</code>(예: 0.9999…)를 사용하면 <code>recency score</code>가 빠르게 0으로 수렴합니다.</p>
<p>(만약 이 값을 1로 설정하면 모든 객체의 <code>recency</code> 값이 0이 되어, Vector Lookup 과 동일한 결과를 얻게 됩니다.)</p>
<p><code>TimeWeightedVectorStoreRetriever</code>를 사용하여 검색기를 초기화합니다. <code>decay_rate</code>를 0.999로 설정하여 시간에 따른 가중치 감소율을 조정합니다.</p>
<div id="2891e7d1" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임베딩 모델을 정의합니다.</span></span>
<span id="cb6-2">embeddings_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-embedding-3-small"</span>)</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소를 빈 상태로 초기화합니다.</span></span>
<span id="cb6-5">embedding_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1536</span></span>
<span id="cb6-6">index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> faiss.IndexFlatL2(embedding_size)</span>
<span id="cb6-7">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS(embeddings_model, index, InMemoryDocstore({}), {})</span>
<span id="cb6-8"></span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 시간 가중치가 적용된 벡터 저장소 검색기를 초기화합니다.</span></span>
<span id="cb6-10">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TimeWeightedVectorStoreRetriever(</span>
<span id="cb6-11">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore, decay_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.999</span>, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-12">)</span></code></pre></div></div>
</details>
</div>
<p>다시 문서를 새롭게 추가합니다.</p>
<div id="227a4317" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 어제 날짜를 계산합니다.</span></span>
<span id="cb7-2">yesterday <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.now() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> timedelta(days<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb7-3"></span>
<span id="cb7-4">retriever.add_documents(</span>
<span id="cb7-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 추가하고, metadata에 어제 날짜를 설정합니다.</span></span>
<span id="cb7-6">    [</span>
<span id="cb7-7">        Document(</span>
<span id="cb7-8">            page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트 구독해 주세요."</span>,</span>
<span id="cb7-9">            metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"last_accessed_at"</span>: yesterday},</span>
<span id="cb7-10">        )</span>
<span id="cb7-11">    ]</span>
<span id="cb7-12">)</span>
<span id="cb7-13"></span>
<span id="cb7-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 다른 문서를 추가합니다. metadata는 별도로 설정하지 않았습니다.</span></span>
<span id="cb7-15">retriever.add_documents([Document(page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트 구독 해주실꺼죠? Please!"</span>)])</span></code></pre></div></div>
</details>
</div>
<p><code>retriever.invoke("테디노트")</code> 를 호출하면 <code>""테디노트 구독 해주실꺼죠? Please!""</code> 가 먼저 반환됩니다. - 이는 retriever가 “테디노트 구독해 주세요.” 와 관련된 문서를 대부분 잊어버렸기 때문입니다.</p>
<div id="9c85ae8b" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 후 결과확인</span></span>
<span id="cb8-2">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트"</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="감쇠율decay_rate-정리" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="감쇠율decay_rate-정리"><span class="header-section-number">3</span> 감쇠율(decay_rate) 정리</h2>
<ul>
<li><code>decay_rate</code> 를 0.000001 로 매우 작게 설정한 경우
<ul>
<li>감쇠율(즉, 정보를 망각하는 비율)이 매우 낮기 때문에 정보를 거의 잊지 않습니다.</li>
<li>따라서, <strong>최신 정보이든 오래된 정보든 시간 가중치 차이가 거의 없습니다.</strong> 이럴때는 유사도에 더 높은 점수를 주게 됩니다.</li>
</ul></li>
<li><code>decay_rate</code> 를 0.999 로 1에 가깝게 설정한 경우
<ul>
<li>감쇠율(즉, 정보를 망각하는 비율)이 매우 높습니다. 따라서, 과거의 정보는 거의다 잊어버립니다.</li>
<li>따라서, 이러한 경우는 최신 정보에 더 높은 점수를 주게 됩니다.</li>
</ul></li>
</ul>
</section>
<section id="가상의-시간으로-decay_rate-조정" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="가상의-시간으로-decay_rate-조정"><span class="header-section-number">4</span> 가상의 시간으로 <code>decay_rate</code> 조정</h2>
<p>LangChain의 일부 유틸리티를 사용하면 시간 구성 요소를 모의(mock) 테스트 할 수 있습니다.</p>
<ul>
<li><code>mock_now</code> 함수는 LangChain에서 제공하는 유틸리티 함수로, 현재 시간을 모의(mock)하는 데 사용됩니다.</li>
</ul>
<div id="081e96d0" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime</span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.utils <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> mock_now</span>
<span id="cb9-4"></span>
<span id="cb9-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 현재 시간을 특정 시점으로 설정</span></span>
<span id="cb9-6">mock_now(datetime.datetime(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">00</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">00</span>))</span>
<span id="cb9-7"></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 현재 시간 출력</span></span>
<span id="cb9-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(datetime.datetime.now())</span></code></pre></div></div>
</details>
</div>
<p><code>mock_now</code> 함수를 사용하여 현재 시간을 변경하면서 검색 결과를 테스트할 수 있습니다.</p>
<ul>
<li>해당 기능을 활용하여 적절한 <code>decay_rate</code> 를 찾는데 도움을 받을 수 있습니다.</li>
</ul>
<p>[주의] 만약 너무 오래전의 시간으로 설정하면, decay_rate 계산시 오류가 발생할 수 있습니다.</p>
<div id="96bebb2e" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 현재 시간을 임의의 시간으로 변경합니다.</span></span>
<span id="cb10-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> mock_now(datetime.datetime(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">00</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">00</span>)):</span>
<span id="cb10-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 변경된 시점에서 문서를 검색합니다.</span></span>
<span id="cb10-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트"</span>))</span></code></pre></div></div>
</details>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/09-TimeWeightedVectorStoreRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>벡터스토어 기반 검색기(VectorStore-backed Retriever)</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/01-VectorStoreRetriever.html</link>
  <description><![CDATA[ 






<p><strong>VectorStore 지원 검색기</strong> 는 vector store를 사용하여 문서를 검색하는 retriever입니다.</p>
<p>Vector store에 구현된 <strong>유사도 검색(similarity search)</strong> 이나 <strong>MMR</strong> 과 같은 검색 메서드를 사용하여 vector store 내의 텍스트를 쿼리합니다.</p>
<p>아래의 코드를 실행하여 VectorStore 를 생성합니다.</p>
<div id="137bd65d" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="329e78b6" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="ee9b98ed" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> CharacterTextSplitter</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TextLoader</span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TextLoader를 사용하여 파일을 로드합니다.</span></span>
<span id="cb3-7">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TextLoader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./data/appendix-keywords.txt"</span>)</span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 로드합니다.</span></span>
<span id="cb3-10">documents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loader.load()</span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문자 기반으로 텍스트를 분할하는 CharacterTextSplitter를 생성합니다. 청크 크기는 300이고 청크 간 중복은 없습니다.</span></span>
<span id="cb3-13">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-14"></span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 로드된 문서를 분할합니다.</span></span>
<span id="cb3-16">split_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> text_splitter.split_documents(documents)</span>
<span id="cb3-17"></span>
<span id="cb3-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># OpenAI 임베딩을 생성합니다.</span></span>
<span id="cb3-19">embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings()</span>
<span id="cb3-20"></span>
<span id="cb3-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 분할된 텍스트와 임베딩을 사용하여 FAISS 벡터 데이터베이스를 생성합니다.</span></span>
<span id="cb3-22">db <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS.from_documents(split_docs, embeddings)</span></code></pre></div></div>
</details>
</div>
<section id="vectorstore에서-vectorstoreretriever-초기화as_retriever" class="level3" data-number="0.1">
<h3 data-number="0.1" class="anchored" data-anchor-id="vectorstore에서-vectorstoreretriever-초기화as_retriever"><span class="header-section-number">0.1</span> VectorStore에서 VectorStoreRetriever 초기화(as_retriever)</h3>
<p><code>as_retriever</code> 메서드는 VectorStore 객체를 기반으로 VectorStoreRetriever를 초기화하고 반환합니다. 이 메서드를 통해 다양한 검색 옵션을 설정하여 사용자의 요구에 맞는 문서 검색을 수행할 수 있습니다.</p>
<p><strong>매개변수(parameters)</strong></p>
<ul>
<li><code>**kwargs</code>: 검색 함수에 전달할 키워드 인자
<ul>
<li><code>search_type</code>: 검색 유형 (“similarity”, “mmr”, “similarity_score_threshold”)</li>
<li><code>search_kwargs</code>: 추가 검색 옵션
<ul>
<li><code>k</code>: 반환할 문서 수 (기본값: 4)</li>
<li><code>score_threshold</code>: similarity_score_threshold 검색의 최소 유사도 임계값</li>
<li><code>fetch_k</code>: MMR 알고리즘에 전달할 문서 수 (기본값: 20)</li>
<li><code>lambda_mult</code>: MMR 결과의 다양성 조절 (0-1 사이, 기본값: 0.5)</li>
<li><code>filter</code>: 문서 메타데이터 기반 필터링</li>
</ul></li>
</ul></li>
</ul>
<p><strong>반환값(return)</strong></p>
<ul>
<li><code>VectorStoreRetriever</code>: 초기화된 VectorStoreRetriever 객체</li>
</ul>
<p><strong>참고</strong></p>
<ul>
<li>다양한 검색 전략 구현 가능 (유사도, MMR, 임계값 기반)</li>
<li>MMR (Maximal Marginal Relevance) 알고리즘으로 검색 결과의 다양성 조절 가능</li>
<li>메타데이터 필터링으로 특정 조건의 문서만 검색 가능</li>
<li><code>tags</code> 매개변수를 통해 검색기에 태그 추가 가능</li>
</ul>
<p><strong>주의사항</strong></p>
<ul>
<li><code>search_type</code>과 <code>search_kwargs</code>의 적절한 조합 필요</li>
<li>MMR 사용 시 <code>fetch_k</code>와 <code>k</code> 값의 균형 조절 필요</li>
<li><code>score_threshold</code> 설정 시 너무 높은 값은 검색 결과가 없을 수 있음</li>
<li>필터 사용 시 데이터셋의 메타데이터 구조 정확히 파악 필요</li>
<li><code>lambda_mult</code> 값이 0에 가까울수록 다양성이 높아지고, 1에 가까울수록 유사성이 높아짐</li>
</ul>
<div id="f79a365f" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 데이터베이스를 검색기로 사용하기 위해 retriever 변수에 할당</span></span>
<span id="cb4-2">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.as_retriever()</span></code></pre></div></div>
</details>
</div>
</section>
<section id="retriever의-invoke" class="level3" data-number="0.2">
<h3 data-number="0.2" class="anchored" data-anchor-id="retriever의-invoke"><span class="header-section-number">0.2</span> Retriever의 invoke()</h3>
<p><code>invoke</code> 메서드는 Retriever의 주요 진입점으로, 관련 문서를 검색하는 데 사용됩니다. 이 메서드는 동기적으로 Retriever를 호출하여 주어진 쿼리에 대한 관련 문서를 반환합니다.</p>
<p><strong>매개변수(parameters)</strong></p>
<ul>
<li><code>input</code>: 검색 쿼리 문자열</li>
<li><code>config</code>: Retriever 구성 (Optional[RunnableConfig])</li>
<li><code>**kwargs</code>: Retriever에 전달할 추가 인자</li>
</ul>
<p><strong>반환값(return)</strong></p>
<ul>
<li><code>List[Document]</code>: 관련 문서 목록</li>
</ul>
<div id="b8e39091" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb5-2">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"임베딩(Embedding)은 무엇인가요?"</span>)</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs:</span>
<span id="cb5-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb5-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="max-marginal-relevance-mmr" class="level3" data-number="0.3">
<h3 data-number="0.3" class="anchored" data-anchor-id="max-marginal-relevance-mmr"><span class="header-section-number">0.3</span> Max Marginal Relevance (MMR)</h3>
<p><code>MMR(Maximal Marginal Relevance)</code> 방식은 쿼리에 대한 관련 항목을 검색할 때 검색된 문서의 <strong>중복</strong> 을 피하는 방법 중 하나입니다.</p>
<p>단순히 가장 관련성 높은 항목들만을 검색하는 대신, MMR은 쿼리에 대한 <strong>문서의 관련성</strong> 과 이미 선택된 <strong>문서들과의 차별성을 동시에 고려</strong> 합니다.</p>
<ul>
<li><code>search_type</code> 매개변수를 <code>"mmr"</code> 로 설정하여 <strong>MMR(Maximal Marginal Relevance)</strong> 검색 알고리즘을 사용합니다.</li>
<li><code>k</code>: 반환할 문서 수 (기본값: 4)</li>
<li><code>fetch_k</code>: MMR 알고리즘에 전달할 문서 수 (기본값: 20)</li>
<li><code>lambda_mult</code>: MMR 결과의 다양성 조절 (0~1, 기본값: 0.5, 0: 유사도 점수만 고려, 1: 다양성만 고려)</li>
</ul>
<div id="8144a926" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MMR(Maximal Marginal Relevance) 검색 유형을 지정</span></span>
<span id="cb6-2">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.as_retriever(</span>
<span id="cb6-3">    search_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmr"</span>, search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fetch_k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lambda_mult"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>}</span>
<span id="cb6-4">)</span>
<span id="cb6-5"></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색합니다.</span></span>
<span id="cb6-7">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"임베딩(Embedding)은 무엇인가요?"</span>)</span>
<span id="cb6-8"></span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb6-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs:</span>
<span id="cb6-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb6-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="유사도-점수-임계값-검색similarity_score_threshold" class="level3" data-number="0.4">
<h3 data-number="0.4" class="anchored" data-anchor-id="유사도-점수-임계값-검색similarity_score_threshold"><span class="header-section-number">0.4</span> 유사도 점수 임계값 검색(similarity_score_threshold)</h3>
<p>유사도 점수 임계값을 설정하고 해당 임계값 이상의 점수를 가진 문서만 반환하는 검색 방법을 설정할 수 있습니다.</p>
<p>임계값을 적절히 설정함으로써 <strong>관련성이 낮은 문서를 필터링</strong> 하고, 질의와 <strong>가장 유사한 문서만 선별</strong> 할 수 있습니다.</p>
<ul>
<li><p><code>search_type</code> 매개변수를 <code>"similarity_score_threshold"</code> 로 설정하여 유사도 점수 임계값을 기준으로 검색을 수행합니다.</p></li>
<li><p><code>search_kwargs</code> 매개변수에 <code>{"score_threshold": 0.8}</code>를 전달하여 유사도 점수 임계값을 0.8로 설정합니다. 이는 검색 결과의 <strong>유사도 점수가 0.8 이상인 문서만 반환됨</strong> 을 의미합니다.</p></li>
</ul>
<div id="b6509f52" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.as_retriever(</span>
<span id="cb7-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 유형을 "similarity_score_threshold 으로 설정</span></span>
<span id="cb7-3">    search_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"similarity_score_threshold"</span>,</span>
<span id="cb7-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임계값 설정</span></span>
<span id="cb7-5">    search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"score_threshold"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>},</span>
<span id="cb7-6">)</span>
<span id="cb7-7"></span>
<span id="cb7-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb7-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Word2Vec 은 무엇인가요?"</span>):</span>
<span id="cb7-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb7-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="top_k-설정" class="level3" data-number="0.5">
<h3 data-number="0.5" class="anchored" data-anchor-id="top_k-설정"><span class="header-section-number">0.5</span> top_k 설정</h3>
<p>검색 시 사용할 <code>k</code> 와 같은 검색 키워드 인자(kwargs)를 지정할 수 있습니다.</p>
<p><code>k</code> 매개변수는 검색 결과에서 반환할 상위 결과의 개수를 나타냅니다.</p>
<ul>
<li><code>search_kwargs</code>에서 <code>k</code> 매개변수를 1로 설정하여 검색 결과로 반환할 문서의 수를 지정합니다.</li>
</ul>
<div id="081e0134" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># k 설정</span></span>
<span id="cb8-2">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.as_retriever(search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>})</span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb8-5">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"임베딩(Embedding)은 무엇인가요?"</span>)</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb8-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs:</span>
<span id="cb8-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb8-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="동적-설정configurable" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="동적-설정configurable"><span class="header-section-number">1</span> 동적 설정(Configurable)</h2>
<ul>
<li>검색 설정을 동적으로 조정하기 위해 <code>ConfigurableField</code> 를 사용합니다.</li>
<li><code>ConfigurableField</code> 는 검색 매개변수의 고유 식별자, 이름, 설명을 설정하는 역할을 합니다.</li>
<li>검색 설정을 조정하기 위해 <code>config</code> 매개변수를 사용하여 검색 설정을 지정합니다.</li>
<li>검색 설정은 <code>config</code> 매개변수에 전달된 딕셔너리의 <code>configurable</code> 키에 저장됩니다.</li>
<li>검색 설정은 검색 쿼리와 함께 전달되며, 검색 쿼리에 따라 동적으로 조정됩니다.</li>
</ul>
<div id="bc25029f" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.runnables <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ConfigurableField</span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># k 설정</span></span>
<span id="cb9-4">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.as_retriever(search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}).configurable_fields(</span>
<span id="cb9-5">    search_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ConfigurableField(</span>
<span id="cb9-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"search_type"</span>,</span>
<span id="cb9-7">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Search Type"</span>,</span>
<span id="cb9-8">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The search type to use"</span>,</span>
<span id="cb9-9">    ),</span>
<span id="cb9-10">    search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ConfigurableField(</span>
<span id="cb9-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 매개변수의 고유 식별자를 설정</span></span>
<span id="cb9-12">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"search_kwargs"</span>,</span>
<span id="cb9-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 매개변수의 이름을 설정</span></span>
<span id="cb9-14">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Search Kwargs"</span>,</span>
<span id="cb9-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 매개변수에 대한 설명을 작성</span></span>
<span id="cb9-16">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The search kwargs to use"</span>,</span>
<span id="cb9-17">    ),</span>
<span id="cb9-18">)</span></code></pre></div></div>
</details>
</div>
<p>아래는 동적 검색설정을 적용한 예시입니다.</p>
<div id="f2da4f32" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 설정을 지정. Faiss 검색에서 k=3로 설정하여 가장 유사한 문서 3개를 반환</span></span>
<span id="cb10-2">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"search_kwargs"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>}}}</span>
<span id="cb10-3"></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb10-5">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"임베딩(Embedding)은 무엇인가요?"</span>, config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config)</span>
<span id="cb10-6"></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb10-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs:</span>
<span id="cb10-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb10-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span></code></pre></div></div>
</details>
</div>
<div id="48f53c12" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 설정을 지정. score_threshold 0.8 이상의 점수를 가진 문서만 반환</span></span>
<span id="cb11-2">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb11-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {</span>
<span id="cb11-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"search_type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"similarity_score_threshold"</span>,</span>
<span id="cb11-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"search_kwargs"</span>: {</span>
<span id="cb11-6">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"score_threshold"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>,</span>
<span id="cb11-7">        },</span>
<span id="cb11-8">    }</span>
<span id="cb11-9">}</span>
<span id="cb11-10"></span>
<span id="cb11-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb11-12">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Word2Vec 은 무엇인가요?"</span>, config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config)</span>
<span id="cb11-13"></span>
<span id="cb11-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb11-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs:</span>
<span id="cb11-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb11-17">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span></code></pre></div></div>
</details>
</div>
<div id="951851c8" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 설정을 지정. mmr 검색 설정.</span></span>
<span id="cb12-2">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb12-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {</span>
<span id="cb12-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"search_type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmr"</span>,</span>
<span id="cb12-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"search_kwargs"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fetch_k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lambda_mult"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>},</span>
<span id="cb12-6">    }</span>
<span id="cb12-7">}</span>
<span id="cb12-8"></span>
<span id="cb12-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb12-10">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Word2Vec 은 무엇인가요?"</span>, config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config)</span>
<span id="cb12-11"></span>
<span id="cb12-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb12-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs:</span>
<span id="cb12-14">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb12-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="upstage-임베딩과-같이-query-passage-embedding-model-이-분리된-경우" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="upstage-임베딩과-같이-query-passage-embedding-model-이-분리된-경우"><span class="header-section-number">2</span> Upstage 임베딩과 같이 Query &amp; Passage embedding model 이 분리된 경우</h2>
<p>기본 retriever는 쿼리와 문서에 대해 동일한 임베딩 모델을 사용합니다.</p>
<p>하지만 쿼리와 문서에 대해 서로 다른 임베딩 모델을 사용하는 경우가 있습니다.</p>
<p>이러한 경우에는 쿼리 임베딩 모델을 사용하여 쿼리를 임베딩하고, 문서 임베딩 모델을 사용하여 문서를 임베딩합니다.</p>
<p>이렇게 하면 쿼리와 문서에 대해 서로 다른 임베딩 모델을 사용할 수 있습니다.</p>
<div id="6b51093b" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb13-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> CharacterTextSplitter</span>
<span id="cb13-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TextLoader</span>
<span id="cb13-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_upstage <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> UpstageEmbeddings</span>
<span id="cb13-5"></span>
<span id="cb13-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TextLoader를 사용하여 파일을 로드합니다.</span></span>
<span id="cb13-7">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TextLoader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./data/appendix-keywords.txt"</span>)</span>
<span id="cb13-8"></span>
<span id="cb13-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 로드합니다.</span></span>
<span id="cb13-10">documents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loader.load()</span>
<span id="cb13-11"></span>
<span id="cb13-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문자 기반으로 텍스트를 분할하는 CharacterTextSplitter를 생성합니다. 청크 크기는 300이고 청크 간 중복은 없습니다.</span></span>
<span id="cb13-13">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb13-14"></span>
<span id="cb13-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 로드된 문서를 분할합니다.</span></span>
<span id="cb13-16">split_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> text_splitter.split_documents(documents)</span>
<span id="cb13-17"></span>
<span id="cb13-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Upstage 임베딩을 생성합니다. 문서용 모델을 사용합니다.</span></span>
<span id="cb13-19">doc_embedder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> UpstageEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solar-embedding-1-large-passage"</span>)</span>
<span id="cb13-20"></span>
<span id="cb13-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 분할된 텍스트와 임베딩을 사용하여 FAISS 벡터 데이터베이스를 생성합니다.</span></span>
<span id="cb13-22">db <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS.from_documents(split_docs, doc_embedder)</span></code></pre></div></div>
</details>
</div>
<p>아래는 쿼리용 Upstage 임베딩을 생성하고, 쿼리 문장을 벡터로 변환하여 벡터 유사도 검색을 수행하는 예시입니다.</p>
<div id="aa46e289" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 쿼리용 Upstage 임베딩을 생성합니다. 쿼리용 모델을 사용합니다.</span></span>
<span id="cb14-2">query_embedder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> UpstageEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solar-embedding-1-large-query"</span>)</span>
<span id="cb14-3"></span>
<span id="cb14-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 쿼리 문장을 벡터로 변환합니다.</span></span>
<span id="cb14-5">query_vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query_embedder.embed_query(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"임베딩(Embedding)은 무엇인가요?"</span>)</span>
<span id="cb14-6"></span>
<span id="cb14-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 유사도 검색을 수행하여 가장 유사한 2개의 문서를 반환합니다.</span></span>
<span id="cb14-8">db.similarity_search_by_vector(query_vector, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div></div>
</details>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/01-VectorStoreRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>긴 문맥 재정렬(LongContextReorder)</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/04-LongContextReorder.html</link>
  <description><![CDATA[ 






<p>모델의 아키텍처와 상관없이, 10개 이상의 검색된 문서를 포함할 경우 성능이 상당히 저하됩니다.</p>
<p>간단히 말해, 모델이 긴 컨텍스트 중간에 있는 관련 정보에 접근해야 할 때, 제공된 문서를 무시하는 경향이 있습니다.</p>
<p>자세한 내용은 다음 논문을 참조하세요</p>
<ul>
<li>https://arxiv.org/abs/2307.03172</li>
</ul>
<p>이 문제를 피하기 위해, 검색 후 문서의 순서를 재배열하여 성능 저하를 방지할 수 있습니다.</p>
<section id="문제의-원인" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="문제의-원인"><span class="header-section-number">1</span> 문제의 원인</h2>
<p>LLM 은 두괄식으로 학습이 되어있어서 입력으로 들어온 텍스트에 대해 앞쪽 문서와 뒤쪽 문서를 중요하다고 생각한다. 그러나, Retreval 으로 가져온 결과들은 유사도 기반으로 정렬이 되어있는 문서이기 때문에 그대로 LLM 으로 입력을 했을 때 올바른 결과를 내어주지 못한다.</p>
<ul>
<li><code>Chroma</code> 벡터 저장소를 사용하여 텍스트 데이터를 저장하고 검색할 수 있는 <code>retriever</code>를 생성합니다.</li>
<li><code>retriever</code>의 <code>invoke</code> 메서드를 사용하여 주어진 쿼리에 대해 관련성이 높은 문서를 검색합니다.</li>
</ul>
<div id="1a914221" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="0d337cfb" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="089f999e" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PromptTemplate</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LongContextReorder</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chroma</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb3-5"></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임베딩을 가져옵니다.</span></span>
<span id="cb3-8">embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-embedding-3-small"</span>)</span>
<span id="cb3-9"></span>
<span id="cb3-10">texts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb3-11">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"이건 그냥 내가 아무렇게나 적어본 글입니다."</span>,</span>
<span id="cb3-12">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"사용자와 대화하는 것처럼 설계된 AI인 ChatGPT는 다양한 질문에 답할 수 있습니다."</span>,</span>
<span id="cb3-13">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"아이폰, 아이패드, 맥북 등은 애플이 출시한 대표적인 제품들입니다."</span>,</span>
<span id="cb3-14">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"챗GPT는 OpenAI에 의해 개발되었으며, 지속적으로 개선되고 있습니다."</span>,</span>
<span id="cb3-15">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"챗지피티는 사용자의 질문을 이해하고 적절한 답변을 생성하기 위해 대량의 데이터를 학습했습니다."</span>,</span>
<span id="cb3-16">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"애플 워치와 에어팟 같은 웨어러블 기기도 애플의 인기 제품군에 속합니다."</span>,</span>
<span id="cb3-17">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChatGPT는 복잡한 문제를 해결하거나 창의적인 아이디어를 제안하는 데에도 사용될 수 있습니다."</span>,</span>
<span id="cb3-18">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"비트코인은 디지털 금이라고도 불리며, 가치 저장 수단으로서 인기를 얻고 있습니다."</span>,</span>
<span id="cb3-19">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChatGPT의 기능은 지속적인 학습과 업데이트를 통해 더욱 발전하고 있습니다."</span>,</span>
<span id="cb3-20">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FIFA 월드컵은 네 번째 해마다 열리며, 국제 축구에서 가장 큰 행사입니다."</span>,</span>
<span id="cb3-21">]</span>
<span id="cb3-22"></span>
<span id="cb3-23"></span>
<span id="cb3-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색기를 생성합니다. (K는 10으로 설정합니다)</span></span>
<span id="cb3-25">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma.from_texts(texts, embedding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings).as_retriever(</span>
<span id="cb3-26">    search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>}</span>
<span id="cb3-27">)</span></code></pre></div></div>
</details>
</div>
<p>검색기에 쿼리를 입력하여 검색을 수행합니다.</p>
<div id="2871aeaf" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChatGPT에 대해 무엇을 말해줄 수 있나요?"</span></span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련성 점수에 따라 정렬된 관련 문서를 가져옵니다.</span></span>
<span id="cb4-4">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(query)</span>
<span id="cb4-5">docs</span></code></pre></div></div>
</details>
</div>
<p><code>LongContextReorder</code> 클래스의 인스턴스인 <code>reordering</code>을 생성합니다.</p>
<ul>
<li><code>reordering.transform_documents(docs)</code>를 호출하여 문서 목록 <code>docs</code>를 재정렬합니다.
<ul>
<li>덜 관련된 문서는 목록의 중간에 위치하고, 더 관련된 문서는 시작과 끝에 위치하도록 재정렬됩니다.</li>
</ul></li>
</ul>
<div id="ae93a9a1" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 재정렬합니다</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 덜 관련된 문서는 목록의 중간에 위치하고 더 관련된 요소는 시작/끝에 위치합니다.</span></span>
<span id="cb5-3">reordering <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LongContextReorder()</span>
<span id="cb5-4">reordered_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reordering.transform_documents(docs)</span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4개의 관련 문서가 시작과 끝에 위치하는지 확인합니다.</span></span>
<span id="cb5-7">reordered_docs</span></code></pre></div></div>
</details>
</div>
</section>
<section id="context-reordering을-사용하여-질의-응답-체인-생성" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="context-reordering을-사용하여-질의-응답-체인-생성"><span class="header-section-number">2</span> Context Reordering을 사용하여 질의-응답 체인 생성</h2>
<div id="1f2ea0a4" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> format_docs(docs):</span>
<span id="cb6-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join([doc.page_content <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(docs)])</span></code></pre></div></div>
</details>
</div>
<div id="4a645502" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(format_docs(docs))</span></code></pre></div></div>
</details>
</div>
<div id="2c9b07e1" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> format_docs(docs):</span>
<span id="cb8-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join(</span>
<span id="cb8-3">        [</span>
<span id="cb8-4">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"[</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">] </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> [source: teddylee777@gmail.com]"</span></span>
<span id="cb8-5">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(docs)</span>
<span id="cb8-6">        ]</span>
<span id="cb8-7">    )</span>
<span id="cb8-8"></span>
<span id="cb8-9"></span>
<span id="cb8-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> reorder_documents(docs):</span>
<span id="cb8-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 재정렬</span></span>
<span id="cb8-12">    reordering <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LongContextReorder()</span>
<span id="cb8-13">    reordered_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reordering.transform_documents(docs)</span>
<span id="cb8-14">    combined <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> format_docs(reordered_docs)</span>
<span id="cb8-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(combined)</span>
<span id="cb8-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> combined</span></code></pre></div></div>
</details>
</div>
<p>재정렬된 문서를 출력합니다.</p>
<div id="a193bc14" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 재정렬된 문서를 출력</span></span>
<span id="cb9-2">_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reorder_documents(docs)</span></code></pre></div></div>
</details>
</div>
<div id="703afe03" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate</span>
<span id="cb10-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> operator <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> itemgetter</span>
<span id="cb10-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb10-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.output_parsers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StrOutputParser</span>
<span id="cb10-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.runnables <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RunnableLambda</span>
<span id="cb10-6"></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트 템플릿</span></span>
<span id="cb10-8">template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""Given this text extracts:</span></span>
<span id="cb10-9"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{context}</span></span>
<span id="cb10-10"></span>
<span id="cb10-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-----</span></span>
<span id="cb10-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Please answer the following question:</span></span>
<span id="cb10-13"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{question}</span></span>
<span id="cb10-14"></span>
<span id="cb10-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Answer in the following languages: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{language}</span></span>
<span id="cb10-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb10-17"></span>
<span id="cb10-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트 정의</span></span>
<span id="cb10-19">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_template(template)</span>
<span id="cb10-20"></span>
<span id="cb10-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Chain 정의</span></span>
<span id="cb10-22">chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb10-23">    {</span>
<span id="cb10-24">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"context"</span>: itemgetter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>)</span>
<span id="cb10-25">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> retriever</span>
<span id="cb10-26">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> RunnableLambda(reorder_documents),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질문을 기반으로 문맥을 검색합니다.</span></span>
<span id="cb10-27">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: itemgetter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질문을 추출합니다.</span></span>
<span id="cb10-28">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"language"</span>: itemgetter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"language"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 답변 언어를 추출합니다.</span></span>
<span id="cb10-29">    }</span>
<span id="cb10-30">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> prompt  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트 템플릿에 값을 전달합니다.</span></span>
<span id="cb10-31">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 언어 모델에 프롬프트를 전달합니다.</span></span>
<span id="cb10-32">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 모델의 출력을 문자열로 파싱합니다.</span></span>
<span id="cb10-33">)</span></code></pre></div></div>
</details>
</div>
<p><code>question</code> 에 쿼리를 입력하고 <code>language</code> 에 언어를 입력합니다.</p>
<ul>
<li>재정렬된 문서의 검색 결과도 확인합니다.</li>
</ul>
<div id="9249067c" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">answer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chain.invoke(</span>
<span id="cb11-2">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChatGPT에 대해 무엇을 말해줄 수 있나요?"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"language"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"KOREAN"</span>}</span>
<span id="cb11-3">)</span></code></pre></div></div>
</details>
</div>
<p>답변을 출력합니다.</p>
<div id="2ef4b288" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(answer)</span></code></pre></div></div>
</details>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/04-LongContextReorder.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
<item>
  <title>다중 벡터저장소 검색기(MultiVectorRetriever)</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/07-MultiVectorRetriever.html</link>
  <description><![CDATA[ 






<p>LangChain에서는 문서를 다양한 상황에서 효율적으로 쿼리할 수 있는 특별한 기능, 바로 <code>MultiVectorRetriever</code>를 제공합니다. 이 기능을 사용하면 문서를 여러 벡터로 저장하고 관리할 수 있어, 정보 검색의 정확도와 효율성을 대폭 향상시킬 수 있습니다.</p>
<p><code>MultiVectorRetriever</code>를 활용해 문서당 여러 벡터를 생성하는 몇 가지 방법을 살펴보겠습니다.</p>
<p><strong>문서당 여러 벡터 생성 방법 소개</strong></p>
<ol type="1">
<li><p><strong>작은 청크 생성</strong>: 문서를 더 작은 단위로 나눈 후, 각 청크에 대해 별도의 임베딩을 생성합니다. 이 방식을 사용하면 문서의 특정 부분에 좀 더 세심한 주의를 기울일 수 있습니다. 이 과정은 <code>ParentDocumentRetriever</code>를 통해 구현할 수 있어, 세부 정보에 대한 탐색이 용이해집니다.</p></li>
<li><p><strong>요약 임베딩</strong>: 각 문서의 요약을 생성하고, 이 요약으로부터 임베딩을 만듭니다. 이 요약 임베딩은 문서의 핵심 내용을 신속하게 파악하는 데 큰 도움이 됩니다. 문서 전체를 분석하는 대신 핵심적인 요약 부분만을 활용하여 효율성을 극대화할 수 있습니다.</p></li>
<li><p><strong>가설 질문 활용</strong>: 각 문서에 대해 적합한 가설 질문을 만들고, 이 질문에 기반한 임베딩을 생성합니다. 특정 주제나 내용에 대해 깊이 있는 탐색을 원할 때 이 방법이 유용합니다. 가설 질문은 문서의 내용을 다양한 관점에서 접근하게 해주며, 더 광범위한 이해를 가능하게 합니다.</p></li>
<li><p><strong>수동 추가 방식</strong>: 사용자가 문서 검색 시 고려해야 할 특정 질문이나 쿼리를 직접 추가할 수 있습니다. 이 방법을 통해 사용자는 검색 과정에서 보다 세밀한 제어를 할 수 있으며, 자신의 요구 사항에 맞춘 맞춤형 검색이 가능해집니다.</p></li>
</ol>
<section id="실습에-활용한-문서" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="실습에-활용한-문서"><span class="header-section-number">1</span> 실습에 활용한 문서</h2>
<p>소프트웨어정책연구소(SPRi) - 2023년 12월호</p>
<ul>
<li>저자: 유재흥(AI정책연구실 책임연구원), 이지수(AI정책연구실 위촉연구원)</li>
<li>링크: https://spri.kr/posts/view/23669</li>
<li>파일명: <code>SPRI_AI_Brief_2023년12월호_F.pdf</code></li>
</ul>
<p><strong>참고</strong>: 위의 파일은 <code>data</code> 폴더 내에 다운로드 받으세요</p>
<div id="18a2a1b0" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="26eac101" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
<p>텍스트 파일에서 데이터를 로드하고, 로드된 문서들을 지정된 크기로 분할하는 전처리 과정을 수행합니다.</p>
<p>분할된 문서들은 추후 벡터화 및 검색 등의 작업에 사용될 수 있습니다.</p>
<div id="0d6c52a3" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PyMuPDFLoader</span>
<span id="cb3-2"></span>
<span id="cb3-3">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PyMuPDFLoader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/SPRI_AI_Brief_2023년12월호_F.pdf"</span>)</span>
<span id="cb3-4">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loader.load()</span></code></pre></div></div>
</details>
</div>
<p>데이터로부터 로드한 원본 도큐먼트는 <code>docs</code> 변수에 담았습니다.</p>
<div id="12a50910" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>].page_content[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>])</span></code></pre></div></div>
</details>
</div>
</section>
<section id="chunk-원본-문서-검색" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="chunk-원본-문서-검색"><span class="header-section-number">2</span> Chunk + 원본 문서 검색</h2>
<p>대용량 정보를 검색하는 경우, 더 작은 단위로 정보를 임베딩하는 것이 유용할 수 있습니다.</p>
<p><code>MultiVectorRetriever</code> 를 통해 문서를 여러 벡터로 저장하고 관리할 수 있습니다.</p>
<p><code>docstore</code> 에 원본 문서를 저장하고, <code>vectorstore</code> 에 임베딩된 문서를 저장합니다.</p>
<p>이로써 문서를 더 작은 단위로 나누어 더 정확한 검색이 가능해집니다. 때에 따라서는 원본 문서의 내용을 조회할 수 있습니다.</p>
<div id="8bc51c01" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 자식 청크를 인덱싱하는 데 사용할 벡터 저장소</span></span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> uuid</span>
<span id="cb5-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.storage <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> InMemoryStore</span>
<span id="cb5-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_chroma <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chroma</span>
<span id="cb5-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb5-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb5-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.multi_vector <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> MultiVectorRetriever</span>
<span id="cb5-8"></span>
<span id="cb5-9">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma(</span>
<span id="cb5-10">    collection_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"small_bigger_chunks"</span>,</span>
<span id="cb5-11">    embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>OpenAIEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-embedding-3-small"</span>),</span>
<span id="cb5-12">)</span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 부모 문서의 저장소 계층</span></span>
<span id="cb5-14">store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> InMemoryStore()</span>
<span id="cb5-15"></span>
<span id="cb5-16">id_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_id"</span></span>
<span id="cb5-17"></span>
<span id="cb5-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색기 (시작 시 비어 있음)</span></span>
<span id="cb5-19">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MultiVectorRetriever(</span>
<span id="cb5-20">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,</span>
<span id="cb5-21">    byte_store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>store,</span>
<span id="cb5-22">    id_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>id_key,</span>
<span id="cb5-23">)</span>
<span id="cb5-24"></span>
<span id="cb5-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 ID를 생성합니다.</span></span>
<span id="cb5-26">doc_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(uuid.uuid4()) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs]</span>
<span id="cb5-27"></span>
<span id="cb5-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 두개의 생성된 id를 확인합니다.</span></span>
<span id="cb5-29">doc_ids</span></code></pre></div></div>
</details>
</div>
<p>여기서 큰 청크로 분할하기 위한 <code>parent_text_splitter</code></p>
<p>더 작은 청크로 분할하기 위한 <code>child_text_splitter</code> 를 정의합니다.</p>
<div id="3bc95363" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># RecursiveCharacterTextSplitter 객체를 생성합니다.</span></span>
<span id="cb6-2">parent_text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>)</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 더 작은 청크를 생성하는 데 사용할 분할기</span></span>
<span id="cb6-5">child_text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span></code></pre></div></div>
</details>
</div>
<p>더 큰 Chunk인 Parent 문서를 생성합니다.</p>
<div id="f4437c9e" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">parent_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(docs):</span>
<span id="cb7-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 현재 문서의 ID를 가져옵니다.</span></span>
<span id="cb7-5">    _id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> doc_ids[i]</span>
<span id="cb7-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 현재 문서를 하위 문서로 분할</span></span>
<span id="cb7-7">    parent_doc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parent_text_splitter.split_documents([doc])</span>
<span id="cb7-8"></span>
<span id="cb7-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> parent_doc:</span>
<span id="cb7-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># metadata에 문서 ID 를 저장</span></span>
<span id="cb7-11">        _doc.metadata[id_key] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _id</span>
<span id="cb7-12">    parent_docs.extend(parent_doc)</span></code></pre></div></div>
</details>
</div>
<p><code>parent_docs</code> 에 기입된 <code>doc_id</code> 를 확인합니다.</p>
<div id="f8d7ff8b" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 생성된 Parent 문서의 메타데이터를 확인합니다.</span></span>
<span id="cb8-2">parent_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].metadata</span></code></pre></div></div>
</details>
</div>
<p>상대적으로 더 작은 Chunk인 Child 문서를 생성합니다.</p>
<div id="e56afe1a" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1">child_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb9-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(docs):</span>
<span id="cb9-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 현재 문서의 ID를 가져옵니다.</span></span>
<span id="cb9-4">    _id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> doc_ids[i]</span>
<span id="cb9-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 현재 문서를 하위 문서로 분할</span></span>
<span id="cb9-6">    child_doc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> child_text_splitter.split_documents([doc])</span>
<span id="cb9-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> child_doc:</span>
<span id="cb9-8">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># metadata에 문서 ID 를 저장</span></span>
<span id="cb9-9">        _doc.metadata[id_key] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _id</span>
<span id="cb9-10">    child_docs.extend(child_doc)</span></code></pre></div></div>
</details>
</div>
<p><code>child_docs</code> 에 기입된 <code>doc_id</code> 를 확인합니다.</p>
<div id="80857992" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 생성된 Child 문서의 메타데이터를 확인합니다.</span></span>
<span id="cb10-2">child_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].metadata</span></code></pre></div></div>
</details>
</div>
<p>각각 분할된 청크의 수를 확인합니다.</p>
<div id="6dfd9565" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"분할된 parent_docs의 개수: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(parent_docs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb11-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"분할된 child_docs의 개수: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(child_docs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
</div>
<p>벡터저장소에 새롭게 생성한 작게 쪼개진 하위문서 집합을 추가합니다.</p>
<p>다음으로는 상위 문서는 생성한 UUID 와 맵핑하여 <code>docstore</code> 에 추가합니다.</p>
<ul>
<li><code>mset()</code> 메서드를 통해 문서 ID와 문서 내용을 key-value 쌍으로 문서 저장소에 저장합니다.</li>
</ul>
<div id="a291a760" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소에 parent + child 문서를 추가</span></span>
<span id="cb12-2">retriever.vectorstore.add_documents(parent_docs)</span>
<span id="cb12-3">retriever.vectorstore.add_documents(child_docs)</span>
<span id="cb12-4"></span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># docstore 에 원본 문서를 저장</span></span>
<span id="cb12-6">retriever.docstore.mset(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(doc_ids, docs)))</span></code></pre></div></div>
</details>
</div>
<p>유사도 검색을 수행합니다. 가장 유사도가 높은 첫 번째 문서 조각을 출력합니다.</p>
<p>여기서 <code>retriever.vectorstore.similarity_search</code> 메서드는 child + parent 문서 chunk 내에서 검색을 수행합니다.</p>
<div id="a0d9ba0c" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vectorstore의 유사도 검색을 수행합니다.</span></span>
<span id="cb13-2">relevant_chunks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.vectorstore.similarity_search(</span>
<span id="cb13-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span></span>
<span id="cb13-4">)</span>
<span id="cb13-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"검색된 문서의 개수: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(relevant_chunks)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="e5eb7fc2" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> chunk <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> relevant_chunks:</span>
<span id="cb14-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(chunk.page_content, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb14-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
</div>
<p>이번에는 <code>retriever.invoke()</code> 메서드를 사용하여 쿼리를 실행합니다.</p>
<p><code>retriever.invoke()</code> 메서드는 원본 문서의 전체 내용을 검색합니다.</p>
<div id="1a29f9b4" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1">relevant_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span>)</span>
<span id="cb15-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"검색된 문서의 개수: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(relevant_docs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(relevant_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>
<p>리트리버(retriever)가 벡터 데이터베이스에서 기본적으로 수행하는 검색 유형은 유사도 검색입니다.</p>
<p>LangChain Vector Stores는 <a href="https://api.python.langchain.com/en/latest/vectorstores/langchain_core.vectorstores.VectorStore.html#langchain_core.vectorstores.VectorStore.max_marginal_relevance_search">Max Marginal Relevance</a>를 통한 검색도 지원하므로, 이를 대신 사용하고 싶다면 다음과 같이 <code>search_type</code> 속성을 설정하면 됩니다.</p>
<ul>
<li><code>retriever</code> 객체의 <code>search_type</code> 속성을 <code>SearchType.mmr</code>로 설정합니다.
<ul>
<li>이는 검색 시 MMR(Maximal Marginal Relevance) 알고리즘을 사용하도록 지정하는 것입니다.</li>
</ul></li>
</ul>
<div id="c545fc19" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.multi_vector <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SearchType</span>
<span id="cb16-2"></span>
<span id="cb16-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 유형을 MMR(Maximal Marginal Relevance)로 설정</span></span>
<span id="cb16-4">retriever.search_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SearchType.mmr</span>
<span id="cb16-5"></span>
<span id="cb16-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서 전체를 검색</span></span>
<span id="cb16-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>
<div id="07d08019" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.multi_vector <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SearchType</span>
<span id="cb17-2"></span>
<span id="cb17-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 유형을 similarity_score_threshold로 설정</span></span>
<span id="cb17-4">retriever.search_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SearchType.similarity_score_threshold</span>
<span id="cb17-5">retriever.search_kwargs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"score_threshold"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>}</span>
<span id="cb17-6"></span>
<span id="cb17-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서 전체를 검색</span></span>
<span id="cb17-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>
<div id="d203555f" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.multi_vector <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SearchType</span>
<span id="cb18-2"></span>
<span id="cb18-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 유형을 similarity로 설정, k값을 1로 설정</span></span>
<span id="cb18-4">retriever.search_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SearchType.similarity</span>
<span id="cb18-5">retriever.search_kwargs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}</span>
<span id="cb18-6"></span>
<span id="cb18-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서 전체를 검색</span></span>
<span id="cb18-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span>)))</span></code></pre></div></div>
</details>
</div>
</section>
<section id="요약본summary을-벡터저장소에-저장" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="요약본summary을-벡터저장소에-저장"><span class="header-section-number">3</span> 요약본(summary)을 벡터저장소에 저장</h2>
<p>요약은 종종 청크(chunk)의 내용을 보다 정확하게 추출할 수 있어 더 나은 검색 결과를 얻을 수 있습니다.</p>
<p>여기서는 요약을 생성하는 방법과 이를 임베딩하는 방법에 대해 설명합니다.</p>
<div id="e7c44d7a" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PDF 파일을 로드하고 텍스트를 분할하기 위한 라이브러리 임포트</span></span>
<span id="cb19-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PyMuPDFLoader</span>
<span id="cb19-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb19-4"></span>
<span id="cb19-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PDF 파일 로더 초기화</span></span>
<span id="cb19-6">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PyMuPDFLoader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/SPRI_AI_Brief_2023년12월호_F.pdf"</span>)</span>
<span id="cb19-7"></span>
<span id="cb19-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 텍스트 분할</span></span>
<span id="cb19-9">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb19-10"></span>
<span id="cb19-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PDF 파일 로드 및 텍스트 분할 실행</span></span>
<span id="cb19-12">split_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loader.load_and_split(text_splitter)</span>
<span id="cb19-13"></span>
<span id="cb19-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 분할된 문서의 개수 출력</span></span>
<span id="cb19-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"분할된 문서의 개수: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(split_docs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="a161ea24" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.documents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Document</span>
<span id="cb20-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.output_parsers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StrOutputParser</span>
<span id="cb20-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate</span>
<span id="cb20-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb20-5"></span>
<span id="cb20-6"></span>
<span id="cb20-7">summary_chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb20-8">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc"</span>: <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x.page_content}</span>
<span id="cb20-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 요약을 위한 프롬프트 템플릿 생성</span></span>
<span id="cb20-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ChatPromptTemplate.from_messages(</span>
<span id="cb20-11">        [</span>
<span id="cb20-12">            (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert in summarizing documents in Korean."</span>),</span>
<span id="cb20-13">            (</span>
<span id="cb20-14">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>,</span>
<span id="cb20-15">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Summarize the following documents in 3 sentences in bullet points format.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{doc}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb20-16">            ),</span>
<span id="cb20-17">        ]</span>
<span id="cb20-18">    )</span>
<span id="cb20-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># OpenAI의 ChatGPT 모델을 사용하여 요약 생성</span></span>
<span id="cb20-20">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ChatOpenAI(temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>)</span>
<span id="cb20-21">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser()</span>
<span id="cb20-22">)</span></code></pre></div></div>
</details>
</div>
<p><code>chain.batch</code> 메서드를 사용하여 <code>docs</code> 리스트의 문서들을 일괄 요약합니다. - 여기서 <code>max_concurrency</code> 매개변수를 10 으로 설정하여 최대 10개의 문서를 동시에 처리할 수 있도록 합니다.</p>
<div id="f7fe3a63" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 배치 처리</span></span>
<span id="cb21-2">summaries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> summary_chain.batch(split_docs, {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_concurrency"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>})</span></code></pre></div></div>
</details>
</div>
<div id="45363e96" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(summaries)</span></code></pre></div></div>
</details>
</div>
<p>요약된 내용을 출력하여 결과를 확인합니다.</p>
<div id="436bd00a" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 원본 문서의 내용을 출력합니다.</span></span>
<span id="cb23-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(split_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span>].page_content, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb23-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 요약을 출력합니다.</span></span>
<span id="cb23-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[요약]"</span>)</span>
<span id="cb23-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(summaries[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span>])</span></code></pre></div></div>
</details>
</div>
<p><code>Chroma</code> 벡터 저장소를 초기화하여 자식 청크(child chunks)를 인덱싱합니다. 이때 <code>OpenAIEmbeddings</code>를 임베딩 함수로 사용합니다.</p>
<ul>
<li>문서 ID를 나타내는 키로 <code>"doc_id"</code>를 사용합니다.</li>
</ul>
<div id="bbe2f51a" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> uuid</span>
<span id="cb24-2"></span>
<span id="cb24-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 요약 정보를 저장할 벡터 저장소를 생성합니다.</span></span>
<span id="cb24-4">summary_vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma(</span>
<span id="cb24-5">    collection_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"summaries"</span>,</span>
<span id="cb24-6">    embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>OpenAIEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-embedding-3-small"</span>),</span>
<span id="cb24-7">)</span>
<span id="cb24-8"></span>
<span id="cb24-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 부모 문서를 저장할 저장소를 생성합니다.</span></span>
<span id="cb24-10">store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> InMemoryStore()</span>
<span id="cb24-11"></span>
<span id="cb24-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 ID를 저장할 키 이름을 지정합니다.</span></span>
<span id="cb24-13">id_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_id"</span></span>
<span id="cb24-14"></span>
<span id="cb24-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색기를 초기화합니다. (시작 시 비어 있음)</span></span>
<span id="cb24-16">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MultiVectorRetriever(</span>
<span id="cb24-17">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>summary_vectorstore,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소</span></span>
<span id="cb24-18">    byte_store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>store,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 바이트 저장소</span></span>
<span id="cb24-19">    id_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>id_key,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 ID 키</span></span>
<span id="cb24-20">)</span>
<span id="cb24-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 ID를 생성합니다.</span></span>
<span id="cb24-22">doc_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(uuid.uuid4()) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> split_docs]</span></code></pre></div></div>
</details>
</div>
<p>요약된 문서와 메타데이터(여기서는 생성한 요약본에 대한 <code>Document ID</code> 입니다)를 저장합니다.</p>
<div id="cec99148" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1">summary_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb25-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 요약된 내용을 페이지 콘텐츠로 하고, 문서 ID를 메타데이터로 포함하는 Document 객체를 생성합니다.</span></span>
<span id="cb25-3">    Document(page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>s, metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{id_key: doc_ids[i]})</span>
<span id="cb25-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, s <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(summaries)</span>
<span id="cb25-5">]</span></code></pre></div></div>
</details>
</div>
<p>요약본의 문서의 개수는 원본 문서의 개수와 일치합니다.</p>
<div id="d36e4d50" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 요약본의 문서의 개수</span></span>
<span id="cb26-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(summary_docs)</span></code></pre></div></div>
</details>
</div>
<ul>
<li><code>retriever.vectorstore.add_documents(summary_docs)</code>를 통해 <code>summary_docs</code>를 벡터 저장소에 추가합니다.</li>
<li><code>retriever.docstore.mset(list(zip(doc_ids, docs)))</code>를 사용하여 <code>doc_ids</code>와 <code>docs</code>를 매핑하여 문서 저장소에 저장합니다.</li>
</ul>
<div id="df7ce3a2" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1">retriever.vectorstore.add_documents(</span>
<span id="cb27-2">    summary_docs</span>
<span id="cb27-3">)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 요약된 문서를 벡터 저장소에 추가합니다.</span></span>
<span id="cb27-4"></span>
<span id="cb27-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 ID와 문서를 매핑하여 문서 저장소에 저장합니다.</span></span>
<span id="cb27-6">retriever.docstore.mset(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(doc_ids, split_docs)))</span></code></pre></div></div>
</details>
</div>
<p><code>vectorstore</code> 객체의 <code>similarity_search</code> 메서드를 사용하여 유사도 검색을 수행합니다.</p>
<div id="89e3d643" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 유사도 검색을 수행합니다.</span></span>
<span id="cb28-2">result_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> summary_vectorstore.similarity_search(</span>
<span id="cb28-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span></span>
<span id="cb28-4">)</span></code></pre></div></div>
</details>
</div>
<div id="ae7cb5a7" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1개의 결과 문서를 출력합니다.</span></span>
<span id="cb29-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>
<p><code>retriever</code> 객체의 <code>invoke()</code> 사용하여 질문과 관련된 문서를 검색합니다.</p>
<div id="c5a9c432" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련된 문서를 검색하여 가져옵니다.</span></span>
<span id="cb30-2">retrieved_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span>)</span>
<span id="cb30-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(retrieved_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="가설-쿼리hypothetical-queries-를-활용하여-문서-내용-탐색" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="가설-쿼리hypothetical-queries-를-활용하여-문서-내용-탐색"><span class="header-section-number">4</span> 가설 쿼리(Hypothetical Queries) 를 활용하여 문서 내용 탐색</h2>
<p>LLM은 특정 문서에 대해 가정할 수 있는 질문 목록을 생성하는 데에도 사용될 수 있습니다.</p>
<p>이렇게 생성된 질문들은 임베딩(embedding)될 수 있으며, 이를 통해 문서의 내용을 더욱 깊이 있게 탐색하고 이해할 수 있습니다.</p>
<p>가정 질문 생성은 문서의 주요 주제와 개념을 파악하는 데 도움이 되며, 독자들이 문서 내용에 대해 더 많은 궁금증을 갖도록 유도할 수 있습니다.</p>
<p>아래는 <code>Function Calling</code> 을 활용하여 가설 질문을 생성하는 예제입니다.</p>
<div id="5baf8ff9" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1">functions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb31-2">    {</span>
<span id="cb31-3">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hypothetical_questions"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 함수의 이름을 지정합니다.</span></span>
<span id="cb31-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"description"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Generate hypothetical questions"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 함수에 대한 설명을 작성합니다.</span></span>
<span id="cb31-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: {  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 함수의 매개변수를 정의합니다.</span></span>
<span id="cb31-6">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"object"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 매개변수의 타입을 객체로 지정합니다.</span></span>
<span id="cb31-7">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"properties"</span>: {  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 객체의 속성을 정의합니다.</span></span>
<span id="cb31-8">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"questions"</span>: {  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 'questions' 속성을 정의합니다.</span></span>
<span id="cb31-9">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"array"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 'questions'의 타입을 배열로 지정합니다.</span></span>
<span id="cb31-10">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"items"</span>: {</span>
<span id="cb31-11">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span></span>
<span id="cb31-12">                    },  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 배열의 요소 타입을 문자열로 지정합니다.</span></span>
<span id="cb31-13">                },</span>
<span id="cb31-14">            },</span>
<span id="cb31-15">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"required"</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"questions"</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 필수 매개변수로 'questions'를 지정합니다.</span></span>
<span id="cb31-16">        },</span>
<span id="cb31-17">    }</span>
<span id="cb31-18">]</span></code></pre></div></div>
</details>
</div>
<p><code>ChatPromptTemplate</code>을 사용하여 주어진 문서를 기반으로 3개의 가상 질문을 생성하는 프롬프트 템플릿을 정의합니다.</p>
<ul>
<li><code>functions</code>와 <code>function_call</code>을 설정하여 가상 질문 생성 함수를 호출합니다.</li>
<li><code>JsonKeyOutputFunctionsParser</code>를 사용하여 생성된 가상 질문을 파싱하고, <code>questions</code> 키에 해당하는 값을 추출합니다.</li>
</ul>
<div id="7cb4be57" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate</span>
<span id="cb32-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.output_parsers.openai_functions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> JsonKeyOutputFunctionsParser</span>
<span id="cb32-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb32-4"></span>
<span id="cb32-5">hypothetical_query_chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb32-6">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc"</span>: <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x.page_content}</span>
<span id="cb32-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 아래 문서를 사용하여 답변할 수 있는 가상의 질문을 정확히 3개 생성하도록 요청합니다. 이 숫자는 조정될 수 있습니다.</span></span>
<span id="cb32-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ChatPromptTemplate.from_template(</span>
<span id="cb32-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Generate a list of exactly 3 hypothetical questions that the below document could be used to answer. "</span></span>
<span id="cb32-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Potential users are those interested in the AI industry. Create questions that they would be interested in. "</span></span>
<span id="cb32-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Output should be written in Korean:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{doc}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb32-12">    )</span>
<span id="cb32-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ChatOpenAI(max_retries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>).bind(</span>
<span id="cb32-14">        functions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>functions, function_call<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hypothetical_questions"</span>}</span>
<span id="cb32-15">    )</span>
<span id="cb32-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 출력에서 "questions" 키에 해당하는 값을 추출합니다.</span></span>
<span id="cb32-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> JsonKeyOutputFunctionsParser(key_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"questions"</span>)</span>
<span id="cb32-18">)</span></code></pre></div></div>
</details>
</div>
<p>문서에 대한 답변을 출력합니다.</p>
<ul>
<li>출력은 생성한 3개의 가설 쿼리(Hypothetical Queries) 가 담겨 있습니다.</li>
</ul>
<div id="a9cda3be" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 주어진 문서에 대해 체인을 실행합니다.</span></span>
<span id="cb33-2">hypothetical_query_chain.invoke(split_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span>])</span></code></pre></div></div>
</details>
</div>
<p><code>chain.batch</code> 메서드를 사용하여 <code>split_docs</code> 데이터에 대해 동시에 여러 개의 요청을 처리합니다.</p>
<div id="ac642190" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 목록에 대해 가설 질문을 배치 생성</span></span>
<span id="cb34-2">hypothetical_questions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hypothetical_query_chain.batch(</span>
<span id="cb34-3">    split_docs, {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_concurrency"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>}</span>
<span id="cb34-4">)</span></code></pre></div></div>
</details>
</div>
<div id="02840bcd" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1">hypothetical_questions[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span>]</span></code></pre></div></div>
</details>
</div>
<p>아래는 이전에 진행했던 방식과 동일하게 생성한 가설 쿼리(Hypothetical Queries) 를 벡터저장소에 저장하는 과정입니다.</p>
<div id="c44404c6" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 자식 청크를 인덱싱하는 데 사용할 벡터 저장소</span></span>
<span id="cb36-2">hypothetical_vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma(</span>
<span id="cb36-3">    collection_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hypo-questions"</span>, embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>OpenAIEmbeddings()</span>
<span id="cb36-4">)</span>
<span id="cb36-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 부모 문서의 저장소 계층</span></span>
<span id="cb36-6">store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> InMemoryStore()</span>
<span id="cb36-7"></span>
<span id="cb36-8">id_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_id"</span></span>
<span id="cb36-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색기 (시작 시 비어 있음)</span></span>
<span id="cb36-10">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MultiVectorRetriever(</span>
<span id="cb36-11">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>hypothetical_vectorstore,</span>
<span id="cb36-12">    byte_store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>store,</span>
<span id="cb36-13">    id_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>id_key,</span>
<span id="cb36-14">)</span>
<span id="cb36-15">doc_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(uuid.uuid4()) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> split_docs]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 ID 생성</span></span></code></pre></div></div>
</details>
</div>
<p><code>question_docs</code> 리스트에 메타데이터(문서 ID) 를 추가합니다.</p>
<div id="a7cbb65e" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb37-1">question_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb37-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hypothetical_questions 저장</span></span>
<span id="cb37-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, question_list <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(hypothetical_questions):</span>
<span id="cb37-4">    question_docs.extend(</span>
<span id="cb37-5">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질문 리스트의 각 질문에 대해 Document 객체를 생성하고, 메타데이터에 해당 질문의 문서 ID를 포함시킵니다.</span></span>
<span id="cb37-6">        [Document(page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>s, metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{id_key: doc_ids[i]}) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> question_list]</span>
<span id="cb37-7">    )</span></code></pre></div></div>
</details>
</div>
<p>가설 쿼리를 문서에 추가하고, 원본 문서를 <code>docstore</code> 에 추가합니다.</p>
<div id="105ecf34" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hypothetical_questions 문서를 벡터 저장소에 추가합니다.</span></span>
<span id="cb38-2">retriever.vectorstore.add_documents(question_docs)</span>
<span id="cb38-3"></span>
<span id="cb38-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 ID와 문서를 매핑하여 문서 저장소에 저장합니다.</span></span>
<span id="cb38-5">retriever.docstore.mset(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(doc_ids, split_docs)))</span></code></pre></div></div>
</details>
</div>
<p><code>vectorstore</code> 객체의 <code>similarity_search</code> 메서드를 사용하여 유사도 검색을 수행합니다.</p>
<div id="ca9afb0a" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 유사한 문서를 벡터 저장소에서 검색합니다.</span></span>
<span id="cb39-2">result_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hypothetical_vectorstore.similarity_search(</span>
<span id="cb39-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span></span>
<span id="cb39-4">)</span></code></pre></div></div>
</details>
</div>
<p>아래는 유사도 검색 결과입니다.</p>
<p>여기서는 생성한 가설 쿼리만 추가해 놓은 상태이기 때문에, 생성한 가설 쿼리 중 유사도가 가장 높은 문서를 반환합니다.</p>
<div id="10c33bb4" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 유사도 검색 결과를 출력합니다.</span></span>
<span id="cb40-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> result_docs:</span>
<span id="cb40-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb40-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.metadata)</span></code></pre></div></div>
</details>
</div>
<p><code>retriever</code> 객체의 <code>invoke</code> 메서드를 사용하여 쿼리와 관련된 문서를 검색합니다.</p>
<div id="d106a8d0" class="cell">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련된 문서를 검색하여 가져옵니다.</span></span>
<span id="cb41-2">retrieved_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(result_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].page_content)</span>
<span id="cb41-3"></span>
<span id="cb41-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서를 출력합니다.</span></span>
<span id="cb41-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> retrieved_docs:</span>
<span id="cb41-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span></code></pre></div></div>
</details>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/07-MultiVectorRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 04:32:17 GMT</pubDate>
</item>
</channel>
</rss>
