<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Junhyun Lee</title>
<link>https://dlwns0719.github.io/my_blog/docs/blog/</link>
<atom:link href="https://dlwns0719.github.io/my_blog/docs/blog/index.xml" rel="self" type="application/rss+xml"/>
<description>blog</description>
<generator>quarto-1.8.25</generator>
<lastBuildDate>Wed, 18 Feb 2026 15:00:00 GMT</lastBuildDate>
<item>
  <title>Agent</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/Agent/</link>
  <description><![CDATA[ 






<section id="agent" class="level2" data-number="1">

<section id="코드분석-agent" class="level3" data-number="1.1">

<ol type="1">
<li><a href="../../../../docs/blog/posts/Agent/01-코드분석/01-메타데이터_시행착오와_설계_원칙.html">메타데이터 추출 시행착오와 설계 원칙</a></li>
<li><a href="../../../../docs/blog/posts/Agent/01-코드분석/02-하이브리드_파이프라인_설계.html">하이브리드 파이프라인 설계: AST + LLM 자동화</a></li>
</ol>


</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>Agent</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/Agent/</guid>
  <pubDate>Wed, 18 Feb 2026 15:00:00 GMT</pubDate>
</item>
<item>
  <title>LLM 에이전트로 코드 메타데이터 추출하기: 시행착오와 설계 원칙</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/Agent/01-코드분석/01-메타데이터_시행착오와_설계_원칙.html</link>
  <description><![CDATA[ 






<section id="llm-에이전트로-코드-메타데이터-추출하기" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> LLM 에이전트로 코드 메타데이터 추출하기</h1>
<section id="왜-코드베이스-메타데이터가-필요한가" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="왜-코드베이스-메타데이터가-필요한가"><span class="header-section-number">1.1</span> 왜 코드베이스 메타데이터가 필요한가</h2>
<p>인실리코(in-silico) 알고리즘 코드를 분석하는 <strong>코드 설명 Agent</strong>를 구축하려면, Agent가 코드를 이해하기 위한 구조화된 메타데이터가 필요합니다.</p>
<p>여기서 말하는 메타데이터란:</p>
<ul>
<li>모든 클래스/함수/변수의 <strong>물리명, 논리명, 데이터 타입, 기본값, 의미</strong></li>
<li>모듈 간 <strong>입출력 연결 관계</strong></li>
<li>파이프라인 <strong>단계 간 의존성</strong></li>
<li>중간 산출물의 <strong>파일 스키마</strong> (구분자, 인코딩, 컬럼 정의)</li>
<li>알고리즘 <strong>파라미터, 임계값, 허용 범위</strong></li>
<li><strong>암묵적 규칙</strong> (코드에 명시되지 않은 관계, 상태 전이 조건)</li>
</ul>
<p>이 메타데이터를 14개 카테고리로 분류하여 <code>METADATA_INVESTIGATION.md</code>라는 단일 문서로 생성하는 것이 목표입니다.</p>
<hr>
</section>
<section id="대상-automsa-파이프라인" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="대상-automsa-파이프라인"><span class="header-section-number">1.2</span> 대상: AutoMSA 파이프라인</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 54%">
<col style="width: 45%">
</colgroup>
<thead>
<tr class="header">
<th>항목</th>
<th>값</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>레포지토리</td>
<td><code>insilico-core-automsa</code></td>
</tr>
<tr class="even">
<td>Python 파일 수</td>
<td>152개</td>
</tr>
<tr class="odd">
<td>총 코드 줄 수</td>
<td>~29,178줄</td>
</tr>
<tr class="even">
<td>파이프라인 단계</td>
<td>9개 서비스 (5 Step)</td>
</tr>
<tr class="odd">
<td>역할</td>
<td>유전자/단백질 키워드 기반 서열 수집, BLAST 확장, 대표 서열 선정, 다중 서열 정렬(MSA) 자동화</td>
</tr>
</tbody>
</table>
<p>파이프라인 구조:</p>
<pre><code>AutoMSA -&gt; DRS -&gt; monoom -&gt; multiom -&gt; multiom-output -&gt; multitom -&gt; multiplex-excel</code></pre>
<p>이 규모의 코드베이스에서 원자적 수준의 메타데이터를 추출하면 <strong>1,400개 이상의 항목</strong>이 나옵니다.</p>
<hr>
</section>
<section id="차-시도-단일-에이전트-실패" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="차-시도-단일-에이전트-실패"><span class="header-section-number">1.3</span> 1차 시도: 단일 에이전트 (실패)</h2>
<section id="접근" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="접근"><span class="header-section-number">1.3.1</span> 접근</h3>
<p>하나의 Claude Code 에이전트에게 전체 152개 파일을 분석하라고 요청했습니다.</p>
</section>
<section id="결과" class="level3" data-number="1.3.2">
<h3 data-number="1.3.2" class="anchored" data-anchor-id="결과"><span class="header-section-number">1.3.2</span> 결과</h3>
<p><strong>Context window 한계에 도달.</strong> 약 50개 파일을 읽은 시점에서 컨텍스트가 부족해져, 나머지 100개 파일은 조사되지 않았습니다.</p>
</section>
<section id="교훈" class="level3" data-number="1.3.3">
<h3 data-number="1.3.3" class="anchored" data-anchor-id="교훈"><span class="header-section-number">1.3.3</span> 교훈</h3>
<blockquote class="blockquote">
<p><strong>대규모 코드베이스는 단일 에이전트로 처리할 수 없다.</strong> Context window는 유한하고, 152개 파일 x 평균 192줄 = ~29K줄의 코드를 한 번에 읽고 분석하는 것은 불가능합니다.</p>
</blockquote>
<hr>
</section>
</section>
<section id="차-시도-3개-분산-에이전트" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="차-시도-3개-분산-에이전트"><span class="header-section-number">1.4</span> 2차 시도: 3개 분산 에이전트</h2>
<section id="접근-1" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="접근-1"><span class="header-section-number">1.4.1</span> 접근</h3>
<p>14개 카테고리를 3개 그룹으로 나누어 병렬 실행:</p>
<ul>
<li>Agent A: Cat 1-3 (파이프라인 구조, 중간 산출물)</li>
<li>Agent B: Cat 4-7 (입력/파라미터, DB, 품질)</li>
<li>Agent C: Cat 8-14 (라이브러리, 환경, 인프라, 로깅, 기타)</li>
</ul>
</section>
<section id="결과-1" class="level3" data-number="1.4.2">
<h3 data-number="1.4.2" class="anchored" data-anchor-id="결과-1"><span class="header-section-number">1.4.2</span> 결과</h3>
<p>3개 에이전트 모두 완료. 그러나 <strong>산출물의 형식이 프롬프트와 불일치</strong>:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>문제</th>
<th>상세</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>N.1-N.4 구조 누락</td>
<td>각 카테고리에 “추출 가능 이유”, “조사 대상 파일”, “해석 메타데이터” 섹션이 없음</td>
</tr>
<tr class="even">
<td>테이블 헤더 영문</td>
<td>한국어 8열 헤더 대신 영어 헤더 사용</td>
</tr>
<tr class="odd">
<td>통계표 누락</td>
<td>최종 카테고리별 항목 수 집계표 없음</td>
</tr>
<tr class="even">
<td>품질 체크리스트 누락</td>
<td>12개 항목 체크리스트 없음</td>
</tr>
</tbody>
</table>
</section>
<section id="교훈-1" class="level3" data-number="1.4.3">
<h3 data-number="1.4.3" class="anchored" data-anchor-id="교훈-1"><span class="header-section-number">1.4.3</span> 교훈</h3>
<blockquote class="blockquote">
<p><strong>LLM은 추상적 규칙보다 구체적 예시를 훨씬 잘 따른다.</strong> 프롬프트에 “N.1, N.2, N.3, N.4 구조로 작성하세요”라고 써도, 실제 완성된 예시가 없으면 에이전트가 자의적으로 해석합니다.</p>
</blockquote>
<hr>
</section>
</section>
<section id="차-시도-7개-분산-에이전트-형식-교정" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="차-시도-7개-분산-에이전트-형식-교정"><span class="header-section-number">1.5</span> 3차 시도: 7개 분산 에이전트 + 형식 교정</h2>
<section id="접근-2" class="level3" data-number="1.5.1">
<h3 data-number="1.5.1" class="anchored" data-anchor-id="접근-2"><span class="header-section-number">1.5.1</span> 접근</h3>
<ul>
<li>참조 문서(multiom 레포의 METADATA_INVESTIGATION.md)를 Gold Standard로 제공</li>
<li>7개 에이전트로 더 세밀하게 분할:
<ul>
<li>Cat 1 / Cat 2-3 / Cat 4 / Cat 5-6 / Cat 7-8 / Cat 9-11 / Cat 12-14</li>
</ul></li>
<li>각 에이전트에게 <strong>구체적 형식 예시</strong>와 <strong>참조 문서</strong>를 함께 전달</li>
</ul>
</section>
<section id="결과-2" class="level3" data-number="1.5.2">
<h3 data-number="1.5.2" class="anchored" data-anchor-id="결과-2"><span class="header-section-number">1.5.2</span> 결과</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>카테고리</th>
<th>항목 수</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1. 모듈 간 I/O</td>
<td>213</td>
</tr>
<tr class="even">
<td>2. 파이프라인 의존성</td>
<td>62</td>
</tr>
<tr class="odd">
<td>3. 중간 산출물</td>
<td>218</td>
</tr>
<tr class="even">
<td>4. 입력 JSON/UI</td>
<td>128</td>
</tr>
<tr class="odd">
<td>5. 알고리즘 파라미터</td>
<td>129</td>
</tr>
<tr class="even">
<td>6. DB 스키마/쿼리</td>
<td>110</td>
</tr>
<tr class="odd">
<td>7. 품질 규칙</td>
<td>99</td>
</tr>
<tr class="even">
<td>8. 라이브러리/API</td>
<td>53</td>
</tr>
<tr class="odd">
<td>9. 환경 변수</td>
<td>35</td>
</tr>
<tr class="even">
<td>10. 병렬 처리</td>
<td>18</td>
</tr>
<tr class="odd">
<td>11. 실행 모드</td>
<td>45</td>
</tr>
<tr class="even">
<td>12. 인프라</td>
<td>44</td>
</tr>
<tr class="odd">
<td>13. 로깅</td>
<td>81</td>
</tr>
<tr class="even">
<td>14. 기타</td>
<td>176</td>
</tr>
<tr class="odd">
<td><strong>합계</strong></td>
<td><strong>1,411</strong></td>
</tr>
</tbody>
</table>
<p>형식은 올바르게 나왔으나, <strong>Cat 3의 파일 스키마가 누락</strong>되었습니다.</p>
</section>
<section id="교훈-2" class="level3" data-number="1.5.3">
<h3 data-number="1.5.3" class="anchored" data-anchor-id="교훈-2"><span class="header-section-number">1.5.3</span> 교훈</h3>
<blockquote class="blockquote">
<p><strong>중요한 요구사항은 독립 섹션으로 분리해야 한다.</strong> Cat 3 설명 안에 “파일 스키마를 반드시 기술하세요”라고 묻어 놓으면 에이전트가 놓칩니다. <strong>CRITICAL</strong> 표시와 함께 별도 섹션으로 올려야 합니다.</p>
</blockquote>
<hr>
</section>
</section>
<section id="cat-3-파일-스키마-보강-전용-에이전트" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="cat-3-파일-스키마-보강-전용-에이전트"><span class="header-section-number">1.6</span> Cat 3 파일 스키마 보강: 전용 에이전트</h2>
<p>Cat 3의 36개 중간 산출물 파일에 대해 전용 에이전트를 추가 투입했습니다.</p>
<section id="추출한-파일-스키마-속성-9가지" class="level3" data-number="1.6.1">
<h3 data-number="1.6.1" class="anchored" data-anchor-id="추출한-파일-스키마-속성-9가지"><span class="header-section-number">1.6.1</span> 추출한 파일 스키마 속성 (9가지)</h3>
<p>각 파일에 대해:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 81%">
</colgroup>
<thead>
<tr class="header">
<th>속성</th>
<th>예시 (InExCrossInfo.txt)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>구분자</td>
<td><code>\t</code> (탭)</td>
</tr>
<tr class="even">
<td>인코딩</td>
<td>UTF-8</td>
</tr>
<tr class="odd">
<td>헤더 행</td>
<td>없음</td>
</tr>
<tr class="even">
<td>행 의미</td>
<td>1행 = 1개 키-값 쌍</td>
</tr>
<tr class="odd">
<td>정렬 순서</td>
<td>dict 순회 순서</td>
</tr>
<tr class="even">
<td>생성 함수</td>
<td><code>get_in_ex_cross_info.py::output_default_in_ex_cross_file()</code></td>
</tr>
<tr class="odd">
<td>소비 함수</td>
<td><code>in_ex_param_info.py::InExParamInfo.__init__()</code></td>
</tr>
<tr class="even">
<td>좌표 체계</td>
<td>N/A</td>
</tr>
<tr class="odd">
<td>컬럼 정의</td>
<td>key(str) + value(str)</td>
</tr>
</tbody>
</table>
</section>
<section id="부록으로-추가된-내용" class="level3" data-number="1.6.2">
<h3 data-number="1.6.2" class="anchored" data-anchor-id="부록으로-추가된-내용"><span class="header-section-number">1.6.2</span> 부록으로 추가된 내용</h3>
<ul>
<li>FASTA 헤더 타입 종합 정리 (SeqInfo 11가지 + MatchSeqInfo 4가지 헤더 형식)</li>
<li>TSV 엔티티 컬럼 비교표 (IN/EX/CROSS 37개 컬럼 대조)</li>
</ul>
</section>
<section id="최종-산출물" class="level3" data-number="1.6.3">
<h3 data-number="1.6.3" class="anchored" data-anchor-id="최종-산출물"><span class="header-section-number">1.6.3</span> 최종 산출물</h3>
<ul>
<li><strong>3,782줄</strong>의 METADATA_INVESTIGATION.md</li>
<li><strong>1,411개</strong> 원자적 메타데이터 항목</li>
<li><strong>36개</strong> 파일 스키마 상세</li>
<li>총 <strong>8개 에이전트</strong> 사용 (7개 카테고리 + 1개 파일 스키마)</li>
</ul>
<hr>
</section>
</section>
<section id="차-시도-읽기요약합성-방식의-실패" class="level2" data-number="1.7">
<h2 data-number="1.7" class="anchored" data-anchor-id="차-시도-읽기요약합성-방식의-실패"><span class="header-section-number">1.7</span> 4차 시도: “읽기→요약→합성” 방식의 실패</h2>
<p>7개 에이전트 방식(3차 시도)이 성공한 후, 32개 레포지토리를 대량 처리하기 위해 <strong>다른 접근법</strong>을 시도했습니다. 이 시도에서 발견한 실패 모드는 앞의 3가지 시도와는 질적으로 다른 문제였습니다.</p>
<section id="접근-읽기-에이전트-합성" class="level3" data-number="1.7.1">
<h3 data-number="1.7.1" class="anchored" data-anchor-id="접근-읽기-에이전트-합성"><span class="header-section-number">1.7.1</span> 접근: 읽기 에이전트 + 합성</h3>
<pre><code>Phase 1: 5개 백그라운드 에이전트가 파일 그룹별로 전체 코드를 읽음
         (core, enum/dto, entity, common modules, pipeline steps)
         ↓
Phase 2: 각 에이전트가 읽은 내용의 "요약"을 반환
         ↓
Phase 3: 메인 에이전트가 요약을 기반으로 METADATA_INVESTIGATION.md 합성</code></pre>
<p>이 접근법은 합리적으로 보였습니다. 152개 파일을 5개로 나눠 병렬 읽기, 요약, 합성. 그러나 <strong>결과는 참담했습니다.</strong></p>
</section>
<section id="결과-cat-3이-16개-항목으로-축소" class="level3" data-number="1.7.2">
<h3 data-number="1.7.2" class="anchored" data-anchor-id="결과-cat-3이-16개-항목으로-축소"><span class="header-section-number">1.7.2</span> 결과: Cat 3이 16개 항목으로 축소</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>지표</th>
<th>7개 추출 에이전트 (3차)</th>
<th>5개 읽기 에이전트 + 합성</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>총 항목 수</td>
<td>1,411</td>
<td><strong>436</strong> (69% 감소)</td>
</tr>
<tr class="even">
<td>Cat 3 항목 수</td>
<td>218</td>
<td><strong>16</strong> (93% 감소)</td>
</tr>
<tr class="odd">
<td>Cat 3 파일 스키마</td>
<td>36개 상세 기술</td>
<td><strong>0</strong></td>
</tr>
<tr class="even">
<td>DTO 필드 추출</td>
<td>개별 행으로 전수</td>
<td><strong>완전 누락</strong></td>
</tr>
</tbody>
</table>
<p>Cat 3에 들어갔어야 할 항목들이 대량 누락되었습니다:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 47%">
<col style="width: 26%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>누락된 항목 유형</th>
<th>예상 규모</th>
<th>실제 추출</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DTO 클래스 전체 필드 (SeqInfo 859줄, MatchSeqInfo 1273줄 등)</td>
<td>200+ 필드</td>
<td>0</td>
</tr>
<tr class="even">
<td>Entity Enum 필드 (25개 파일)</td>
<td>300+ 필드</td>
<td>0</td>
</tr>
<tr class="odd">
<td>중간 파일 스키마 (컬럼 정의)</td>
<td>수십 개</td>
<td>0</td>
</tr>
<tr class="even">
<td>단계 간 반환값</td>
<td>30+ 항목</td>
<td>0</td>
</tr>
</tbody>
</table>
</section>
<section id="근본-원인-분석" class="level3" data-number="1.7.3">
<h3 data-number="1.7.3" class="anchored" data-anchor-id="근본-원인-분석"><span class="header-section-number">1.7.3</span> 근본 원인 분석</h3>
<p><strong>원인 1: 2단계 간접 처리에서 정보 소실</strong></p>
<p>읽기 에이전트가 <code>MatchSeqInfo</code> 클래스(1,273줄)를 읽으면, 요약에는 이렇게 돌아옵니다:</p>
<pre><code>MatchSeqInfo: 매칭 서열 정보를 나타내는 포괄적 클래스.
1273줄. 여러 헤더 형식, 정렬 상세, 어셈블리/분류 정보 포함.
다수의 getter/setter 메서드.</code></pre>
<p>이 요약으로는 <code>score</code>, <code>gene</code>, <code>product</code>, <code>pct_id</code>, <code>coverage</code> 같은 <strong>개별 필드</strong>를 원자적 행으로 추출할 수 없습니다. <strong>요약은 구조를 전달하지만, 원자적 항목을 전달하지 못합니다.</strong></p>
<p><strong>원인 2: 컨텍스트 압박에 의한 카테고리 범위 축소</strong></p>
<p>합성 에이전트는 14개 카테고리를 모두 작성해야 합니다. 요약 기반으로 남은 컨텍스트가 빠듯하면 <strong>초기 카테고리를 빨리 끝내고 넘어가려는 경향</strong>이 생깁니다. Cat 3이 첫 번째 쓰기 배치에 포함되어 있었고, 뒤에 11개 카테고리가 남아있다는 압박에 요약 모드로 전환되었습니다.</p>
<p><strong>원인 3: 카테고리 범위를 좁게 재해석</strong></p>
<p>프롬프트는 Cat 3에 “모델 클래스의 모든 필드”, “메서드 반환값”, “메모리 상 상태 변수”를 명시적으로 요구합니다. 그러나 합성 에이전트는 <strong>“중간 산출물 = 디스크에 기록되는 파일”</strong>로 좁게 해석하여, DTO 필드/Entity Enum/반환값을 전부 누락시켰습니다.</p>
<p><strong>원인 4: 카테고리 간 중복 회피 과잉 적용</strong></p>
<p>프롬프트는 “주 카테고리에 배치하고 비고에 관련 카테고리를 표기”라고 명시합니다. 그러나 합성 에이전트는 DTO 필드를 Cat 5(파라미터)나 Cat 1(I/O)에 분산 배치해야 한다고 판단하여, Cat 3에서는 파일 경로만 나열했습니다.</p>
</section>
<section id="교훈-읽기-에이전트는-추출-에이전트가-아니다" class="level3" data-number="1.7.4">
<h3 data-number="1.7.4" class="anchored" data-anchor-id="교훈-읽기-에이전트는-추출-에이전트가-아니다"><span class="header-section-number">1.7.4</span> 교훈: “읽기 에이전트”는 “추출 에이전트”가 아니다</h3>
<pre><code>읽기 에이전트 (Reading Agent)
+---------------------------------------------+
| 입력: "이 파일들을 읽어라"                    |
| 출력: 파일 내용의 요약 (구조적, 서술적)        |
| 한계: 원자적 항목 추출을 하지 않음             |
+---------------------------------------------+

추출 에이전트 (Extraction Agent)
+---------------------------------------------+
| 입력: "이 파일에서 Cat N의 메타데이터를 추출하라" |
| 출력: 구조화된 테이블 (행 = 원자적 항목)        |
| 강점: 목적이 명확하므로 원자적 디테일 유지      |
+---------------------------------------------+</code></pre>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 36%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th>비교 항목</th>
<th>읽기 + 합성</th>
<th>직접 추출</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>에이전트 역할</td>
<td>“파일을 읽고 요약하라”</td>
<td>“Cat N의 메타데이터를 추출하라”</td>
</tr>
<tr class="even">
<td>정보 흐름</td>
<td>코드 -&gt; 요약 -&gt; 테이블 (2단계)</td>
<td>코드 -&gt; 테이블 (1단계)</td>
</tr>
<tr class="odd">
<td>원자적 디테일</td>
<td>요약에서 소실</td>
<td>직접 보존</td>
</tr>
<tr class="even">
<td>Cat 3 결과</td>
<td>16개 항목</td>
<td>218개 항목</td>
</tr>
<tr class="odd">
<td>실패 지점</td>
<td>요약 &lt;-&gt; 합성 사이의 간극</td>
<td>없음 (단일 변환)</td>
</tr>
</tbody>
</table>
<blockquote class="blockquote">
<p><strong>에이전트에게 “읽어라”와 “추출하라”는 전혀 다른 지시입니다.</strong> 메타데이터 추출에서는 에이전트가 카테고리를 인식한 상태에서 직접 원자적 항목을 추출해야 합니다. 읽기 에이전트의 요약을 합성하는 것은 “전화 게임(Chinese whispers)”과 같아서, 단계마다 정보가 소실됩니다.</p>
</blockquote>
<hr>
</section>
</section>
<section id="설계-원칙-정리" class="level2" data-number="1.8">
<h2 data-number="1.8" class="anchored" data-anchor-id="설계-원칙-정리"><span class="header-section-number">1.8</span> 설계 원칙 정리</h2>
<p>4번의 시행착오에서 도출한 원칙들을 종합합니다.</p>
<section id="프롬프트-설계-원칙-6가지" class="level3" data-number="1.8.1">
<h3 data-number="1.8.1" class="anchored" data-anchor-id="프롬프트-설계-원칙-6가지"><span class="header-section-number">1.8.1</span> 프롬프트 설계 원칙 (6가지)</h3>
<section id="원칙-1-분산-실행-프로토콜을-프롬프트에-명시하라" class="level4" data-number="1.8.1.1">
<h4 data-number="1.8.1.1" class="anchored" data-anchor-id="원칙-1-분산-실행-프로토콜을-프롬프트에-명시하라"><span class="header-section-number">1.8.1.1</span> 원칙 1: 분산 실행 프로토콜을 프롬프트에 명시하라</h4>
<p>단일 에이전트 전제의 프롬프트를 여러 에이전트에게 나눠주면 실패합니다. <strong>어떻게 나누고, 어떻게 합칠 것인지</strong>를 프롬프트 자체에 포함해야 합니다.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## 분산 실행 프로토콜</span></span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">### 분할 단위</span></span>
<span id="cb5-4"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span>Agent A: Cat 1-2 (파이프라인 구조)</span>
<span id="cb5-5"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span>Agent B: Cat 3 (중간 산출물) -- 단독</span>
<span id="cb5-6"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span>Agent C: Cat 4-5 (입력/파라미터)</span>
<span id="cb5-7">...</span>
<span id="cb5-8"></span>
<span id="cb5-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">### 에이전트별 산출물 규칙</span></span>
<span id="cb5-10"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span>파일명: <span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">`/tmp/{repo}_metadata/cat_{NN}.md`</span></span>
<span id="cb5-11"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span>자기 완결적 (헤더 불필요, 카테고리 내용만)</span>
<span id="cb5-12"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span>마지막에 <span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">`&lt;!-- ROW_COUNT: {숫자} --&gt;`</span> 주석 추가</span></code></pre></div></div>
</section>
<section id="원칙-2-카테고리별-대상-파일을-사전-매핑하라" class="level4" data-number="1.8.1.2">
<h4 data-number="1.8.1.2" class="anchored" data-anchor-id="원칙-2-카테고리별-대상-파일을-사전-매핑하라"><span class="header-section-number">1.8.1.2</span> 원칙 2: 카테고리별 대상 파일을 사전 매핑하라</h4>
<p>모든 에이전트가 152개 파일을 각자 탐색하면 토큰 낭비입니다. 파일을 미리 분류해서 에이전트 범위를 좁혀야 합니다.</p>
</section>
<section id="원칙-3-추상적-규칙-대신-완성된-예시를-제공하라" class="level4" data-number="1.8.1.3">
<h4 data-number="1.8.1.3" class="anchored" data-anchor-id="원칙-3-추상적-규칙-대신-완성된-예시를-제공하라"><span class="header-section-number">1.8.1.3</span> 원칙 3: 추상적 규칙 대신 완성된 예시를 제공하라</h4>
<p>“N.1-N.4 구조로 작성하세요”보다 <strong>실제 완성된 카테고리 1개를 통째로</strong> 예시로 보여주는 것이 효과적입니다.</p>
</section>
<section id="원칙-4-중요-요구사항은-독립-섹션-critical-표시로-분리하라" class="level4" data-number="1.8.1.4">
<h4 data-number="1.8.1.4" class="anchored" data-anchor-id="원칙-4-중요-요구사항은-독립-섹션-critical-표시로-분리하라"><span class="header-section-number">1.8.1.4</span> 원칙 4: 중요 요구사항은 독립 섹션 + CRITICAL 표시로 분리하라</h4>
<p>카테고리 설명 안에 묻어 놓으면 에이전트가 놓칩니다.</p>
</section>
<section id="원칙-5-레포-규모별-자동-분할-기준을-포함하라" class="level4" data-number="1.8.1.5">
<h4 data-number="1.8.1.5" class="anchored" data-anchor-id="원칙-5-레포-규모별-자동-분할-기준을-포함하라"><span class="header-section-number">1.8.1.5</span> 원칙 5: 레포 규모별 자동 분할 기준을 포함하라</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Python 파일 수</th>
<th>권장 에이전트 수</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>~30개</td>
<td>1 (단일)</td>
</tr>
<tr class="even">
<td>30~80개</td>
<td>3</td>
</tr>
<tr class="odd">
<td>80~150개</td>
<td>5~7</td>
</tr>
<tr class="even">
<td>150개+</td>
<td>7~10</td>
</tr>
</tbody>
</table>
</section>
<section id="원칙-6-오케스트레이터용-병합-체크리스트를-명시하라" class="level4" data-number="1.8.1.6">
<h4 data-number="1.8.1.6" class="anchored" data-anchor-id="원칙-6-오케스트레이터용-병합-체크리스트를-명시하라"><span class="header-section-number">1.8.1.6</span> 원칙 6: 오케스트레이터용 병합 체크리스트를 명시하라</h4>
<p>병합 단계에서 통계표 누락, 행 수 불일치가 발생합니다. 오케스트레이터가 따를 체크리스트가 필요합니다.</p>
</section>
</section>
<section id="에이전트-역할-설계-원칙-3가지" class="level3" data-number="1.8.2">
<h3 data-number="1.8.2" class="anchored" data-anchor-id="에이전트-역할-설계-원칙-3가지"><span class="header-section-number">1.8.2</span> 에이전트 역할 설계 원칙 (3가지)</h3>
<section id="원칙-7-에이전트에게는-추출을-시켜라-읽기를-시키지-마라" class="level4" data-number="1.8.2.1">
<h4 data-number="1.8.2.1" class="anchored" data-anchor-id="원칙-7-에이전트에게는-추출을-시켜라-읽기를-시키지-마라"><span class="header-section-number">1.8.2.1</span> 원칙 7: 에이전트에게는 “추출”을 시켜라, “읽기”를 시키지 마라</h4>
<p>“이 파일들을 읽어라”가 아니라 “이 파일에서 Cat N의 메타데이터를 추출하라”로 지시해야 원자적 디테일이 보존됩니다.</p>
</section>
<section id="원칙-8-cat-3은-항상-단독-에이전트에-할당하라" class="level4" data-number="1.8.2.2">
<h4 data-number="1.8.2.2" class="anchored" data-anchor-id="원칙-8-cat-3은-항상-단독-에이전트에-할당하라"><span class="header-section-number">1.8.2.2</span> 원칙 8: Cat 3은 항상 단독 에이전트에 할당하라</h4>
<p>Cat 3 (중간 산출물)은 DTO 필드 추출 + 파일 스키마 분석이 합쳐져 <strong>가장 분량이 큽니다</strong> (218개 항목 + 637줄 파일 스키마). 다른 카테고리와 묶으면 context window를 초과합니다.</p>
</section>
<section id="원칙-9-대량-처리-시-레포-크기에-따라-전략을-나눠라" class="level4" data-number="1.8.2.3">
<h4 data-number="1.8.2.3" class="anchored" data-anchor-id="원칙-9-대량-처리-시-레포-크기에-따라-전략을-나눠라"><span class="header-section-number">1.8.2.3</span> 원칙 9: 대량 처리 시 레포 크기에 따라 전략을 나눠라</h4>
<pre><code>for repo in repos:
    if repo.file_count &lt; 30:
        single_extraction_agent(repo)
    else:
        parallel_extraction_agents(repo, categories)</code></pre>
</section>
</section>
<section id="llm-추출의-근본적-한계" class="level3" data-number="1.8.3">
<h3 data-number="1.8.3" class="anchored" data-anchor-id="llm-추출의-근본적-한계"><span class="header-section-number">1.8.3</span> LLM 추출의 근본적 한계</h3>
<p>프롬프트를 아무리 정밀하게 만들어도 해결할 수 없는 문제가 있습니다.</p>
<section id="비결정성non-determinism-문제" class="level4" data-number="1.8.3.1">
<h4 data-number="1.8.3.1" class="anchored" data-anchor-id="비결정성non-determinism-문제"><span class="header-section-number">1.8.3.1</span> 비결정성(Non-determinism) 문제</h4>
<p>같은 프롬프트 + 같은 코드로 두 번 실행하면:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>문제</th>
<th>예시</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>행 수 불일치</td>
<td>이번 1,411개, 다음번 1,380개</td>
</tr>
<tr class="even">
<td>행 순서 변동</td>
<td><code>uclust_pct_id</code>가 3번이었다가 7번</td>
</tr>
<tr class="odd">
<td>논리명 흔들림</td>
<td>“UCLUST Percent Identity” vs “UCLUST Identity Threshold”</td>
</tr>
<tr class="even">
<td>누락/추가</td>
<td>private 메서드 포함 여부가 달라짐</td>
</tr>
<tr class="odd">
<td>카테고리 분류 흔들림</td>
<td>같은 항목이 Cat 5에 갔다가 Cat 7에 감</td>
</tr>
</tbody>
</table>
</section>
<section id="왜-이것이-문제인가" class="level4" data-number="1.8.3.2">
<h4 data-number="1.8.3.2" class="anchored" data-anchor-id="왜-이것이-문제인가"><span class="header-section-number">1.8.3.2</span> 왜 이것이 문제인가</h4>
<p>코드 설명 Agent가 메타데이터를 참조할 때, <strong>실행마다 메타데이터가 달라지면 Agent의 응답도 불안정</strong>해집니다. 주기적으로 메타데이터를 갱신해야 하는 운영 환경에서는 치명적입니다.</p>
</section>
<section id="재현성-한계" class="level4" data-number="1.8.3.3">
<h4 data-number="1.8.3.3" class="anchored" data-anchor-id="재현성-한계"><span class="header-section-number">1.8.3.3</span> 재현성 한계</h4>
<table class="caption-top table">
<thead>
<tr class="header">
<th>접근법</th>
<th>재현성</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>정밀 프롬프트만</td>
<td>~70%</td>
</tr>
<tr class="even">
<td>프롬프트 + 참조 예시</td>
<td>~80%</td>
</tr>
<tr class="odd">
<td><strong>프롬프트로는 한계</strong></td>
<td><strong>100%는 불가능</strong></td>
</tr>
</tbody>
</table>
<hr>
</section>
</section>
</section>
<section id="실전에서-배운-세부-교훈들" class="level2" data-number="1.9">
<h2 data-number="1.9" class="anchored" data-anchor-id="실전에서-배운-세부-교훈들"><span class="header-section-number">1.9</span> 실전에서 배운 세부 교훈들</h2>
<section id="파일-스키마-추출은-특별-취급이-필요하다" class="level3" data-number="1.9.1">
<h3 data-number="1.9.1" class="anchored" data-anchor-id="파일-스키마-추출은-특별-취급이-필요하다"><span class="header-section-number">1.9.1</span> 파일 스키마 추출은 특별 취급이 필요하다</h3>
<p>TSV/FASTA 파일의 스키마(구분자, 컬럼 순서, 생산/소비 함수)는 코드의 <strong>실제 write 로직</strong> (f-string 안의 컬럼 순서, 조건부 컬럼 등)을 분석해야 합니다. 단순 추출로는 불가능하며, 전용 에이전트가 코드 흐름을 따라가야 합니다.</p>
</section>
<section id="병합-단계에서-빠지기-쉬운-항목들" class="level3" data-number="1.9.2">
<h3 data-number="1.9.2" class="anchored" data-anchor-id="병합-단계에서-빠지기-쉬운-항목들"><span class="header-section-number">1.9.2</span> 병합 단계에서 빠지기 쉬운 항목들</h3>
<ul>
<li>통계표의 행 수 (에이전트가 <code>*</code>로 남겨두는 경우)</li>
<li>파이프라인 구조 다이어그램</li>
<li>전체 파일 목록 (상단)</li>
<li>품질 검증 체크리스트 (하단)</li>
</ul>
<p>이들은 <strong>오케스트레이터(리더 에이전트 또는 스크립트)</strong>가 자동 생성해야 합니다.</p>
</section>
<section id="permission-모드-주의" class="level3" data-number="1.9.3">
<h3 data-number="1.9.3" class="anchored" data-anchor-id="permission-모드-주의"><span class="header-section-number">1.9.3</span> Permission 모드 주의</h3>
<p><code>bypassPermissions</code> 모드로 에이전트를 실행해도 <code>/tmp</code> 디렉토리 생성에 실패하는 경우가 있었습니다. 산출물 디렉토리는 <strong>에이전트 실행 전에 미리 생성</strong>해 두어야 합니다.</p>
<hr>
</section>
</section>
<section id="결론" class="level2" data-number="1.10">
<h2 data-number="1.10" class="anchored" data-anchor-id="결론"><span class="header-section-number">1.10</span> 결론</h2>
<p>4번의 시행착오에서 배운 핵심:</p>
<ol type="1">
<li><strong>대규모 코드베이스는 단일 에이전트로 처리할 수 없다</strong> – Context window의 물리적 한계</li>
<li><strong>LLM은 추상적 규칙보다 구체적 예시를 따른다</strong> – Gold Standard 참조 문서가 필수</li>
<li><strong>중요 요구사항은 독립 섹션으로 분리해야 한다</strong> – 프롬프트 안에 묻히면 누락됨</li>
<li><strong>“읽어라”와 “추출하라”는 근본적으로 다른 지시다</strong> – 요약 기반 합성은 원자적 디테일을 체계적으로 소실시킨다</li>
<li><strong>순수 LLM 접근은 비결정적이다</strong> – 프롬프트 개선만으로는 100% 재현성을 달성할 수 없다</li>
<li><strong>에이전트의 역할 설계가 결과 품질을 결정한다</strong> – 같은 코드를 봐도 역할에 따라 전혀 다른 출력이 나온다</li>
</ol>
<p>한마디로: <strong>“무엇을 추출할 것인가”는 프롬프트의 영역이지만, “에이전트에게 무엇을 시킬 것인가”는 역할 설계의 영역이다.</strong></p>
<p>이 한계를 인식한 후 설계한 해결책 – AST 코드 파서와 LLM을 결합한 하이브리드 파이프라인 – 은 <a href="../../../../../docs/blog/posts/Agent/01-코드분석/02-하이브리드_파이프라인_설계.html">다음 글</a>에서 다룹니다.</p>


</section>
</section>

 ]]></description>
  <category>Agent</category>
  <category>Code_Analysis</category>
  <category>Prompt_Engineering</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/Agent/01-코드분석/01-메타데이터_시행착오와_설계_원칙.html</guid>
  <pubDate>Thu, 12 Feb 2026 15:00:00 GMT</pubDate>
</item>
<item>
  <title>하이브리드 메타데이터 추출 파이프라인: AST + LLM 자동화 설계</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/Agent/01-코드분석/02-하이브리드_파이프라인_설계.html</link>
  <description><![CDATA[ 






<section id="하이브리드-메타데이터-추출-파이프라인" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> 하이브리드 메타데이터 추출 파이프라인</h1>
<section id="문제-정의-왜-순수-llm이-안-되는가" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="문제-정의-왜-순수-llm이-안-되는가"><span class="header-section-number">1.1</span> 문제 정의: 왜 순수 LLM이 안 되는가</h2>
<p><a href="../../../../../docs/blog/posts/Agent/01-코드분석/01-메타데이터_시행착오와_설계_원칙.html">이전 글</a>에서 4번의 시행착오를 통해 발견한 순수 LLM 접근의 한계:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>문제</th>
<th>영향</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>비결정성</strong></td>
<td>같은 코드로 실행해도 항목 수, 순서, 논리명이 매번 달라짐 (재현성 ~70%)</td>
</tr>
<tr class="even">
<td><strong>높은 비용</strong></td>
<td>7 에이전트 x ~500K tokens, 매 실행마다 전체 재처리</td>
</tr>
<tr class="odd">
<td><strong>느린 속도</strong></td>
<td>~50분/레포 (32개 레포 = ~27시간)</td>
</tr>
<tr class="even">
<td><strong>디테일 소실</strong></td>
<td>읽기-합성 방식에서 원자적 항목의 93%가 누락될 수 있음</td>
</tr>
</tbody>
</table>
<p>이 문제들은 프롬프트 개선만으로는 해결할 수 없습니다. <strong>아키텍처 변경</strong>이 필요합니다.</p>
<hr>
</section>
<section id="핵심-발견-8열-테이블의-75는-결정적으로-추출-가능하다" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="핵심-발견-8열-테이블의-75는-결정적으로-추출-가능하다"><span class="header-section-number">1.2</span> 핵심 발견: 8열 테이블의 75%는 결정적으로 추출 가능하다</h2>
<p>메타데이터 테이블의 8열을 분석하면:</p>
<pre><code>| # | 파일 | 클래스/함수/변수 | 물리명 | 논리명 | 데이터 타입 | 값/기본값 | 의미 |
     +-------------------------------------+  +------------------+
           코드 파서로 100% 결정적 추출             LLM 해석 필요</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>컬럼</th>
<th>추출 방법</th>
<th>결정적?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>#</code></td>
<td>자동 번호</td>
<td>100%</td>
</tr>
<tr class="even">
<td><code>파일</code></td>
<td><code>glob("**/*.py")</code></td>
<td>100%</td>
</tr>
<tr class="odd">
<td><code>클래스/함수/변수</code></td>
<td>Python AST</td>
<td>100%</td>
</tr>
<tr class="even">
<td><code>물리명</code></td>
<td>Python AST</td>
<td>100%</td>
</tr>
<tr class="odd">
<td><strong><code>논리명</code></strong></td>
<td><strong>LLM</strong></td>
<td><strong>비결정적</strong></td>
</tr>
<tr class="even">
<td><code>데이터 타입</code></td>
<td>AST + type hints</td>
<td>95%</td>
</tr>
<tr class="odd">
<td><code>값/기본값</code></td>
<td>AST</td>
<td>100%</td>
</tr>
<tr class="even">
<td><strong><code>의미</code></strong></td>
<td><strong>LLM</strong></td>
<td><strong>비결정적</strong></td>
</tr>
</tbody>
</table>
<p><strong>8열 중 6열은 코드 파서, 2열만 LLM으로 채우면 됩니다.</strong></p>
<hr>
</section>
<section id="하이브리드-아키텍처" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="하이브리드-아키텍처"><span class="header-section-number">1.3</span> 하이브리드 아키텍처</h2>
<pre><code>Phase 1: 결정적 추출 (Python AST 파서)
--------------------------------------------
  glob + ast.parse -&gt; 모든 클래스/함수/변수/상수 추출
  |
  규칙 기반 카테고리 분류 (rules.yaml)
  |
  skeleton.json (8열 중 6열 완성, 논리명/의미는 빈 칸)

Phase 2: LLM 해석
--------------------------------------------
  skeleton.json + 소스코드 컨텍스트 -&gt; Claude API
  |
  논리명 + 의미 + N.1/N.4 해석 메타데이터 생성
  |
  enriched.json (이전 실행 결과 참조하여 안정성 확보)

Phase 3: 렌더링
--------------------------------------------
  enriched.json + Jinja2 템플릿
  |
  METADATA_INVESTIGATION.md (항상 동일 구조)

Phase 4: Diff 검증
--------------------------------------------
  이전 버전과 비교 -&gt; 변경 리포트
  |
  안정성 점수, 신규/삭제/변경 항목 식별</code></pre>
<hr>
</section>
<section id="phase-1-ast-추출기" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="phase-1-ast-추출기"><span class="header-section-number">1.4</span> Phase 1: AST 추출기</h2>
<section id="핵심-코드" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="핵심-코드"><span class="header-section-number">1.4.1</span> 핵심 코드</h3>
<p>Python <code>ast</code> 모듈로 코드의 <strong>사실(fact)</strong>을 결정적으로 추출합니다:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ast, glob, os</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> PythonASTExtractor:</span>
<span id="cb3-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> extract_all(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, repo_path: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>]:</span>
<span id="cb3-5">        items <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb3-6">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sorted()로 파일 순서 고정</span></span>
<span id="cb3-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> py_file <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(glob.glob(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>repo_path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/**/*.py"</span>, recursive<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)):</span>
<span id="cb3-8">            tree <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ast.parse(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(py_file).read())</span>
<span id="cb3-9">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> node <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ast.walk(tree):</span>
<span id="cb3-10">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(node, ast.ClassDef):</span>
<span id="cb3-11">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> item <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> node.body:</span>
<span id="cb3-12">                        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(item, ast.AnnAssign):</span>
<span id="cb3-13">                            items.append({</span>
<span id="cb3-14">                                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># id = 파일:줄번호:물리명 (실행 간 앵커)</span></span>
<span id="cb3-15">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>rel_path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>item<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>lineno<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>item<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>target<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb3-16">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file"</span>: rel_path,</span>
<span id="cb3-17">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"line_number"</span>: item.lineno,</span>
<span id="cb3-18">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"structure"</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>node<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> field"</span>,</span>
<span id="cb3-19">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"physical_name"</span>: item.target.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>,</span>
<span id="cb3-20">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data_type"</span>: ast.unparse(item.annotation),</span>
<span id="cb3-21">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"default_value"</span>: ast.unparse(item.value) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> item.value <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>,</span>
<span id="cb3-22">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logical_name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLM이 채움</span></span>
<span id="cb3-23">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"meaning"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLM이 채움</span></span>
<span id="cb3-24">                            })</span>
<span id="cb3-25">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(items, key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: (x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file"</span>], x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"line_number"</span>]))</span></code></pre></div></div>
<p><strong>핵심:</strong> <code>id</code>가 <code>파일:줄번호:물리명</code>으로 구성되어, 코드가 동일하면 <strong>항상 동일한 ID</strong>가 생성됩니다. 이 ID가 실행 간 일관성의 앵커 역할을 합니다.</p>
</section>
<section id="규칙-기반-카테고리-분류" class="level3" data-number="1.4.2">
<h3 data-number="1.4.2" class="anchored" data-anchor-id="규칙-기반-카테고리-분류"><span class="header-section-number">1.4.2</span> 규칙 기반 카테고리 분류</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rules.yaml</span></span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">categories</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb4-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"중간 산출물"</span></span>
<span id="cb4-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rules</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file_path_match"</span></span>
<span id="cb4-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file_patterns</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*/dto/*.py"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]</span></span>
<span id="cb4-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">structure_types</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"class_field"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]</span></span>
<span id="cb4-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">priority</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  # DTO 필드는 무조건 Cat 3</span></span>
<span id="cb4-10"></span>
<span id="cb4-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span></span>
<span id="cb4-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DB 스키마 및 쿼리"</span></span>
<span id="cb4-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rules</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"file_path_match"</span></span>
<span id="cb4-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file_patterns</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*/repository/*.py"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">,</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*/entity/**/*.py"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]</span></span>
<span id="cb4-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">priority</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span></span>
<span id="cb4-17"></span>
<span id="cb4-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 매칭되지 않은 항목은 Cat 14 (기타)</span></span>
<span id="cb4-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fallback_category</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span></span></code></pre></div></div>
<p>파일 경로, 구조 유형, 물리명 패턴으로 카테고리를 <strong>규칙 기반</strong>으로 분류합니다. LLM이 개입하지 않으므로 <strong>항상 동일한 분류 결과</strong>가 나옵니다.</p>
<hr>
</section>
</section>
<section id="phase-2-llm-해석-이전-결과-참조" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="phase-2-llm-해석-이전-결과-참조"><span class="header-section-number">1.5</span> Phase 2: LLM 해석 + 이전 결과 참조</h2>
<p>LLM이 담당하는 <code>논리명</code>과 <code>의미</code>의 안정성을 확보하는 핵심 메커니즘:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> build_prompt(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, skeleton_items, previous_items):</span>
<span id="cb5-2">    prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb5-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ## 기존 항목 검증 (변경 불필요 시 그대로 유지)</span></span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    아래 항목들은 이전 실행에서 이미 해석되었습니다.</span></span>
<span id="cb5-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    코드 변경으로 인해 의미가 달라진 항목만 수정하세요.</span></span>
<span id="cb5-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    **변경이 없으면 반드시 그대로 유지하세요.**</span></span>
<span id="cb5-8"></span>
<span id="cb5-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ## 신규 항목 해석 (새로 작성)</span></span>
<span id="cb5-10"></span>
<span id="cb5-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    아래 항목들은 이전 실행에 없던 신규 항목입니다.</span></span>
<span id="cb5-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    logical_name(영문 Title Case)과 meaning(한글 1~2문장)을 작성하세요.</span></span>
<span id="cb5-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span></code></pre></div></div>
<p>이전 실행 결과를 <strong>명시적으로 제공</strong>하고 “변경 없으면 유지”를 지시하면, LLM이 담당하는 2열도 <strong>95%+ 안정성</strong>을 확보합니다.</p>
<hr>
</section>
<section id="phase-3-jinja2-렌더링" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="phase-3-jinja2-렌더링"><span class="header-section-number">1.6</span> Phase 3: Jinja2 렌더링</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource jinja2 number-lines code-with-copy"><code class="sourceCode"><span id="cb6-1">{% for cat in categories %}</span>
<span id="cb6-2">## {{ cat.number }}. {{ cat.name }}</span>
<span id="cb6-3"></span>
<span id="cb6-4">### {{ cat.number }}.1 추출 가능 이유</span>
<span id="cb6-5">{{ cat.rationale }}</span>
<span id="cb6-6"></span>
<span id="cb6-7">### {{ cat.number }}.2 조사 대상 파일 목록</span>
<span id="cb6-8">{% for f in cat.files %}</span>
<span id="cb6-9">- `{ f }`</span>
<span id="cb6-10">{% endfor %}</span>
<span id="cb6-11"></span>
<span id="cb6-12">### {{ cat.number }}.3 상세 내용</span>
<span id="cb6-13"></span>
<span id="cb6-14">| # | 파일 | 클래스/함수/변수 | 물리명 | 논리명 | 데이터 타입 | 값/기본값 | 의미 |</span>
<span id="cb6-15">|---|------|------------------|--------|--------|-------------|-----------|------|</span>
<span id="cb6-16">{% for item in cat.items %}</span>
<span id="cb6-17">| {{ item.number }} | `{ item.file }` | {{ item.structure }} | `{ item.physical_name }` | {{ item.logical_name }} | `{ item.data_type }` | {{ item.default }} | {{ item.meaning }} |</span>
<span id="cb6-18">{% endfor %}</span>
<span id="cb6-19"></span>
<span id="cb6-20">### {{ cat.number }}.4 해석 메타데이터</span>
<span id="cb6-21">{{ cat.interpretation }}</span>
<span id="cb6-22">{% endfor %}</span></code></pre></div></div>
<p>같은 JSON이 들어오면 <strong>항상 동일한 Markdown</strong>이 출력됩니다. 병합 과정의 ad-hoc 작업이 완전히 제거됩니다.</p>
<hr>
</section>
<section id="phase-4-diff-검증" class="level2" data-number="1.7">
<h2 data-number="1.7" class="anchored" data-anchor-id="phase-4-diff-검증"><span class="header-section-number">1.7</span> Phase 4: Diff 검증</h2>
<pre><code>=== 메타데이터 변경 리포트 ===
이전: 1,411개 -&gt; 현재: 1,423개 (+12)
안정성 점수: 0.9915 (99.15%)

[신규 추가] 12개:
  + automsa/common/module/new_feature.py:15:threshold  (Cat 5)
  ...

[삭제] 0개
[의미 변경] 0개
[카테고리 이동] 0개</code></pre>
<hr>
</section>
<section id="비용시간재현성-비교" class="level2" data-number="1.8">
<h2 data-number="1.8" class="anchored" data-anchor-id="비용시간재현성-비교"><span class="header-section-number">1.8</span> 비용/시간/재현성 비교</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 56%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th>항목</th>
<th>순수 LLM (7 에이전트)</th>
<th>하이브리드</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Phase 1 (추출)</td>
<td>-</td>
<td><strong>30초</strong> (AST)</td>
</tr>
<tr class="even">
<td>Phase 2 (해석)</td>
<td>7 에이전트 x 5분 = <strong>35분</strong></td>
<td>14 API 호출 x 30초 = <strong>7분</strong></td>
</tr>
<tr class="odd">
<td>Phase 3 (렌더링)</td>
<td>수동 병합 <strong>10분</strong></td>
<td><strong>1초</strong> (Jinja2)</td>
</tr>
<tr class="even">
<td>Phase 4 (검증)</td>
<td>수동 확인</td>
<td><strong>1초</strong> (자동)</td>
</tr>
<tr class="odd">
<td><strong>총 시간</strong></td>
<td><strong>~50분</strong></td>
<td><strong>~8분</strong></td>
</tr>
<tr class="even">
<td><strong>토큰 비용</strong></td>
<td>~500K tokens</td>
<td>~80K tokens (1/6)</td>
</tr>
<tr class="odd">
<td><strong>재현성</strong></td>
<td>~70%</td>
<td><strong>~99%</strong></td>
</tr>
<tr class="even">
<td><strong>코드 변경 시</strong></td>
<td>전체 재실행</td>
<td>변경분만 재실행</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="점진적-도입-경로" class="level2" data-number="1.9">
<h2 data-number="1.9" class="anchored" data-anchor-id="점진적-도입-경로"><span class="header-section-number">1.9</span> 점진적 도입 경로</h2>
<p>한 번에 전체를 구축할 필요 없습니다:</p>
<section id="step-1-ast-skeleton만-생성-즉시-효과" class="level3" data-number="1.9.1">
<h3 data-number="1.9.1" class="anchored" data-anchor-id="step-1-ast-skeleton만-생성-즉시-효과"><span class="header-section-number">1.9.1</span> Step 1: AST Skeleton만 생성 (즉시 효과)</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> extractor.py phase1 /path/to/repo <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--output</span> skeleton.json</span></code></pre></div></div>
<p>이것만으로도 <strong>행 수, 행 순서, 카테고리 분류가 100% 고정</strong>됩니다. skeleton.json을 에이전트에게 전달하면, 에이전트는 빈 칸(논리명, 의미)만 채우면 됩니다.</p>
<blockquote class="blockquote">
<p>Step 1만으로 가장 큰 문제(비결정성)의 80%가 해결됩니다.</p>
</blockquote>
</section>
<section id="step-2-llm-api-자동화-이전-결과-참조" class="level3" data-number="1.9.2">
<h3 data-number="1.9.2" class="anchored" data-anchor-id="step-2-llm-api-자동화-이전-결과-참조"><span class="header-section-number">1.9.2</span> Step 2: LLM API 자동화 + 이전 결과 참조</h3>
<p>Claude API로 논리명/의미를 자동 채우고, previous.json 참조 메커니즘을 추가합니다.</p>
</section>
<section id="step-3-템플릿-diff-리포트-cicd-통합" class="level3" data-number="1.9.3">
<h3 data-number="1.9.3" class="anchored" data-anchor-id="step-3-템플릿-diff-리포트-cicd-통합"><span class="header-section-number">1.9.3</span> Step 3: 템플릿 + Diff 리포트 + CI/CD 통합</h3>
<p>Jinja2 렌더링, Diff 검증을 완성하고, 코드 변경 시 자동 실행되도록 CI/CD에 통합합니다.</p>
<hr>
</section>
</section>
<section id="ast만으로는-부족한-영역" class="level2" data-number="1.10">
<h2 data-number="1.10" class="anchored" data-anchor-id="ast만으로는-부족한-영역"><span class="header-section-number">1.10</span> AST만으로는 부족한 영역</h2>
<p>하이브리드 파이프라인에서도 LLM이 여전히 필수적인 영역이 있습니다:</p>
<section id="파일-스키마-추출" class="level3" data-number="1.10.1">
<h3 data-number="1.10.1" class="anchored" data-anchor-id="파일-스키마-추출"><span class="header-section-number">1.10.1</span> 파일 스키마 추출</h3>
<p>TSV/FASTA 파일의 스키마(구분자, 컬럼 순서, 생산/소비 함수)는 AST로 <strong>함수 시그니처</strong>는 추출할 수 있지만, <strong>실제 write 로직</strong> (f-string 안의 컬럼 순서, 조건부 컬럼 등)은 코드 흐름 분석이 필요합니다.</p>
</section>
<section id="해석-메타데이터-n.4-섹션" class="level3" data-number="1.10.2">
<h3 data-number="1.10.2" class="anchored" data-anchor-id="해석-메타데이터-n.4-섹션"><span class="header-section-number">1.10.2</span> 해석 메타데이터 (N.4 섹션)</h3>
<p>항목 간 관계, 암묵적 규칙, 상태 전이 조건 등은 코드의 <strong>의미론적 이해</strong>가 필요하며, AST의 구문론적 분석만으로는 도출할 수 없습니다.</p>
</section>
<section id="카테고리-경계의-애매한-항목" class="level3" data-number="1.10.3">
<h3 data-number="1.10.3" class="anchored" data-anchor-id="카테고리-경계의-애매한-항목"><span class="header-section-number">1.10.3</span> 카테고리 경계의 애매한 항목</h3>
<p>규칙 기반 분류로 90%는 해결되지만, 여러 카테고리에 걸치는 항목의 “주 카테고리” 결정은 LLM의 판단이 필요합니다.</p>
<hr>
</section>
</section>
<section id="결론" class="level2" data-number="1.11">
<h2 data-number="1.11" class="anchored" data-anchor-id="결론"><span class="header-section-number">1.11</span> 결론</h2>
<p>대규모 코드베이스의 메타데이터를 주기적으로 추출해야 하는 상황에서:</p>
<ol type="1">
<li><strong>코드 파서(AST)가 사실을 고정하고, LLM은 해석만 담당하는 하이브리드가 정답이다</strong></li>
<li><strong>이전 실행 결과를 참조</strong>하면 LLM 해석의 안정성도 95%+로 올릴 수 있다</li>
<li><strong>Jinja2 템플릿</strong>으로 렌더링하면 출력 형식이 100% 결정적이다</li>
<li><strong>Diff 검증</strong>으로 변경을 추적하면 운영 환경에서의 안정성이 보장된다</li>
<li><strong>Step 1(AST Skeleton)만으로도</strong> 비결정성 문제의 80%가 즉시 해결된다</li>
</ol>
<p>한마디로: <strong>“무엇을 추출할 것인가”는 프롬프트의 영역이지만, “어떻게 안정적으로 반복할 것인가”는 아키텍처의 영역이다.</strong></p>


</section>
</section>

 ]]></description>
  <category>Agent</category>
  <category>Code_Analysis</category>
  <category>Architecture</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/Agent/01-코드분석/02-하이브리드_파이프라인_설계.html</guid>
  <pubDate>Thu, 12 Feb 2026 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Claude Code</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/Claude_Code/</link>
  <description><![CDATA[ 






<section id="claude-code" class="level2" data-number="1">

<section id="팀-환경-구축" class="level3" data-number="1.1">

<ol type="1">
<li><a href="../../../../docs/blog/posts/Claude_Code/01-팀_설정_구축/01-Claude_Code_팀_설정_구축.html">01-Claude Code Max 팀 설정 완전 가이드</a></li>
</ol>


</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>Claude_Code</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/Claude_Code/</guid>
  <pubDate>Wed, 11 Feb 2026 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Claude Code Max 팀 설정 완전 가이드</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/Claude_Code/01-팀_설정_구축/01-Claude_Code_팀_설정_구축.html</link>
  <description><![CDATA[ 






<section id="claude-code-max-팀-설정-완전-가이드" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Claude Code Max 팀 설정 완전 가이드</h1>
<section id="배경" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="배경"><span class="header-section-number">1.1</span> 배경</h2>
<p><a href="https://docs.anthropic.com/en/docs/claude-code">Claude Code</a>는 Anthropic에서 만든 CLI 기반 AI 코딩 어시스턴트입니다. 터미널에서 직접 실행되며, 코드 작성/수정, 디버깅, Git 작업, 테스트 등 소프트웨어 엔지니어링 전반을 지원합니다.</p>
<p>이 포스트에서는 팀 전체가 동일한 Claude Code 환경을 사용할 수 있도록 <strong>팀 설정 레포지토리를 클론하고, 모든 도구를 설치하는 과정</strong>을 기록합니다.</p>
<hr>
</section>
<section id="단계-ssh를-이용한-private-레포-클론" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="단계-ssh를-이용한-private-레포-클론"><span class="header-section-number">1.2</span> 1단계: SSH를 이용한 Private 레포 클론</h2>
<p>팀 설정 레포는 GitHub 조직의 private 레포이므로 SSH 인증이 필요합니다.</p>
<section id="ssh-키-및-config-설정" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="ssh-키-및-config-설정"><span class="header-section-number">1.2.1</span> SSH 키 및 config 설정</h3>
<p><code>~/.ssh/config</code>에 조직용 호스트를 등록합니다:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Host</span> seegene</span>
<span id="cb1-2">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">User</span> git</span>
<span id="cb1-3">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">HostName</span> github.com</span>
<span id="cb1-4">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Port</span> 22</span>
<span id="cb1-5">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">IdentityFile</span> ~/.ssh/seegene</span></code></pre></div></div>
</section>
<section id="클론-실행" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="클론-실행"><span class="header-section-number">1.2.2</span> 클론 실행</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone git@seegene:seegene/claude-code-team-config.git</span></code></pre></div></div>
<p>SSH 호스트 별칭(<code>seegene</code>)을 사용하면 HTTPS 인증 없이도 private 레포에 접근할 수 있습니다.</p>
<hr>
</section>
</section>
<section id="단계-팀-기본-설정-설치-install.sh" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="단계-팀-기본-설정-설치-install.sh"><span class="header-section-number">1.3</span> 2단계: 팀 기본 설정 설치 (install.sh)</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> claude-code-team-config</span>
<span id="cb3-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">./install.sh</span></span></code></pre></div></div>
<p>이 스크립트가 <code>~/.claude/</code>에 설치하는 항목:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>항목</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>CLAUDE.md</code></td>
<td>팀 공통 글로벌 지침 (한국어 응답, 코딩 스타일 등)</td>
</tr>
<tr class="even">
<td><code>settings.json</code></td>
<td>훅, 권한, Agent Teams 환경변수</td>
</tr>
<tr class="odd">
<td><code>rules/</code> (9개)</td>
<td>보안, 테스팅, Git 워크플로우 등 코딩 규칙</td>
</tr>
<tr class="even">
<td><code>agents/</code> (9개)</td>
<td>planner, architect, tdd-guide 등 전문 에이전트</td>
</tr>
<tr class="odd">
<td><code>commands/</code> (26개)</td>
<td>/plan, /tdd, /code-review 등 슬래시 명령어</td>
</tr>
<tr class="even">
<td><code>hooks/</code></td>
<td>Prettier 자동 포맷, TypeScript 체크, Codiens 데이터 수집</td>
</tr>
</tbody>
</table>
<p>기존 설정이 있으면 <code>~/.claude/backup-YYYYMMDD-HHMMSS/</code>에 자동 백업됩니다.</p>
<hr>
</section>
<section id="단계-생산성-도구-설치" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="단계-생산성-도구-설치"><span class="header-section-number">1.4</span> 3단계: 생산성 도구 설치</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">brew</span> install tmux bat lsd fzf</span></code></pre></div></div>
<table class="caption-top table">
<thead>
<tr class="header">
<th>도구</th>
<th>용도</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>tmux</strong></td>
<td>Agent Teams 분할 창 모드에 필수</td>
</tr>
<tr class="even">
<td><strong>bat</strong></td>
<td>문법 강조가 되는 cat 대체</td>
</tr>
<tr class="odd">
<td><strong>lsd</strong></td>
<td>아이콘이 있는 ls 대체</td>
</tr>
<tr class="even">
<td><strong>fzf</strong></td>
<td>퍼지 검색 (Ctrl+R로 명령어 히스토리 검색)</td>
</tr>
</tbody>
</table>
<section id="tmux-설정-.tmux.conf" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="tmux-설정-.tmux.conf"><span class="header-section-number">1.4.1</span> tmux 설정 (<code>~/.tmux.conf</code>)</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 마우스 지원</span></span>
<span id="cb5-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-g</span> mouse on</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 256색 지원</span></span>
<span id="cb5-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-g</span> default-terminal <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"screen-256color"</span></span>
<span id="cb5-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-ga</span> terminal-overrides <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">",xterm-256color:Tc"</span></span>
<span id="cb5-7"></span>
<span id="cb5-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 패널 분할 (직관적)</span></span>
<span id="cb5-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bind</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">split-window</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-h</span></span>
<span id="cb5-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bind</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> split-window <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-v</span></span>
<span id="cb5-11"></span>
<span id="cb5-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vim 스타일 패널 이동</span></span>
<span id="cb5-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bind</span> h select-pane <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-L</span></span>
<span id="cb5-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bind</span> j select-pane <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-D</span></span>
<span id="cb5-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bind</span> k select-pane <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-U</span></span>
<span id="cb5-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bind</span> l select-pane <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span></span>
<span id="cb5-17"></span>
<span id="cb5-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 히스토리 크기</span></span>
<span id="cb5-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-g</span> history-limit 50000</span>
<span id="cb5-20"></span>
<span id="cb5-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 인덱스 1부터 시작</span></span>
<span id="cb5-22"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-g</span> base-index 1</span>
<span id="cb5-23"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">setw</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-g</span> pane-base-index 1</span></code></pre></div></div>
<p>tmux는 Claude Code의 <strong>Agent Teams</strong> 기능에 필수입니다. 여러 에이전트가 각각 독립된 tmux 패널에서 동시에 작업하는 것을 시각적으로 확인할 수 있습니다.</p>
<hr>
</section>
</section>
<section id="단계-bioskills-설치-바이오인포매틱스-425개-스킬" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="단계-bioskills-설치-바이오인포매틱스-425개-스킬"><span class="header-section-number">1.5</span> 4단계: bioSkills 설치 (바이오인포매틱스 425개 스킬)</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">./install-bioskills.sh</span></span></code></pre></div></div>
<p><a href="https://github.com/GPTomics/bioSkills">GPTomics/bioSkills</a> 레포에서 바이오인포매틱스 전문 스킬을 설치합니다. 56개 카테고리, 425개 스킬이 <code>~/.claude/skills/</code>에 설치됩니다.</p>
<section id="주요-카테고리" class="level3" data-number="1.5.1">
<h3 data-number="1.5.1" class="anchored" data-anchor-id="주요-카테고리"><span class="header-section-number">1.5.1</span> 주요 카테고리</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>카테고리</th>
<th>스킬 예시</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>variant-calling</td>
<td>GATK, DeepVariant, VCF 처리</td>
</tr>
<tr class="even">
<td>single-cell</td>
<td>scRNA-seq, trajectory, perturb-seq</td>
</tr>
<tr class="odd">
<td>alignment</td>
<td>SAM/BAM 처리, MSA, pairwise alignment</td>
</tr>
<tr class="even">
<td>chip-seq</td>
<td>peak calling, motif analysis</td>
</tr>
<tr class="odd">
<td>spatial-transcriptomics</td>
<td>공간 전사체 분석</td>
</tr>
<tr class="even">
<td>workflows</td>
<td>Nextflow, Snakemake, WDL 파이프라인</td>
</tr>
</tbody>
</table>
<p>설치 후 Claude Code에 자연어로 요청하면 해당 스킬이 자동 활성화됩니다:</p>
<pre><code>"RNA-seq 카운트 데이터에서 차등 발현 유전자를 찾아줘"
"BAM 파일에서 변이를 호출해줘"</code></pre>
<hr>
</section>
</section>
<section id="단계-speckit-설치-spec-driven-development" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="단계-speckit-설치-spec-driven-development"><span class="header-section-number">1.6</span> 5단계: SpecKit 설치 (Spec-Driven Development)</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">./install-speckit.sh</span></span></code></pre></div></div>
<p>GitHub의 <a href="https://github.com/github/spec-kit">spec-kit</a> 기반 Spec-Driven Development 도구를 설치합니다.</p>
<section id="설치되는-슬래시-명령어-9개" class="level3" data-number="1.6.1">
<h3 data-number="1.6.1" class="anchored" data-anchor-id="설치되는-슬래시-명령어-9개"><span class="header-section-number">1.6.1</span> 설치되는 슬래시 명령어 (9개)</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>명령어</th>
<th>기능</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>/speckit-constitution</code></td>
<td>프로젝트 원칙 수립</td>
</tr>
<tr class="even">
<td><code>/speckit-specify</code></td>
<td>기능 명세 작성</td>
</tr>
<tr class="odd">
<td><code>/speckit-plan</code></td>
<td>구현 계획 생성</td>
</tr>
<tr class="even">
<td><code>/speckit-tasks</code></td>
<td>태스크 분해</td>
</tr>
<tr class="odd">
<td><code>/speckit-taskstoissues</code></td>
<td>태스크를 이슈로 변환</td>
</tr>
<tr class="even">
<td><code>/speckit-implement</code></td>
<td>명세 기반 구현</td>
</tr>
<tr class="odd">
<td><code>/speckit-checklist</code></td>
<td>QA 체크리스트 생성</td>
</tr>
<tr class="even">
<td><code>/speckit-analyze</code></td>
<td>기존 코드 분석</td>
</tr>
<tr class="odd">
<td><code>/speckit-clarify</code></td>
<td>요구사항 명확화</td>
</tr>
</tbody>
</table>
<hr>
</section>
</section>
<section id="단계-hook-시스템" class="level2" data-number="1.7">
<h2 data-number="1.7" class="anchored" data-anchor-id="단계-hook-시스템"><span class="header-section-number">1.7</span> 6단계: Hook 시스템</h2>
<p>팀 설정에는 14개의 Hook이 포함되어 있습니다. Hook은 Claude Code의 도구 실행 전후에 자동으로 실행되는 스크립트입니다.</p>
<section id="hook-구성" class="level3" data-number="1.7.1">
<h3 data-number="1.7.1" class="anchored" data-anchor-id="hook-구성"><span class="header-section-number">1.7.1</span> Hook 구성</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 32%">
<col style="width: 24%">
<col style="width: 44%">
</colgroup>
<thead>
<tr class="header">
<th>타이밍</th>
<th>수량</th>
<th>주요 동작</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>PreToolUse</strong></td>
<td>4개</td>
<td>dev 서버 tmux 강제, tmux 사용 알림, git push 일시정지, .md 생성 차단</td>
</tr>
<tr class="even">
<td><strong>PostToolUse</strong></td>
<td>5개</td>
<td>PR URL 로그, Prettier 자동 포맷, TypeScript 체크, console.log 경고, Codiens 실시간 전송</td>
</tr>
<tr class="odd">
<td><strong>Stop</strong></td>
<td>3개</td>
<td>console.log 최종 감사, MEMORY.md 리마인더, Codiens 세션 동기화</td>
</tr>
<tr class="even">
<td><strong>UserPromptSubmit</strong></td>
<td>1개</td>
<td>학습 키워드 감지 시 MEMORY.md 업데이트 리마인더</td>
</tr>
<tr class="odd">
<td><strong>PreCompact</strong></td>
<td>1개</td>
<td>컨텍스트 압축 전 MEMORY.md 강제 저장 알림</td>
</tr>
</tbody>
</table>
</section>
<section id="주요-hook-상세" class="level3" data-number="1.7.2">
<h3 data-number="1.7.2" class="anchored" data-anchor-id="주요-hook-상세"><span class="header-section-number">1.7.2</span> 주요 Hook 상세</h3>
<p><strong>코드 품질 Hook:</strong></p>
<ul>
<li><code>.ts/.tsx/.js/.jsx</code> 파일 편집 후 <strong>Prettier 자동 포맷</strong></li>
<li><code>.ts/.tsx</code> 파일 편집 후 <strong>TypeScript 타입 체크</strong> (<code>tsc --noEmit</code>)</li>
<li><code>console.log</code> 발견 시 경고, 세션 종료 시 최종 감사</li>
<li><code>git push</code> 전 리뷰 일시정지 (Enter로 계속, Ctrl+C로 취소)</li>
</ul>
<p><strong>Codiens Hook (사용 데이터 수집):</strong></p>
<ul>
<li>도구 사용 시 실시간 데이터 전송 (<code>cc-sync-realtime.mjs</code>)</li>
<li>세션 종료 시 전체 세션 데이터 동기화 (<code>cc-sync-session.mjs</code>)</li>
</ul>
<p><strong>Memory Hook:</strong></p>
<ul>
<li>학습 키워드(“실수”, “오류”, “에러” 등) 감지 시 MEMORY.md 업데이트 리마인더</li>
<li>컨텍스트 압축 전 학습 내용 강제 저장 알림</li>
</ul>
<hr>
</section>
</section>
<section id="단계-설치-검증" class="level2" data-number="1.8">
<h2 data-number="1.8" class="anchored" data-anchor-id="단계-설치-검증"><span class="header-section-number">1.8</span> 7단계: 설치 검증</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">./verify.sh</span></span></code></pre></div></div>
<pre><code>[OK] CLAUDE.md (global instructions)
[OK] settings.json
[OK] settings.local.json (optional)
[OK] rules/ (11 files)
[OK] agents/ (9 files)
[OK] commands/ (35 files)
[OK] hooks/ (4 files)
[OK] 전체 rule/agent/hooks.json 검증 통과</code></pre>
<hr>
</section>
<section id="최종-설치-현황" class="level2" data-number="1.9">
<h2 data-number="1.9" class="anchored" data-anchor-id="최종-설치-현황"><span class="header-section-number">1.9</span> 최종 설치 현황</h2>
<pre><code>~/.claude/
├── CLAUDE.md                    # 팀 공통 글로벌 지침
├── settings.json                # Claude Code 설정
├── settings.local.json          # 개인별 설정
├── rules/                       # 코딩 규칙 (11개)
├── agents/                      # 전문 에이전트 (9개)
├── commands/                    # 슬래시 명령어 (35개)
├── hooks/                       # 훅 스크립트
├── skills/                      # bioSkills (425개)
├── templates/speckit/           # SpecKit 템플릿
└── backup-YYYYMMDD-HHMMSS/     # 기존 설정 백업

~/.tmux.conf                     # tmux 설정</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>구분</th>
<th>수량</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>에이전트</td>
<td>9개</td>
</tr>
<tr class="even">
<td>슬래시 명령어</td>
<td>35개 (기본 26 + SpecKit 9)</td>
</tr>
<tr class="odd">
<td>bioSkills</td>
<td>425개</td>
</tr>
<tr class="even">
<td>코딩 규칙 (rules)</td>
<td>11개</td>
</tr>
<tr class="odd">
<td>Hook</td>
<td>14개</td>
</tr>
<tr class="even">
<td><strong>합계</strong></td>
<td><strong>494개</strong></td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="에이전트-목록" class="level2" data-number="1.10">
<h2 data-number="1.10" class="anchored" data-anchor-id="에이전트-목록"><span class="header-section-number">1.10</span> 에이전트 목록</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>에이전트</th>
<th>용도</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>planner</code></td>
<td>기능 구현 계획 수립</td>
</tr>
<tr class="even">
<td><code>architect</code></td>
<td>시스템 설계 및 아키텍처</td>
</tr>
<tr class="odd">
<td><code>tdd-guide</code></td>
<td>테스트 주도 개발 가이드</td>
</tr>
<tr class="even">
<td><code>code-reviewer</code></td>
<td>코드 품질/보안 리뷰</td>
</tr>
<tr class="odd">
<td><code>security-reviewer</code></td>
<td>보안 취약점 분석</td>
</tr>
<tr class="even">
<td><code>build-error-resolver</code></td>
<td>빌드 에러 해결</td>
</tr>
<tr class="odd">
<td><code>e2e-runner</code></td>
<td>Playwright E2E 테스팅</td>
</tr>
<tr class="even">
<td><code>refactor-cleaner</code></td>
<td>데드 코드 정리</td>
</tr>
<tr class="odd">
<td><code>doc-updater</code></td>
<td>문서 업데이트</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="트러블슈팅" class="level2" data-number="1.11">
<h2 data-number="1.11" class="anchored" data-anchor-id="트러블슈팅"><span class="header-section-number">1.11</span> 트러블슈팅</h2>
<section id="codiens-hook-도메인-수정" class="level3" data-number="1.11.1">
<h3 data-number="1.11.1" class="anchored" data-anchor-id="codiens-hook-도메인-수정"><span class="header-section-number">1.11.1</span> Codiens Hook 도메인 수정</h3>
<p>설치 직후 Codiens 대시보드에 데이터가 전송되지 않는 문제가 있었습니다. 원인은 <code>~/.claude/hooks/lib/constants.mjs</code>의 API URL 도메인 오타:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource javascript number-lines code-with-copy"><code class="sourceCode javascript"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 수정 전 (오타)</span></span>
<span id="cb12-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">export</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> API_BASE_URL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">process</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">env</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">CC_API_URL</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://tech.dev.srarch.net/api/claude-code'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-3"></span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 수정 후</span></span>
<span id="cb12-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">export</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">const</span> API_BASE_URL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">process</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">env</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">CC_API_URL</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://tech.dev.sgarch.net/api/claude-code'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
</section>
<section id="일반적인-문제-해결" class="level3" data-number="1.11.2">
<h3 data-number="1.11.2" class="anchored" data-anchor-id="일반적인-문제-해결"><span class="header-section-number">1.11.2</span> 일반적인 문제 해결</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>문제</th>
<th>해결</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>SSH 클론 실패</td>
<td><code>ssh -T git@seegene</code>으로 연결 확인</td>
</tr>
<tr class="even">
<td>설정 미적용</td>
<td>Claude Code 재시작 (<code>/exit</code> 후 <code>claude</code>)</td>
</tr>
<tr class="odd">
<td>기존 설정 충돌</td>
<td><code>./uninstall.sh --restore</code>로 백업 복원</td>
</tr>
<tr class="even">
<td>tmux 오류</td>
<td><code>tmux kill-server</code> 후 재시작</td>
</tr>
<tr class="odd">
<td>Hook 오류</td>
<td><code>which node</code>로 Node.js 확인 (Hook 실패해도 Claude Code에 영향 없음)</td>
</tr>
</tbody>
</table>
<hr>
</section>
</section>
<section id="마무리" class="level2" data-number="1.12">
<h2 data-number="1.12" class="anchored" data-anchor-id="마무리"><span class="header-section-number">1.12</span> 마무리</h2>
<p>이 설정을 통해 팀 전체가 동일한 규칙, 에이전트, Hook 시스템을 공유하며 Claude Code를 활용할 수 있습니다. 특히 바이오인포매틱스 팀에게는 425개의 bioSkills가 큰 도움이 됩니다.</p>
<p>다음 포스트에서는 실제 프로젝트에서 Claude Code의 에이전트와 슬래시 명령어를 활용하는 워크플로우를 다루겠습니다.</p>


</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>Claude_Code</category>
  <category>DevOps</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/Claude_Code/01-팀_설정_구축/01-Claude_Code_팀_설정_구축.html</guid>
  <pubDate>Wed, 11 Feb 2026 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Parent Document Retriever</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/05-ParentDocumentRetriever.html</link>
  <description><![CDATA[ 






<section id="parent-document-retriever-개요" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="parent-document-retriever-개요"><span class="header-section-number">1</span> Parent Document Retriever 개요</h2>
<section id="기본-개념" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="기본-개념"><span class="header-section-number">1.1</span> 기본 개념</h3>
<ul>
<li><strong>Child Document</strong>: Document, Sub Document, Split, Split Document, Chunk 등으로도 불리는 작은 단위의 문서 조각</li>
<li><strong>Parent Document</strong>: Child Document들이 생성된 원본 문서 또는 더 큰 단위의 상위 문서</li>
</ul>
</section>
<section id="parentdocumentretriever의-필요성" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="parentdocumentretriever의-필요성"><span class="header-section-number">1.2</span> ParentDocumentRetriever의 필요성</h3>
<section id="계층적-문서-구조의-활용" class="level4" data-number="1.2.1">
<h4 data-number="1.2.1" class="anchored" data-anchor-id="계층적-문서-구조의-활용"><span class="header-section-number">1.2.1</span> 계층적 문서 구조의 활용</h4>
<p>전통적인 RAG 시스템에서는 Child Document만을 사용하여 검색과 응답 생성을 수행한다. 하지만 특정 상황에서는 원본 문서(Parent Document)의 맥락이 필요한 경우가 있다.</p>
</section>
<section id="향상된-rag-아키텍처" class="level4" data-number="1.2.2">
<h4 data-number="1.2.2" class="anchored" data-anchor-id="향상된-rag-아키텍처"><span class="header-section-number">1.2.2</span> 향상된 RAG 아키텍처</h4>
<p>단순히 검색된 Child Document를 LLM에 직접 입력하는 것보다, 다음과 같은 고도화된 프로세스를 통해 더 나은 결과를 얻을 수 있다:</p>
<ol type="1">
<li>Child Document로 정확한 검색 수행</li>
<li>해당 Child Document가 포함된 Parent Document에서 앞뒤 맥락 추출</li>
<li>추출된 맥락을 별도 LLM으로 실시간 요약</li>
<li>요약된 결과를 최종 RAG LLM에 입력</li>
</ol>
<p>이러한 접근법은 <strong>할루시네이션 감소</strong>와 <strong>답변 품질 향상</strong>에 크게 기여한다.</p>
</section>
<section id="parentdocumentretriever의-역할" class="level4" data-number="1.2.3">
<h4 data-number="1.2.3" class="anchored" data-anchor-id="parentdocumentretriever의-역할"><span class="header-section-number">1.2.3</span> ParentDocumentRetriever의 역할</h4>
<p>ParentDocumentRetriever는 이러한 계층적 문서 구조를 효과적으로 활용할 수 있도록 설계된 특화된 Retriever이다. 원본 문서의 맥락이 필요한 모든 상황에서 사용할 수 있다.</p>
</section>
</section>
</section>
<section id="rag의-청킹-딜레마" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="rag의-청킹-딜레마"><span class="header-section-number">2</span> RAG의 청킹 딜레마</h2>
<section id="문제-상충되는-두-가지-요구사항" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="문제-상충되는-두-가지-요구사항"><span class="header-section-number">2.1</span> 문제: 상충되는 두 가지 요구사항</h3>
<p>RAG 시스템에서 문서를 청크(chunk)로 분할할 때 다음의 <strong>트레이드오프 (정확한 임베딩 vs 넓은 범위의 맥락)</strong>에 직면하게 된다.</p>
<p><strong>요구사항 1: 작은 청크 (정확한 임베딩)</strong><br>
- <strong>목적</strong>: 임베딩이 청크의 의미를 정확하게 표현<br>
- <strong>이유</strong>: 긴 텍스트의 임베딩은 다양한 주제가 섞여 의미가 희석된다<br>
- <strong>장점</strong>: 검색 정확도 향상<br>
- <strong>단점</strong>: 맥락 손실</p>
<p><strong>요구사항 2: 큰 청크 (충분한 맥락)</strong><br>
- <strong>목적</strong>: LLM이 답변 생성 시 필요한 맥락 제공<br>
- <strong>이유</strong>: 작은 청크만으로는 질문에 답하기 어려울 수 있다<br>
- <strong>장점</strong>: 풍부한 맥락 정보<br>
- <strong>단점</strong>: 임베딩 품질 저하</p>
<p><strong>청킹 딜레마 예시</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">청크 크기</th>
<th style="text-align: left;">임베딩 품질</th>
<th style="text-align: left;">맥락 유지</th>
<th style="text-align: left;">검색 정확도</th>
<th style="text-align: left;">LLM 답변 품질</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">작음 (200자)</td>
<td style="text-align: left;"><strong>높음</strong></td>
<td style="text-align: left;">낮음</td>
<td style="text-align: left;"><strong>높음</strong></td>
<td style="text-align: left;">낮음</td>
</tr>
<tr class="even">
<td style="text-align: left;">중간 (500자)</td>
<td style="text-align: left;">중간</td>
<td style="text-align: left;">중간</td>
<td style="text-align: left;">중간</td>
<td style="text-align: left;">중간</td>
</tr>
<tr class="odd">
<td style="text-align: left;">큼 (1000자)</td>
<td style="text-align: left;">낮음</td>
<td style="text-align: left;"><strong>높음</strong></td>
<td style="text-align: left;">낮음</td>
<td style="text-align: left;"><strong>높음</strong></td>
</tr>
</tbody>
</table>
</section>
<section id="해결책-parentdocumentretriever" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="해결책-parentdocumentretriever"><span class="header-section-number">2.2</span> 해결책: ParentDocumentRetriever</h3>
<p><strong>핵심 아이디어: “작게 검색하고, 크게 반환한다”</strong></p>
<p><code>ParentDocumentRetriever</code>는 계층적 문서 구조를 활용하여 이 딜레마를 해결한다.</p>
<p><strong>작동 원리</strong></p>
<ol type="1">
<li><strong>문서 분할 (Splitting)</strong>
<ul>
<li>원본 문서를 큰 청크(Parent)로 분할<br>
</li>
<li>큰 청크를 다시 작은 청크(Child)로 분할</li>
</ul></li>
<li><strong>인덱싱 (Indexing)</strong>
<ul>
<li>작은 청크(Child)만 벡터 DB에 임베딩<br>
</li>
<li>큰 청크(Parent)는 별도 문서 저장소(Docstore)에 보관<br>
</li>
<li>Child와 Parent 간 ID로 연결</li>
</ul></li>
<li><strong>검색 (Retrieval)</strong>
<ul>
<li>작은 청크로 유사도 검색 (정확한 매칭)<br>
</li>
<li>검색된 작은 청크의 Parent ID 확인<br>
</li>
<li>큰 청크(Parent)를 LLM에 전달</li>
</ul></li>
</ol>
<p><strong>계층 구조 예시</strong></p>
<pre><code>원본 문서 (5000자) ← 문서 DB에 저장
├── Parent Chunk 1 (1000자) ← 문서 DB 또는 벡터 DB에 저장
│   ├── Child Chunk 1-1 (200자) ← 벡터 DB에 저장
│   ├── Child Chunk 1-2 (200자) ← 벡터 DB에 저장
│   └── Child Chunk 1-3 (200자) ← 벡터 DB에 저장
├── Parent Chunk 2 (1000자)
│   ├── Child Chunk 2-1 (200자)
│   └── Child Chunk 2-2 (200자)
</code></pre>
<p><strong>검색 프로세스</strong></p>
<pre><code>사용자 질문: "Word2Vec이란?"
         ↓
벡터 검색 (Child Chunk에서)
         ↓
Child Chunk 1-2 발견 (유사도: 0.95)
         ↓
Parent ID 확인 → Parent Chunk 1
         ↓
Parent Chunk 1 (1000자) 반환
         ↓
LLM에 충분한 맥락 제공</code></pre>
</section>
<section id="핵심-장점" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="핵심-장점"><span class="header-section-number">2.3</span> 핵심 장점</h3>
<p><strong>1. 검색 정확도 향상</strong><br>
- 작은 청크로 검색하므로 임베딩이 명확한 의미 표현<br>
- 노이즈가 적어 관련 문서를 정확히 찾음</p>
<p><strong>2. 맥락 보존</strong><br>
- 큰 청크를 반환하므로 충분한 맥락 제공<br>
- LLM이 더 정확한 답변 생성 가능</p>
<p><strong>3. 유연한 구조</strong><br>
- Parent 크기를 조절하여 맥락 범위 조정 가능<br>
- Child 크기를 조절하여 검색 정밀도 조정 가능</p>
<p><strong>4. 저장 공간 효율</strong><br>
- Child만 벡터화하므로 벡터 DB 크기 절감<br>
- Parent는 일반 문서 저장소에 보관</p>
</section>
</section>
<section id="환경-설정" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="환경-설정"><span class="header-section-number">3</span> 환경 설정</h2>
<p>ParentDocumentRetriever 실습을 위한 환경을 설정한다. 여러 개의 텍스트 파일을 로드하기 위해 <code>TextLoader</code> 객체를 생성하고 데이터를 로드한다.</p>
<div id="c21d76be" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb3-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="099be846" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb4-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb4-4"></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb4-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="a7e14ac3" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.storage <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> InMemoryStore</span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TextLoader</span>
<span id="cb5-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_chroma <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chroma</span>
<span id="cb5-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb5-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb5-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ParentDocumentRetriever</span></code></pre></div></div>
</details>
</div>
<div id="7e7902f9" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1">loaders <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb6-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 파일을 로드합니다.</span></span>
<span id="cb6-3">    TextLoader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./data/appendix-keywords.txt"</span>),</span>
<span id="cb6-4">]</span>
<span id="cb6-5"></span>
<span id="cb6-6">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># embeding을 위해 docs에 text 데이터 저장</span></span>
<span id="cb6-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> loader <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> loaders:</span>
<span id="cb6-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 로더를 사용하여 문서를 로드하고 docs 리스트에 추가합니다.</span></span>
<span id="cb6-9">    docs.extend(loader.load())</span></code></pre></div></div>
</details>
</div>
<ul>
<li>예시는 <code>.txt</code> 파일로 로드되어 있기 때문에 파일 내에 있는 전체 내용이 parent document가 된다.
<ul>
<li><code>len(docs)</code>를 출력하면 parent document의 수 <code>1</code>이 출력된다.<br>
</li>
</ul></li>
<li>단, <code>.pdf</code>의 경우 업로드 시 페이지 단위로 문서가 업로드되어 parent document는 PDF의 page가 된다.
<ul>
<li><code>len(docs)</code>를 출력하면 parent document의 수는 <code>페이지수</code>가 출력된다.</li>
</ul></li>
</ul>
</section>
<section id="전체-문서-검색" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="전체-문서-검색"><span class="header-section-number">4</span> 전체 문서 검색</h2>
<section id="전략-child만-분할-parent는-원본" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="전략-child만-분할-parent는-원본"><span class="header-section-number">4.1</span> 전략: Child만 분할, Parent는 원본</h3>
<p><code>parent_splitter</code>를 지정하지 않고 <code>child_splitter</code>만 사용하는 기본적인 방식을 살펴본다.</p>
<p><strong>동작 방식</strong><br>
- <strong>Child</strong>: 200자 청크로 분할 → 벡터 DB 저장<br>
- <strong>Parent</strong>: 원본 문서 그대로 → Docstore 저장<br>
- <strong>검색</strong>: Child로 찾고 → 원본 문서 전체 반환</p>
<p><strong>장점</strong>: 전체 문서 맥락 유지<br>
<strong>단점</strong>: 문서가 너무 길면 LLM 컨텍스트 낭비</p>
</section>
<section id="코드-구현" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="코드-구현"><span class="header-section-number">4.2</span> 코드 구현</h3>
<div id="d6c8da7d" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 자식 분할기를 생성: 200 token 단위 chunk 생성</span></span>
<span id="cb7-2">child_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DB를 생성</span></span>
<span id="cb7-5">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma(</span>
<span id="cb7-6">    collection_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"full_documents"</span>, embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>OpenAIEmbeddings()</span>
<span id="cb7-7">)</span>
<span id="cb7-8"></span>
<span id="cb7-9">store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> InMemoryStore()</span>
<span id="cb7-10"></span>
<span id="cb7-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Retriever 를 생성</span></span>
<span id="cb7-12">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ParentDocumentRetriever(</span>
<span id="cb7-13">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,</span>
<span id="cb7-14">    docstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>store, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parent Document (원본 Document) 저장 </span></span>
<span id="cb7-15">    child_splitter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>child_splitter,</span>
<span id="cb7-16">)</span></code></pre></div></div>
</details>
</div>
<p><code>retriever.add_documents(docs, ids=None)</code> 함수로 문서목록을 추가한다.</p>
<ul>
<li><code>ids</code>가 <code>None</code>이면 자동으로 생성된다.</li>
<li><code>add_to_docstore=False</code>로 설정 시 document를 중복으로 추가하지 않는다. 단, 중복을 체크하기 위한 <code>ids</code> 값이 필수적으로 요구된다.</li>
</ul>
<div id="3c6f5efa" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 검색기에 추가합니다. docs는 문서 목록이고, ids는 문서의 고유 식별자 목록입니다.</span></span>
<span id="cb8-2">retriever.add_documents(docs, ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, add_to_docstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
</details>
</div>
<p>이 코드는 추가된 문서 수만큼 키를 반환한다.</p>
<ul>
<li><code>store</code> 객체의 <code>yield_keys()</code> 메서드를 호출하여 반환된 키(key) 값들을 리스트로 변환한다.</li>
</ul>
<div id="7e669c85" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 저장소의 모든 키를 리스트로 반환합니다.</span></span>
<span id="cb9-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(store.yield_keys())</span></code></pre></div></div>
</details>
</div>
<pre><code>['c2a89a0f-a690-4915-af68-2ea432fb6e51']</code></pre>
<ul>
<li>1개가 출력되었다. 이는 parent document가 1개 있다는 의미이다. 하지만 chunk는 여러 개다.<br>
</li>
<li>이제 벡터 스토어의 검색 기능을 테스트해본다.<br>
</li>
<li>작은 청크(chunk)들을 저장하고 있기 때문에, 검색 결과로 작은 청크들이 반환되는 것을 확인할 수 있다.<br>
</li>
<li><code>vectorstore</code> 객체의 <code>similarity_search</code> 메서드를 사용하여 <code>Word2Vec</code>와 관련성이 높은 문서를 찾아내는 유사도 검색을 수행한다.</li>
</ul>
<div id="ab04ae77" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 유사도 검색을 수행합니다.</span></span>
<span id="cb11-2">sub_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vectorstore.similarity_search(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Word2Vec"</span>)</span></code></pre></div></div>
</details>
</div>
<ul>
<li><code>sub_docs[0].page_content</code>, 즉 chunk를 출력한다.</li>
</ul>
<div id="c25c8887" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sub_docs 리스트의 첫 번째 요소의 page_content 속성을 출력합니다.</span></span>
<span id="cb12-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(sub_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>
<pre><code>정의: Word2Vec은 단어를 벡터 공간에 매핑하여 단어 간의 의미적 관계를 나타내는 자연어 처리 기술입니다. 이는 단어의 문맥적 유사성을 기반으로 벡터를 생성합니다.
예시: Word2Vec 모델에서 "왕"과 "여왕"은 서로 가까운 위치에 벡터로 표현됩니다.
연관키워드: 자연어 처리, 임베딩, 의미론적 유사성</code></pre>
<ul>
<li>이제 전체 retriever에서 검색해본다.</li>
<li>이 과정에서는 작은 청크(chunk)들이 위치한 <strong>문서를 반환</strong>하기 때문에 상대적으로 큰 문서들이 반환된다.</li>
<li><code>retriever</code> 객체의 <code>invoke()</code> 메서드를 사용하여 쿼리와 관련된 문서를 검색한다.</li>
</ul>
<div id="de01c49a" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 전체 문서 (parent document)를 검색하여 가져옵니다.</span></span>
<span id="cb14-2">retrieved_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Word2Vec"</span>)</span></code></pre></div></div>
</details>
</div>
<ul>
<li>Parent Document (<code>retrieved_docs[0]</code>)의 일부 내용을 출력한다.</li>
</ul>
<div id="c9c1a9ed" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서의 문서의 페이지 내용의 길이를 출력합니다.</span></span>
<span id="cb15-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb15-3">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"문서의 길이: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(retrieved_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb15-4">    end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">=====================</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb15-5">)</span>
<span id="cb15-6"></span>
<span id="cb15-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서의 일부를 출력합니다.</span></span>
<span id="cb15-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(retrieved_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2500</span>])</span></code></pre></div></div>
</details>
</div>
<pre><code>문서의 길이: 5733

=====================

 컴퓨팅을 도입하여 데이터 저장과 처리를 혁신하는 것은 디지털 변환의 예입니다.
연관키워드: 혁신, 기술, 비즈니스 모델

Crawling

정의: 크롤링은 자동화된 방식으로 웹 페이지를 방문하여 데이터를 수집하는 과정입니다. 이는 검색 엔진 최적화나 데이터 분석에 자주 사용됩니다.
예시: 구글 검색 엔진이 인터넷 상의 웹사이트를 방문하여 콘텐츠를 수집하고 인덱싱하는 것이 크롤링입니다.
연관키워드: 데이터 수집, 웹 스크래핑, 검색 엔진

Word2Vec

정의: Word2Vec은 단어를 벡터 공간에 매핑하여 단어 간의 의미적 관계를 나타내는 자연어 처리 기술입니다. 이는 단어의 문맥적 유사성을 기반으로 벡터를 생성합니다.
예시: Word2Vec 모델에서 "왕"과 "여왕"은 서로 가까운 위치에 벡터로 표현됩니다.
연관키워드: 자연어 처리, 임베딩, 의미론적 유사성
LLM (Large Language Model)

정의: LLM은 대규모의 텍스트 데이터로 훈련된 큰 규모의 언어 모델을</code></pre>
<p><strong>결과 분석</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">항목</th>
<th style="text-align: left;">Child 검색</th>
<th style="text-align: left;">Parent 반환</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>크기</strong></td>
<td style="text-align: left;">200자 내외</td>
<td style="text-align: left;">5733자 (원본 전체)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>내용</strong></td>
<td style="text-align: left;">Word2Vec 정의만</td>
<td style="text-align: left;">전체 키워드 사전</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>장점</strong></td>
<td style="text-align: left;">정확한 매칭</td>
<td style="text-align: left;">풍부한 맥락</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>단점</strong></td>
<td style="text-align: left;">맥락 부족</td>
<td style="text-align: left;">불필요한 정보 포함</td>
</tr>
</tbody>
</table>
<p><strong>문제점</strong></p>
<ul>
<li>원본 문서가 5733자로 너무 길어 LLM에 전달 시 비효율적이다.<br>
</li>
<li>Parent 크기를 조절하여 이를 해결한다.</li>
</ul>
</section>
</section>
<section id="계층적-청킹-권장-방식" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="계층적-청킹-권장-방식"><span class="header-section-number">5</span> 계층적 청킹 (권장 방식)</h2>
<section id="전략-parent와-child-모두-분할" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="전략-parent와-child-모두-분할"><span class="header-section-number">5.1</span> 전략: Parent와 Child 모두 분할</h3>
<ul>
<li>이전 방식의 문제점(맥락부족 &amp; 불필요한 정보 포함)을 해결하기 위해 <strong>2단계 청킹</strong>을 적용한다.</li>
<li>즉, parent의 크기를 조절하는 방식이다.</li>
</ul>
<p><strong>분할 전략</strong><br>
1. <strong>1단계</strong>: 원본 문서 → Parent Chunk (1000자)<br>
2. <strong>2단계</strong>: Parent Chunk → Child Chunk (200자)<br>
3. <strong>저장</strong>: Child만 벡터화, Parent는 Docstore<br>
4. <strong>검색</strong>: Child로 찾고 → Parent 반환 (1000자)</p>
<p><strong>크기 비교</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">방식</th>
<th style="text-align: left;">Child 크기</th>
<th style="text-align: left;">Parent 크기</th>
<th style="text-align: left;">Parent 개수</th>
<th style="text-align: left;">장점</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>실습 1</strong></td>
<td style="text-align: left;">200자</td>
<td style="text-align: left;">5733자 (원본)</td>
<td style="text-align: left;">1개</td>
<td style="text-align: left;">전체 맥락</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>실습 2</strong></td>
<td style="text-align: left;">200자</td>
<td style="text-align: left;">1000자</td>
<td style="text-align: left;">7개</td>
<td style="text-align: left;">적절한 맥락 + 효율성</td>
</tr>
</tbody>
</table>
<p><strong>왜 1000자인가?</strong><br>
- 대부분의 LLM은 입력으로 4-8K 토큰 컨텍스트 사용<br>
- 1000자 ≈ 250 토큰 (영문 기준)<br>
- 4-5개 청크 = 1000-1250 토큰 (적정 범위)<br>
- 충분한 맥락 + 효율적인 토큰 사용</p>
</section>
<section id="코드-구현-1" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="코드-구현-1"><span class="header-section-number">5.2</span> 코드 구현</h3>
<ul>
<li><code>RecursiveCharacterTextSplitter</code>를 사용하여 부모 문서와 자식 문서를 생성한다.
<ul>
<li>부모 문서는 <code>chunk_size</code>가 1000으로 설정되어 있다<br>
</li>
<li>자식 문서는 <code>chunk_size</code>가 200으로 설정되어 있으며, 부모 문서보다 작은 크기로 생성된다</li>
</ul></li>
</ul>
<div id="5c4b0e71" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 부모 문서를 생성하는 데 사용되는 텍스트 분할기입니다.</span></span>
<span id="cb17-2">parent_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span>
<span id="cb17-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 자식 문서를 생성하는 데 사용되는 텍스트 분할기입니다.</span></span>
<span id="cb17-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 부모보다 작은 문서를 생성해야 합니다.</span></span>
<span id="cb17-5">child_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb17-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 자식 청크를 인덱싱하는 데 사용할 벡터 저장소입니다.</span></span>
<span id="cb17-7">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma(</span>
<span id="cb17-8">    collection_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"split_parents"</span>, embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>OpenAIEmbeddings()</span>
<span id="cb17-9">)</span>
<span id="cb17-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 부모 문서의 저장 계층입니다.</span></span>
<span id="cb17-11">store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> InMemoryStore()</span></code></pre></div></div>
</details>
</div>
<p><code>ParentDocumentRetriever</code>를 초기화하는 코드이다.</p>
<ul>
<li><code>vectorstore</code> 매개변수는 문서 벡터를 저장하는 벡터 저장소를 지정한다.</li>
<li><code>docstore</code> 매개변수는 문서 데이터를 저장하는 문서 저장소를 지정한다.</li>
<li><code>child_splitter</code> 매개변수는 하위 문서를 분할하는 데 사용되는 문서 분할기를 지정한다.</li>
<li><code>parent_splitter</code> 매개변수는 상위 문서를 분할하는 데 사용되는 문서 분할기를 지정한다.</li>
</ul>
<p><code>ParentDocumentRetriever</code>는 계층적 문서 구조를 처리하며, 상위 문서와 하위 문서를 별도로 분할하고 저장한다. 이를 통해 검색 시 상위 문서와 하위 문서를 효과적으로 활용할 수 있다.</p>
<div id="39dfb53c" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ParentDocumentRetriever(</span>
<span id="cb18-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소를 지정한다.</span></span>
<span id="cb18-3">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,</span>
<span id="cb18-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 저장소를 지정한다.</span></span>
<span id="cb18-5">    docstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>store,</span>
<span id="cb18-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 하위 문서 분할기를 지정한다.</span></span>
<span id="cb18-7">    child_splitter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>child_splitter,</span>
<span id="cb18-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 상위 문서 분할기를 지정한다.</span></span>
<span id="cb18-9">    parent_splitter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>parent_splitter, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1000글자 단위 spliter</span></span>
<span id="cb18-10">)</span></code></pre></div></div>
</details>
</div>
<p><code>retriever</code> 객체에 <code>docs</code>를 추가한다. <code>retriever</code>가 검색할 수 있는 문서 집합에 새로운 문서들을 추가하는 역할을 한다.</p>
<div id="6b1cb0e9" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1">retriever.add_documents(docs)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 retriever에 추가한다.</span></span></code></pre></div></div>
</details>
</div>
<p>이제 문서의 수가 훨씬 더 많아진 것을 볼 수 있다. 이는 더 큰 크기의 상위 청크(chunk)들이다.</p>
<div id="513afef0" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 저장소에서 키를 생성하고 리스트로 변환한 후 길이를 반환합니다.</span></span>
<span id="cb20-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(store.yield_keys()))</span></code></pre></div></div>
</details>
</div>
<pre><code>7</code></pre>
<ul>
<li>1000자 단위로 쪼개진 상위 chunk가 <code>7</code>개라는 의미이다</li>
</ul>
<p>기본 벡터 저장소가 여전히 작은 청크를 검색하는지 확인해본다.</p>
<p><code>vectorstore</code> 객체의 <code>similarity_search</code> 메서드를 사용하여 유사도 검색을 수행한다.</p>
<div id="71a48415" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 유사도 검색을 수행합니다.</span></span>
<span id="cb22-2">sub_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vectorstore.similarity_search(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Word2Vec"</span>)</span>
<span id="cb22-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sub_docs 리스트의 첫 번째 요소의 page_content 속성을 출력합니다.</span></span>
<span id="cb22-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(sub_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>
<pre><code>정의: Word2Vec은 단어를 벡터 공간에 매핑하여 단어 간의 의미적 관계를 나타내는 자연어 처리 기술입니다. 이는 단어의 문맥적 유사성을 기반으로 벡터를 생성합니다.
예시: Word2Vec 모델에서 "왕"과 "여왕"은 서로 가까운 위치에 벡터로 표현됩니다.
연관키워드: 자연어 처리, 임베딩, 의미론적 유사성</code></pre>
<p>이번에는 <code>retriever</code> 객체의 <code>invoke()</code> 메서드를 사용하여 문서를 검색한다.</p>
<div id="a42f5b4a" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 검색하여 가져옵니다.</span></span>
<span id="cb24-2">retrieved_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Word2Vec"</span>)</span>
<span id="cb24-3"></span>
<span id="cb24-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서의 첫 번째 문서의 페이지 내용을 반환한다.</span></span>
<span id="cb24-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(retrieved_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>
<pre><code>정의: 트랜스포머는 자연어 처리에서 사용되는 딥러닝 모델의 한 유형으로, 주로 번역, 요약, 텍스트 생성 등에 사용됩니다. 이는 Attention 메커니즘을 기반으로 합니다.
예시: 구글 번역기는 트랜스포머 모델을 사용하여 다양한 언어 간의 번역을 수행합니다.
연관키워드: 딥러닝, 자연어 처리, Attention

HuggingFace

정의: HuggingFace는 자연어 처리를 위한 다양한 사전 훈련된 모델과 도구를 제공하는 라이브러리입니다. 이는 연구자와 개발자들이 쉽게 NLP 작업을 수행할 수 있도록 돕습니다.
예시: HuggingFace의 Transformers 라이브러리를 사용하여 감정 분석, 텍스트 생성 등의 작업을 수행할 수 있습니다.
연관키워드: 자연어 처리, 딥러닝, 라이브러리

Digital Transformation

정의: 디지털 변환은 기술을 활용하여 기업의 서비스, 문화, 운영을 혁신하는 과정입니다. 이는 비즈니스 모델을 개선하고 디지털 기술을 통해 경쟁력을 높이는 데 중점을 둡니다.
예시: 기업이 클라우드 컴퓨팅을 도입하여 데이터 저장과 처리를 혁신하는 것은 디지털 변환의 예입니다.
연관키워드: 혁신, 기술, 비즈니스 모델

Crawling

정의: 크롤링은 자동화된 방식으로 웹 페이지를 방문하여 데이터를 수집하는 과정입니다. 이는 검색 엔진 최적화나 데이터 분석에 자주 사용됩니다.
예시: 구글 검색 엔진이 인터넷 상의 웹사이트를 방문하여 콘텐츠를 수집하고 인덱싱하는 것이 크롤링입니다.
연관키워드: 데이터 수집, 웹 스크래핑, 검색 엔진

Word2Vec

정의: Word2Vec은 단어를 벡터 공간에 매핑하여 단어 간의 의미적 관계를 나타내는 자연어 처리 기술입니다. 이는 단어의 문맥적 유사성을 기반으로 벡터를 생성합니다.
예시: Word2Vec 모델에서 "왕"과 "여왕"은 서로 가까운 위치에 벡터로 표현됩니다.
연관키워드: 자연어 처리, 임베딩, 의미론적 유사성
LLM (Large Language Model)</code></pre>
</section>
</section>
<section id="두-가지-방식-비교" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="두-가지-방식-비교"><span class="header-section-number">6</span> 두 가지 방식 비교</h2>
<section id="검색-결과-분석" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="검색-결과-분석"><span class="header-section-number">6.1</span> 검색 결과 분석</h3>
<p><strong>실습 1: Parent = 원본 문서</strong><br>
- Parent 크기: 5733자 (원본 전체)<br>
- Parent 개수: 1개<br>
- 반환 내용: 전체 키워드 사전<br>
- 문제점: 불필요한 정보 과다 포함</p>
<p><strong>실습 2: Parent = 1000자 청크</strong><br>
- Parent 크기: 약 1000자<br>
- Parent 개수: 7개<br>
- 반환 내용: Word2Vec 관련 키워드 및 문맥 집합<br>
- 장점: 관련성 높은 정보만 포함</p>
</section>
<section id="성능-비교" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="성능-비교"><span class="header-section-number">6.2</span> 성능 비교</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">지표</th>
<th style="text-align: left;">실습 1 (원본)</th>
<th style="text-align: left;">실습 2 (1000자)</th>
<th style="text-align: left;">개선</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>검색 정확도</strong></td>
<td style="text-align: left;">높음</td>
<td style="text-align: left;">높음</td>
<td style="text-align: left;">동일</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>맥락 충분성</strong></td>
<td style="text-align: left;">과다</td>
<td style="text-align: left;">적절</td>
<td style="text-align: left;">개선</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>토큰 효율성</strong></td>
<td style="text-align: left;">낮음</td>
<td style="text-align: left;">높음</td>
<td style="text-align: left;">5배 개선</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>답변 품질</strong></td>
<td style="text-align: left;">중간</td>
<td style="text-align: left;">높음</td>
<td style="text-align: left;">개선</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>처리 속도</strong></td>
<td style="text-align: left;">느림</td>
<td style="text-align: left;">빠름</td>
<td style="text-align: left;">개선</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="실무-적용-가이드" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="실무-적용-가이드"><span class="header-section-number">7</span> 실무 적용 가이드</h2>
<section id="청크-크기-설정-전략" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="청크-크기-설정-전략"><span class="header-section-number">7.1</span> 청크 크기 설정 전략</h3>
<p><strong>Child Chunk 크기 (검색용)</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">크기</th>
<th style="text-align: left;">권장 상황</th>
<th style="text-align: left;">장점</th>
<th style="text-align: left;">단점</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>100-200자</strong></td>
<td style="text-align: left;">정확한 검색 필요</td>
<td style="text-align: left;">정밀한 매칭</td>
<td style="text-align: left;">맥락 부족</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>200-400자</strong></td>
<td style="text-align: left;">일반적인 경우</td>
<td style="text-align: left;">균형 잡힘</td>
<td style="text-align: left;">-</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>400-600자</strong></td>
<td style="text-align: left;">넓은 검색 필요</td>
<td style="text-align: left;">다양한 매칭</td>
<td style="text-align: left;">정확도 저하</td>
</tr>
</tbody>
</table>
<p><strong>Parent Chunk 크기 (반환용)</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">크기</th>
<th style="text-align: left;">권장 상황</th>
<th style="text-align: left;">토큰 (영문 기준)</th>
<th style="text-align: left;">예상 비용</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>500-1000자</strong></td>
<td style="text-align: left;">짧은 답변</td>
<td style="text-align: left;">125-250</td>
<td style="text-align: left;">낮음</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>1000-2000자</strong></td>
<td style="text-align: left;">일반적인 경우</td>
<td style="text-align: left;">250-500</td>
<td style="text-align: left;">중간</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>2000-4000자</strong></td>
<td style="text-align: left;">긴 맥락 필요</td>
<td style="text-align: left;">500-1000</td>
<td style="text-align: left;">높음</td>
</tr>
</tbody>
</table>
</section>
<section id="parentdocumentretriever-사용-권장-시나리오" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="parentdocumentretriever-사용-권장-시나리오"><span class="header-section-number">7.2</span> ParentDocumentRetriever 사용 권장 시나리오</h3>
<ol type="1">
<li><strong>긴 문서 처리</strong>
<ul>
<li>논문, 보고서, 매뉴얼 등<br>
</li>
<li>전체 문서는 너무 크지만 맥락은 필요한 경우</li>
</ul></li>
<li><strong>토큰 비용 절감</strong>
<ul>
<li>LLM API 비용이 중요한 경우<br>
</li>
<li>대량의 문서 처리 시</li>
</ul></li>
<li><strong>계층적 정보 구조</strong>
<ul>
<li>섹션별로 나뉜 문서<br>
</li>
<li>챕터/절 구조가 있는 경우</li>
</ul></li>
</ol>
</section>
<section id="일반-retriever-사용-권장" class="level3" data-number="7.3">
<h3 data-number="7.3" class="anchored" data-anchor-id="일반-retriever-사용-권장"><span class="header-section-number">7.3</span> 일반 Retriever 사용 권장</h3>
<ol type="1">
<li><strong>짧은 문서</strong>
<ul>
<li>이미 400자 이하의 작은 단위<br>
</li>
<li>추가 분할이 불필요한 경우</li>
</ul></li>
<li><strong>단순 구조</strong>
<ul>
<li>FAQ, 짧은 뉴스 기사<br>
</li>
<li>계층 구조가 없는 경우</li>
</ul></li>
<li><strong>전체 맥락 필수</strong>
<ul>
<li>문서 전체를 봐야 하는 경우<br>
</li>
<li>코드 전체, 계약서 전문 등</li>
</ul></li>
</ol>
</section>
<section id="최적화-팁" class="level3" data-number="7.4">
<h3 data-number="7.4" class="anchored" data-anchor-id="최적화-팁"><span class="header-section-number">7.4</span> 최적화 팁</h3>
<ol type="1">
<li>동적 크기 조정</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 길이에 따라 Parent 크기 조정</span></span>
<span id="cb26-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> avg_doc_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>:</span>
<span id="cb26-3">    parent_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb26-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> avg_doc_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>:</span>
<span id="cb26-5">    parent_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span></span>
<span id="cb26-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb26-7">    parent_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3000</span></span></code></pre></div></div>
<ol start="2" type="1">
<li>Overlap 설정</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1">parent_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(</span>
<span id="cb27-2">    chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,</span>
<span id="cb27-3">    chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 20% 오버랩으로 맥락 연결</span></span>
<span id="cb27-4">)</span></code></pre></div></div>
<ol start="3" type="1">
<li>메타데이터 활용</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 섹션 정보 추가로 검색 정확도 향상</span></span>
<span id="cb28-2">child_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(</span>
<span id="cb28-3">    chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>,</span>
<span id="cb28-4">    add_start_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 위치 정보 추가</span></span>
<span id="cb28-5">)</span></code></pre></div></div>
</section>
</section>
<section id="핵심-요약" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="핵심-요약"><span class="header-section-number">8</span> 핵심 요약</h2>
<section id="parentdocumentretriever의-핵심-원리" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="parentdocumentretriever의-핵심-원리"><span class="header-section-number">8.1</span> ParentDocumentRetriever의 핵심 원리</h3>
<p><strong>“작게 검색하고, 크게 반환한다”</strong></p>
<ol type="1">
<li><strong>정확한 검색</strong>: 작은 청크로 정밀한 임베딩과 유사도 검색 수행<br>
</li>
<li><strong>충분한 맥락</strong>: 큰 청크를 반환하여 LLM에 필요한 맥락 정보 제공<br>
</li>
<li><strong>계층적 구조</strong>: 두 단계 청킹으로 효율성과 정확도를 동시에 달성</li>
</ol>
</section>
<section id="주요-장점과-해결-문제" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="주요-장점과-해결-문제"><span class="header-section-number">8.2</span> 주요 장점과 해결 문제</h3>
<p><strong>해결하는 문제</strong><br>
- 기존 RAG의 청킹 딜레마 (정확한 임베딩 vs 충분한 맥락)<br>
- 토큰 비용 과다 문제<br>
- 검색 정확도와 답변 품질 사이의 트레이드오프</p>
<p><strong>제공하는 장점</strong><br>
1. <strong>검색 정확도 향상</strong>: 작은 청크로 정밀한 매칭<br>
2. <strong>맥락 정보 보존</strong>: 큰 청크 반환으로 풍부한 맥락<br>
3. <strong>토큰 비용 절감</strong>: 적절한 크기로 효율성 증대<br>
4. <strong>유연한 구조</strong>: 도메인별 크기 조절 가능</p>
</section>
<section id="실무-적용-가이드-1" class="level3" data-number="8.3">
<h3 data-number="8.3" class="anchored" data-anchor-id="실무-적용-가이드-1"><span class="header-section-number">8.3</span> 실무 적용 가이드</h3>
<p><strong>권장 설정</strong><br>
- <strong>Child 청크</strong>: 200-400자 (검색 정밀도 최적화)<br>
- <strong>Parent 청크</strong>: 1000-2000자 (맥락과 효율성 균형)<br>
- <strong>Overlap</strong>: 10-20% (맥락 연결성 향상)</p>
<p><strong>적용 시나리오</strong><br>
- ✅ 긴 문서 처리 (논문, 매뉴얼, 보고서)<br>
- ✅ 토큰 비용이 중요한 대용량 처리<br>
- ✅ 계층적 정보 구조가 있는 문서<br>
- ❌ 이미 작은 단위의 문서 (FAQ, 짧은 기사)</p>
<p><strong>최적화 전략</strong><br>
- 문서 특성에 따른 동적 크기 조정<br>
- 메타데이터 활용으로 검색 정확도 향상<br>
- 도메인별 청킹 전략 수립<br>
- A/B 테스트를 통한 최적 크기 탐색</p>
<p>ParentDocumentRetriever는 RAG 시스템의 성능을 크게 향상시킬 수 있는 강력한 도구이다. 특히 긴 문서를 다루는 환경에서 검색 정확도와 답변 품질을 동시에 개선할 수 있는 효과적인 솔루션이다.</p>


</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>RAG</category>
  <category>LangChain</category>
  <category>Agent</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/05-ParentDocumentRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>문맥 압축 검색기(ContextualCompressionRetriever)</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/02-ContextualCompressionRetriever.html</link>
  <description><![CDATA[ 






<section id="문제-상황-무관한-문서의-과다-검색" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="문제-상황-무관한-문서의-과다-검색"><span class="header-section-number">1</span> 문제 상황: 무관한 문서의 과다 검색</h2>
<p>RAG 시스템에서 리트리버가 과도한 수의 문서를 반환하면 할루시네이션 가능성이 증가한다. 예를 들어, 실제 질의와 관련된 부분이 5곳(k=5)에만 있는데 k=20으로 설정하면, LLM이 15곳의 무관한 내용까지 검토하게 되어 마치 함정을 설치하는 것과 같다. 이상적으로는 LLM에게 정확히 5곳만 제공해야 하지만, 질의를 미리 알 수 없으므로 이를 구현하기는 어렵다.</p>
</section>
<section id="해결책-문맥-압축-contextual-compression" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="해결책-문맥-압축-contextual-compression"><span class="header-section-number">2</span> 해결책: 문맥 압축 (Contextual Compression)</h2>
<p><code>ContextualCompressionRetriever</code>는 이 문제를 해결하기 위해 설계되었다. 다량의 문서(k=10~20)를 검색한 후 문맥 압축을 통해 관련성 높은 문서만 선별(k=5)하여 반환한다.</p>
<p><strong>압축 방식의 종류:</strong></p>
<ol type="1">
<li><strong>LLM 기반 압축</strong>: LLM을 활용하여 관련 내용만 추출
<ul>
<li>장점: 할루시네이션 감소, 의미 기반 판단</li>
<li>단점: 비용 증가, 응답 시간 증가</li>
</ul></li>
<li><strong>Embedding 기반 압축</strong>: 유사도 임계값으로 문서 필터링
<ul>
<li>장점: 저비용, 빠른 처리, 중복 제거 가능</li>
<li>단점: 의미적 이해 제한</li>
</ul></li>
</ol>
</section>
<section id="작동-원리" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="작동-원리"><span class="header-section-number">3</span> 작동 원리</h2>
<p><code>ContextualCompressionRetriever</code>는 두 단계로 작동한다:</p>
<ol type="1">
<li><strong>검색 단계</strong>: 질의를 base retriever에 전달하여 초기 문서 검색 (비효율적이지만 폭넓은 범위)</li>
<li><strong>압축 단계</strong>: Document Compressor를 통해 관련성 낮은 문서 제거 또는 내용 축약</li>
</ol>
<p><strong>“압축”의 의미</strong>: - 개별 문서의 내용을 축약 (관련 내용만 추출) - 무관한 문서를 완전히 필터링 제거</p>
<p>이를 통해 LLM에 전달되는 토큰 수를 줄이면서도 관련성을 유지한다.</p>
<blockquote class="blockquote">
<p>출처: https://drive.google.com/uc?id=1CtNgWODXZudxAWSRiWgSGEoTNrUFT98v</p>
</blockquote>
<p><img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/images/01-Contextual-Compression.jpeg" class="img-fluid"></p>
</section>
<section id="환경-설정" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="환경-설정"><span class="header-section-number">4</span> 환경 설정</h2>
<div id="1f8bbc42" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="4b317e74" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적 설정 (선택사항: 디버깅 및 모니터링용)</span></span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-3">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="f05956ee" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 패키지 설치 (테디노트 커스텀 압축기)</span></span>
<span id="cb3-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>qU langchain<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>teddynote</span></code></pre></div></div>
</details>
</div>
</section>
<section id="헬퍼-함수-문서-출력" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="헬퍼-함수-문서-출력"><span class="header-section-number">5</span> 헬퍼 함수: 문서 출력</h2>
<div id="410d41ee" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 시각적으로 보기 좋게 출력하는 함수</span></span>
<span id="cb4-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> pretty_print_docs(docs):</span>
<span id="cb4-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb4-4">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join(</span>
<span id="cb4-5">            [<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"문서 </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> d.page_content <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(docs)]</span>
<span id="cb4-6">        )</span>
<span id="cb4-7">    )</span></code></pre></div></div>
</details>
</div>
</section>
<section id="기본-retriever-설정" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="기본-retriever-설정"><span class="header-section-number">6</span> 기본 Retriever 설정</h2>
<p>벡터 스토어 retriever를 초기화하고 문서를 검색합니다. 기본 retriever는 관련 문서와 무관한 문서를 함께 반환합니다.</p>
<div id="d322f914" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TextLoader</span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb5-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb5-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> CharacterTextSplitter</span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 로드 및 청크 분할</span></span>
<span id="cb5-7">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TextLoader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./data/appendix-keywords.txt"</span>)</span>
<span id="cb5-8">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb5-9">texts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loader.load_and_split(text_splitter)</span>
<span id="cb5-10"></span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소 생성 및 검색기 설정</span></span>
<span id="cb5-12">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS.from_documents(texts, OpenAIEmbeddings()).as_retriever()</span>
<span id="cb5-13"></span>
<span id="cb5-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 실행</span></span>
<span id="cb5-15">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Semantic Search 에 대해서 알려줘."</span>)</span>
<span id="cb5-16">pretty_print_docs(docs)</span></code></pre></div></div>
</details>
</div>
<pre><code>문서 1:

Semantic Search

정의: 의미론적 검색은 사용자의 질의를 단순한 키워드 매칭을 넘어서 그 의미를 파악하여 관련된 결과를 반환하는 검색 방식입니다.
예시: 사용자가 "태양계 행성"이라고 검색하면, "목성", "화성" 등과 같이 관련된 행성에 대한 정보를 반환합니다.
연관키워드: 자연어 처리, 검색 알고리즘, 데이터 마이닝

Embedding
----------------------------------------------------------------------------------------------------
문서 2:

정의: 키워드 검색은 사용자가 입력한 키워드를 기반으로 정보를 찾는 과정입니다. 이는 대부분의 검색 엔진과 데이터베이스 시스템에서 기본적인 검색 방식으로 사용됩니다.
예시: 사용자가 "커피숍 서울"이라고 검색하면, 관련된 커피숍 목록을 반환합니다.
연관키워드: 검색 엔진, 데이터 검색, 정보 검색

Page Rank
----------------------------------------------------------------------------------------------------
문서 3:

정의: 크롤링은 자동화된 방식으로 웹 페이지를 방문하여 데이터를 수집하는 과정입니다. 이는 검색 엔진 최적화나 데이터 분석에 자주 사용됩니다.
예시: 구글 검색 엔진이 인터넷 상의 웹사이트를 방문하여 콘텐츠를 수집하고 인덱싱하는 것이 크롤링입니다.
연관키워드: 데이터 수집, 웹 스크래핑, 검색 엔진

Word2Vec
----------------------------------------------------------------------------------------------------
문서 4:

정의: 페이지 랭크는 웹 페이지의 중요도를 평가하는 알고리즘으로, 주로 검색 엔진 결과의 순위를 결정하는 데 사용됩니다. 이는 웹 페이지 간의 링크 구조를 분석하여 평가합니다.
예시: 구글 검색 엔진은 페이지 랭크 알고리즘을 사용하여 검색 결과의 순위를 정합니다.
연관키워드: 검색 엔진 최적화, 웹 분석, 링크 분석

데이터 마이닝</code></pre>
<p><strong>결과 해석</strong>: 기본 리트리버는 쿼리와 무관한 문서(2, 3, 4번)까지 함께 반환됨. 이로 인해 LLM에 불필요한 컨텍스트가 전달되어 비용과 할루시네이션 위험 증가.</p>
</section>
<section id="맥락적-압축contextualcompression" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="맥락적-압축contextualcompression"><span class="header-section-number">7</span> 맥락적 압축(ContextualCompression)</h2>
<p><code>LLMChainExtractor</code>는 LLM을 사용하여 문서에서 관련 내용만 추출합니다.</p>
<div id="eef64564" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.document_compressors <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LLMChainExtractor <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># deprecated lang chain module을 테디가 다시 커스터마이징함</span></span>
<span id="cb7-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ContextualCompressionRetriever</span>
<span id="cb7-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb7-4"></span>
<span id="cb7-5">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>)</span>
<span id="cb7-6"></span>
<span id="cb7-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLM을 사용하여 문서 압축기 생성</span></span>
<span id="cb7-8">compressor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LLMChainExtractor.from_llm(llm)</span>
<span id="cb7-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compressor = LLMChainExtractor.from_llm(llm, prompt= PromptTemplate.from_template("""주어진 문서에서 entity 들을 추출해 주세요.""")) # 이건 원본 문서를 paraphrasing하는 역할을 한다.</span></span>
<span id="cb7-10">compression_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ContextualCompressionRetriever(</span>
<span id="cb7-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 압축기와 리트리버를 사용하여 컨텍스트 압축 리트리버 생성</span></span>
<span id="cb7-12">    base_compressor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>compressor,</span>
<span id="cb7-13">    base_retriever<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>retriever,</span>
<span id="cb7-14">)</span>
<span id="cb7-15"></span>
<span id="cb7-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 일반 리트리버 vs 압축 리트리버 성능 비교</span></span>
<span id="cb7-17"></span>
<span id="cb7-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 일반 리트리버</span></span>
<span id="cb7-19">pretty_print_docs(retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Semantic Search 에 대해서 알려줘."</span>))</span>
<span id="cb7-20"></span>
<span id="cb7-21"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span>
<span id="cb7-22"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"============== LLMChainExtractor 적용 후 =================="</span>)</span>
<span id="cb7-23"></span>
<span id="cb7-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 압축 리트리버</span></span>
<span id="cb7-25">compressed_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb7-26">    compression_retriever.invoke(  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 컨텍스트 압축 리트리버를 사용하여 관련 문서 검색</span></span>
<span id="cb7-27">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Semantic Search 에 대해서 알려줘."</span></span>
<span id="cb7-28">    )</span>
<span id="cb7-29">)</span>
<span id="cb7-30">pretty_print_docs(compressed_docs)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서를 예쁘게 출력</span></span></code></pre></div></div>
</details>
</div>
<pre><code>문서 1:

Semantic Search

정의: 의미론적 검색은 사용자의 질의를 단순한 키워드 매칭을 넘어서 그 의미를 파악하여 관련된 결과를 반환하는 검색 방식입니다.
예시: 사용자가 "태양계 행성"이라고 검색하면, "목성", "화성" 등과 같이 관련된 행성에 대한 정보를 반환합니다.
연관키워드: 자연어 처리, 검색 알고리즘, 데이터 마이닝

Embedding
----------------------------------------------------------------------------------------------------
문서 2:

정의: 키워드 검색은 사용자가 입력한 키워드를 기반으로 정보를 찾는 과정입니다. 이는 대부분의 검색 엔진과 데이터베이스 시스템에서 기본적인 검색 방식으로 사용됩니다.
예시: 사용자가 "커피숍 서울"이라고 검색하면, 관련된 커피숍 목록을 반환합니다.
연관키워드: 검색 엔진, 데이터 검색, 정보 검색

Page Rank
----------------------------------------------------------------------------------------------------
문서 3:

정의: 크롤링은 자동화된 방식으로 웹 페이지를 방문하여 데이터를 수집하는 과정입니다. 이는 검색 엔진 최적화나 데이터 분석에 자주 사용됩니다.
예시: 구글 검색 엔진이 인터넷 상의 웹사이트를 방문하여 콘텐츠를 수집하고 인덱싱하는 것이 크롤링입니다.
연관키워드: 데이터 수집, 웹 스크래핑, 검색 엔진

Word2Vec
----------------------------------------------------------------------------------------------------
문서 4:

정의: 페이지 랭크는 웹 페이지의 중요도를 평가하는 알고리즘으로, 주로 검색 엔진 결과의 순위를 결정하는 데 사용됩니다. 이는 웹 페이지 간의 링크 구조를 분석하여 평가합니다.
예시: 구글 검색 엔진은 페이지 랭크 알고리즘을 사용하여 검색 결과의 순위를 정합니다.
연관키워드: 검색 엔진 최적화, 웹 분석, 링크 분석

데이터 마이닝
=========================================================
============== LLMChainExtractor 적용 후 ==================
문서 1:

Semantic Search

정의: 의미론적 검색은 사용자의 질의를 단순한 키워드 매칭을 넘어서 그 의미를 파악하여 관련된 결과를 반환하는 검색 방식입니다.
예시: 사용자가 "태양계 행성"이라고 검색하면, "목성", "화성" 등과 같이 관련된 행성에 대한 정보를 반환합니다.
</code></pre>
<p><strong>결과 해석</strong>: - 기존 리트리버: 4개 문서 모두 반환 (약 800토큰) - 압축 리트리버: 관련 문서만 추출 (약 200토큰, 75% 감소) - <strong>효과</strong>: 토큰 사용량 감소로 비용 절감, 할루시네이션 위험 감소</p>
</section>
<section id="llmchainfilter-문서-선택-기반-필터링" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="llmchainfilter-문서-선택-기반-필터링"><span class="header-section-number">8</span> LLMChainFilter: 문서 선택 기반 필터링</h2>
<p><code>LLMChainFilter</code>는 문서 내용을 수정하지 않고 관련 문서만 선택하여 반환합니다.</p>
<div id="f337a8af" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.document_compressors <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LLMChainFilter <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 입력쿼리와 관련된 내용만 필터링, 문서 내용 변경은 하지않음</span></span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLM을 사용하여 LLMChainFilter 객체를 생성</span></span>
<span id="cb9-4">_filter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LLMChainFilter.from_llm(llm)</span>
<span id="cb9-5"></span>
<span id="cb9-6">compression_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ContextualCompressionRetriever(</span>
<span id="cb9-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLMChainFilter와 retriever를 사용하여 ContextualCompressionRetriever 객체를 생성</span></span>
<span id="cb9-8">    base_compressor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>_filter,</span>
<span id="cb9-9">    base_retriever<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>retriever,</span>
<span id="cb9-10">)</span>
<span id="cb9-11"></span>
<span id="cb9-12">compressed_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> compression_retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Semantic Search 에 대해서 알려줘."</span>)</span>
<span id="cb9-13">pretty_print_docs(compressed_docs)</span></code></pre></div></div>
</details>
</div>
<pre><code>문서 1:

Semantic Search

정의: 의미론적 검색은 사용자의 질의를 단순한 키워드 매칭을 넘어서 그 의미를 파악하여 관련된 결과를 반환하는 검색 방식입니다.
예시: 사용자가 "태양계 행성"이라고 검색하면, "목성", "화성" 등과 같이 관련된 행성에 대한 정보를 반환합니다.
연관키워드: 자연어 처리, 검색 알고리즘, 데이터 마이닝

Embedding</code></pre>
<section id="embeddingsfilter" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="embeddingsfilter"><span class="header-section-number">8.1</span> <code>EmbeddingsFilter</code></h3>
<ul>
<li>각각의 검색된 문서에 대해 추가적인 LLM 호출을 수행하는 것은 비용이 많이 들고 속도가 느리다</li>
<li><code>EmbeddingsFilter</code>는 문서와 쿼리를 임베딩하고 쿼리와 충분히 유사한 임베딩을 가진 문서만 반환함으로써 더 저렴하고 빠른 옵션을 제공</li>
<li>이를 통해 검색 결과의 관련성을 유지하면서도 계산 비용과 시간을 절약</li>
<li><code>EmbeddingsFilter</code> 와 <code>ContextualCompressionRetriever</code> 를 사용하여 관련 문서를 압축하고 검색하는 과정
<ul>
<li><code>EmbeddingsFilter</code> 를 사용하여 지정된 <strong>유사도 임계값(0.86)</strong> 이상인 문서를 필터링 합니다.</li>
</ul></li>
</ul>
<div id="ff17edec" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.document_compressors <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> EmbeddingsFilter</span>
<span id="cb11-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb11-3"></span>
<span id="cb11-4">embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings()</span>
<span id="cb11-5"></span>
<span id="cb11-6">embeddings_filter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EmbeddingsFilter(embeddings<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings, similarity_threshold<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.86</span>)</span>
<span id="cb11-7"></span>
<span id="cb11-8">compression_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ContextualCompressionRetriever(</span>
<span id="cb11-9">    base_compressor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings_filter, base_retriever<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>retriever</span>
<span id="cb11-10">)</span>
<span id="cb11-11"></span>
<span id="cb11-12">compressed_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> compression_retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Semantic Search 에 대해서 알려줘."</span>)</span>
<span id="cb11-13">pretty_print_docs(compressed_docs)</span></code></pre></div></div>
</details>
</div>
<pre><code>문서 1:

Semantic Search

정의: 의미론적 검색은 사용자의 질의를 단순한 키워드 매칭을 넘어서 그 의미를 파악하여 관련된 결과를 반환하는 검색 방식입니다.
예시: 사용자가 "태양계 행성"이라고 검색하면, "목성", "화성" 등과 같이 관련된 행성에 대한 정보를 반환합니다.
연관키워드: 자연어 처리, 검색 알고리즘, 데이터 마이닝

Embedding</code></pre>
</section>
</section>
<section id="documentcompressorpipeline-다단계-압축" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="documentcompressorpipeline-다단계-압축"><span class="header-section-number">9</span> DocumentCompressorPipeline: 다단계 압축</h2>
<p>여러 compressor를 순차적으로 결합하여 최적화된 결과를 얻는다</p>
<p><strong>파이프라인 단계:</strong> 1. <strong>TextSplitter</strong>: 문서를 작은 청크로 분할 2. <strong>EmbeddingsRedundantFilter</strong>: 중복 문서 제거 (유사도 0.95 이상) 3. <strong>EmbeddingsFilter</strong>: 관련성 필터링 (유사도 0.86 이상) 4. <strong>LLMChainExtractor</strong>: 최종 내용 추출</p>
<div id="937cdcba" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.document_compressors <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DocumentCompressorPipeline</span>
<span id="cb13-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> EmbeddingsRedundantFilter</span>
<span id="cb13-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> CharacterTextSplitter</span>
<span id="cb13-4"></span>
<span id="cb13-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문자 기반 텍스트 분할기를 생성하고, 청크 크기를 300으로, 청크 간 중복을 0으로 설정합니다.</span></span>
<span id="cb13-6">splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb13-7"></span>
<span id="cb13-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임베딩을 사용하여 중복 필터를 생성: 검색된 문서 사이의 유사도 검색을 수행, 0.95도 이상의 문서들은 중복 문서라 판단하고 드랍시켜줌</span></span>
<span id="cb13-9">redundant_filter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EmbeddingsRedundantFilter(embeddings<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings)</span>
<span id="cb13-10"></span>
<span id="cb13-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임베딩을 사용하여 관련성 필터를 생성하고, 유사도 임계값을 0.86으로 설정합니다.</span></span>
<span id="cb13-12">relevant_filter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EmbeddingsFilter(embeddings<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings, similarity_threshold<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.86</span>)</span>
<span id="cb13-13"></span>
<span id="cb13-14">pipeline_compressor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DocumentCompressorPipeline(</span>
<span id="cb13-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 압축 파이프라인을 생성하고, 분할기, 중복 필터, 관련성 필터, LLMChainExtractor를 변환기를 순서대로 설정합니다.</span></span>
<span id="cb13-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 반드시, 이 기능들을 순서대로 쓰는게 아니라 필요시 파이프라인을 추가할 수 있다는 것에 집중</span></span>
<span id="cb13-17">    transformers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb13-18">        splitter,</span>
<span id="cb13-19">        redundant_filter,</span>
<span id="cb13-20">        relevant_filter,</span>
<span id="cb13-21">        LLMChainExtractor.from_llm(llm),</span>
<span id="cb13-22">    ]</span>
<span id="cb13-23">)</span></code></pre></div></div>
</details>
</div>
<p><code>ContextualCompressionRetriever</code>를 초기화하며, <code>base_compressor</code>로 <code>pipeline_compressor</code>를, <code>base_retriever</code>로 <code>retriever</code>를 사용합니다.</p>
<div id="92109dd0" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1">compression_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ContextualCompressionRetriever(</span>
<span id="cb14-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 기본 압축기로 pipeline_compressor를 사용하고, 기본 검색기로 retriever를 사용하여 ContextualCompressionRetriever를 초기화</span></span>
<span id="cb14-3">    base_compressor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>pipeline_compressor,</span>
<span id="cb14-4">    base_retriever<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>retriever,</span>
<span id="cb14-5">)</span>
<span id="cb14-6"></span>
<span id="cb14-7">compressed_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> compression_retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Semantic Search 에 대해서 알려줘."</span>)</span>
<span id="cb14-8">pretty_print_docs(compressed_docs)</span></code></pre></div></div>
</details>
</div>
<pre><code>문서 1:

Semantic Search

정의: 의미론적 검색은 사용자의 질의를 단순한 키워드 매칭을 넘어서 그 의미를 파악하여 관련된 결과를 반환하는 검색 방식입니다.
예시: 사용자가 "태양계 행성"이라고 검색하면, "목성", "화성" 등과 같이 관련된 행성에 대한 정보를 반환합니다.</code></pre>


</section>

 ]]></description>
  <category>AI</category>
  <category>RAG</category>
  <category>LangChain</category>
  <category>Agent</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/02-ContextualCompressionRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>MultiVectorRetriever</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/07-MultiVectorRetriever.html</link>
  <description><![CDATA[ 






<section id="multivectorretriever-개요" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> MultiVectorRetriever 개요</h1>
<section id="핵심-개념" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="핵심-개념"><span class="header-section-number">1.1</span> 핵심 개념</h2>
<p><strong>MultiVectorRetriever</strong>는 단일 문서에 대해 여러 벡터를 생성하여 다양한 관점에서 검색할 수 있도록 도와주는 고급 검색 시스템이다.</p>
<section id="기본-아키텍처-docstore-vectorstore-이중-구조" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="기본-아키텍처-docstore-vectorstore-이중-구조"><span class="header-section-number">1.1.1</span> 기본 아키텍처: “DocStore + VectorStore” 이중 구조</h3>
<p>이름에서 오해를 사수 있는 부분을 명확히 하자. <strong>“다중 벡터저장소”</strong>는 여러 개의 벡터 데이터베이스를 운영한다는 의미가 아니다. 실제로는 다음 두 가지 데이터 저장소를 함께 운영한다:</p>
<ol type="1">
<li><strong>DocStore</strong>: 원본 문서(규모가 큰 데이터)를 저장하는 공간<br>
</li>
<li><strong>VectorStore</strong>: 처리된 벡터 임베딩을 저장하는 공간</li>
</ol>
</section>
<section id="왜-필요한가" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="왜-필요한가"><span class="header-section-number">1.1.2</span> 왜 필요한가?</h3>
<p><strong>계층적 맥락 보존 문제</strong></p>
<p>전통적인 RAG 시스템에서 A 페이지가 1, 2, 3번 chunk로 분할되었을 때:<br>
- 가장 유사도가 높은 단일 chunk만 반환됨 (예: 2번 chunk)<br>
- 2, 3번 chunk에도 질문과 유사한 내용이 들어있을 수 있음<br>
- <strong>문제</strong>: 제한된 문맥 정보로 인해 LLM이 부정확한 답변을 생성</p>
<p><strong>MultiVectorRetriever의 해결책</strong></p>
<p>단일 chunk만 반환하는 대신, 질문 쿼리의 내용이 모두 담긴 <strong>A 페이지 전체</strong>를 검색 반환한다. 이를 통해:<br>
- LLM이 “Lost in the Middle” 리스크를 간접적으로 회피할 수 있음<br>
- 더 정확하고 포괄적인 답변 생성 가능<br>
- 맥락을 유지하면서도 세밀한 검색 가능</p>
</section>
</section>
<section id="parentdocumentretriever와의-차이점" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="parentdocumentretriever와의-차이점"><span class="header-section-number">1.2</span> ParentDocumentRetriever와의 차이점</h2>
<p><strong>기능적 유사성</strong></p>
<ul>
<li>두 Retriever 모두 계층적 문서 구조를 사용하지만, MultiVectorRetriever는 <strong>용도적으로 더 세분화된 기능</strong>을 제공한다.<br>
</li>
<li>둘 다 “작게 검색 → 크게 반환”
<ul>
<li>검색: 작은 청크로 검색 (정밀도 ↑)<br>
</li>
<li>반환: 큰 문서로 반환 (맥락 ↑)<br>
</li>
</ul></li>
<li>구조도 동일:
<ul>
<li>VectorStore: 검색용 작은 청크<br>
</li>
<li>DocStore: 반환용 큰 문서<br>
</li>
<li>ID 매핑으로 연결</li>
</ul></li>
</ul>
<p><strong>핵심 차이: “작은 청크를 어떻게 만드느냐”</strong></p>
<ul>
<li>MultiVectorRetriever는 ParentDocumentRetriever의 일반화 버전이다.<br>
</li>
<li>ParentDocumentRetriever
<ul>
<li>원본 문서를 물리적으로 쪼갬<br>
</li>
<li>큰 문서 (Parent) -(분할)→ 작은 청크1, 청크2, 청크3 (Child)<br>
</li>
<li>Child는 Parent의 실제 일부분 (계층적 분할): 단순히 크기만 다르게 쪼갬
<ul>
<li><code>parent_splitter = RecursiveCharacterTextSplitter(chunk_size=2000)</code><br>
</li>
<li><code>child_splitter = RecursiveCharacterTextSplitter(chunk_size=400)</code><br>
</li>
</ul></li>
</ul></li>
<li>MultiVectorRetriever
<ul>
<li>원본 문서(Parent)는 그대로 두고, 검색용 “표현(Chunk)”을 별도 생성<br>
</li>
<li>child 생성 방식: 요약본 / 가상질문 / 여러 청크 (내용보전)<br>
</li>
<li>큰 문서 (Parent) -(파생)→ 작은 청크1, 청크2, 청크3 (Child)<br>
</li>
<li>검색용 표현은 원본과 다른 내용일 수 있음<br>
</li>
<li>여러 방법 가능: 요약, 질문 생성, 다중 청크 등<br>
</li>
<li><strong>ID 기반 유연한 매핑 시스템</strong>
<ul>
<li>문서 A 페이지에 1, 2, 3 chunk가 있을 때, 각 문서와 chunk에 동일한 ID(예: ‘abc’)를 부여:
<ul>
<li><strong>DocStore</strong>: Parent document → ID ’abc’로 저장<br>
</li>
<li><strong>VectorStore</strong>: Child chunks (1, 2, 3) → 모두 ID ’abc’로 저장<br>
</li>
</ul></li>
<li>ID로 parent와 child가 강제로 연결되기 때문에 child 문서를 가공 및 변형해도 parent와 연결시킬 수 있다.<br>
</li>
</ul></li>
</ul></li>
<li><strong>ID 기반 유연한 매핑 시스템</strong>을 이용한 MultiVectorRetriever의 유연한 반환 전략
<ul>
<li>chunk 1, 2, 3 중 하나가 검색되었을 때, ID ’abc’를 key로 사용하여 다음 옵션들을 선택적으로 제어 가능:
<ol type="1">
<li><strong>Parent Document만 반환</strong>: 전체 맥락 제공<br>
</li>
<li><strong>Child Chunk만 반환</strong>: 정밀한 정보만 제공<br>
</li>
<li><strong>둘 다 반환</strong>: 세밀한 정보 + 전체 맥락 동시 제공</li>
</ol></li>
</ul></li>
</ul>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>ParentDocumentRetriever</th>
<th>MultiVectorRetriever</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>검색용 청크</strong></td>
<td>원본의 일부 (물리적 분할)</td>
<td>원본의 파생 표현 (요약/질문 등)</td>
</tr>
<tr class="even">
<td><strong>청크와 원본 관계</strong></td>
<td>포함 관계</td>
<td>독립적 (다른 내용 가능)</td>
</tr>
<tr class="odd">
<td><strong>유연성</strong></td>
<td>낮음 (분할만)</td>
<td>높음 (요약/질문/다중 방식)</td>
</tr>
<tr class="even">
<td><strong>사용 시기</strong></td>
<td>단순한 계층 구조</td>
<td>검색 품질 최적화 필요</td>
</tr>
</tbody>
</table>
<section id="예시-비교" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="예시-비교"><span class="header-section-number">1.2.1</span> 예시 비교</h3>
<p><strong>ParentDocumentRetriever:</strong></p>
<pre><code>원본: "AI는 인공지능이다. 머신러닝을 사용한다. 딥러닝도 포함된다."  

Child1: "AI는 인공지능이다."  
Child2: "머신러닝을 사용한다."  
Child3: "딥러닝도 포함된다."  

→ Child2로 검색 → 원본 전체 반환  </code></pre>
<p><strong>MultiVectorRetriever:</strong></p>
<pre><code>원본: "AI는 인공지능이다. 머신러닝을 사용한다. 딥러닝도 포함된다."  

요약: "AI와 머신러닝, 딥러닝의 관계 설명"  
가상질문: "AI란 무엇인가? 머신러닝이란?"  

→ 요약/질문으로 검색 → 원본 반환  </code></pre>
</section>
</section>
<section id="고급-활용-전략" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="고급-활용-전략"><span class="header-section-number">1.3</span> 고급 활용 전략</h2>
<section id="요약-기반-서치-최적화" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="요약-기반-서치-최적화"><span class="header-section-number">1.3.1</span> 요약 기반 서치 최적화</h3>
<ul>
<li>각 chunk의 <strong>요약본</strong>을 생성하여 VectorStore에 임베딩 데이터로 저장:
<ul>
<li>Semantic Match 품질 향상: 쿼리와 검색 대상의 추상화 레벨을 맞춰서 semantic match를 개선<br>
</li>
<li>질문자 쿼리와 유사한 요약본을 검색<br>
</li>
<li>해당 요약본에 대응되는 <strong>원본 chunk</strong>를 DocStore에서 호출<br>
</li>
</ul></li>
<li>예시
<ul>
<li>원본 청크: “2023년 11월 8일 삼성전자가 삼성 AI 포럼에서 삼성 가우스를 공개했다. 정규분포 이론을 정립한 수학자 가우스의 이름을 따왔으며, …”<br>
</li>
<li>사용자 질문 쿼리: “삼성의 AI 제품이 뭐야?”<br>
</li>
<li>문제
<ul>
<li>원본에는 날짜, 인명, 기술적 세부사항이 섞여있음<br>
</li>
<li>임베딩이 이런 잡음에 영향받음<br>
</li>
<li>핵심 의미(삼성이 AI 제품을 만들었다)가 희석됨<br>
</li>
</ul></li>
<li>해결: 요약본으로 검색
<ul>
<li>요약 청크: “삼성전자가 온디바이스 생성 AI 모델 ’삼성 가우스’를 공개했으며, 언어·코드·이미지 3개 모델로 구성되어 있다.”<br>
</li>
<li>사용자 질문 쿼리: “삼성의 AI 제품이 뭐야?”<br>
</li>
</ul></li>
</ul></li>
<li>요약본 청크 생성 이점
<ul>
<li>검색 품질 향상<br>
</li>
<li>의미 밀도 증가: 핵심 정보만 압축되어 있음<br>
</li>
<li>노이즈 제거: 불필요한 세부사항 제거됨<br>
</li>
<li>상화 레벨 맞춤: 쿼리와 semantic 유사도가 더 높음<br>
</li>
</ul></li>
<li>요약본 청크 생성 단점
<ul>
<li>비용: LLM으로 요약 생성 필요<br>
</li>
<li>시간: 인덱싱 시간 증가<br>
</li>
<li>정보손실: 요약 과정에서 중요한 디테일 누락 가능<br>
</li>
</ul></li>
<li>언제 사용?
<ul>
<li>문서가 길고 세부사항이 많을 때<br>
</li>
<li>사용자 질문이 고수준/추상적일 때<br>
</li>
<li>검색 품질이 비용보다 중요할 때<br>
</li>
</ul></li>
<li>언제 비추천?
<ul>
<li>정확한 수치/날짜가 중요할 때<br>
</li>
<li>문서가 이미 간결할 때<br>
</li>
<li>실시간 검색 속도가 중요할 때</li>
</ul></li>
</ul>
</section>
<section id="다양한-벡터-생성-전략" class="level3" data-number="1.3.2">
<h3 data-number="1.3.2" class="anchored" data-anchor-id="다양한-벡터-생성-전략"><span class="header-section-number">1.3.2</span> 다양한 벡터 생성 전략</h3>
<p>LangChain에서는 문서를 다양한 상황에서 효율적으로 쿼리할 수 있는 MultiVectorRetriever를 제공한다. 이 기능을 사용하면 문서를 여러 벡터로 저장하고 관리할 수 있어, 정보 검색의 정확도와 효율성을 대폭 향상시킬 수 있다.</p>
<p><strong>문서당 여러 벡터 생성 방법:</strong></p>
<ol type="1">
<li><p><strong>작은 청크 생성</strong>: 문서를 더 작은 단위로 나눈 후, 각 청크에 대해 별도의 임베딩을 생성한다. 이 방식을 사용하면 문서의 특정 부분에 좋 더 세심한 주의를 기울일 수 있다. 이 과정은 <code>ParentDocumentRetriever</code>를 통해 구현할 수 있어, 세부 정보에 대한 탐색이 용이해진다.</p></li>
<li><p><strong>요약 임베딩</strong>: 각 문서의 요약을 생성하고, 이 요약으로부터 임베딩을 만듭니다. 이 요약 임베딩은 문서의 핵심 내용을 신속하게 파악하는 데 큰 도움이 된다. 문서 전체를 분석하는 대신 핵심적인 요약 부분만을 활용하여 효율성을 극대화할 수 있다.</p></li>
<li><p><strong>가설 질문 활용</strong>: 각 문서에 대해 적합한 가설 질문을 만들고, 이 질문에 기반한 임베딩을 생성한다. 특정 주제나 내용에 대해 깊이 있는 탐색을 원할 때 이 방법이 유용하다. 가설 질문은 문서의 내용을 다양한 관점에서 접근하게 해주며, 더 광범위한 이해를 가능하게 한다.</p></li>
<li><p><strong>수동 추가 방식</strong>: 사용자가 문서 검색 시 고려해야 할 특정 질문이나 쿼리를 직접 추가할 수 있다. 이 방법을 통해 사용자는 검색 과정에서 보다 세밀한 제어를 할 수 있으며, 자신의 요구 사항에 맞춘 맞춤형 검색이 가능해진다.</p></li>
</ol>
</section>
</section>
<section id="실습에-활용한-문서" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="실습에-활용한-문서"><span class="header-section-number">1.4</span> 실습에 활용한 문서</h2>
<p>소프트웨어정책연구소(SPRi) - 2023년 12월호</p>
<ul>
<li>저자: 유재흥(AI정책연구실 책임연구원), 이지수(AI정책연구실 위촉연구원)<br>
</li>
<li>링크: https://spri.kr/posts/view/23669<br>
</li>
<li>파일명: <code>SPRI_AI_Brief_2023년12월호_F.pdf</code></li>
</ul>
<p><strong>참고</strong>: 위의 파일은 <code>data</code> 폴더 내에 다운로드 받으세요</p>
<div id="780ff41f" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일  </span></span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv  </span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드  </span></span>
<span id="cb3-5">load_dotenv()  </span></code></pre></div></div>
</details>
</div>
<div id="91009cba" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정한다. https://smith.langchain.com  </span></span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote  </span></span>
<span id="cb4-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging  </span>
<span id="cb4-4"></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력한다.  </span></span>
<span id="cb4-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)  </span></code></pre></div></div>
</details>
</div>
<p>텍스트 파일에서 데이터를 로드하고, 로드된 문서들을 지정된 크기로 분할하는 전처리 과정을 수행한다.</p>
<p>분할된 문서들은 추후 벡터화 및 검색 등의 작업에 사용될 수 있다.</p>
<div id="9892955f" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PyMuPDFLoader  </span>
<span id="cb5-2"></span>
<span id="cb5-3">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PyMuPDFLoader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/SPRI_AI_Brief_2023년12월호_F.pdf"</span>)  </span>
<span id="cb5-4">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loader.load()  </span>
<span id="cb5-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(docs))  </span></code></pre></div></div>
</details>
</div>
<p>데이터로부터 로드한 원본 도큐먼트는 <code>docs</code> 변수에 담았다.</p>
<pre><code>23  </code></pre>
<div id="9d6fcbb2" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>].page_content[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>])  </span></code></pre></div></div>
</details>
</div>
<pre><code>1. 정책/법제  
2. 기업/산업   
3. 기술/연구   
 4. 인력/교육  
영국 AI 안전성 정상회의에 참가한 28개국, AI 위험에 공동 대응 선언  
n 영국 블레츨리 파크에서 개최된 AI 안전성 정상회의에 참가한 28개국들이 AI 안전 보장을   
위한 협력 방안을 담은 블레츨리 선언을 발표  
n 첨단 AI를 개발하는 국가와 기업들은 AI 시스템에 대한 안전 테스트 계획에 합의했으며,   
영국의 AI 안전 연구소가 전 세계 국가와 협력해 테스트를 주도할 예정   
KEY Contents  
£ AI 안전성 정상회의 참가국들, 블레츨리 선언 통해 AI 안전 보장을 위한 협력에 합의  
n 2023년 11월 1~2일 영국 블레츨리 파크에서 열린 AI 안전성 정상회의(AI Safety Summit)에   
참가한 28개국 대표들이 AI 위험 관리를 위한 ‘블레츨리 선언’을 발표   
∙선언은 AI 안전 보장을 위해 국가, 국제기구, 기업, 시민사회, 학계를 포함한 모든 이해관계자의 협력이   
중요하다고 강조했으며,  </code></pre>
<ul>
<li>pdf가 23페이지로 구성되어 있어 23이 반환됨 pdf loader는 패이지 단위로 로드가 된다.</li>
</ul>
</section>
<section id="chunk-원본-문서-검색" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="chunk-원본-문서-검색"><span class="header-section-number">1.5</span> Chunk + 원본 문서 검색</h2>
<ul>
<li>대용량 정보를 검색하는 경우, 더 작은 단위로 정보를 임베딩하는 것이 유용할 수 있다.<br>
</li>
<li><code>MultiVectorRetriever</code>를 통해 문서를 여러 벡터로 저장하고 관리할 수 있다.<br>
</li>
<li><code>docstore</code>에 원본 문서를 저장하고, <code>vectorstore</code>에 임베딩된 문서를 저장한다.</li>
</ul>
<p>이로써 문서를 더 작은 단위로 나누어 더 정확한 검색이 가능해진다. 때에 따라서는 원본 문서의 내용을 조회할 수 있다.</p>
<div id="0547398a" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 자식 청크를 인덱싱하는 데 사용할 벡터 저장소  </span></span>
<span id="cb9-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> uuid  </span>
<span id="cb9-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.storage <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> InMemoryStore  </span>
<span id="cb9-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_chroma <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chroma  </span>
<span id="cb9-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings  </span>
<span id="cb9-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RecursiveCharacterTextSplitter  </span>
<span id="cb9-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.multi_vector <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> MultiVectorRetriever  </span>
<span id="cb9-8"></span>
<span id="cb9-9">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma(  </span>
<span id="cb9-10">    collection_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"small_bigger_chunks"</span>,  </span>
<span id="cb9-11">    embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>OpenAIEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-embedding-3-small"</span>),  </span>
<span id="cb9-12">)  </span>
<span id="cb9-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 부모 문서의 저장소 계층  </span></span>
<span id="cb9-14">store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> InMemoryStore()  </span>
<span id="cb9-15"></span>
<span id="cb9-16">id_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_id"</span>  </span>
<span id="cb9-17"></span>
<span id="cb9-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색기 (시작 시 비어 있음)  </span></span>
<span id="cb9-19">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MultiVectorRetriever(  </span>
<span id="cb9-20">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,  </span>
<span id="cb9-21">    byte_store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>store,  </span>
<span id="cb9-22">    id_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>id_key,  </span>
<span id="cb9-23">)  </span>
<span id="cb9-24"></span>
<span id="cb9-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 ID를 생성합니다.  </span></span>
<span id="cb9-26">doc_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(uuid.uuid4()) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs]  </span>
<span id="cb9-27"></span>
<span id="cb9-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 두개의 생성된 id를 확인한다.  </span></span>
<span id="cb9-29">doc_ids  </span></code></pre></div></div>
</details>
</div>
<pre><code>['ff65f8d8-376d-47d2-bbc0-eae1f7e3c381', 'e18fd86b-f01a-445f-bf31-eb8d16259241', 'f099589b-066f-4827-9679-3bf2d2ec28d2', '834e63d6-0dd9-4bfb-8383-ca6a06d731ef', '5a33bffb-ae85-402e-a4bf-81ab376d7744', '319396d0-cc7d-41f9-826c-71bccc8dade6', '9a38995c-94b7-4963-9605-5d27f868b5e7', 'bc32292c-0d19-452f-b970-1074c43fc864', '48de377c-4693-407b-93e6-3f0ea44b5009', '9e27fff9-15d3-4754-bb26-00779158d528', 'd73a5aef-251b-4a30-aadb-2dc973ef1607', '56535934-2a23-4e3e-b6d2-79121dd93005', 'a535c103-0cf8-4c46-b5ea-90c34aad90bc', '48aac7ed-f704-4d65-90bd-3b5b18adc127', '63b42edf-3546-4257-9046-ff3f4687a217', '749f6239-fec3-4893-8959-f641d6d551b3', '4a08aa0e-4e38-460d-90dc-34e3faca6784', '91cfa69e-7ca7-44f9-8795-bc710622af17', '817e7519-3853-450c-bb05-b3f6763d9cd4', '00e3e534-762a-477b-adf4-3d1dbe67b656', '03171c52-bf3d-4d27-bf93-bb2da4ba6d87', 'df37aeb5-0bfd-4fb1-960d-aad8a5ad11cd', '3cf6570c-25c8-4b28-82ec-6804026e844e']  </code></pre>
<ul>
<li>총 23개 (parent document 수)의 uid가 생성됨<br>
</li>
<li>여기서 큰 청크로 분할하기 위한 <code>parent_text_splitter</code><br>
</li>
<li>더 작은 청크로 분할하기 위한 <code>child_text_splitter</code>를 정의한다.</li>
</ul>
<div id="15097f7a" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># RecursiveCharacterTextSplitter 객체를 생성한다.  </span></span>
<span id="cb11-2">parent_text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>)  </span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 더 작은 청크를 생성하는 데 사용할 분할기  </span></span>
<span id="cb11-5">child_text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)  </span></code></pre></div></div>
</details>
</div>
<p>더 큰 Chunk인 Parent 문서를 생성한다.</p>
<div id="dd4c709c" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1">parent_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []  </span>
<span id="cb12-2"></span>
<span id="cb12-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(docs):  </span>
<span id="cb12-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 현재 문서의 ID를 가져옵니다.  </span></span>
<span id="cb12-5">    _id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> doc_ids[i]  </span>
<span id="cb12-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 현재 문서를 하위 문서로 분할  </span></span>
<span id="cb12-7">    parent_doc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parent_text_splitter.split_documents([doc])  </span>
<span id="cb12-8"></span>
<span id="cb12-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> parent_doc:  </span>
<span id="cb12-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># metadata에 문서 ID 를 저장  </span></span>
<span id="cb12-11">        _doc.metadata[id_key] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _id  </span>
<span id="cb12-12">    parent_docs.extend(parent_doc)  </span></code></pre></div></div>
</details>
</div>
<ul>
<li><code>parent_docs</code>에 기입된 <code>doc_id</code>를 확인한다.<br>
</li>
<li><code>doc</code>에는 parent doc(page단위 내용)이 담기고<br>
</li>
<li><code>parent_docs</code>에는 split chunk들이 담긴다.<br>
</li>
<li>위의 코드 청크가 parent doc과 split chunk들에게 동일한 id를 부여하는 기능을 한다.</li>
</ul>
<div id="c166edf8" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1">child_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []  </span>
<span id="cb13-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(docs):  </span>
<span id="cb13-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 현재 문서의 ID를 가져옵니다.  </span></span>
<span id="cb13-4">    _id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> doc_ids[i]  </span>
<span id="cb13-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 현재 문서를 하위 문서로 분할  </span></span>
<span id="cb13-6">    child_doc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> child_text_splitter.split_documents([doc])  </span>
<span id="cb13-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> child_doc:  </span>
<span id="cb13-8">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># metadata에 문서 ID 를 저장  </span></span>
<span id="cb13-9">        _doc.metadata[id_key] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> _id  </span>
<span id="cb13-10">    child_docs.extend(child_doc)  </span></code></pre></div></div>
</details>
</div>
<ul>
<li><code>child_docs</code>에 기입된 <code>doc_id</code>를 확인한다.<br>
</li>
<li>상대적으로 더 작은 Chunk인 Child 문서를 생성한다.</li>
</ul>
<div id="a8542ad0" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 생성된 Child 문서의 메타데이터를 확인한다.  </span></span>
<span id="cb14-2">child_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].metadata  </span></code></pre></div></div>
</details>
</div>
<p>{‘source’: ‘data/SPRI_AI_Brief_2023년12월호_F.pdf’, ‘file_path’: ‘data/SPRI_AI_Brief_2023년12월호_F.pdf’, ‘page’: 0, ‘total_pages’: 23, ‘format’: ‘PDF 1.4’, ‘title’: ’‘, ’author’: ‘dj’, ‘subject’: ’‘, ’keywords’: ’‘, ’creator’: ‘Hwp 2018 10.0.0.13462’, ‘producer’: ‘Hancom PDF 1.3.0.542’, ‘creationDate’: “D:20231208132838+09’00’”, ‘modDate’: “D:20231208132838+09’00’”, ‘trapped’: ’‘, ’doc_id’: ‘ff65f8d8-376d-47d2-bbc0-eae1f7e3c381’}</p>
<p>각각 분할된 청크의 수를 확인한다.</p>
<div id="f9203466" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"분할된 parent_docs의 개수: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(parent_docs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)  </span>
<span id="cb15-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"분할된 child_docs의 개수: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(child_docs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)  </span></code></pre></div></div>
</details>
</div>
<pre><code>분할된 parent_docs의 개수: 74  
분할된 child_docs의 개수: 443  </code></pre>
<ul>
<li>보통 표준적인 MultiVectorRetriever 사용법</li>
</ul>
<pre><code># 정상적인 방법  
retriever.vectorstore.add_documents(child_docs)   # 검색용: 작은 청크만  
retriever.docstore.mset(zip(doc_ids, parent_docs)) # 반환용: 큰 청크  

# VectorStore: child_docs (443개) - 검색에 사용  
# DocStore: parent_docs (74개) - 반환에 사용  </code></pre>
<ul>
<li>하지만, 더 유연하게 구성을 가져갈 수도 있다.
<ul>
<li>벡터저장소엔 parent_docs와 child_docs를 저장하고<br>
</li>
<li>docstore엔 문서 원본을 저장한다.<br>
</li>
<li>벡터저장소에 새롭게 생성한 작게 쪼개진 하위문서 집합을 추가한다.<br>
</li>
<li>다음으로는 상위 문서는 생성한 UUID와 맵핑하여 <code>docstore</code>에 추가한다.<br>
</li>
<li><code>mset()</code> 메소드를 통해 문서 ID와 문서 내용을 key-value 쌍으로 문서 저장소에 저장한다.</li>
</ul></li>
</ul>
<div id="6fb63e45" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소에 parent + child 문서를 추가  </span></span>
<span id="cb18-2">retriever.vectorstore.add_documents(parent_docs)  </span>
<span id="cb18-3">retriever.vectorstore.add_documents(child_docs)  </span>
<span id="cb18-4"></span>
<span id="cb18-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># docstore 에 원본 문서를 저장  </span></span>
<span id="cb18-6">retriever.docstore.mset(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(doc_ids, docs)))  </span></code></pre></div></div>
</details>
</div>
<p>유사도 검색을 수행한다. 가장 유사도가 높은 첫 번째 문서 조각을 출력한다.</p>
<p>여기서 <code>retriever.vectorstore.similarity_search</code> 메소드는 child + parent 문서 chunk 내에서 검색을 수행한다.</p>
<div id="d9861f87" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vectorstore의 유사도 검색을 수행한다.   </span></span>
<span id="cb19-2">relevant_chunks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.vectorstore.similarity_search(  </span>
<span id="cb19-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span>  </span>
<span id="cb19-4">)  </span>
<span id="cb19-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"검색된 문서의 개수: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(relevant_chunks)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)  </span></code></pre></div></div>
</details>
</div>
<pre><code>검색된 문서의 개수: 4  </code></pre>
<ul>
<li>잘게 쪼개진 chunk들에서 검색을 하고 싶으면 <code>retriever.vectorstore</code> 에서 유사도 검색 수행</li>
</ul>
<div id="0ec32178" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> chunk <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> relevant_chunks:  </span>
<span id="cb21-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(chunk.page_content, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)  </span>
<span id="cb21-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)  </span></code></pre></div></div>
</details>
</div>
<pre><code>☞ 출처 : 삼성전자, ‘삼성 AI 포럼’서 자체 개발 생성형 AI ‘삼성 가우스’ 공개, 2023.11.08.  
삼성전자, ‘삼성 개발자 콘퍼런스 코리아 2023’ 개최, 2023.11.14.  
TechRepublic, Samsung Gauss: Samsung Research Reveals Generative AI, 2023.11.08.  

&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;  

SPRi AI Brief |  
2023-12월호  
10  
삼성전자, 자체 개발 생성 AI ‘삼성 가우스’ 공개  
n 삼성전자가 온디바이스에서 작동 가능하며 언어, 코드, 이미지의 3개 모델로 구성된 자체 개발 생성   
AI 모델 ‘삼성 가우스’를 공개  
n 삼성전자는 삼성 가우스를 다양한 제품에 단계적으로 탑재할 계획으로, 온디바이스 작동이 가능한  

&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;  

▹ 삼성전자, 자체 개발 생성 AI ‘삼성 가우스’ 공개 ··························································· 10  
   ▹ 구글, 앤스로픽에 20억 달러 투자로 생성 AI 협력 강화 ················································ 11  

&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;  

SPRi AI Brief |  
2023-12월호  
10  
삼성전자, 자체 개발 생성 AI ‘삼성 가우스’ 공개  
n 삼성전자가 온디바이스에서 작동 가능하며 언어, 코드, 이미지의 3개 모델로 구성된 자체 개발 생성   
AI 모델 ‘삼성 가우스’를 공개  
n 삼성전자는 삼성 가우스를 다양한 제품에 단계적으로 탑재할 계획으로, 온디바이스 작동이 가능한   
삼성 가우스는 외부로 사용자 정보가 유출될 위험이 없다는 장점을 보유  
KEY Contents  
£ 언어, 코드, 이미지의 3개 모델로 구성된 삼성 가우스, 온디바이스 작동 지원  
n 삼성전자가 2023년 11월 8일 열린 ‘삼성 AI 포럼 2023’ 행사에서 자체 개발한 생성 AI 모델   
‘삼성 가우스’를 최초 공개  
∙정규분포 이론을 정립한 천재 수학자 가우스(Gauss)의 이름을 본뜬 삼성 가우스는 다양한 상황에   
최적화된 크기의 모델 선택이 가능  
∙삼성 가우스는 라이선스나 개인정보를 침해하지 않는 안전한 데이터를 통해 학습되었으며,   
온디바이스에서 작동하도록 설계되어 외부로 사용자의 정보가 유출되지 않는 장점을 보유  
∙삼성전자는 삼성 가우스를 활용한 온디바이스 AI 기술도 소개했으며, 생성 AI 모델을 다양한 제품에  

&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;  </code></pre>
<p>이번에는 <code>retriever.invoke()</code> 메소드를 사용하여 쿼리를 실행한다.</p>
<p><code>retriever.invoke()</code> 메소드는 원본 문서의 전체 내용을 검색한다.</p>
<ul>
<li>잘게 쪼개진 chunk들의 parent_doc에서 검색을 하고 싶으면 <code>retriever</code> 에서 유사도 검색 수행<br>
</li>
<li>parent와 child는 상대적인 개념으로 parent가 반드시 가공전 원본 문서를 의미하지는 않는다.</li>
</ul>
<div id="e18d6d65" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1">relevant_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span>)  </span>
<span id="cb23-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"검색된 문서의 개수: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(relevant_docs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)  </span>
<span id="cb23-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)  </span>
<span id="cb23-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(relevant_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)  </span></code></pre></div></div>
</details>
</div>
<pre><code>검색된 문서의 개수: 2  

====================================================================================================  

SPRi AI Brief |  
2023-12월호  
10  
삼성전자, 자체 개발 생성 AI ‘삼성 가우스’ 공개  
n 삼성전자가 온디바이스에서 작동 가능하며 언어, 코드, 이미지의 3개 모델로 구성된 자체 개발 생성   
AI 모델 ‘삼성 가우스’를 공개  
n 삼성전자는 삼성 가우스를 다양한 제품에 단계적으로 탑재할 계획으로, 온디바이스 작동이 가능한   
삼성 가우스는 외부로 사용자 정보가 유출될 위험이 없다는 장점을 보유  
KEY Contents  
£ 언어, 코드, 이미지의 3개 모델로 구성된 삼성 가우스, 온디바이스 작동 지원  
n 삼성전자가 2023년 11월 8일 열린 ‘삼성 AI 포럼 2023’ 행사에서 자체 개발한 생성 AI 모델   
‘삼성 가우스’를 최초 공개  
∙정규분포 이론을 정립한 천재 수학자 가우스(Gauss)의 이름을 본뜬 삼성 가우스는 다양한 상황에   
최적화된 크기의 모델 선택이 가능  
∙삼성 가우스는 라이선스나 개인정보를 침해하지 않는 안전한 데이터를 통해 학습되었으며,   
온디바이스에서 작동하도록 설계되어 외부로 사용자의 정보가 유출되지 않는 장점을 보유  
∙삼성전자는 삼성 가우스를 활용한 온디바이스 AI 기술도 소개했으며, 생성 AI 모델을 다양한 제품에   
단계적으로 탑재할 계획  
n 삼성 가우스는 △텍스트를 생성하는 언어모델 △코드를 생성하는 코드 모델 △이미지를 생성하는   
이미지 모델의 3개 모델로 구성  
∙언어 모델은 클라우드와 온디바이스 대상 다양한 모델로 구성되며, 메일 작성, 문서 요약, 번역 업무의   
처리를 지원  
∙코드 모델 기반의 AI 코딩 어시스턴트 ‘코드아이(code.i)’는 대화형 인터페이스로 서비스를 제공하며   
사내 소프트웨어 개발에 최적화  
∙이미지 모델은 창의적인 이미지를 생성하고 기존 이미지를 원하는 대로 바꿀 수 있도록 지원하며   
저해상도 이미지의 고해상도 전환도 지원  
n IT 전문지 테크리퍼블릭(TechRepublic)은 온디바이스 AI가 주요 기술 트렌드로 부상했다며,   
2024년부터 가우스를 탑재한 삼성 스마트폰이 메타의 라마(Llama)2를 탑재한 퀄컴 기기 및 구글   
어시스턴트를 적용한 구글 픽셀(Pixel)과 경쟁할 것으로 예상  
☞ 출처 : 삼성전자, ‘삼성 AI 포럼’서 자체 개발 생성형 AI ‘삼성 가우스’ 공개, 2023.11.08.  
삼성전자, ‘삼성 개발자 콘퍼런스 코리아 2023’ 개최, 2023.11.14.  
TechRepublic, Samsung Gauss: Samsung Research Reveals Generative AI, 2023.11.08.  </code></pre>
<ul>
<li>리트리버(retriever)가 벡터 데이터베이스에서 기본적으로 수행하는 검색 유형은 유사도 검색이다.<br>
</li>
<li>LangChain Vector Stores는 <a href="https://api.python.langchain.com/en/latest/vectorstores/langchain_core.vectorstores.VectorStore.html#langchain_core.vectorstores.VectorStore.max_marginal_relevance_search">Max Marginal Relevance</a>를 통한 검색도 지원하므로, 이를 대신 사용하고 싶다면 다음과 같이 <code>search_type</code> 속성을 설정하면 된다.<br>
</li>
<li><code>retriever</code> 객체의 <code>search_type</code> 속성을 <code>SearchType.mmr</code>로 설정한다.
<ul>
<li>이는 검색 시 MMR(Maximal Marginal Relevance) 알고리즘을 사용하도록 지정하는 것</li>
</ul></li>
</ul>
<div id="5e2a7f1a" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.multi_vector <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SearchType  </span>
<span id="cb25-2"></span>
<span id="cb25-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 유형을 MMR(Maximal Marginal Relevance)로 설정  </span></span>
<span id="cb25-4">retriever.search_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SearchType.mmr  </span>
<span id="cb25-5"></span>
<span id="cb25-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서 전체를 검색  </span></span>
<span id="cb25-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)  </span></code></pre></div></div>
</details>
</div>
<pre><code>SPRi AI Brief |  
2023-12월호  
10  
삼성전자, 자체 개발 생성 AI ‘삼성 가우스’ 공개  
n 삼성전자가 온디바이스에서 작동 가능하며 언어, 코드, 이미지의 3개 모델로 구성된 자체 개발 생성   
AI 모델 ‘삼성 가우스’를 공개  
n 삼성전자는 삼성 가우스를 다양한 제품에 단계적으로 탑재할 계획으로, 온디바이스 작동이 가능한   
삼성 가우스는 외부로 사용자 정보가 유출될 위험이 없다는 장점을 보유  
KEY Contents  
£ 언어, 코드, 이미지의 3개 모델로 구성된 삼성 가우스, 온디바이스 작동 지원  
n 삼성전자가 2023년 11월 8일 열린 ‘삼성 AI 포럼 2023’ 행사에서 자체 개발한 생성 AI 모델   
‘삼성 가우스’를 최초 공개  
∙정규분포 이론을 정립한 천재 수학자 가우스(Gauss)의 이름을 본뜬 삼성 가우스는 다양한 상황에   
최적화된 크기의 모델 선택이 가능  
∙삼성 가우스는 라이선스나 개인정보를 침해하지 않는 안전한 데이터를 통해 학습되었으며,   
온디바이스에서 작동하도록 설계되어 외부로 사용자의 정보가 유출되지 않는 장점을 보유  
∙삼성전자는 삼성 가우스를 활용한 온디바이스 AI 기술도 소개했으며, 생성 AI 모델을 다양한 제품에   
단계적으로 탑재할 계획  
n 삼성 가우스는 △텍스트를 생성하는 언어모델 △코드를 생성하는 코드 모델 △이미지를 생성하는   
이미지 모델의 3개 모델로 구성  
∙언어 모델은 클라우드와 온디바이스 대상 다양한 모델로 구성되며, 메일 작성, 문서 요약, 번역 업무의   
처리를 지원  
∙코드 모델 기반의 AI 코딩 어시스턴트 ‘코드아이(code.i)’는 대화형 인터페이스로 서비스를 제공하며   
사내 소프트웨어 개발에 최적화  
∙이미지 모델은 창의적인 이미지를 생성하고 기존 이미지를 원하는 대로 바꿀 수 있도록 지원하며   
저해상도 이미지의 고해상도 전환도 지원  
n IT 전문지 테크리퍼블릭(TechRepublic)은 온디바이스 AI가 주요 기술 트렌드로 부상했다며,   
2024년부터 가우스를 탑재한 삼성 스마트폰이 메타의 라마(Llama)2를 탑재한 퀄컴 기기 및 구글   
어시스턴트를 적용한 구글 픽셀(Pixel)과 경쟁할 것으로 예상  
☞ 출처 : 삼성전자, ‘삼성 AI 포럼’서 자체 개발 생성형 AI ‘삼성 가우스’ 공개, 2023.11.08.  
삼성전자, ‘삼성 개발자 콘퍼런스 코리아 2023’ 개최, 2023.11.14.  
TechRepublic, Samsung Gauss: Samsung Research Reveals Generative AI, 2023.11.08.  </code></pre>
<div id="30d3b05a" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.multi_vector <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SearchType  </span>
<span id="cb27-2"></span>
<span id="cb27-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 유형을 similarity_score_threshold로 설정  </span></span>
<span id="cb27-4">retriever.search_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SearchType.similarity_score_threshold  </span>
<span id="cb27-5">retriever.search_kwargs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"score_threshold"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>}  </span>
<span id="cb27-6"></span>
<span id="cb27-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서 전체를 검색  </span></span>
<span id="cb27-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)  </span></code></pre></div></div>
</details>
</div>
<pre><code>SPRi AI Brief |  
2023-12월호  
10  
삼성전자, 자체 개발 생성 AI ‘삼성 가우스’ 공개  
n 삼성전자가 온디바이스에서 작동 가능하며 언어, 코드, 이미지의 3개 모델로 구성된 자체 개발 생성   
AI 모델 ‘삼성 가우스’를 공개  
n 삼성전자는 삼성 가우스를 다양한 제품에 단계적으로 탑재할 계획으로, 온디바이스 작동이 가능한   
삼성 가우스는 외부로 사용자 정보가 유출될 위험이 없다는 장점을 보유  
KEY Contents  
£ 언어, 코드, 이미지의 3개 모델로 구성된 삼성 가우스, 온디바이스 작동 지원  
n 삼성전자가 2023년 11월 8일 열린 ‘삼성 AI 포럼 2023’ 행사에서 자체 개발한 생성 AI 모델   
‘삼성 가우스’를 최초 공개  
∙정규분포 이론을 정립한 천재 수학자 가우스(Gauss)의 이름을 본뜬 삼성 가우스는 다양한 상황에   
최적화된 크기의 모델 선택이 가능  
∙삼성 가우스는 라이선스나 개인정보를 침해하지 않는 안전한 데이터를 통해 학습되었으며,   
온디바이스에서 작동하도록 설계되어 외부로 사용자의 정보가 유출되지 않는 장점을 보유  
∙삼성전자는 삼성 가우스를 활용한 온디바이스 AI 기술도 소개했으며, 생성 AI 모델을 다양한 제품에   
단계적으로 탑재할 계획  
n 삼성 가우스는 △텍스트를 생성하는 언어모델 △코드를 생성하는 코드 모델 △이미지를 생성하는   
이미지 모델의 3개 모델로 구성  
∙언어 모델은 클라우드와 온디바이스 대상 다양한 모델로 구성되며, 메일 작성, 문서 요약, 번역 업무의   
처리를 지원  
∙코드 모델 기반의 AI 코딩 어시스턴트 ‘코드아이(code.i)’는 대화형 인터페이스로 서비스를 제공하며   
사내 소프트웨어 개발에 최적화  
∙이미지 모델은 창의적인 이미지를 생성하고 기존 이미지를 원하는 대로 바꿀 수 있도록 지원하며   
저해상도 이미지의 고해상도 전환도 지원  
n IT 전문지 테크리퍼블릭(TechRepublic)은 온디바이스 AI가 주요 기술 트렌드로 부상했다며,   
2024년부터 가우스를 탑재한 삼성 스마트폰이 메타의 라마(Llama)2를 탑재한 퀄컴 기기 및 구글   
어시스턴트를 적용한 구글 픽셀(Pixel)과 경쟁할 것으로 예상  
☞ 출처 : 삼성전자, ‘삼성 AI 포럼’서 자체 개발 생성형 AI ‘삼성 가우스’ 공개, 2023.11.08.  
삼성전자, ‘삼성 개발자 콘퍼런스 코리아 2023’ 개최, 2023.11.14.  
TechRepublic, Samsung Gauss: Samsung Research Reveals Generative AI, 2023.11.08.  </code></pre>
<div id="091dc44c" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.multi_vector <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SearchType  </span>
<span id="cb29-2"></span>
<span id="cb29-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 유형을 similarity로 설정, k값을 1로 설정  </span></span>
<span id="cb29-4">retriever.search_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SearchType.similarity  </span>
<span id="cb29-5">retriever.search_kwargs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}  </span>
<span id="cb29-6"></span>
<span id="cb29-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서 전체를 검색  </span></span>
<span id="cb29-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span>)))  </span></code></pre></div></div>
</details>
</div>
<pre><code>1  </code></pre>
</section>
<section id="요약본summary을-벡터저장소에-저장" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="요약본summary을-벡터저장소에-저장"><span class="header-section-number">1.6</span> 요약본(summary)을 벡터저장소에 저장</h2>
<ul>
<li>요약은 종종 청크(chunk)의 내용을 보다 정확하게 추출할 수 있어 더 나은 검색 결과를 얻을 수 있다.<br>
</li>
<li>요약은 핵심 내용만을 담고 있어 LLM의 할루시네이션을 방지할 수 있다.<br>
</li>
<li>여기서는 요약을 생성하는 방법과 이를 임베딩하는 방법에 대해 설명한다.</li>
</ul>
<div id="d06191bf" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PDF 파일을 로드하고 텍스트를 분할하기 위한 라이브러리 임포트  </span></span>
<span id="cb31-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PyMuPDFLoader  </span>
<span id="cb31-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RecursiveCharacterTextSplitter  </span>
<span id="cb31-4"></span>
<span id="cb31-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PDF 파일 로더 초기화  </span></span>
<span id="cb31-6">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PyMuPDFLoader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data/SPRI_AI_Brief_2023년12월호_F.pdf"</span>)  </span>
<span id="cb31-7"></span>
<span id="cb31-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 텍스트 분할  </span></span>
<span id="cb31-9">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)  </span>
<span id="cb31-10"></span>
<span id="cb31-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PDF 파일 로드 및 텍스트 분할 실행  </span></span>
<span id="cb31-12">split_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loader.load_and_split(text_splitter)  </span>
<span id="cb31-13"></span>
<span id="cb31-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 분할된 문서의 개수 출력  </span></span>
<span id="cb31-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"분할된 문서의 개수: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(split_docs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)  </span></code></pre></div></div>
</details>
</div>
<pre><code>분할된 문서의 개수: 61  </code></pre>
<div id="ce345c02" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.documents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Document  </span>
<span id="cb33-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.output_parsers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StrOutputParser  </span>
<span id="cb33-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate  </span>
<span id="cb33-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI  </span>
<span id="cb33-5"></span>
<span id="cb33-6"></span>
<span id="cb33-7">summary_chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (  </span>
<span id="cb33-8">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc"</span>: <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x.page_content}  </span>
<span id="cb33-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 요약을 위한 프롬프트 템플릿 생성  </span></span>
<span id="cb33-10">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ChatPromptTemplate.from_messages(  </span>
<span id="cb33-11">        [  </span>
<span id="cb33-12">            (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert in summarizing documents in Korean."</span>),  </span>
<span id="cb33-13">            (  </span>
<span id="cb33-14">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>,  </span>
<span id="cb33-15">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Summarize the following documents in 3 sentences in bullet points format.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{doc}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,  </span>
<span id="cb33-16">            ),  </span>
<span id="cb33-17">        ]  </span>
<span id="cb33-18">    )  </span>
<span id="cb33-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># OpenAI의 ChatGPT 모델을 사용하여 요약 생성  </span></span>
<span id="cb33-20">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ChatOpenAI(temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>)  </span>
<span id="cb33-21">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser()  </span>
<span id="cb33-22">)  </span></code></pre></div></div>
</details>
</div>
<ul>
<li><code>chain.batch</code> 메소드를 사용하여 <code>docs</code> 리스트의 문서들을 일괄 요약한다.<br>
</li>
<li>여기서 <code>max_concurrency</code> 매개변수를 10으로 설정하여 최대 10개의 문서를 동시에 처리할 수 있도록 한다.</li>
</ul>
<div id="f7321b7d" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 배치 처리  </span></span>
<span id="cb34-2">summaries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> summary_chain.batch(split_docs, {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_concurrency"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>})  </span></code></pre></div></div>
</details>
</div>
<div id="d504bf64" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(summaries)  </span></code></pre></div></div>
</details>
</div>
<pre><code>61  </code></pre>
<ul>
<li>61개의 요약본이 생김<br>
</li>
<li>요약된 내용을 출력하여 결과를 확인한다.</li>
</ul>
<div id="a661ad69" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 원본 문서의 내용을 출력한다.  </span></span>
<span id="cb37-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(split_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span>].page_content, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)  </span>
<span id="cb37-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 요약을 출력한다.  </span></span>
<span id="cb37-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[요약]"</span>)  </span>
<span id="cb37-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(summaries[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span>])  </span></code></pre></div></div>
</details>
</div>
<pre><code>SPRi AI Brief |  
2023-12월호  
10  
삼성전자, 자체 개발 생성 AI ‘삼성 가우스’ 공개  
n 삼성전자가 온디바이스에서 작동 가능하며 언어, 코드, 이미지의 3개 모델로 구성된 자체 개발 생성   
AI 모델 ‘삼성 가우스’를 공개  
n 삼성전자는 삼성 가우스를 다양한 제품에 단계적으로 탑재할 계획으로, 온디바이스 작동이 가능한   
삼성 가우스는 외부로 사용자 정보가 유출될 위험이 없다는 장점을 보유  
KEY Contents  
£ 언어, 코드, 이미지의 3개 모델로 구성된 삼성 가우스, 온디바이스 작동 지원  
n 삼성전자가 2023년 11월 8일 열린 ‘삼성 AI 포럼 2023’ 행사에서 자체 개발한 생성 AI 모델   
‘삼성 가우스’를 최초 공개  
∙정규분포 이론을 정립한 천재 수학자 가우스(Gauss)의 이름을 본뜬 삼성 가우스는 다양한 상황에   
최적화된 크기의 모델 선택이 가능  
∙삼성 가우스는 라이선스나 개인정보를 침해하지 않는 안전한 데이터를 통해 학습되었으며,   
온디바이스에서 작동하도록 설계되어 외부로 사용자의 정보가 유출되지 않는 장점을 보유  
∙삼성전자는 삼성 가우스를 활용한 온디바이스 AI 기술도 소개했으며, 생성 AI 모델을 다양한 제품에  

[요약]  
- 삼성전자가 온디바이스에서 작동 가능한 생성 AI 모델 '삼성 가우스'를 공개하였으며, 이 모델은 언어, 코드, 이미지의 3개 모델로 구성되어 있다.  
- '삼성 가우스'는 정규분포 이론을 정립한 수학자 가우스의 이름을 따왔으며, 다양한 상황에 최적화된 모델 선택이 가능하다.  
- 삼성전자는 이 AI 모델이 사용자 정보를 외부로 유출하지 않도록 설계되었으며, 향후 다양한 제품에 단계적으로 탑재할 계획이다.  </code></pre>
<ul>
<li><code>Chroma</code> 벡터 저장소를 초기화하여 자식 청크(child chunks)를 인덱싱한다. 이때 <code>OpenAIEmbeddings</code>를 임베딩 함수로 사용한다.<br>
</li>
<li>문서 ID를 나타내는 키로 <code>"doc_id"</code>를 사용한다.</li>
</ul>
<div id="bb80fb47" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> uuid  </span>
<span id="cb39-2"></span>
<span id="cb39-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 요약 정보를 저장할 벡터 저장소를 생성한다.  </span></span>
<span id="cb39-4">summary_vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma(  </span>
<span id="cb39-5">    collection_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"summaries"</span>,  </span>
<span id="cb39-6">    embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>OpenAIEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-embedding-3-small"</span>),  </span>
<span id="cb39-7">)  </span>
<span id="cb39-8"></span>
<span id="cb39-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 부모 문서를 저장할 저장소를 생성한다.  </span></span>
<span id="cb39-10">store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> InMemoryStore()  </span>
<span id="cb39-11"></span>
<span id="cb39-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 ID를 저장할 키 이름을 지정한다.  </span></span>
<span id="cb39-13">id_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_id"</span>  </span>
<span id="cb39-14"></span>
<span id="cb39-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색기를 초기화한다. (시작 시 비어 있음)  </span></span>
<span id="cb39-16">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MultiVectorRetriever(  </span>
<span id="cb39-17">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>summary_vectorstore,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소  </span></span>
<span id="cb39-18">    byte_store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>store,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 바이트 저장소  </span></span>
<span id="cb39-19">    id_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>id_key,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 ID 키  </span></span>
<span id="cb39-20">)  </span>
<span id="cb39-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 ID를 생성합니다.  </span></span>
<span id="cb39-22">doc_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(uuid.uuid4()) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> split_docs]  </span></code></pre></div></div>
</details>
</div>
<p>요약된 문서와 메타데이터(여기서는 생성한 요약본에 대한 <code>Document ID</code>이다)를 저장한다.</p>
<div id="3392bd38" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1">summary_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [  </span>
<span id="cb40-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 요약된 내용을 페이지 콘텐츠로 하고, 문서 ID를 메타데이터로 포함하는 Document 객체를 생성한다.  </span></span>
<span id="cb40-3">    Document(page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>s, metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{id_key: doc_ids[i]})  </span>
<span id="cb40-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, s <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(summaries)  </span>
<span id="cb40-5">]  </span></code></pre></div></div>
</details>
</div>
<p>요약본의 문서의 개수는 원본 문서의 개수와 일치한다.</p>
<div id="045c9dec" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 요약본의 문서의 개수  </span></span>
<span id="cb41-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(summary_docs)  </span></code></pre></div></div>
</details>
</div>
<pre><code>61  </code></pre>
<ul>
<li><code>retriever.vectorstore.add_documents(summary_docs)</code>를 통해 <code>summary_docs</code>를 벡터 저장소에 추가한다.<br>
</li>
<li><code>retriever.docstore.mset(list(zip(doc_ids, docs)))</code>를 사용하여 <code>doc_ids</code>와 <code>docs</code>를 매핑하여 문서 저장소에 저장한다.</li>
</ul>
<div id="c2bd0b05" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1">retriever.vectorstore.add_documents(  </span>
<span id="cb43-2">    summary_docs  </span>
<span id="cb43-3">)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 요약된 문서를 벡터 저장소에 추가한다.  </span></span>
<span id="cb43-4"></span>
<span id="cb43-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 ID와 문서를 매핑하여 문서 저장소에 저장합니다.  </span></span>
<span id="cb43-6">retriever.docstore.mset(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(doc_ids, split_docs)))  </span></code></pre></div></div>
</details>
</div>
<p><code>vectorstore</code> 객체의 <code>similarity_search</code> 메소드를 사용하여 유사도 검색을 수행한다.</p>
<div id="333df860" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb44-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 유사도 검색을 수행한다.  </span></span>
<span id="cb44-2">result_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> summary_vectorstore.similarity_search(  </span>
<span id="cb44-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span>  </span>
<span id="cb44-4">)  </span></code></pre></div></div>
</details>
</div>
<div id="88920b94" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb45-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1개의 결과 문서를 출력한다. (요약본)  </span></span>
<span id="cb45-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)  </span></code></pre></div></div>
</details>
</div>
<pre><code>- 삼성전자가 온디바이스에서 작동 가능한 생성 AI 모델 '삼성 가우스'를 공개하였으며, 이 모델은 언어, 코드, 이미지의 3개 모델로 구성되어 있다.  
- '삼성 가우스'는 정규분포 이론을 정립한 수학자 가우스의 이름을 따왔으며, 다양한 상황에 최적화된 모델 선택이 가능하다.  
- 삼성전자는 이 AI 모델이 사용자 정보를 외부로 유출하지 않도록 설계되었으며, 향후 다양한 제품에 단계적으로 탑재할 계획이다.  </code></pre>
<p><code>retriever</code> 객체의 <code>invoke()</code> 사용하여 질문과 관련된 문서를 검색한다.</p>
<div id="9083034f" class="cell" data-execution_count="29">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb47-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련된 원본 문서를 검색하여 가져옵니다.  </span></span>
<span id="cb47-2">retrieved_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span>)  </span>
<span id="cb47-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(retrieved_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)  </span></code></pre></div></div>
</details>
</div>
<pre><code>SPRi AI Brief |  
2023-12월호  
10  
삼성전자, 자체 개발 생성 AI ‘삼성 가우스’ 공개  
n 삼성전자가 온디바이스에서 작동 가능하며 언어, 코드, 이미지의 3개 모델로 구성된 자체 개발 생성   
AI 모델 ‘삼성 가우스’를 공개  
n 삼성전자는 삼성 가우스를 다양한 제품에 단계적으로 탑재할 계획으로, 온디바이스 작동이 가능한   
삼성 가우스는 외부로 사용자 정보가 유출될 위험이 없다는 장점을 보유  
KEY Contents  
£ 언어, 코드, 이미지의 3개 모델로 구성된 삼성 가우스, 온디바이스 작동 지원  
n 삼성전자가 2023년 11월 8일 열린 ‘삼성 AI 포럼 2023’ 행사에서 자체 개발한 생성 AI 모델   
‘삼성 가우스’를 최초 공개  
∙정규분포 이론을 정립한 천재 수학자 가우스(Gauss)의 이름을 본뜬 삼성 가우스는 다양한 상황에   
최적화된 크기의 모델 선택이 가능  
∙삼성 가우스는 라이선스나 개인정보를 침해하지 않는 안전한 데이터를 통해 학습되었으며,   
온디바이스에서 작동하도록 설계되어 외부로 사용자의 정보가 유출되지 않는 장점을 보유  
∙삼성전자는 삼성 가우스를 활용한 온디바이스 AI 기술도 소개했으며, 생성 AI 모델을 다양한 제품에  </code></pre>
</section>
<section id="가설-쿼리hypothetical-queries를-활용한-문서-탐색" class="level2" data-number="1.7">
<h2 data-number="1.7" class="anchored" data-anchor-id="가설-쿼리hypothetical-queries를-활용한-문서-탐색"><span class="header-section-number">1.7</span> 가설 쿼리(Hypothetical Queries)를 활용한 문서 탐색</h2>
<section id="핵심-아이디어" class="level3" data-number="1.7.1">
<h3 data-number="1.7.1" class="anchored" data-anchor-id="핵심-아이디어"><span class="header-section-number">1.7.1</span> 핵심 아이디어</h3>
<p><strong>사용자가 물어볼 만한 질문을 미리 생성해서 검색 인덱스로 활용</strong>하자는 전략이다.</p>
</section>
<section id="왜-효과적인가" class="level3" data-number="1.7.2">
<h3 data-number="1.7.2" class="anchored" data-anchor-id="왜-효과적인가"><span class="header-section-number">1.7.2</span> 왜 효과적인가?</h3>
<p><strong>1. 짧은 텍스트 간 매칭의 우수성</strong></p>
<p>일반적으로 다음과 같은 검색 성능 순서가 관찰된다:<br>
- <strong>질문 ↔︎ 질문</strong> (최고) &gt; 질문 ↔︎ 문단 &gt; 질문 ↔︎ 긴 문서 (최저)</p>
<p><strong>2. 임베딩 정보 손실 문제</strong></p>
<p>긴 문서를 임베딩할 때:<br>
1. 문서 → 임베딩 과정에서 <strong>1차 정보 손실</strong><br>
2. 검색 매칭 과정에서 <strong>2차 정보 손실</strong></p>
<p>따라서 임베딩 대상을 짧게 유지하는 것이 정보 손실을 최소화한다.</p>
<p><strong>3. 가설 질문 방식의 장점</strong></p>
<pre><code>전통적 방식:  
사용자 질문: "삼성의 AI 제품은?"  
    ↓ (의미 공간에서 멀리 떨어짐)  
원본 문서: "2023년 11월 8일 삼성전자가 삼성 AI 포럼에서..."  

가설 질문 방식:  
사용자 질문: "삼성의 AI 제품은?"  
    ↓ (의미 공간에서 매우 가까움)  
미리 생성한 질문: "삼성전자가 개발한 AI 기술은?"  
    ↓ (ID로 연결)  
원본 문서: "2023년 11월 8일 삼성전자가..."  </code></pre>
<p><strong>질문 ↔︎ 질문</strong> 매칭이므로 의미적 유사도가 훨씬 높다.</p>
</section>
<section id="작동-원리" class="level3" data-number="1.7.3">
<h3 data-number="1.7.3" class="anchored" data-anchor-id="작동-원리"><span class="header-section-number">1.7.3</span> 작동 원리</h3>
<ol type="1">
<li><strong>문서마다 가상 질문 생성</strong> (LLM 활용)
<ul>
<li>문서 내용을 읽고 “이 문서로 답할 수 있는 질문”을 3~5개 생성</li>
</ul></li>
<li><strong>질문을 VectorStore에 저장</strong>
<ul>
<li>원본 문서는 DocStore에 보관<br>
</li>
<li>가상 질문들만 임베딩하여 검색 대상으로 활용</li>
</ul></li>
<li><strong>검색 시</strong>
<ul>
<li>사용자 질문 → 가상 질문들과 유사도 검색<br>
</li>
<li>매칭된 가상 질문의 ID로 원본 문서 반환</li>
</ul></li>
</ol>
</section>
<section id="장단점-분석" class="level3" data-number="1.7.4">
<h3 data-number="1.7.4" class="anchored" data-anchor-id="장단점-분석"><span class="header-section-number">1.7.4</span> 장단점 분석</h3>
<p><strong>장점:</strong><br>
- 검색 정확도 향상: 질문-질문 매칭의 높은 의미 유사도<br>
- 다양한 관점 포착: 한 문서에 대해 여러 각도의 질문 생성 가능<br>
- 사용자 의도 파악 개선: 실제 사용자 질문 패턴과 유사</p>
<p><strong>단점:</strong><br>
- 비용 증가: LLM으로 질문 생성 필요 (문서당 3~5개 질문)<br>
- 시간 소요: 인덱싱 시간 증가<br>
- 질문 품질 의존: LLM이 생성한 질문의 품질에 성능 좌우</p>
<p><strong>언제 사용할까?</strong><br>
- 사용자 질문 패턴이 명확할 때 (FAQ, 고객 지원 등)<br>
- 검색 품질이 매우 중요할 때<br>
- 인덱싱 비용보다 검색 성능이 우선일 때</p>
<p><strong>언제 비추천?</strong><br>
- 문서가 자주 변경될 때 (재생성 비용)<br>
- 실시간 인덱싱이 필요할 때<br>
- 비용이 제약 조건일 때</p>
</section>
<section id="구현-예제" class="level3" data-number="1.7.5">
<h3 data-number="1.7.5" class="anchored" data-anchor-id="구현-예제"><span class="header-section-number">1.7.5</span> 구현 예제</h3>
<p>아래는 <code>Function Calling</code>을 활용하여 가설 질문을 생성하는 예제다.</p>
<div id="0cacaf88" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb50-1">functions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [  </span>
<span id="cb50-2">    {  </span>
<span id="cb50-3">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hypothetical_questions"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 함수의 이름을 지정한다.  </span></span>
<span id="cb50-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"description"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Generate hypothetical questions"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 함수에 대한 설명을 작성한다.  </span></span>
<span id="cb50-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"parameters"</span>: {  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 함수의 매개변수를 정의한다.  </span></span>
<span id="cb50-6">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"object"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 매개변수의 타입을 객체로 지정한다.  </span></span>
<span id="cb50-7">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"properties"</span>: {  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 객체의 속성을 정의한다.  </span></span>
<span id="cb50-8">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"questions"</span>: {  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 'questions' 속성을 정의한다.  </span></span>
<span id="cb50-9">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"array"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 'questions'의 타입을 배열로 지정합니다.  </span></span>
<span id="cb50-10">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"items"</span>: {  </span>
<span id="cb50-11">                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span>  </span>
<span id="cb50-12">                    },  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 배열의 요소 타입을 문자열로 지정합니다.  </span></span>
<span id="cb50-13">                },  </span>
<span id="cb50-14">            },  </span>
<span id="cb50-15">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"required"</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"questions"</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 필수 매개변수로 'questions'를 지정합니다.  </span></span>
<span id="cb50-16">        },  </span>
<span id="cb50-17">    }  </span>
<span id="cb50-18">]  </span></code></pre></div></div>
</details>
</div>
<p><code>ChatPromptTemplate</code>을 사용하여 주어진 문서를 기반으로 3개의 가상 질문을 생성하는 프롬프트 템플릿을 정의한다.</p>
<ul>
<li><code>functions</code>와 <code>function_call</code>을 설정하여 가상 질문 생성 함수를 호출한다.<br>
</li>
<li><code>JsonKeyOutputFunctionsParser</code>를 사용하여 생성된 가상 질문을 파싱하고, <code>questions</code> 키에 해당하는 값을 추출한다.</li>
</ul>
<div id="76b1b62b" class="cell" data-execution_count="31">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb51-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate  </span>
<span id="cb51-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.output_parsers.openai_functions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> JsonKeyOutputFunctionsParser  </span>
<span id="cb51-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI  </span>
<span id="cb51-4"></span>
<span id="cb51-5">hypothetical_query_chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (  </span>
<span id="cb51-6">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc"</span>: <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x.page_content}  </span>
<span id="cb51-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 아래 문서를 사용하여 답변할 수 있는 가상의 질문을 정확히 3개 생성하도록 요청합니다. 이 숫자는 조정될 수 있습니다.  </span></span>
<span id="cb51-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ChatPromptTemplate.from_template(  </span>
<span id="cb51-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Generate a list of exactly 3 hypothetical questions that the below document could be used to answer. "</span>  </span>
<span id="cb51-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Potential users are those interested in the AI industry. Create questions that they would be interested in. "</span>  </span>
<span id="cb51-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Output should be written in Korean:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{doc}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>  </span>
<span id="cb51-12">    )  </span>
<span id="cb51-13">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ChatOpenAI(max_retries<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>).bind(  </span>
<span id="cb51-14">        functions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>functions, function_call<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hypothetical_questions"</span>}  </span>
<span id="cb51-15">    )  </span>
<span id="cb51-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 출력에서 "questions" 키에 해당하는 값을 추출합니다.  </span></span>
<span id="cb51-17">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> JsonKeyOutputFunctionsParser(key_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"questions"</span>)  </span>
<span id="cb51-18">)  </span></code></pre></div></div>
</details>
</div>
<p>문서에 대한 답변을 출력<br>
- 출력은 생성한 3개의 가설 쿼리(Hypothetical Queries) 가 담겨 있다.</p>
<div id="61bc1d5d" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb52-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 주어진 문서에 대해 체인을 실행합니다.  </span></span>
<span id="cb52-2">hypothetical_query_chain.invoke(split_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span>])  </span></code></pre></div></div>
</details>
</div>
<pre><code>['삼성 가우스가 다른 생성 AI 모델에 비해 어떤 경쟁력을 가질 수 있을까?', '온디바이스 작동이 가능한 삼성 가우스가 개인 정보 보호에 미치는 영향은 무엇일까?', '삼성전자가 삼성 가우스를 다양한 제품에 단계적으로 탑재하려는 이유는 무엇일까?']  </code></pre>
<p><code>chain.batch</code> 메소드를 사용하여 <code>split_docs</code> 데이터에 대해 동시에 여러 개의 요청을 처리한다.</p>
<div id="b75192d2" class="cell" data-execution_count="33">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb54-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 목록에 대해 가설 질문을 배치 생성  </span></span>
<span id="cb54-2">hypothetical_questions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hypothetical_query_chain.batch(  </span>
<span id="cb54-3">    split_docs, {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_concurrency"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>}  </span>
<span id="cb54-4">)  </span></code></pre></div></div>
</details>
</div>
<div id="7b041d0a" class="cell" data-execution_count="34">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb55-1">hypothetical_questions[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span>]  </span></code></pre></div></div>
</details>
</div>
<pre><code>['삼성 가우스가 다른 생성 AI 모델과 비교했을 때, 사용자 개인 정보 보호에 있어 어떤 장점을 제공할까요?', '삼성전자가 삼성 가우스를 다양한 제품에 탑재하기로 결정한 이유는 무엇일까요?', '온디바이스에서 작동하는 삼성 가우스의 기능이 AI 산업의 미래에 어떤 영향을 미칠까요?']  </code></pre>
<p>생성한 가설 쿼리(Hypothetical Queries)를 벡터저장소에 저장하는 과정이다.</p>
<div id="7355250d" class="cell" data-execution_count="35">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb57-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 자식 청크를 인덱싱하는 데 사용할 벡터 저장소  </span></span>
<span id="cb57-2">hypothetical_vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma(  </span>
<span id="cb57-3">    collection_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hypo-questions"</span>, embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>OpenAIEmbeddings()  </span>
<span id="cb57-4">)  </span>
<span id="cb57-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 부모 문서의 저장소 계층  </span></span>
<span id="cb57-6">store <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> InMemoryStore()  </span>
<span id="cb57-7"></span>
<span id="cb57-8">id_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_id"</span>  </span>
<span id="cb57-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색기 (시작 시 비어 있음)  </span></span>
<span id="cb57-10">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MultiVectorRetriever(  </span>
<span id="cb57-11">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>hypothetical_vectorstore,  </span>
<span id="cb57-12">    byte_store<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>store,  </span>
<span id="cb57-13">    id_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>id_key,  </span>
<span id="cb57-14">)  </span>
<span id="cb57-15">doc_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(uuid.uuid4()) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> split_docs]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 ID 생성  </span></span></code></pre></div></div>
</details>
</div>
<p><code>question_docs</code> 리스트에 메타데이터(문서 ID)를 추가한다.</p>
<div id="c3cb0f4e" class="cell" data-execution_count="36">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb58-1">question_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []  </span>
<span id="cb58-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hypothetical_questions 저장  </span></span>
<span id="cb58-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, question_list <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(hypothetical_questions):  </span>
<span id="cb58-4">    question_docs.extend(  </span>
<span id="cb58-5">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질문 리스트의 각 질문에 대해 Document 객체를 생성하고, 메타데이터에 해당 질문의 문서 ID를 포함시킵니다.  </span></span>
<span id="cb58-6">        [Document(page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>s, metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{id_key: doc_ids[i]}) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> question_list]  </span>
<span id="cb58-7">    )  </span></code></pre></div></div>
</details>
</div>
<p>가설 쿼리를 문서에 추가하고, 원본 문서를 <code>docstore</code>에 추가한다.</p>
<div id="c9b7d323" class="cell" data-execution_count="37">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb59-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hypothetical_questions 문서를 벡터 저장소에 추가합니다.  </span></span>
<span id="cb59-2">retriever.vectorstore.add_documents(question_docs)  </span>
<span id="cb59-3"></span>
<span id="cb59-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 ID와 문서를 매핑하여 문서 저장소에 저장합니다.  </span></span>
<span id="cb59-5">retriever.docstore.mset(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(doc_ids, split_docs)))  </span></code></pre></div></div>
</details>
</div>
<p><code>vectorstore</code> 객체의 <code>similarity_search</code> 메소드를 사용하여 유사도 검색을 수행한다.</p>
<div id="38016c3c" class="cell" data-execution_count="38">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb60-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 유사한 문서를 벡터 저장소에서 검색합니다.  </span></span>
<span id="cb60-2">result_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> hypothetical_vectorstore.similarity_search(  </span>
<span id="cb60-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"삼성전자가 만든 생성형 AI 의 이름은?"</span>  </span>
<span id="cb60-4">)  </span></code></pre></div></div>
</details>
</div>
<p>아래는 유사도 검색 결과를 확인한다.</p>
<p>여기서는 생성한 가설 쿼리만 추가해 놓은 상태이므로, 생성한 가설 쿼리 중 유사도가 가장 높은 문서를 반환한다.</p>
<div id="f6b5fe85" class="cell" data-execution_count="39">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb61-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 유사도 검색 결과를 출력한다.  </span></span>
<span id="cb61-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> result_docs:  </span>
<span id="cb61-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)  </span>
<span id="cb61-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.metadata)  </span></code></pre></div></div>
</details>
</div>
<pre><code>삼성전자가 AI 기술을 활용하여 개발한 새로운 제품이나 서비스는 무엇일까요?  
{'doc_id': '61bcf671-1f5c-4d75-850e-42d4c88c2c87'}  
삼성의 Generative AI 기술이 향후 AI 시장에서 어떤 경쟁력을 가질 것으로 예상되나요?  
{'doc_id': '61bcf671-1f5c-4d75-850e-42d4c88c2c87'}  
삼성 개발자 콘퍼런스 코리아 2023에서 발표된 내용이 AI 산업에 어떤 영향을 미칠까요?  
{'doc_id': '61bcf671-1f5c-4d75-850e-42d4c88c2c87'}  
온디바이스에서 작동하는 삼성 가우스의 기능이 AI 산업의 미래에 어떤 영향을 미칠까요?  
{'doc_id': 'b7e88e61-8c28-400e-a4fb-f6bd25e5e40b'}  </code></pre>
<p><code>retriever</code> 객체의 <code>invoke</code> 메소드를 사용하여 쿼리와 관련된 문서를 검색한다.</p>
<div id="525dc5fd" class="cell" data-execution_count="40">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb63-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련된 문서를 검색하여 가져옵니다.  </span></span>
<span id="cb63-2">retrieved_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(result_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].page_content)  </span>
<span id="cb63-3"></span>
<span id="cb63-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서를 출력합니다.  </span></span>
<span id="cb63-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> retrieved_docs:  </span>
<span id="cb63-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)  </span></code></pre></div></div>
</details>
</div>
<pre><code>삼성전자, ‘삼성 개발자 콘퍼런스 코리아 2023’ 개최, 2023.11.14.  
TechRepublic, Samsung Gauss: Samsung Research Reveals Generative AI, 2023.11.08.  
SPRi AI Brief |  
2023-12월호  
10  
삼성전자, 자체 개발 생성 AI ‘삼성 가우스’ 공개  
n 삼성전자가 온디바이스에서 작동 가능하며 언어, 코드, 이미지의 3개 모델로 구성된 자체 개발 생성   
AI 모델 ‘삼성 가우스’를 공개  
n 삼성전자는 삼성 가우스를 다양한 제품에 단계적으로 탑재할 계획으로, 온디바이스 작동이 가능한   
삼성 가우스는 외부로 사용자 정보가 유출될 위험이 없다는 장점을 보유  
KEY Contents  
£ 언어, 코드, 이미지의 3개 모델로 구성된 삼성 가우스, 온디바이스 작동 지원  
n 삼성전자가 2023년 11월 8일 열린 ‘삼성 AI 포럼 2023’ 행사에서 자체 개발한 생성 AI 모델   
‘삼성 가우스’를 최초 공개  
∙정규분포 이론을 정립한 천재 수학자 가우스(Gauss)의 이름을 본뜬 삼성 가우스는 다양한 상황에   
최적화된 크기의 모델 선택이 가능  
∙삼성 가우스는 라이선스나 개인정보를 침해하지 않는 안전한 데이터를 통해 학습되었으며,   
온디바이스에서 작동하도록 설계되어 외부로 사용자의 정보가 유출되지 않는 장점을 보유  
∙삼성전자는 삼성 가우스를 활용한 온디바이스 AI 기술도 소개했으며, 생성 AI 모델을 다양한 제품에  </code></pre>


</section>
</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>RAG</category>
  <category>LangChain</category>
  <category>Agent</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/07-MultiVectorRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>앙상블 검색기(Ensemble Retriever)</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/03-EnsembleRetriever.html</link>
  <description><![CDATA[ 






<p><code>EnsembleRetriever</code>는 여러 검색기를 결합하여 더 강력한 검색 결과를 제공하는 LangChain의 기능이다. 다양한 검색 알고리즘의 장점을 활용하여 단일 알고리즘보다 더 나은 성능을 달성할 수 있으며, 사용자들 사이에서 높은 호평을 받고 있다. 다수의 리트리버를 사용하여 나온 결과를 Reciprocal Rank Fusion(RRF) 알고리즘으로 재순위화한 후 하나의 통합 검색 결과를 LLM의 입력으로 제공한다.</p>
<p><strong>주요 특징</strong></p>
<ol type="1">
<li><p><strong>여러 검색기 통합</strong>: 다양한 유형의 검색기를 입력으로 받아 결과를 결합한다.</p></li>
<li><p><strong>결과 재순위화 (Reciprocal Rank Fusion)</strong>: <a href="https://plg.uwaterloo.ca/~gvcormac/cormacksigir09-rrf.pdf">RRF</a> 알고리즘을 사용하여 각 검색기의 결과를 단순 합집합이 아닌 지능형 순위 매김을 통해 통합한다.</p>
<ul>
<li>각 검색기들이 검색한 유사도 높은 문서들을 단순히 합치지 않고 다시 순위를 매긴다</li>
<li>Agent 개발자들 사이에서는 EnsembleRetriever(LangChain 용어)보다 RRF(일반 통용 용어)를 훨씬 더 일반적으로 사용한다</li>
<li>논문에서 거의 모든 경우에 RRF가 더 좋은 성능을 보임을 보여준다</li>
<li>실제 적용에서 RRF의 효과는 비슷한 특성의 리트리버를 결합할 때보다 <strong>다양한 특성의 리트리버를 결합할 때 극대화</strong>된다</li>
</ul></li>
<li><p><strong>하이브리드 검색</strong>: 주로 <code>sparse retriever</code>(예: BM25)와 <code>dense retriever</code>(예: 임베딩 유사도)를 결합하여 사용한다.</p></li>
</ol>
<p><strong>각 검색기의 장점</strong></p>
<ul>
<li><strong>Sparse Retriever (BM25)</strong>: 키워드 기반 검색에 효과적 → 사용자의 정확한 용어에 민감하게 반응</li>
<li><strong>Dense Retriever (임베딩 기반)</strong>: 의미적 유사성 기반 검색에 효과적 → 의도와 맥락을 이해한 검색</li>
</ul>
<p>이러한 상호 보완적인 특성으로 인해 <code>EnsembleRetriever</code>는 다양한 검색 시나리오에서 향상된 성능을 제공한다.</p>
<p>자세한 내용은 <a href="https://python.langchain.com/docs/modules/data_connection/retrievers/ensemble">LangChain 공식 문서</a>를 참조하자.</p>
<section id="환경-설정" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="환경-설정"><span class="header-section-number">1</span> 환경 설정</h2>
<div id="63c4af7d" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="662cb79a" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="기본-사용법-두-개의-검색기-결합" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="기본-사용법-두-개의-검색기-결합"><span class="header-section-number">2</span> 기본 사용법: 두 개의 검색기 결합</h2>
<p><code>EnsembleRetriever</code>를 초기화하여 <code>BM25Retriever</code>와 <code>FAISS</code> 검색기를 결합한다. 각 검색기는 고유한 검색 방식을 사용한다: - <code>BM25Retriever</code>: 키워드 기반 검색 (sparse search) - <code>FAISS</code>: 임베딩 기반 의미 검색 (dense search)</p>
<div id="17ba2cba" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BM25Retriever, EnsembleRetriever</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 샘플 문서 데이터셋 (Apple 관련 문서들)</span></span>
<span id="cb3-6">doc_list <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb3-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I like apples"</span>,</span>
<span id="cb3-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I like apple company"</span>,</span>
<span id="cb3-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I like apple's iphone"</span>,</span>
<span id="cb3-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Apple is my favorite company"</span>,</span>
<span id="cb3-11">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I like apple's ipad"</span>,</span>
<span id="cb3-12">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I like apple's macbook"</span>,</span>
<span id="cb3-13">]</span>
<span id="cb3-14"></span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BM25 Retriever 초기화 (키워드 기반 검색)</span></span>
<span id="cb3-16">bm25_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BM25Retriever.from_texts(doc_list)</span>
<span id="cb3-17">bm25_retriever.k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과 개수</span></span>
<span id="cb3-18"></span>
<span id="cb3-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># FAISS Retriever 초기화 (의미 기반 검색)</span></span>
<span id="cb3-20">embedding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings()</span>
<span id="cb3-21">faiss_vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS.from_texts(doc_list, embedding)</span>
<span id="cb3-22">faiss_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> faiss_vectorstore.as_retriever(search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>})</span>
<span id="cb3-23"></span>
<span id="cb3-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensemble Retriever 생성 (가중치: BM25 70%, FAISS 30%)</span></span>
<span id="cb3-25">ensemble_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EnsembleRetriever(</span>
<span id="cb3-26">    retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[bm25_retriever, faiss_retriever],</span>
<span id="cb3-27">    weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BM25에 더 높은 가중치 부여</span></span>
<span id="cb3-28">)</span></code></pre></div></div>
</details>
</div>
<section id="예제-1-키워드-기반-검색에-유리한-쿼리" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="예제-1-키워드-기반-검색에-유리한-쿼리"><span class="header-section-number">2.1</span> 예제 1: 키워드 기반 검색에 유리한 쿼리</h3>
<p><code>ensemble_retriever</code> 객체를 사용하여 관련 문서를 검색한다. 각 검색기의 결과를 비교하면 가중치의 영향을 확인할 수 있다.</p>
<div id="75c59326" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 실행</span></span>
<span id="cb4-2">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my favorite fruit is apple"</span></span>
<span id="cb4-3">ensemble_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ensemble_retriever.invoke(query)</span>
<span id="cb4-4">bm25_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bm25_retriever.invoke(query)</span>
<span id="cb4-5">faiss_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> faiss_retriever.invoke(query)</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 결과 출력</span></span>
<span id="cb4-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[Ensemble Retriever 결과]"</span>)</span>
<span id="cb4-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ensemble_result:</span>
<span id="cb4-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Content: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb4-12"></span>
<span id="cb4-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[BM25 Retriever 결과]"</span>)</span>
<span id="cb4-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> bm25_result:</span>
<span id="cb4-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Content: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb4-17"></span>
<span id="cb4-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[FAISS Retriever 결과]"</span>)</span>
<span id="cb4-19"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> faiss_result:</span>
<span id="cb4-20">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Content: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span></code></pre></div></div>
</details>
</div>
<pre><code>[Ensemble Retriever 결과]
  I like apples

[BM25 Retriever 결과]
  I like apples

[FAISS Retriever 결과]
  Apple is my favorite company
</code></pre>
<p><strong>결과 해석</strong>: - BM25는 정확한 키워드 매칭(“apple”과 “fruit”)으로 “I like apples” 문서를 찾음 - FAISS는 의미 유사성으로 “favorite”과 관련된 “Apple is my favorite company” 문서를 찾음 - Ensemble은 BM25 가중치(0.7)가 높아서 BM25 결과를 우선함</p>
</section>
<section id="예제-2-의미-검색이-더-유용한-복잡한-쿼리" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="예제-2-의미-검색이-더-유용한-복잡한-쿼리"><span class="header-section-number">2.2</span> 예제 2: 의미 검색이 더 유용한 복잡한 쿼리</h3>
<p>더 자연스러운 문장 형태의 쿼리로 두 검색 방식의 차이를 관찰한다.</p>
<div id="cb5bf505" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 복잡한 쿼리 실행</span></span>
<span id="cb6-2">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Apple company makes my favorite iphone"</span></span>
<span id="cb6-3">ensemble_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ensemble_retriever.invoke(query)</span>
<span id="cb6-4">bm25_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bm25_retriever.invoke(query)</span>
<span id="cb6-5">faiss_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> faiss_retriever.invoke(query)</span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 결과 출력</span></span>
<span id="cb6-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[Ensemble Retriever 결과]"</span>)</span>
<span id="cb6-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ensemble_result:</span>
<span id="cb6-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Content: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb6-12"></span>
<span id="cb6-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[BM25 Retriever]"</span>)</span>
<span id="cb6-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> bm25_result:</span>
<span id="cb6-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Content: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb6-17"></span>
<span id="cb6-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[FAISS Retriever 결과]"</span>)</span>
<span id="cb6-19"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> faiss_result:</span>
<span id="cb6-20">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Content: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-21">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span></code></pre></div></div>
</details>
</div>
<pre><code>[Ensemble Retriever 결과]
  Apple is my favorite company
  I like apple's iphone

[BM25 Retriever 결과]
  Apple is my favorite company

[FAISS Retriever 결과]
  I like apple's iphone</code></pre>
<p><strong>결과 해석</strong>: - BM25는 “Apple”과 “company”라는 정확한 키워드에만 반응 → 한 문서만 반환 - FAISS는 “favorite”과 “iphone”의 의미 관계를 이해 → 더 정확한 문서 검색 - <strong>Ensemble은 두 결과를 결합</strong> → 다양한 관점에서의 정보 제공 - 실제 사용에서는 의미 검색의 가중치를 높이는 것이 복잡한 쿼리에서 더 효과적</p>
</section>
</section>
<section id="고급-기능-런타임에-가중치-동적-변경" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="고급-기능-런타임에-가중치-동적-변경"><span class="header-section-number">3</span> 고급 기능: 런타임에 가중치 동적 변경</h2>
<p><code>ConfigurableField</code>를 사용하면 프로그램 실행 중(런타임)에 각 검색기의 가중치를 동적으로 변경할 수 있다. 이는 다양한 쿼리 유형에 대응하는 유연한 검색 시스템을 구축할 수 있다는 장점이 있다.</p>
<section id="동적-가중치-설정-구성" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="동적-가중치-설정-구성"><span class="header-section-number">3.1</span> 동적 가중치 설정 구성</h3>
<div id="bd35572c" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.runnables <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ConfigurableField</span>
<span id="cb8-2"></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ConfigurableField를 사용한 동적 가중치 설정</span></span>
<span id="cb8-4">ensemble_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> EnsembleRetriever(</span>
<span id="cb8-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 리트리버 목록을 설정합니다. 여기서는 bm25_retriever와 faiss_retriever를 사용합니다.</span></span>
<span id="cb8-6">    retrievers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[bm25_retriever, faiss_retriever],</span>
<span id="cb8-7">).configurable_fields(</span>
<span id="cb8-8">    weights<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ConfigurableField(</span>
<span id="cb8-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ensemble_weights"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 외부에서 참조할 식별자</span></span>
<span id="cb8-10">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ensemble Weights"</span>,</span>
<span id="cb8-11">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BM25와 FAISS 검색기의 가중치 비율 (합계=1.0)"</span>,</span>
<span id="cb8-12">    )</span>
<span id="cb8-13">)</span></code></pre></div></div>
</details>
</div>
<ul>
<li>검색 시 <code>config</code> 매개변수를 통해 검색 설정을 지정
<ul>
<li><code>ensemble_weights</code> 옵션의 가중치를 [1, 0]으로 설정하여 <strong>모든 검색 결과의 가중치가 BM25 retriever 에 더 많이 부여</strong> 되도록</li>
</ul></li>
</ul>
<div id="8e787a91" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># BM25 전용 검색 설정</span></span>
<span id="cb9-2">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ensemble_weights"</span>: [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]}}</span>
<span id="cb9-3"></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 동일한 쿼리로 검색 실행</span></span>
<span id="cb9-5">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ensemble_retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my favorite fruit is apple"</span>, config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config)</span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[BM25만 사용 (가중치 [1.0, 0.0])]"</span>)</span>
<span id="cb9-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(docs, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb9-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
</div>
<pre><code>[BM25만 사용 (가중치 [1.0, 0.0])]
1. I like apples</code></pre>
<p><strong>결과 해석</strong>: BM25만 사용할 때는 정확한 키워드 매칭만 이루어짐. “apple”과 “fruit”을 포함한 문서만 반환됨.</p>
</section>
<section id="케이스-2-faiss-가중치-극대화-의미-기반-검색" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="케이스-2-faiss-가중치-극대화-의미-기반-검색"><span class="header-section-number">3.2</span> 케이스 2: FAISS 가중치 극대화 (의미 기반 검색)</h3>
<p>FAISS 검색기에 전체 가중치(1.0)를 할당하여 의미 기반 검색만 수행한다.</p>
<div id="37dbd688" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># FAISS 전용 검색 설정</span></span>
<span id="cb11-2">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ensemble_weights"</span>: [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]}}</span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 동일한 쿼리로 검색 실행</span></span>
<span id="cb11-5">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ensemble_retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my favorite fruit is apple"</span>, config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config)</span>
<span id="cb11-6"></span>
<span id="cb11-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[FAISS만 사용 (가중치 [0.0, 1.0])]"</span>)</span>
<span id="cb11-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(docs, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb11-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
</div>
<pre><code>[FAISS만 사용 (가중치 [0.0, 1.0])]
1. Apple is my favorite company</code></pre>
<p><strong>결과 해석</strong>: FAISS만 사용할 때는 의미 유사성으로 검색. “my favorite”이라는 표현을 “Apple is my favorite company”에서 찾아 반환함.</p>


</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>RAG</category>
  <category>LangChain</category>
  <category>Agent</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/03-EnsembleRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>벡터스토어 기반 검색기(VectorStore-backed Retriever)</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/01-VectorStoreRetriever.html</link>
  <description><![CDATA[ 






<p><strong>VectorStore 지원 검색기</strong> 는 vector store를 사용하여 문서를 검색하는 retriever입니다.</p>
<p>Vector store에 구현된 <strong>유사도 검색(similarity search)</strong> 이나 <strong>MMR</strong> 과 같은 검색 메서드를 사용하여 vector store 내의 텍스트를 쿼리합니다.</p>
<p>스플릿 다큐먼트를 확인해서 잘못나온거와 잘나온거를 확인해서 원하는 답변이 잘 나오도록 리브리버를 구현하는게 좋다.</p>
<p>아래의 코드를 실행하여 VectorStore 를 생성합니다.</p>
<div id="793ca8c6" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="04b85a40" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="1f0ed321" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> CharacterTextSplitter</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TextLoader</span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TextLoader를 사용하여 파일을 로드합니다.</span></span>
<span id="cb3-7">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TextLoader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./data/appendix-keywords.txt"</span>)</span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 로드합니다.</span></span>
<span id="cb3-10">documents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loader.load()</span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문자 기반으로 텍스트를 분할하는 CharacterTextSplitter를 생성합니다. 청크 크기는 300이고 청크 간 중복은 없습니다.</span></span>
<span id="cb3-13">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-14"></span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 로드된 문서를 분할합니다.</span></span>
<span id="cb3-16">split_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> text_splitter.split_documents(documents)</span>
<span id="cb3-17"></span>
<span id="cb3-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># OpenAI 임베딩을 생성합니다.</span></span>
<span id="cb3-19">embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings()</span>
<span id="cb3-20"></span>
<span id="cb3-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 분할된 텍스트와 임베딩을 사용하여 FAISS 벡터 데이터베이스를 생성합니다.</span></span>
<span id="cb3-22">db <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS.from_documents(split_docs, embeddings)</span></code></pre></div></div>
</details>
</div>
<section id="vectorstore에서-vectorstoreretriever-초기화as_retriever" class="level3" data-number="0.1">
<h3 data-number="0.1" class="anchored" data-anchor-id="vectorstore에서-vectorstoreretriever-초기화as_retriever"><span class="header-section-number">0.1</span> VectorStore에서 VectorStoreRetriever 초기화(as_retriever)</h3>
<p><code>as_retriever</code> 메서드는 VectorStore 객체를 기반으로 VectorStoreRetriever를 초기화하고 반환합니다. 이 메서드를 통해 다양한 검색 옵션을 설정하여 사용자의 요구에 맞는 문서 검색을 수행할 수 있습니다.</p>
<p><strong>매개변수(parameters)</strong></p>
<ul>
<li><code>**kwargs</code>: 검색 함수에 전달할 키워드 인자
<ul>
<li><code>search_type</code>: 검색 유형 (“similarity”, “mmr”, “similarity_score_threshold”)</li>
<li><code>search_kwargs</code>: 추가 검색 옵션
<ul>
<li><code>k</code>: 반환할 문서 수 (기본값: 4)</li>
<li><code>score_threshold</code>: similarity_score_threshold 검색의 최소 유사도 임계값</li>
<li><code>fetch_k</code>: MMR 알고리즘에 전달할 문서 수 (기본값: 20)</li>
<li><code>lambda_mult</code>: MMR 결과의 다양성 조절 (0-1 사이, 기본값: 0.5)</li>
<li><code>filter</code>: 문서 메타데이터 기반 필터링</li>
</ul></li>
</ul></li>
</ul>
<p><strong>반환값(return)</strong></p>
<ul>
<li><code>VectorStoreRetriever</code>: 초기화된 VectorStoreRetriever 객체</li>
</ul>
<p><strong>참고</strong></p>
<ul>
<li>다양한 검색 전략 구현 가능 (유사도, MMR, 임계값 기반)</li>
<li>MMR (Maximal Marginal Relevance) 알고리즘으로 검색 결과의 다양성 조절 가능</li>
<li>메타데이터 필터링으로 특정 조건의 문서만 검색 가능</li>
<li><code>tags</code> 매개변수를 통해 검색기에 태그 추가 가능</li>
</ul>
<p><strong>주의사항</strong></p>
<ul>
<li><code>search_type</code>과 <code>search_kwargs</code>의 적절한 조합 필요</li>
<li>MMR 사용 시 <code>fetch_k</code>와 <code>k</code> 값의 균형 조절 필요</li>
<li><code>score_threshold</code> 설정 시 너무 높은 값은 검색 결과가 없을 수 있음</li>
<li>필터 사용 시 데이터셋의 메타데이터 구조 정확히 파악 필요</li>
<li><code>lambda_mult</code> 값이 0에 가까울수록 다양성이 높아지고, 1에 가까울수록 유사성이 높아짐</li>
</ul>
<div id="fe54f235" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 데이터베이스를 검색기로 사용하기 위해 retriever 변수에 할당</span></span>
<span id="cb4-2">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.as_retriever()</span></code></pre></div></div>
</details>
</div>
</section>
<section id="retriever의-invoke" class="level3" data-number="0.2">
<h3 data-number="0.2" class="anchored" data-anchor-id="retriever의-invoke"><span class="header-section-number">0.2</span> Retriever의 invoke()</h3>
<p><code>invoke</code> 메서드는 Retriever의 주요 진입점으로, 관련 문서를 검색하는 데 사용됩니다. 이 메서드는 동기적으로 Retriever를 호출하여 주어진 쿼리에 대한 관련 문서를 반환합니다.</p>
<p><strong>매개변수(parameters)</strong></p>
<ul>
<li><code>input</code>: 검색 쿼리 문자열</li>
<li><code>config</code>: Retriever 구성 (Optional[RunnableConfig])</li>
<li><code>**kwargs</code>: Retriever에 전달할 추가 인자</li>
</ul>
<p><strong>반환값(return)</strong></p>
<ul>
<li><code>List[Document]</code>: 관련 문서 목록</li>
</ul>
<div id="85a46633" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb5-2">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"임베딩(Embedding)은 무엇인가요?"</span>)</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs:</span>
<span id="cb5-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb5-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="max-marginal-relevance-mmr" class="level3" data-number="0.3">
<h3 data-number="0.3" class="anchored" data-anchor-id="max-marginal-relevance-mmr"><span class="header-section-number">0.3</span> Max Marginal Relevance (MMR)</h3>
<p><code>MMR(Maximal Marginal Relevance)</code> 방식은 쿼리에 대한 관련 항목을 검색할 때 검색된 문서의 <strong>중복</strong> 을 피하는 방법 중 하나입니다.</p>
<p>단순히 가장 관련성 높은 항목들만을 검색하는 대신, MMR은 쿼리에 대한 <strong>문서의 관련성</strong> 과 이미 선택된 <strong>문서들과의 차별성을 동시에 고려</strong> 합니다.</p>
<ul>
<li><code>search_type</code> 매개변수를 <code>"mmr"</code> 로 설정하여 <strong>MMR(Maximal Marginal Relevance)</strong> 검색 알고리즘을 사용합니다.</li>
<li><code>k</code>: 반환할 문서 수 (기본값: 4)</li>
<li><code>fetch_k</code>: MMR 알고리즘에 전달할 문서 수 (기본값: 20)</li>
<li><code>lambda_mult</code>: MMR 결과의 다양성 조절 (0~1, 기본값: 0.5, 0: 유사도 점수만 고려, 1: 다양성만 고려)</li>
</ul>
<div id="43bae704" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MMR(Maximal Marginal Relevance) 검색 유형을 지정</span></span>
<span id="cb6-2">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.as_retriever(</span>
<span id="cb6-3">    search_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmr"</span>, search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fetch_k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lambda_mult"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>}</span>
<span id="cb6-4">)</span>
<span id="cb6-5"></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색합니다.</span></span>
<span id="cb6-7">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"임베딩(Embedding)은 무엇인가요?"</span>)</span>
<span id="cb6-8"></span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb6-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs:</span>
<span id="cb6-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb6-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="유사도-점수-임계값-검색similarity_score_threshold" class="level3" data-number="0.4">
<h3 data-number="0.4" class="anchored" data-anchor-id="유사도-점수-임계값-검색similarity_score_threshold"><span class="header-section-number">0.4</span> 유사도 점수 임계값 검색(similarity_score_threshold)</h3>
<p>유사도 점수 임계값을 설정하고 해당 임계값 이상의 점수를 가진 문서만 반환하는 검색 방법을 설정할 수 있습니다.</p>
<p>임계값을 적절히 설정함으로써 <strong>관련성이 낮은 문서를 필터링</strong> 하고, 질의와 <strong>가장 유사한 문서만 선별</strong> 할 수 있습니다.</p>
<ul>
<li><p><code>search_type</code> 매개변수를 <code>"similarity_score_threshold"</code> 로 설정하여 유사도 점수 임계값을 기준으로 검색을 수행합니다.</p></li>
<li><p><code>search_kwargs</code> 매개변수에 <code>{"score_threshold": 0.8}</code>를 전달하여 유사도 점수 임계값을 0.8로 설정합니다. 이는 검색 결과의 <strong>유사도 점수가 0.8 이상인 문서만 반환됨</strong> 을 의미합니다.</p></li>
</ul>
<div id="97a3a48c" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.as_retriever(</span>
<span id="cb7-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 유형을 "similarity_score_threshold 으로 설정</span></span>
<span id="cb7-3">    search_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"similarity_score_threshold"</span>,</span>
<span id="cb7-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임계값 설정</span></span>
<span id="cb7-5">    search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"score_threshold"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>},</span>
<span id="cb7-6">)</span>
<span id="cb7-7"></span>
<span id="cb7-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb7-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Word2Vec 은 무엇인가요?"</span>):</span>
<span id="cb7-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb7-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="top_k-설정" class="level3" data-number="0.5">
<h3 data-number="0.5" class="anchored" data-anchor-id="top_k-설정"><span class="header-section-number">0.5</span> top_k 설정</h3>
<p>검색 시 사용할 <code>k</code> 와 같은 검색 키워드 인자(kwargs)를 지정할 수 있습니다.</p>
<p><code>k</code> 매개변수는 검색 결과에서 반환할 상위 결과의 개수를 나타냅니다.</p>
<ul>
<li><code>search_kwargs</code>에서 <code>k</code> 매개변수를 1로 설정하여 검색 결과로 반환할 문서의 수를 지정합니다.</li>
</ul>
<div id="5cea1c67" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># k 설정</span></span>
<span id="cb8-2">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.as_retriever(search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>})</span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb8-5">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"임베딩(Embedding)은 무엇인가요?"</span>)</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb8-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs:</span>
<span id="cb8-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb8-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="동적-설정configurable" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="동적-설정configurable"><span class="header-section-number">1</span> 동적 설정(Configurable)</h2>
<ul>
<li>검색 설정을 동적으로 조정하기 위해 <code>ConfigurableField</code> 를 사용합니다.</li>
<li><code>ConfigurableField</code> 는 검색 매개변수의 고유 식별자, 이름, 설명을 설정하는 역할을 합니다.</li>
<li>검색 설정을 조정하기 위해 <code>config</code> 매개변수를 사용하여 검색 설정을 지정합니다.</li>
<li>검색 설정은 <code>config</code> 매개변수에 전달된 딕셔너리의 <code>configurable</code> 키에 저장됩니다.</li>
<li>검색 설정은 검색 쿼리와 함께 전달되며, 검색 쿼리에 따라 동적으로 조정됩니다.</li>
</ul>
<div id="6db24207" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.runnables <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ConfigurableField</span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># k 설정</span></span>
<span id="cb9-4">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.as_retriever(search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}).configurable_fields(</span>
<span id="cb9-5">    search_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ConfigurableField(</span>
<span id="cb9-6">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"search_type"</span>,</span>
<span id="cb9-7">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Search Type"</span>,</span>
<span id="cb9-8">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The search type to use"</span>,</span>
<span id="cb9-9">    ),</span>
<span id="cb9-10">    search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ConfigurableField(</span>
<span id="cb9-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 매개변수의 고유 식별자를 설정</span></span>
<span id="cb9-12">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"search_kwargs"</span>,</span>
<span id="cb9-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 매개변수의 이름을 설정</span></span>
<span id="cb9-14">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Search Kwargs"</span>,</span>
<span id="cb9-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 매개변수에 대한 설명을 작성</span></span>
<span id="cb9-16">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The search kwargs to use"</span>,</span>
<span id="cb9-17">    ),</span>
<span id="cb9-18">)</span></code></pre></div></div>
</details>
</div>
<p>아래는 동적 검색설정을 적용한 예시입니다.</p>
<div id="2bdd8fec" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 설정을 지정. Faiss 검색에서 k=3로 설정하여 가장 유사한 문서 3개를 반환</span></span>
<span id="cb10-2">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"search_kwargs"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>}}}</span>
<span id="cb10-3"></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb10-5">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"임베딩(Embedding)은 무엇인가요?"</span>, config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config)</span>
<span id="cb10-6"></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb10-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs:</span>
<span id="cb10-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb10-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span></code></pre></div></div>
</details>
</div>
<div id="526e3060" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 설정을 지정. score_threshold 0.8 이상의 점수를 가진 문서만 반환</span></span>
<span id="cb11-2">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb11-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {</span>
<span id="cb11-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"search_type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"similarity_score_threshold"</span>,</span>
<span id="cb11-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"search_kwargs"</span>: {</span>
<span id="cb11-6">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"score_threshold"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>,</span>
<span id="cb11-7">        },</span>
<span id="cb11-8">    }</span>
<span id="cb11-9">}</span>
<span id="cb11-10"></span>
<span id="cb11-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb11-12">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Word2Vec 은 무엇인가요?"</span>, config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config)</span>
<span id="cb11-13"></span>
<span id="cb11-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb11-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs:</span>
<span id="cb11-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb11-17">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span></code></pre></div></div>
</details>
</div>
<div id="2259dc45" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 설정을 지정. mmr 검색 설정.</span></span>
<span id="cb12-2">config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb12-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"configurable"</span>: {</span>
<span id="cb12-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"search_type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mmr"</span>,</span>
<span id="cb12-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"search_kwargs"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fetch_k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lambda_mult"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>},</span>
<span id="cb12-6">    }</span>
<span id="cb12-7">}</span>
<span id="cb12-8"></span>
<span id="cb12-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb12-10">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Word2Vec 은 무엇인가요?"</span>, config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>config)</span>
<span id="cb12-11"></span>
<span id="cb12-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련 문서를 검색</span></span>
<span id="cb12-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs:</span>
<span id="cb12-14">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(doc.page_content)</span>
<span id="cb12-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"========================================================="</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="upstage-임베딩과-같이-query-passage-embedding-model-이-분리된-경우" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="upstage-임베딩과-같이-query-passage-embedding-model-이-분리된-경우"><span class="header-section-number">2</span> Upstage 임베딩과 같이 Query &amp; Passage embedding model 이 분리된 경우</h2>
<p>기본 retriever는 쿼리와 문서에 대해 동일한 임베딩 모델을 사용합니다.</p>
<p>하지만 쿼리와 문서에 대해 서로 다른 임베딩 모델을 사용하는 경우가 있습니다.</p>
<p>이러한 경우에는 쿼리 임베딩 모델을 사용하여 쿼리를 임베딩하고, 문서 임베딩 모델을 사용하여 문서를 임베딩합니다.</p>
<p>이렇게 하면 쿼리와 문서에 대해 서로 다른 임베딩 모델을 사용할 수 있습니다.</p>
<div id="3ae721ad" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb13-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> CharacterTextSplitter</span>
<span id="cb13-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TextLoader</span>
<span id="cb13-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_upstage <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> UpstageEmbeddings</span>
<span id="cb13-5"></span>
<span id="cb13-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TextLoader를 사용하여 파일을 로드합니다.</span></span>
<span id="cb13-7">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TextLoader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./data/appendix-keywords.txt"</span>)</span>
<span id="cb13-8"></span>
<span id="cb13-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 로드합니다.</span></span>
<span id="cb13-10">documents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loader.load()</span>
<span id="cb13-11"></span>
<span id="cb13-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문자 기반으로 텍스트를 분할하는 CharacterTextSplitter를 생성합니다. 청크 크기는 300이고 청크 간 중복은 없습니다.</span></span>
<span id="cb13-13">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb13-14"></span>
<span id="cb13-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 로드된 문서를 분할합니다.</span></span>
<span id="cb13-16">split_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> text_splitter.split_documents(documents)</span>
<span id="cb13-17"></span>
<span id="cb13-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Upstage 임베딩을 생성합니다. 문서용 모델을 사용합니다.</span></span>
<span id="cb13-19">doc_embedder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> UpstageEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solar-embedding-1-large-passage"</span>)</span>
<span id="cb13-20"></span>
<span id="cb13-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 분할된 텍스트와 임베딩을 사용하여 FAISS 벡터 데이터베이스를 생성합니다.</span></span>
<span id="cb13-22">db <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS.from_documents(split_docs, doc_embedder)</span></code></pre></div></div>
</details>
</div>
<p>아래는 쿼리용 Upstage 임베딩을 생성하고, 쿼리 문장을 벡터로 변환하여 벡터 유사도 검색을 수행하는 예시입니다.</p>
<div id="54413db5" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 쿼리용 Upstage 임베딩을 생성합니다. 쿼리용 모델을 사용합니다.</span></span>
<span id="cb14-2">query_embedder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> UpstageEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solar-embedding-1-large-query"</span>)</span>
<span id="cb14-3"></span>
<span id="cb14-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 쿼리 문장을 벡터로 변환합니다.</span></span>
<span id="cb14-5">query_vector <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query_embedder.embed_query(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"임베딩(Embedding)은 무엇인가요?"</span>)</span>
<span id="cb14-6"></span>
<span id="cb14-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 유사도 검색을 수행하여 가장 유사한 2개의 문서를 반환합니다.</span></span>
<span id="cb14-8">db.similarity_search_by_vector(query_vector, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div></div>
</details>
</div>


</section>

 ]]></description>
  <category>AI</category>
  <category>RAG</category>
  <category>LangChain</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/01-VectorStoreRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>MultiQueryRetriever</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/06-MultiQueryRetriever.html</link>
  <description><![CDATA[ 






<section id="multiqueryretriever-개요" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> MultiQueryRetriever 개요</h1>
<section id="핵심-개념" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="핵심-개념"><span class="header-section-number">1.1</span> 핵심 개념</h2>
<p><strong>MultiQueryRetriever</strong>는 LLM이 사용자의 단일 쿼리를 기반으로 여러 개의 다양한 쿼리를 자동 생성하여 검색 성능을 향상시키는 고급 검색 기법이다.</p>
<section id="기본-원리-하나로-질문하고-여러-관점으로-검색한다" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="기본-원리-하나로-질문하고-여러-관점으로-검색한다"><span class="header-section-number">1.1.1</span> 기본 원리: “하나로 질문하고, 여러 관점으로 검색한다”</h3>
<ol type="1">
<li><strong>쿼리 확장</strong>: 사용자의 원본 질문을 LLM을 통해 여러 관점의 질문들로 변환<br>
</li>
<li><strong>다중 검색</strong>: 생성된 각 쿼리로 독립적인 검색 수행<br>
</li>
<li><strong>결과 합성</strong>: 모든 검색 결과를 합집합하여 포괄적인 문서 집합 구성</li>
</ol>
</section>
</section>
<section id="왜-필요한가" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="왜-필요한가"><span class="header-section-number">1.2</span> 왜 필요한가?</h2>
<section id="사용자의-쿼리-한계" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="사용자의-쿼리-한계"><span class="header-section-number">1.2.1</span> 사용자의 쿼리 한계</h3>
<p><strong>게으른 사용자 문제</strong></p>
<p>대부분의 사용자는 상세하고 구체적인 질문을 작성하지 않는다. 이로 인해:<br>
- LLM 입력 데이터가 불충분해짐<br>
- 검색 결과의 품질과 범위가 제한됨<br>
- 사용자가 원하는 정보를 놓칠 가능성 증가</p>
<p><strong>비논리적 질문 문제</strong></p>
<p>사람마다 논리적 개성이 강하기 때문에 다음과 같은 문제가 발생한다:<br>
- 논리적 비약이 포함된 질문<br>
- 구체성이 부족한 모호한 표현<br>
- 비유기적이고 정돈되지 않은 문장 구조<br>
- 질문자만 이해하고 타인은 이해하기 어려운 표현</p>
</section>
<section id="거리-기반-벡터-검색의-한계" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="거리-기반-벡터-검색의-한계"><span class="header-section-number">1.2.2</span> 거리 기반 벡터 검색의 한계</h3>
<section id="임베딩-공간의-제약" class="level4" data-number="1.2.2.1">
<h4 data-number="1.2.2.1" class="anchored" data-anchor-id="임베딩-공간의-제약"><span class="header-section-number">1.2.2.1</span> 임베딩 공간의 제약</h4>
<p>거리 기반 벡터 데이터베이스 검색은 고차원 공간에서 쿼리 임베딩과 문서 임베딩 간의 ’거리’를 기준으로 유사한 문서를 찾는다. 하지만 다음과 같은 한계가 있다:</p>
</section>
<section id="쿼리의-세부적인-차이가-검색-결과에-큰-영향을-미치는-이유" class="level4" data-number="1.2.2.2">
<h4 data-number="1.2.2.2" class="anchored" data-anchor-id="쿼리의-세부적인-차이가-검색-결과에-큰-영향을-미치는-이유"><span class="header-section-number">1.2.2.2</span> 쿼리의 세부적인 차이가 검색 결과에 큰 영향을 미치는 이유</h4>
<p>벡터 공간에서의 거리 계산은 매우 민감하게 작동한다:</p>
<ul>
<li><strong>고차원 공간의 차원 저주</strong>: 768차원(BERT) 또는 1536차원(OpenAI) 공간에서 작은 변화도 거리에 큰 영향<br>
</li>
<li><strong>단어 순서와 표현의 미묘한 차이</strong>: “어떻게 사용하나요?” vs “사용법이 무엇인가요?”는 의미상 동일하지만 벡터 공간에서는 다른 위치<br>
</li>
<li><strong>동의어와 유의어 처리의 한계</strong>: “방법”과 “방식”, “사용법”과 “활용법”이 벡터 공간에서 멀리 떨어져 위치할 수 있음</li>
</ul>
<p><strong>구체적인 예시:</strong></p>
<pre><code>쿼리 A: "OpenAI API 사용방법"     → 벡터 위치 [0.1, 0.8, -0.3, ...]
쿼리 B: "OpenAI API 활용법"      → 벡터 위치 [0.2, 0.7, -0.1, ...]
쿼리 C: "OpenAI API를 어떻게 써요?" → 벡터 위치 [0.5, 0.4, 0.2, ...]

동일한 의도의 질문이지만 벡터 공간에서 서로 다른 위치에 배치되어
완전히 다른 문서들이 검색될 수 있음</code></pre>
</section>
<section id="거리-계산의-한계" class="level4" data-number="1.2.2.3">
<h4 data-number="1.2.2.3" class="anchored" data-anchor-id="거리-계산의-한계"><span class="header-section-number">1.2.2.3</span> 거리 계산의 한계</h4>
<ul>
<li><strong>코사인 유사도의 함정</strong>: 벡터의 방향성만 고려하여 의미의 강도나 맥락적 뉘앙스 손실<br>
</li>
<li><strong>임베딩 모델의 편향</strong>: 학습 데이터의 특성에 따라 특정 표현 방식에 치우친 결과<br>
</li>
<li><strong>문맥 길이의 영향</strong>: 짧은 쿼리와 긴 쿼리가 동일한 공간에서 비교되어 부정확한 유사도 계산<br>
</li>
<li>임베딩이 데이터의 의미를 완전히 포착하지 못할 수 있음<br>
</li>
<li>단일 관점의 검색으로 인한 정보 누락 가능성<br>
</li>
<li>수동 프롬프트 엔지니어링의 번거로움</li>
</ul>
</section>
</section>
</section>
<section id="multiqueryretriever의-해결책" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="multiqueryretriever의-해결책"><span class="header-section-number">1.3</span> MultiQueryRetriever의 해결책</h2>
<section id="자동-쿼리-확장" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="자동-쿼리-확장"><span class="header-section-number">1.3.1</span> 자동 쿼리 확장</h3>
<p>MultiQueryRetriever는 LLM(Language Learning Model)을 활용하여 주어진 사용자 입력 쿼리에 대해 다양한 관점에서 여러 쿼리를 자동으로 생성한다. 이를 통해 프롬프트 튜닝 과정을 자동화한다.</p>
</section>
<section id="포괄적-검색-결과" class="level3" data-number="1.3.2">
<h3 data-number="1.3.2" class="anchored" data-anchor-id="포괄적-검색-결과"><span class="header-section-number">1.3.2</span> 포괄적 검색 결과</h3>
<p>각각의 생성된 쿼리에 대해 관련 문서 집합을 검색하고, 모든 쿼리를 아우르는 고유한 문서들의 <strong>합집합</strong>을 추출하여 잠재적으로 관련된 더 큰 문서 집합을 얻는다.</p>
</section>
<section id="논리적-재구성-효과" class="level3" data-number="1.3.3">
<h3 data-number="1.3.3" class="anchored" data-anchor-id="논리적-재구성-효과"><span class="header-section-number">1.3.3</span> 논리적 재구성 효과</h3>
<p>사용자의 비정돈된 질문을 MultiQuery를 통해 논리정연하고 완전한 형식의 문장 및 문단으로 <strong>paraphrasing</strong>하는 효과가 있다. 이러한 paraphrased text들은 LLM이 이해하기 적합한 형태로 나오기 때문에 답변 성능에 긍정적인 효과를 기대할 수 있다.</p>
</section>
<section id="어휘-선택의-민감성-문제" class="level3" data-number="1.3.4">
<h3 data-number="1.3.4" class="anchored" data-anchor-id="어휘-선택의-민감성-문제"><span class="header-section-number">1.3.4</span> 어휘 선택의 민감성 문제</h3>
<p><strong>사용자의 무의식적 어휘 선택</strong></p>
<p>대부분의 사용자는 질문을 작성할 때 어휘 선택(vocabulary choice)을 세심하게 고려하지 않는다. 하지만 벡터 임베딩에서는 각 단어가 고유한 의미 공간을 차지하므로, 유사한 의미의 단어들도 상당한 거리 차이를 보이는 벡터를 생성한다.</p>
<p><strong>동의어 간 벡터 거리의 문제</strong></p>
<p>동일하거나 유사한 개념을 표현하는 단어들이 임베딩 공간에서 예상보다 멀리 떨어져 배치되는 현상:</p>
<pre><code>한국어 예시:
- "이용" → 벡터 A [0.2, 0.8, -0.1, ...]
- "사용" → 벡터 B [0.1, 0.6, 0.3, ...]  
- "활용" → 벡터 C [0.4, 0.2, -0.2, ...]

영어 예시:
- "use" → 벡터 D [0.3, 0.7, 0.1, ...]
- "utilize" → 벡터 E [0.1, 0.4, -0.3, ...]
- "exploit" → 벡터 F [-0.2, 0.5, 0.4, ...]
- "take advantage of" → 벡터 G [0.6, -0.1, 0.2, ...]</code></pre>
<p><strong>실제 검색 영향 사례</strong></p>
<pre><code>사용자 질문 A: "OpenAI API를 이용하는 방법"
사용자 질문 B: "OpenAI API를 사용하는 방법"  
사용자 질문 C: "OpenAI API를 활용하는 방법"

→ 동일한 의도이지만 완전히 다른 검색 결과를 얻을 수 있음
→ 특정 단어로 작성된 문서만 검색되고 나머지는 누락될 위험</code></pre>
<p><strong>언어적 뉘앙스의 벡터화 한계</strong></p>
<ul>
<li><strong>격식의 정도</strong>: “사용”(일반적) vs “이용”(격식) vs “활용”(적극적)<br>
</li>
<li><strong>맥락적 의미</strong>: “exploit”(부정적 뉘앙스) vs “utilize”(중립적) vs “use”(일반적)<br>
</li>
<li><strong>언어 혼재</strong>: 한국어-영어 혼용 시 더욱 복잡한 벡터 공간 형성</li>
</ul>
<p>이러한 어휘 선택의 민감성으로 인해 사용자가 선택한 특정 단어에 따라 검색 품질이 크게 좌우되는 문제가 발생한다.</p>
</section>
<section id="검색-한계-극복" class="level3" data-number="1.3.5">
<h3 data-number="1.3.5" class="anchored" data-anchor-id="검색-한계-극복"><span class="header-section-number">1.3.5</span> 검색 한계 극복</h3>
<p>여러 관점에서 동일한 질문을 생성함으로써, MultiQueryRetriever는 거리 기반 검색의 제한을 일정 부분 극복하고, 더욱 풍부한 검색 결과를 제공할 수 있다.</p>
</section>
</section>
</section>
<section id="환경-설정" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> 환경 설정</h1>
<section id="api-키-및-추적-설정" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="api-키-및-추적-설정"><span class="header-section-number">2.1</span> API 키 및 추적 설정</h2>
<div id="9356a2b4" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb4-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb4-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="62c24ce7" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정한다. https://smith.langchain.com</span></span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb5-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력한다.</span></span>
<span id="cb5-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="76cf0011" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 샘플 벡터DB 구축</span></span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> WebBaseLoader</span>
<span id="cb6-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb6-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb6-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 블로그 포스트 (Parent Document)  로드</span></span>
<span id="cb6-8">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> WebBaseLoader(</span>
<span id="cb6-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://teddylee777.github.io/openai/openai-assistant-tutorial/"</span>, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span></span>
<span id="cb6-10">)</span>
<span id="cb6-11"></span>
<span id="cb6-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 분할</span></span>
<span id="cb6-13">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb6-14">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loader.load_and_split(text_splitter)</span>
<span id="cb6-15"></span>
<span id="cb6-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임베딩 정의</span></span>
<span id="cb6-17">openai_embedding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings()</span>
<span id="cb6-18"></span>
<span id="cb6-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터DB 생성</span></span>
<span id="cb6-20">db <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS.from_documents(docs, openai_embedding)</span>
<span id="cb6-21"></span>
<span id="cb6-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># retriever 생성</span></span>
<span id="cb6-23">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.as_retriever()</span>
<span id="cb6-24"></span>
<span id="cb6-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 검색</span></span>
<span id="cb6-26">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OpenAI Assistant API의 Functions 사용법에 대해 알려주세요."</span></span>
<span id="cb6-27">relevant_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(query)</span>
<span id="cb6-28"></span>
<span id="cb6-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서의 개수 출력</span></span>
<span id="cb6-30"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(relevant_docs)</span></code></pre></div></div>
</details>
</div>
<pre><code>USER_AGENT environment variable not set, consider setting it to identify your requests.
4</code></pre>
<p>검색된 결과 중 1개 문서의 내용을 출력한다.</p>
<div id="260061ff" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1번 문서를 출력합니다.</span></span>
<span id="cb8-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(relevant_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].page_content)</span></code></pre></div></div>
</details>
</div>
<pre><code>가장 강력한 도구로서, Assistant에게 사용자 정의 함수를 지정할 수 있습니다. 이는 Chat Completions API에서의 함수 호출과 매우 유사합니다.


Function calling(함수 호출) 도구를 사용하면 Assistant 에게 사용자 정의 함수 를 설명하여 호출해야 하는 함수를 인자와 함께 지능적으로 반환하도록 할 수 있습니다.


Assistant API는 실행 중에 함수를 호출할 때 실행을 일시 중지하며, 함수 호출 결과를 다시 제공하여 Run 실행을 계속할 수 있습니다. (이는 사용자 피드백을 받아 재게할 수 있는 의미이기도 합니다. 아래 튜토리얼에서 상세히 다룹니다).</code></pre>
</section>
</section>
<section id="multiqueryretriever-사용법" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> MultiQueryRetriever 사용법</h1>
<section id="기본-사용법" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="기본-사용법"><span class="header-section-number">3.1</span> 기본 사용법</h2>
<p><code>MultiQueryRetriever</code>에 사용할 LLM을 지정하고 질의 생성에 사용하면, retriever가 나머지 작업을 처리한다.</p>
<section id="multiqueryretriever-생성" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="multiqueryretriever-생성"><span class="header-section-number">3.1.1</span> MultiQueryRetriever 생성</h3>
<div id="d84a9d99" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.multi_query <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> MultiQueryRetriever</span>
<span id="cb10-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb10-3"></span>
<span id="cb10-4"></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ChatOpenAI 언어 모델을 초기화한다. temperature는 0으로 설정한다.</span></span>
<span id="cb10-6">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>)</span>
<span id="cb10-7"></span>
<span id="cb10-8">multiquery_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MultiQueryRetriever.from_llm(  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MultiQueryRetriever를 언어 모델을 사용하여 초기화한다.</span></span>
<span id="cb10-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 데이터베이스의 retriever와 언어 모델을 전달한다.</span></span>
<span id="cb10-10">    retriever<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>db.as_retriever(),</span>
<span id="cb10-11">    llm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm,</span>
<span id="cb10-12">)</span></code></pre></div></div>
</details>
</div>
<p>아래는 다중 쿼리를 생성하는 중간 과정을 디버깅하기 위하여 실행하는 코드이다.</p>
<p>먼저 <code>"langchain.retrievers.multi_query"</code> 로거를 가져온다. 이는 <code>logging.getLogger()</code> 함수를 사용하여 수행된다. 그 다음, 이 로거의 로그 레벨을 <code>INFO</code>로 설정하여, <code>INFO</code> 레벨 이상의 로그 메시지만 출력되도록 할 수 있다.</p>
<div id="06ac516a" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 쿼리에 대한 로깅 설정</span></span>
<span id="cb11-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb11-3"></span>
<span id="cb11-4">logging.basicConfig()</span>
<span id="cb11-5">logging.getLogger(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"langchain.retrievers.multi_query"</span>).setLevel(logging.INFO)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="multiqueryretriever-실행-및-결과-분석" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="multiqueryretriever-실행-및-결과-분석"><span class="header-section-number">3.1.2</span> MultiQueryRetriever 실행 및 결과 분석</h3>
<p>이 코드는 <code>multiquery_retriever</code> 객체의 <code>invoke</code> 메서드를 사용하여 주어진 <code>question</code>과 관련된 문서를 검색한다. 검색된 문서들은 <code>unique_docs</code>라는 변수에 저장되며, 이 변수의 길이를 확인함으로써 검색된 관련 문서의 총 개수를 알 수 있다. 이 과정을 통해 사용자의 질문에 대한 관련 정보를 효과적으로 찾아내고 그 양을 파악할 수 있다.</p>
<div id="bb6c7c4a" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질문을 정의한다.</span></span>
<span id="cb12-2">question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OpenAI Assistant API의 Functions 사용법에 대해 알려주세요."</span></span>
<span id="cb12-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 검색</span></span>
<span id="cb12-4">relevant_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> multiquery_retriever.invoke(question)</span>
<span id="cb12-5"></span>
<span id="cb12-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 고유한 문서의 개수를 반환합니다.</span></span>
<span id="cb12-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb12-8">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"===============</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">검색된 문서 개수: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(relevant_docs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb12-9">    end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">===============</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb12-10">)</span>
<span id="cb12-11"></span>
<span id="cb12-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서의 내용을 출력합니다.</span></span>
<span id="cb12-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(relevant_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>
<pre><code>INFO:langchain.retrievers.multi_query:Generated queries: ['OpenAI Assistant API에서 Functions 기능을 사용하는 방법에 대해 설명해 주세요.  ', 'OpenAI Assistant API의 Functions를 활용하는 방법은 무엇인가요?  ', 'OpenAI Assistant API의 Functions 사용에 대한 가이드를 제공해 주실 수 있나요?']
</code></pre>
<ul>
<li>질문 쿼리가 3개로 늘어남</li>
</ul>
<pre><code>===============
검색된 문서 개수: 5
===============
OpenAI의 새로운 Assistants API는 대화와 더불어 강력한 도구 접근성을 제공합니다. 본 튜토리얼은 OpenAI Assistants API를 활용하는 내용을 다룹니다. 특히, Assistant API 가 제공하는 도구인 Code Interpreter, Retrieval, Functions 를 활용하는 방법에 대해 다룹니다. 이와 더불어 파일을 업로드 하는 내용과 사용자의 피드백을 제출하는 내용도 튜토리얼 말미에 포함하고 있습니다.



주요내용</code></pre>
<ul>
<li>단일 쿼리 질문에서는 검색된 문서 개수가 4개</li>
<li>추가된 질문 쿼리를 합하여 검색된 문서 개수가 5개 (1개가 더 늘어남)</li>
</ul>
</section>
</section>
<section id="고급-기법-lcel-chain-활용-방법" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="고급-기법-lcel-chain-활용-방법"><span class="header-section-number">3.2</span> 고급 기법: LCEL Chain 활용 방법</h2>
<section id="사용자-정의-프롬프트로-커스터마이징" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="사용자-정의-프롬프트로-커스터마이징"><span class="header-section-number">3.2.1</span> 사용자 정의 프롬프트로 커스터마이징</h3>
<p>기본 MultiQueryRetriever 대신 LCEL(LangChain Expression Language) Chain을 활용하여 더욱 세밀한 제어가 가능한 커스텀 리트리버를 만들 수 있다.</p>
<p><strong>주요 특징:</strong><br>
- 사용자 정의 프롬프트 정의 가능<br>
- 생성될 쿼리 개수 조정 가능 (예: 5개)<br>
- 생성된 쿼리를 <code>"\n"</code> 구분자로 구분하여 반환<br>
- 사용자 정의 Chain과 함께 사용 가능</p>
</section>
<section id="lcel-chain-구현" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="lcel-chain-구현"><span class="header-section-number">3.2.2</span> LCEL Chain 구현</h3>
<div id="056fdd57" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.runnables <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RunnablePassthrough</span>
<span id="cb15-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PromptTemplate</span>
<span id="cb15-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.output_parsers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StrOutputParser</span>
<span id="cb15-4"></span>
<span id="cb15-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트 템플릿을 정의한다.(5개의 질문을 생성하도록 프롬프트를 작성하였다)</span></span>
<span id="cb15-6">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PromptTemplate.from_template(</span>
<span id="cb15-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""You are an AI language model assistant. </span></span>
<span id="cb15-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Your task is to generate five different versions of the given user question to retrieve relevant documents from a vector database. </span></span>
<span id="cb15-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">By generating multiple perspectives on the user question, your goal is to help the user overcome some of the limitations of the distance-based similarity search. </span></span>
<span id="cb15-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Your response should be a list of values separated by new lines, eg: `foo</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">bar</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">baz</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span></span>
<span id="cb15-11"></span>
<span id="cb15-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#ORIGINAL QUESTION: </span></span>
<span id="cb15-13"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{question}</span></span>
<span id="cb15-14"></span>
<span id="cb15-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#Answer in Korean:</span></span>
<span id="cb15-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb15-17">)</span>
<span id="cb15-18"></span>
<span id="cb15-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 언어 모델 인스턴스를 생성한다.</span></span>
<span id="cb15-20">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>)</span>
<span id="cb15-21"></span>
<span id="cb15-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLMChain을 생성한다.</span></span>
<span id="cb15-23">custom_multiquery_chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb15-24">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: RunnablePassthrough()} <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser()</span>
<span id="cb15-25">)</span>
<span id="cb15-26"></span>
<span id="cb15-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질문을 정의한다.</span></span>
<span id="cb15-28">question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OpenAI Assistant API의 Functions 사용법에 대해 알려주세요."</span></span>
<span id="cb15-29"></span>
<span id="cb15-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 체인을 실행하여 생성된 다중 쿼리를 확인한다.</span></span>
<span id="cb15-31">multi_queries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> custom_multiquery_chain.invoke(question)</span>
<span id="cb15-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 결과를 확인한다.(5개 질문 생성)</span></span>
<span id="cb15-33">multi_queries</span></code></pre></div></div>
</details>
</div>
<pre><code>'OpenAI Assistant API의 Functions 기능을 사용하는 방법을 설명해 주세요.  \nOpenAI Assistant API에서 Functions를 활용하는 방법이 궁금합니다.  \nOpenAI Assistant API의 Functions를 어떻게 사용할 수 있는지 알려주세요.  \nFunctions를 사용하여 OpenAI Assistant API를 활용하는 방법에 대해 설명해 주세요.  \nOpenAI Assistant API의 Functions 사용법에 대한 자세한 정보를 제공해 주세요.  '</code></pre>
</section>
<section id="출력-포맷-및-고려사항" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="출력-포맷-및-고려사항"><span class="header-section-number">3.2.3</span> 출력 포맷 및 고려사항</h3>
<p><strong>중요한 프롬프트 지시사항:</strong></p>
<pre><code>Your response should be a list of values separated by new lines, eg: `foo\nbar\nbaz\n`</code></pre>
<p><strong>이 지시사항이 중요한 이유:</strong><br>
- <strong>파싱 용이성</strong>: 나중에 list 형식으로 파싱이 용이하게 출력이 되도록 하기 위해서다.<br>
- <strong>강력한 구분자</strong>: 리스트 형식으로 스플릿을 구현할 때 명확한 구분자(new line)를 인식시켜야 오류가 발생하지 않는다.<br>
- <strong>시스템 안정성</strong>: 일관된 출력 형식으로 후속 처리의 안정성을 보장한다.</p>
</section>
<section id="custom-chain을-multiqueryretriever에-적용" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4" class="anchored" data-anchor-id="custom-chain을-multiqueryretriever에-적용"><span class="header-section-number">3.2.4</span> Custom Chain을 MultiQueryRetriever에 적용</h3>
<p>이전에 생성한 Chain을 <code>MultiQueryRetriever</code>에 전달하여 검색을 수행할 수 있다.</p>
<div id="af003050" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1">multiquery_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MultiQueryRetriever.from_llm(</span>
<span id="cb18-2">    llm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>custom_multiquery_chain, retriever<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>db.as_retriever()</span>
<span id="cb18-3">)</span></code></pre></div></div>
</details>
</div>
<p><code>MultiQueryRetriever</code>를 사용하여 문서를 검색하고 결과를 확인한다.</p>
<div id="300365ad" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 결과</span></span>
<span id="cb19-2">relevant_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> multiquery_retriever.invoke(question)</span>
<span id="cb19-3"></span>
<span id="cb19-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 고유한 문서의 개수를 반환한다.</span></span>
<span id="cb19-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb19-6">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"===============</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">검색된 문서 개수: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(relevant_docs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb19-7">    end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">===============</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb19-8">)</span>
<span id="cb19-9"></span>
<span id="cb19-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색된 문서의 내용을 출력한다.</span></span>
<span id="cb19-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(relevant_docs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content)</span></code></pre></div></div>
</details>
</div>
<pre><code>INFO:langchain.retrievers.multi_query:Generated queries: ['OpenAI Assistant API의 Functions 사용법에 대해 설명해 주세요.  ', 'OpenAI Assistant API에서 Functions를 어떻게 활용할 수 있나요?  ', 'OpenAI Assistant API의 Functions 기능에 대한 정보를 제공해 주세요.  ', 'Functions를 사용하여 OpenAI Assistant API를 어떻게 사용할 수 있는지 알려주세요.  ', 'OpenAI Assistant API의 Functions 사용법에 대한 자세한 내용을 알고 싶습니다.']</code></pre>
<pre><code>===============
검색된 문서 개수: 5
===============
OpenAI의 새로운 Assistants API는 대화와 더불어 강력한 도구 접근성을 제공합니다. 본 튜토리얼은 OpenAI Assistants API를 활용하는 내용을 다룹니다. 특히, Assistant API 가 제공하는 도구인 Code Interpreter, Retrieval, Functions 를 활용하는 방법에 대해 다룹니다. 이와 더불어 파일을 업로드 하는 내용과 사용자의 피드백을 제출하는 내용도 튜토리얼 말미에 포함하고 있습니다.
===============</code></pre>
</section>
</section>
</section>
<section id="성능-분석-및-효과" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> 성능 분석 및 효과</h1>
<section id="실험-결과-비교" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="실험-결과-비교"><span class="header-section-number">4.1</span> 실험 결과 비교</h2>
<section id="단일-쿼리-vs-다중-쿼리-비교" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="단일-쿼리-vs-다중-쿼리-비교"><span class="header-section-number">4.1.1</span> 단일 쿼리 vs 다중 쿼리 비교</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 13%">
<col style="width: 30%">
<col style="width: 30%">
<col style="width: 13%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">방식</th>
<th style="text-align: left;">생성된 쿼리 수</th>
<th style="text-align: left;">검색된 문서 수</th>
<th style="text-align: left;">장점</th>
<th style="text-align: left;">단점</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>단일 쿼리</strong></td>
<td style="text-align: left;">1개</td>
<td style="text-align: left;">4개</td>
<td style="text-align: left;">빠른 처리, 간단한 구조</td>
<td style="text-align: left;">제한된 검색 범위</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>기본 MultiQuery</strong></td>
<td style="text-align: left;">3개</td>
<td style="text-align: left;">5개</td>
<td style="text-align: left;">자동 쿼리 확장</td>
<td style="text-align: left;">제한된 커스터마이징</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Custom MultiQuery</strong></td>
<td style="text-align: left;">5개</td>
<td style="text-align: left;">5개</td>
<td style="text-align: left;">높은 커스터마이징, 더 다양한 관점</td>
<td style="text-align: left;">복잡한 설정</td>
</tr>
</tbody>
</table>
</section>
<section id="주요-개선-효과" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="주요-개선-효과"><span class="header-section-number">4.1.2</span> 주요 개선 효과</h3>
<p><strong>1. 검색 범위 확장</strong><br>
- 단일 쿼리: 4개 문서 → 다중 쿼리: 5개 문서 (25% 증가)<br>
- 더 포괄적인 정보 수집 가능</p>
<p><strong>2. 쿼리 다양성 향상</strong></p>
<pre><code>원본: "OpenAI Assistant API의 Functions 사용법에 대해 알려주세요."

생성된 다양한 관점:
1. "기능을 사용하는 방법을 설명해 주세요"
2. "Functions를 활용하는 방법이 궁금합니다"  
3. "Functions를 어떻게 사용할 수 있는지 알려주세요"
4. "Functions를 사용하여 API를 활용하는 방법"
5. "Functions 사용법에 대한 자세한 정보"</code></pre>
<p><strong>3. 검색 품질 개선</strong><br>
- 다양한 표현 방식으로 누락될 수 있는 관련 문서까지 포괄<br>
- 사용자 의도를 더 정확하게 해석하여 검색</p>
</section>
</section>
<section id="실무-적용-가이드" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="실무-적용-가이드"><span class="header-section-number">4.2</span> 실무 적용 가이드</h2>
<section id="언제-사용할까" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="언제-사용할까"><span class="header-section-number">4.2.1</span> 언제 사용할까?</h3>
<p><strong>✅ MultiQueryRetriever 사용 권장 상황</strong><br>
1. <strong>복잡하거나 모호한 쿼리</strong>: 사용자 질문이 불명확하거나 여러 해석이 가능한 경우<br>
2. <strong>포괄적 검색이 필요</strong>: 관련된 모든 정보를 놓치지 않고 수집해야 하는 경우<br>
3. <strong>다양한 표현의 문서</strong>: 동일한 개념이 여러 방식으로 표현된 문서들이 있는 경우<br>
4. <strong>사용자 경험 개선</strong>: 사용자가 정확한 키워드를 모르는 상황에서도 좋은 결과를 제공해야 하는 경우</p>
<p><strong>❌ 일반 Retriever 사용 권장 상황</strong><br>
1. <strong>명확하고 구체적인 쿼리</strong>: 이미 정확한 키워드나 구문이 포함된 경우<br>
2. <strong>빠른 응답이 중요</strong>: 실시간 응답이 중요하고 약간의 정확도 손실을 감수할 수 있는 경우<br>
3. <strong>제한된 리소스</strong>: LLM API 호출 비용을 최소화해야 하는 경우<br>
4. <strong>단순한 FAQ</strong>: 간단한 질문-답변 시스템에서 과도한 기능일 수 있는 경우</p>
</section>
<section id="최적화-전략" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="최적화-전략"><span class="header-section-number">4.2.2</span> 최적화 전략</h3>
<p><strong>1. 쿼리 생성 수 조정</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 간단한 질문: 3개</span></span>
<span id="cb23-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 복잡한 질문: 5-7개</span></span>
<span id="cb23-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 매우 복잡한 분석: 10개까지</span></span>
<span id="cb23-4"></span>
<span id="cb23-5">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PromptTemplate.from_template(</span>
<span id="cb23-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""Generate </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{num_queries}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> different versions of the question:</span></span>
<span id="cb23-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{question}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb23-8">)</span></code></pre></div></div>
<p><strong>2. 도메인별 프롬프트 최적화</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 기술 문서용</span></span>
<span id="cb24-2">tech_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""Generate technical variations focusing on:</span></span>
<span id="cb24-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- Implementation details</span></span>
<span id="cb24-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- API usage patterns  </span></span>
<span id="cb24-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- Code examples</span></span>
<span id="cb24-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- Troubleshooting scenarios"""</span></span>
<span id="cb24-7"></span>
<span id="cb24-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 비즈니스 문서용  </span></span>
<span id="cb24-9">business_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""Generate business-oriented variations focusing on:</span></span>
<span id="cb24-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- Use cases and applications</span></span>
<span id="cb24-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- Benefits and advantages</span></span>
<span id="cb24-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- Cost and ROI considerations</span></span>
<span id="cb24-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- Best practices"""</span></span></code></pre></div></div>
<p><strong>3. 성능 모니터링</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과 품질 추적</span></span>
<span id="cb25-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> evaluate_retrieval_quality(original_query, generated_queries, results):</span>
<span id="cb25-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb25-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'query_diversity'</span>: calculate_diversity(generated_queries),</span>
<span id="cb25-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'result_coverage'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(results)),</span>
<span id="cb25-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'relevance_score'</span>: calculate_relevance(original_query, results)</span>
<span id="cb25-7">    }</span></code></pre></div></div>
</section>
</section>
<section id="핵심-요약" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="핵심-요약"><span class="header-section-number">4.3</span> 핵심 요약</h2>
<section id="multiqueryretriever의-핵심-가치" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="multiqueryretriever의-핵심-가치"><span class="header-section-number">4.3.1</span> MultiQueryRetriever의 핵심 가치</h3>
<p><strong>“하나로 질문하고, 여러 관점으로 검색한다”</strong></p>
<ol type="1">
<li><strong>자동 쿼리 확장</strong>: 사용자의 단일 질문을 다양한 관점의 여러 질문으로 자동 변환<br>
</li>
<li><strong>검색 범위 확대</strong>: 단일 쿼리로는 놓칠 수 있는 관련 문서들까지 포괄적으로 수집<br>
</li>
<li><strong>사용자 경험 향상</strong>: 불완전하거나 모호한 질문도 의도를 파악하여 적절한 답변 제공<br>
</li>
<li><strong>유연한 커스터마이징</strong>: LCEL Chain을 통해 도메인별, 용도별 최적화 가능</li>
</ol>
</section>
<section id="주요-장점" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="주요-장점"><span class="header-section-number">4.3.2</span> 주요 장점</h3>
<ol type="1">
<li><strong>검색 정확도 향상</strong>: 다양한 관점에서의 접근으로 누락 정보 최소화<br>
</li>
<li><strong>사용성 개선</strong>: 사용자가 정확한 키워드를 몰라도 좋은 결과 제공<br>
</li>
<li><strong>자동화</strong>: 프롬프트 엔지니어링 과정을 LLM이 자동으로 수행<br>
</li>
<li><strong>확장성</strong>: 기존 Retriever 위에 간단히 추가하여 성능 향상 가능</li>
</ol>
</section>
<section id="실무-적용-포인트" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3" class="anchored" data-anchor-id="실무-적용-포인트"><span class="header-section-number">4.3.3</span> 실무 적용 포인트</h3>
<ul>
<li><strong>적정 쿼리 수</strong>: 3-5개 (복잡도에 따라 조정)<br>
</li>
<li><strong>비용 대비 효과</strong>: LLM 호출 비용 증가 vs 검색 품질 향상의 트레이드오프 고려<br>
</li>
<li><strong>도메인 특화</strong>: 업계별, 용도별 프롬프트 템플릿 개발로 효과 극대화<br>
</li>
<li><strong>성능 모니터링</strong>: 검색 결과의 다양성과 관련성을 지속적으로 평가</li>
</ul>
<p>MultiQueryRetriever는 RAG 시스템의 검색 단계를 크게 개선할 수 있는 강력한 도구이다. 특히 사용자의 질문이 불명확하거나 포괄적인 정보 수집이 필요한 상황에서 그 가치를 발휘한다.</p>


</section>
</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>RAG</category>
  <category>LangChain</category>
  <category>Agent</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/06-MultiQueryRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>긴 문맥 재정렬(LongContextReorder)</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/04-LongContextReorder.html</link>
  <description><![CDATA[ 






<section id="lost-in-the-middle-현상" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="lost-in-the-middle-현상"><span class="header-section-number">1</span> Lost in the Middle 현상</h2>
<section id="문제-정의" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="문제-정의"><span class="header-section-number">1.1</span> 문제 정의</h3>
<p>RAG 시스템에서 벡터 검색을 수행하면 일반적으로 유사도 점수에 따라 문서가 내림차순으로 정렬된다. 그러나 검색된 문서가 10개 이상일 때, 단순히 유사도 순서대로 LLM에 전달하는 것이 최선의 전략은 아니다.</p>
</section>
<section id="핵심-발견" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="핵심-발견"><span class="header-section-number">1.2</span> 핵심 발견</h3>
<p><strong>성능 저하 현상</strong><br>
- 모델 아키텍처와 무관하게 10개 이상의 문서를 입력할 경우 성능이 상당히 저하된다<br>
- 특정 훈련 방식(Instruction Tuning 등)과 관계없이 모든 LLM에서 공통적으로 나타난다</p>
<p><strong>원인: 위치 편향 (Positional Bias)</strong></p>
<ul>
<li>LLM은 시작과 끝 토큰에 더 높은 주의 가중치(Attention Weight)를 할당하는 학습된 편향을 가지고 있다.</li>
<li>이는 Transformer의 Self-Attention 메커니즘 학습 과정에서 형성된다.</li>
</ul>
<p><strong>학습된 편향의 형성 과정</strong></p>
<ol type="1">
<li><strong>초기 상태</strong>: Transformer는 초기에 단어 간의 관계만 학습한다</li>
<li><strong>편향 학습</strong>: 학습 데이터셋에서 <strong>핵심 정보가 시작과 끝에 자주 위치</strong>했기 때문에 위치적 편향이 형성된다</li>
<li><strong>파라미터 조정</strong>:
<ul>
<li>시작 토큰의 <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BQ%7D"> (Query)가 다른 토큰의 <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BK%7D"> (Key)와 강한 유사도를 갖도록 학습</li>
<li>끝 토큰의 <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BK%7D"> 가 다른 토큰의 <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BQ%7D"> 와 강한 유사도를 갖도록 학습</li>
</ul></li>
<li><strong>결과</strong>: 중간 위치 토큰은 상대적으로 낮은 주의 가중치를 받게 되어 <strong>‘Lost in the Middle’</strong> 현상 발생</li>
</ol>
<p><strong>은닉 표현 공간에서의 정보 경쟁</strong></p>
<p>중간 위치의 정보가 손실되는 이유는 벡터 공간의 제약에서 비롯된다.</p>
<ol type="1">
<li><strong>벡터화 한계</strong>: 모든 정보를 고정 크기 벡터로 압축해야 하는 제약</li>
<li><strong>신호 희석 (Signal Dilution)</strong>:
<ul>
<li>중간 위치의 관련 정보는 앞뒤 토큰들로부터의 주의 신호와 경쟁한다</li>
<li>은닉 표현 공간에서 노이즈 정보에 의해 <strong>희석</strong>되거나 <strong>덮어쓰인다</strong></li>
<li>결과적으로 모델이 해당 정보를 “잊어버린” 것처럼 동작한다</li>
</ul></li>
</ol>
<p><strong>학습 데이터의 영향</strong></p>
<ul>
<li>대부분의 잘 설계된 글은 중요한 정보를 시작(서론)이나 끝(결론)에 배치한다.</li>
<li>LLM은 이러한 패턴을 내재화하여 위치 기반 휴리스틱을 학습하게 된다.</li>
</ul>
</section>
<section id="실무적-함의" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="실무적-함의"><span class="header-section-number">1.3</span> 실무적 함의</h3>
<p><strong>문제 상황</strong> - 쿼리와 관련된 핵심 문서가 컨텍스트 중간에 위치할 경우 LLM의 답변 정확도가 크게 저하된다 - 모델이 제공된 문서를 무시하고 사전 학습 지식에만 의존하는 경향이 나타난다</p>
<p><strong>해결 방안</strong> - <strong>문서 재정렬 (Re-ordering)</strong>: 관련성 높은 문서를 시작과 끝에 배치 - <strong>재순위화 (Re-ranking)</strong>: 검색 후 추가 모델로 순위 재조정 - <strong>LongContextReorder</strong>: 중간 문서를 시작/끝으로 교대 배치하는 LangChain 기법</p>
</section>
</section>
<section id="관련-연구-lost-in-the-middle" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="관련-연구-lost-in-the-middle"><span class="header-section-number">2</span> 관련 연구: Lost in the Middle</h2>
<section id="논문-개요" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="논문-개요"><span class="header-section-number">2.1</span> 논문 개요</h3>
<p><a href="https://arxiv.org/abs/2307.03172">Lost in the Middle: How Language Models Use Long Contexts</a> (Liu et al., 2023)</p>
<p>이 논문은 최근 언어 모델들이 긴 컨텍스트를 입력받을 수 있음에도 불구하고, 컨텍스트 내 정보를 얼마나 효과적으로 활용하는지를 체계적으로 분석한 연구다.</p>
<p><strong>핵심 발견</strong>: LLM이 문맥 중간에 위치한 정보를 검색할 때 성능이 현저히 저하되는 <strong>‘Lost in the Middle’</strong> 현상을 발견했다. ### 실험 설계</p>
<p>연구팀은 <strong>멀티 문서 질의응답(Multi-Document QA)</strong>과 <strong>키-값 검색(Key-Value Retrieval)</strong> 두 가지 작업을 설계하여 모델 성능을 평가했다.</p>
<p><strong>주요 발견</strong></p>
<ol type="1">
<li><strong>정보 위치에 따른 성능 저하</strong>
<ul>
<li>관련 정보의 위치가 변경될 때 언어 모델의 성능이 크게 저하된다</li>
<li>현재 LLM은 긴 입력 컨텍스트의 정보를 강건하게(robustly) 활용하지 못한다</li>
</ul></li>
<li><strong>위치별 성능 패턴</strong>
<ul>
<li>성능 순서: <strong>앞 부분 &gt; 뒷 부분 &gt; 중간 부분</strong></li>
<li>시작(Beginning) 또는 끝(End) 위치: 최고 성능</li>
<li>중간(Middle) 위치: 현저한 성능 저하</li>
</ul></li>
<li><strong>범용적 현상</strong>
<ul>
<li>Long Context를 명시적으로 지원하는 모델(GPT-4, Claude 등)에서도 동일하게 관찰된다</li>
<li>모델 크기, 아키텍처와 무관하게 공통적으로 나타난다</li>
</ul></li>
</ol>
</section>
<section id="평가-방법론" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="평가-방법론"><span class="header-section-number">2.2</span> 평가 방법론</h3>
<p><strong>실험 설계 원칙</strong>: 관련 정보의 <strong>위치를 체계적으로 변화</strong>시키면서 성능을 측정한다.</p>
<p><strong>작업 1: 다중 문서 질의응답 (Multi-Document QA)</strong></p>
<p>목적: 여러 문서 중에서 정답을 포함한 문서를 식별하고 정확한 답변을 추출하는 능력을 평가한다.</p>
<ul>
<li><strong>데이터셋</strong>: Natural Questions, HotpotQA 등 기존 QA 벤치마크 활용</li>
<li><strong>컨텍스트 구성</strong>:
<ul>
<li><strong>관련 문서 (Relevant Document)</strong>: 질문에 대한 정답 포함</li>
<li><strong>방해 문서 (Distractor Documents)</strong>: 무작위로 선택된 비관련 문서들</li>
<li>두 종류를 결합하여 매우 긴 컨텍스트를 생성한다</li>
</ul></li>
</ul>
<p><strong>작업 2: 키-값 검색 (Key-Value Retrieval)</strong></p>
<p>목적: 긴 입력에서 특정 키에 해당하는 값을 정확히 추출하는 능력을 평가한다.</p>
<ul>
<li><strong>컨텍스트 구성</strong>: 수많은 무작위 키-값 쌍으로 구성</li>
<li><strong>평가 방식</strong>:
<ol type="1">
<li>모델에게 특정 키 제시</li>
<li>해당 키와 정확히 일치하는 값을 출력하는지 확인</li>
<li>정확도(Exact Match) 측정</li>
</ol></li>
</ul>
<p><strong>‘Lost in the Middle’ 현상 측정 프로토콜</strong></p>
<p>두 작업 모두에서 관련 정보의 위치를 체계적으로 조작하여 성능을 측정한다.</p>
<ol type="1">
<li><strong>관련 정보 추출</strong>
<ul>
<li>QA: 정답이 포함된 문서</li>
<li>키-값 검색: 질문과 관련된 키-값 쌍</li>
</ul></li>
<li><strong>위치 삽입 (Position Shifting)</strong>
<ul>
<li>전체 컨텍스트의 다양한 위치에 삽입한다</li>
<li>위치: 시작(Index 0), 1/4 지점, 중간(Middle), 3/4 지점, 끝(Index N)</li>
</ul></li>
<li><strong>성능 측정</strong>
<ul>
<li>각 위치별로 정답 정확도(Accuracy) 측정</li>
<li>위치에 따른 성능 곡선 분석</li>
</ul></li>
</ol>
</section>
<section id="논문의-기여" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="논문의-기여"><span class="header-section-number">2.3</span> 논문의 기여</h3>
<p><strong>학술적 기여</strong> 1. LLM이 긴 컨텍스트를 처리하는 메커니즘에 대한 실증적 분석을 제공한다 2. Long Context LLM 성능 평가를 위한 새로운 벤치마크 프로토콜을 제시한다 3. 위치 편향이라는 LLM의 근본적 한계를 밝혔다</p>
<p><strong>실무적 시사점</strong></p>
<p>논문은 <strong>문서 재정렬(Re-ordering)</strong> 전략을 제안한다: - 중간 부분의 문서를 시작과 끝으로 교대 배치한다 - 가장 관련성 높은 문서를 시작과 끝에 위치시킨다 - LangChain의 <code>LongContextReorder</code>가 이 전략을 구현한 것이다</p>
</section>
<section id="실험-결과-요약" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="실험-결과-요약"><span class="header-section-number">2.4</span> 실험 결과 요약</h3>
<p><strong>위치별 성능 패턴</strong></p>
<table class="caption-top table">
<colgroup>
<col style="width: 30%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">관련 정보 위치</th>
<th style="text-align: left;">예상 성능</th>
<th style="text-align: left;">실험 결과</th>
<th style="text-align: left;">성능 저하 정도</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>시작 (Beginning)</strong></td>
<td style="text-align: left;">높음</td>
<td style="text-align: left;">최고 성능 (90-95%)</td>
<td style="text-align: left;">-</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>1/4 지점</strong></td>
<td style="text-align: left;">중간</td>
<td style="text-align: left;">중간 성능 (70-80%)</td>
<td style="text-align: left;">약 15% 저하</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>중간 (Middle)</strong></td>
<td style="text-align: left;">낮음</td>
<td style="text-align: left;"><strong>최저 성능 (50-60%)</strong></td>
<td style="text-align: left;"><strong>최대 40% 저하</strong></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>3/4 지점</strong></td>
<td style="text-align: left;">중간</td>
<td style="text-align: left;">중간 성능 (75-85%)</td>
<td style="text-align: left;">약 10% 저하</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>끝 (End)</strong></td>
<td style="text-align: left;">높음</td>
<td style="text-align: left;">높은 성능 (85-90%)</td>
<td style="text-align: left;">약 5% 저하</td>
</tr>
</tbody>
</table>
<p><strong>핵심 인사이트</strong> - 시작 위치가 가장 높은 성능을 보인다 - 중간 위치는 최대 40%의 성능 저하가 발생한다 - 끝 위치도 높은 성능을 보이지만 시작보다는 약간 낮다</p>
</section>
<section id="해결-방안-문서-재정렬" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="해결-방안-문서-재정렬"><span class="header-section-number">2.5</span> 해결 방안: 문서 재정렬</h3>
<p>이 문제를 해결하기 위해 검색된 문서의 순서를 전략적으로 재배열하여 LLM에 입력한다.</p>
</section>
</section>
<section id="실습-longcontextreorder-적용" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="실습-longcontextreorder-적용"><span class="header-section-number">3</span> 실습: LongContextReorder 적용</h2>
<section id="환경-설정" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="환경-설정"><span class="header-section-number">3.1</span> 환경 설정</h3>
<p>이 실습에서는 다음을 수행한다: 1. <code>Chroma</code> 벡터 저장소로 텍스트 데이터를 저장하고 검색한다 2. 일반 검색 결과와 재정렬된 결과를 비교한다 3. RAG 체인에 <code>LongContextReorder</code>를 통합한다</p>
<div id="8859a76b" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="b43e5d54" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="longcontextreorder-의-재순위-방식-핵심-로직" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="longcontextreorder-의-재순위-방식-핵심-로직"><span class="header-section-number">3.2</span> LongContextReorder 의 재순위 방식 — 핵심 로직</h3>
<p>LongContextReorder 의 transform_documents(docs) 함수는 내부적으로 다음과 같은 단계를 거쳐 재정렬한다.</p>
<ol type="1">
<li>retriever가 반환한 문서 리스트를 받는다. 이 리스트는 통상적으로 유사도 기준으로 정렬되어 있다 (가장 관련 높은 문서가 앞쪽).</li>
</ol>
<ul>
<li>원본: [D0(높음), D1, D2, D3, D4(낮음)]</li>
</ul>
<ol start="2" type="1">
<li>내부적으로 리스트를 역순(reverse)으로 뒤집는다.</li>
</ol>
<ul>
<li>reverse 결과: [D4, D3, D2, D1, D0]</li>
</ul>
<ol start="3" type="1">
<li>그 뒤 “양끝 먼저, 중간은 나중” 식의 로직으로 다시 문서를 배치한다. 구체적으로:</li>
</ol>
<ul>
<li>역순된 리스트에서 인덱스 <code>i</code>가 짝수인 문서를 결과 리스트의 맨 앞(front)에 삽입.</li>
<li>인덱스 <code>i</code>가 홀수인 문서를 결과 리스트의 맨 뒤(back)에 삽입.</li>
<li>대화 초반에 멀리 떨어진 문서를 먼저, 후반엔 가까운 문서를 배치</li>
<li>이걸 i=0→4 순으로 처리하면:
<ul>
<li>i=0 → D4 (짝수 → 앞에 넣기) 결과: [D4]</li>
<li>i=1 → D3 (홀수 → 뒤에 넣기) 결과: [D4, D3]</li>
<li>i=2 → D2 (짝수 → 앞에 넣기) 결과: [D2, D4, D3]</li>
<li>i=3 → D1 (홀수 → 뒤에 넣기) 결과: [D2, D4, D3, D1]</li>
<li>i=4 → D0 (짝수 → 앞에 넣기) 결과: [D0, D2, D4, D3, D1]</li>
</ul></li>
<li>결과적으로, 원래 유사도가 높은 문서들이 앞과 뒤(즉, 컨텍스트의 처음과 끝)에 배치되고, 덜 관련 있거나 중간 순위 문서들은 가운데 쪽에 모이게 된다.</li>
</ul>
<div id="81b2539d" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PromptTemplate</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LongContextReorder</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chroma</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb3-5"></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임베딩을 가져옵니다.</span></span>
<span id="cb3-8">embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-embedding-3-small"</span>)</span>
<span id="cb3-9"></span>
<span id="cb3-10">texts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb3-11">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"이건 그냥 내가 아무렇게나 적어본 글입니다."</span>,</span>
<span id="cb3-12">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"사용자와 대화하는 것처럼 설계된 AI인 ChatGPT는 다양한 질문에 답할 수 있습니다."</span>,</span>
<span id="cb3-13">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"아이폰, 아이패드, 맥북 등은 애플이 출시한 대표적인 제품들입니다."</span>,</span>
<span id="cb3-14">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"챗GPT는 OpenAI에 의해 개발되었으며, 지속적으로 개선되고 있습니다."</span>,</span>
<span id="cb3-15">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"챗지피티는 사용자의 질문을 이해하고 적절한 답변을 생성하기 위해 대량의 데이터를 학습했습니다."</span>,</span>
<span id="cb3-16">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"애플 워치와 에어팟 같은 웨어러블 기기도 애플의 인기 제품군에 속합니다."</span>,</span>
<span id="cb3-17">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChatGPT는 복잡한 문제를 해결하거나 창의적인 아이디어를 제안하는 데에도 사용될 수 있습니다."</span>,</span>
<span id="cb3-18">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"비트코인은 디지털 금이라고도 불리며, 가치 저장 수단으로서 인기를 얻고 있습니다."</span>,</span>
<span id="cb3-19">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChatGPT의 기능은 지속적인 학습과 업데이트를 통해 더욱 발전하고 있습니다."</span>,</span>
<span id="cb3-20">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FIFA 월드컵은 네 번째 해마다 열리며, 국제 축구에서 가장 큰 행사입니다."</span>,</span>
<span id="cb3-21">]</span>
<span id="cb3-22"></span>
<span id="cb3-23"></span>
<span id="cb3-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색기를 생성합니다. (K는 10으로 설정합니다)</span></span>
<span id="cb3-25">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma.from_texts(texts, embedding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>embeddings).as_retriever(</span>
<span id="cb3-26">    search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>}</span>
<span id="cb3-27">)</span></code></pre></div></div>
</details>
</div>
<p>검색기에 쿼리를 입력하여 검색을 수행합니다.</p>
<div id="f18b957d" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChatGPT에 대해 무엇을 말해줄 수 있나요?"</span></span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련성 점수에 따라 정렬된 관련 문서를 가져옵니다.</span></span>
<span id="cb4-4">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(query)</span>
<span id="cb4-5">docs</span></code></pre></div></div>
</details>
</div>
<pre><code>[Document(page_content='ChatGPT는 복잡한 문제를 해결하거나 창의적인 아이디어를 제안하는 데에도 사용될 수 있습니다.'), 
Document(page_content='ChatGPT의 기능은 지속적인 학습과 업데이트를 통해 더욱 발전하고 있습니다.'), 
Document(page_content='사용자와 대화하는 것처럼 설계된 AI인 ChatGPT는 다양한 질문에 답할 수 있습니다.'), 
Document(page_content='챗GPT는 OpenAI에 의해 개발되었으며, 지속적으로 개선되고 있습니다.'), 
Document(page_content='이건 그냥 내가 아무렇게나 적어본 글입니다.'), 
Document(page_content='챗지피티는 사용자의 질문을 이해하고 적절한 답변을 생성하기 위해 대량의 데이터를 학습했습니다.'),
Document(page_content='비트코인은 디지털 금이라고도 불리며, 가치 저장 수단으로서 인기를 얻고 있습니다.'),
Document(page_content='아이폰, 아이패드, 맥북 등은 애플이 출시한 대표적인 제품들입니다.'), 
Document(page_content='애플 워치와 에어팟 같은 웨어러블 기기도 애플의 인기 제품군에 속합니다.'), 
Document(page_content='FIFA 월드컵은 네 번째 해마다 열리며, 국제 축구에서 가장 큰 행사입니다.')]</code></pre>
<p><strong>검색 결과 분석</strong></p>
<p>ChatGPT와 관련성이 높은 문서들이 상위에 정렬되어 있으며, 유사도 점수에 따라 내림차순으로 정렬된다.</p>
<ul>
<li><strong>상위 3개</strong>: ChatGPT 직접 관련 문서 (높은 관련성)</li>
<li><strong>4-6번</strong>: ChatGPT 언급 문서 (중간 관련성)</li>
<li><strong>7-10번</strong>: 무관한 문서 (낮은 관련성)</li>
</ul>
<p>이제 <code>LongContextReorder</code>를 적용하여 문서 순서를 재배치한다.</p>
</section>
<section id="문서-재정렬-적용" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="문서-재정렬-적용"><span class="header-section-number">3.3</span> 문서 재정렬 적용</h3>
<p><code>LongContextReorder</code> 클래스의 인스턴스인 <code>reordering</code>을 생성합니다.</p>
<ul>
<li><code>reordering.transform_documents(docs)</code>를 호출하여 문서 목록 <code>docs</code>를 재정렬
<ul>
<li>덜 관련된 문서는 목록의 중간에 위치시킨다</li>
<li>더 관련된 문서는 시작과 끝에 위치시킨다</li>
</ul></li>
</ul>
<div id="cb3c8580" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 재정렬한다</span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 덜 관련된 문서는 목록의 중간에 위치하고 더 관련된 요소는 시작/끝에 위치한다</span></span>
<span id="cb6-3">reordering <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LongContextReorder()</span>
<span id="cb6-4">reordered_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reordering.transform_documents(docs)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 순위 재조정</span></span>
<span id="cb6-5"></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ChatGPT 관련 문서가 시작과 끝에 위치하는지 확인한다</span></span>
<span id="cb6-7">reordered_docs</span></code></pre></div></div>
</details>
</div>
<pre><code>[Document(page_content='ChatGPT의 기능은 지속적인 학습과 업데이트를 통해 더욱 발전하고 있습니다.'), 
Document(page_content='챗GPT는 OpenAI에 의해 개발되었으며, 지속적으로 개선되고 있습니다.'),
Document(page_content='챗지피티는 사용자의 질문을 이해하고 적절한 답변을 생성하기 위해 대량의 데이터를 학습했습니다.'), 
Document(page_content='아이폰, 아이패드, 맥북 등은 애플이 출시한 대표적인 제품들입니다.'), 
Document(page_content='FIFA 월드컵은 네 번째 해마다 열리며, 국제 축구에서 가장 큰 행사입니다.'), 
Document(page_content='애플 워치와 에어팟 같은 웨어러블 기기도 애플의 인기 제품군에 속합니다.'), 
Document(page_content='비트코인은 디지털 금이라고도 불리며, 가치 저장 수단으로서 인기를 얻고 있습니다.'), 
Document(page_content='이건 그냥 내가 아무렇게나 적어본 글입니다.'), 
Document(page_content='사용자와 대화하는 것처럼 설계된 AI인 ChatGPT는 다양한 질문에 답할 수 있습니다.'), 
Document(page_content='ChatGPT는 복잡한 문제를 해결하거나 창의적인 아이디어를 제안하는 데에도 사용될 수 있습니다.')]</code></pre>
<p><strong>재정렬 결과 분석</strong></p>
<p>재정렬 전후를 비교하면 다음과 같은 패턴을 확인할 수 있다:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">위치</th>
<th style="text-align: left;">재정렬 전</th>
<th style="text-align: left;">재정렬 후</th>
<th style="text-align: left;">관련성</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>0-1번</strong></td>
<td style="text-align: left;">높은 관련성</td>
<td style="text-align: left;">중간 관련성</td>
<td style="text-align: left;">시작에 중간 문서 배치</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>2-7번</strong></td>
<td style="text-align: left;">중간/낮은 관련성</td>
<td style="text-align: left;">낮은 관련성</td>
<td style="text-align: left;">중간에 무관 문서 집중</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>8-9번</strong></td>
<td style="text-align: left;">낮은 관련성</td>
<td style="text-align: left;"><strong>높은 관련성</strong></td>
<td style="text-align: left;">끝에 핵심 문서 배치</td>
</tr>
</tbody>
</table>
<p><strong>재정렬 전략</strong>: - 가장 관련성 높은 문서(1, 10번)를 끝에 배치한다 - 중간 관련성 문서(2-4번)를 시작에 배치한다 - 무관한 문서(5-8번)를 중간에 배치한다</p>
<p>이렇게 하면 LLM이 시작과 끝에서 관련 정보를 찾을 수 있어 성능이 향상된다.</p>
</section>
</section>
<section id="rag-체인에-context-reordering-통합" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="rag-체인에-context-reordering-통합"><span class="header-section-number">4</span> RAG 체인에 Context Reordering 통합</h2>
<div id="e5f30249" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> format_docs(docs):</span>
<span id="cb8-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join([doc.page_content <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(docs)])</span></code></pre></div></div>
</details>
</div>
<div id="25b9cb28" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(format_docs(docs))</span></code></pre></div></div>
</details>
</div>
<pre><code>ChatGPT는 복잡한 문제를 해결하거나 창의적인 아이디어를 제안하는 데에도 사용될 수 있습니다.
ChatGPT의 기능은 지속적인 학습과 업데이트를 통해 더욱 발전하고 있습니다.
사용자와 대화하는 것처럼 설계된 AI인 ChatGPT는 다양한 질문에 답할 수 있습니다.
챗GPT는 OpenAI에 의해 개발되었으며, 지속적으로 개선되고 있습니다.
이건 그냥 내가 아무렇게나 적어본 글입니다.
챗지피티는 사용자의 질문을 이해하고 적절한 답변을 생성하기 위해 대량의 데이터를 학습했습니다.
비트코인은 디지털 금이라고도 불리며, 가치 저장 수단으로서 인기를 얻고 있습니다.
아이폰, 아이패드, 맥북 등은 애플이 출시한 대표적인 제품들입니다.
애플 워치와 에어팟 같은 웨어러블 기기도 애플의 인기 제품군에 속합니다.
FIFA 월드컵은 네 번째 해마다 열리며, 국제 축구에서 가장 큰 행사입니다.</code></pre>
<div id="1450a1fc" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> format_docs(docs):</span>
<span id="cb11-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join(</span>
<span id="cb11-3">        [</span>
<span id="cb11-4">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"[</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">] </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> [source: teddylee777@gmail.com]"</span></span>
<span id="cb11-5">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(docs)</span>
<span id="cb11-6">        ]</span>
<span id="cb11-7">    )</span>
<span id="cb11-8"></span>
<span id="cb11-9"></span>
<span id="cb11-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> reorder_documents(docs):</span>
<span id="cb11-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 재정렬</span></span>
<span id="cb11-12">    reordering <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LongContextReorder()</span>
<span id="cb11-13">    reordered_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reordering.transform_documents(docs)</span>
<span id="cb11-14">    combined <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> format_docs(reordered_docs)</span>
<span id="cb11-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(combined)</span>
<span id="cb11-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> combined</span></code></pre></div></div>
</details>
</div>
<p>재정렬된 문서를 출력합니다.</p>
<div id="2a53383c" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 재정렬된 문서를 출력</span></span>
<span id="cb12-2">_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reorder_documents(docs)</span></code></pre></div></div>
</details>
</div>
<pre><code>[0] ChatGPT의 기능은 지속적인 학습과 업데이트를 통해 더욱 발전하고 있습니다. [source: teddylee777@gmail.com]
[1] 챗GPT는 OpenAI에 의해 개발되었으며, 지속적으로 개선되고 있습니다. [source: teddylee777@gmail.com]
[2] 챗지피티는 사용자의 질문을 이해하고 적절한 답변을 생성하기 위해 대량의 데이터를 학습했습니다. [source: teddylee777@gmail.com]
[3] 아이폰, 아이패드, 맥북 등은 애플이 출시한 대표적인 제품들입니다. [source: teddylee777@gmail.com]
[4] FIFA 월드컵은 네 번째 해마다 열리며, 국제 축구에서 가장 큰 행사입니다. [source: teddylee777@gmail.com]
[5] 애플 워치와 에어팟 같은 웨어러블 기기도 애플의 인기 제품군에 속합니다. [source: teddylee777@gmail.com]
[6] 비트코인은 디지털 금이라고도 불리며, 가치 저장 수단으로서 인기를 얻고 있습니다. [source: teddylee777@gmail.com]
[7] 이건 그냥 내가 아무렇게나 적어본 글입니다. [source: teddylee777@gmail.com]
[8] 사용자와 대화하는 것처럼 설계된 AI인 ChatGPT는 다양한 질문에 답할 수 있습니다. [source: teddylee777@gmail.com]
[9] ChatGPT는 복잡한 문제를 해결하거나 창의적인 아이디어를 제안하는 데에도 사용될 수 있습니다. [source: teddylee777@gmail.com]</code></pre>
<div id="2851b4d0" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate</span>
<span id="cb14-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> operator <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> itemgetter</span>
<span id="cb14-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb14-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.output_parsers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StrOutputParser</span>
<span id="cb14-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.runnables <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RunnableLambda</span>
<span id="cb14-6"></span>
<span id="cb14-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트 템플릿</span></span>
<span id="cb14-8">template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""Given this text extracts:</span></span>
<span id="cb14-9"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{context}</span></span>
<span id="cb14-10"></span>
<span id="cb14-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-----</span></span>
<span id="cb14-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Please answer the following question:</span></span>
<span id="cb14-13"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{question}</span></span>
<span id="cb14-14"></span>
<span id="cb14-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Answer in the following languages: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{language}</span></span>
<span id="cb14-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb14-17"></span>
<span id="cb14-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트 정의</span></span>
<span id="cb14-19">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_template(template)</span>
<span id="cb14-20"></span>
<span id="cb14-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Chain 정의</span></span>
<span id="cb14-22">chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb14-23">    {</span>
<span id="cb14-24">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"context"</span>: itemgetter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>)</span>
<span id="cb14-25">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> retriever</span>
<span id="cb14-26">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> RunnableLambda(reorder_documents),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질문을 기반으로 문맥을 검색합니다.</span></span>
<span id="cb14-27">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: itemgetter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질문을 추출합니다.</span></span>
<span id="cb14-28">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"language"</span>: itemgetter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"language"</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 답변 언어를 추출합니다.</span></span>
<span id="cb14-29">    }</span>
<span id="cb14-30">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> prompt  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트 템플릿에 값을 전달합니다.</span></span>
<span id="cb14-31">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 언어 모델에 프롬프트를 전달합니다.</span></span>
<span id="cb14-32">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 모델의 출력을 문자열로 파싱합니다.</span></span>
<span id="cb14-33">)</span></code></pre></div></div>
</details>
</div>
<p><code>question</code> 에 쿼리를 입력하고 <code>language</code> 에 언어를 입력합니다.</p>
<ul>
<li>재정렬된 문서의 검색 결과도 확인합니다.</li>
</ul>
<div id="5770a8ea" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1">answer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chain.invoke(</span>
<span id="cb15-2">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ChatGPT에 대해 무엇을 말해줄 수 있나요?"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"language"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"KOREAN"</span>}</span>
<span id="cb15-3">)</span></code></pre></div></div>
</details>
</div>
<pre><code>[0] ChatGPT의 기능은 지속적인 학습과 업데이트를 통해 더욱 발전하고 있습니다. [source: teddylee777@gmail.com]
[1] 챗GPT는 OpenAI에 의해 개발되었으며, 지속적으로 개선되고 있습니다. [source: teddylee777@gmail.com]
[2] 챗지피티는 사용자의 질문을 이해하고 적절한 답변을 생성하기 위해 대량의 데이터를 학습했습니다. [source: teddylee777@gmail.com]
[3] 아이폰, 아이패드, 맥북 등은 애플이 출시한 대표적인 제품들입니다. [source: teddylee777@gmail.com]
[4] FIFA 월드컵은 네 번째 해마다 열리며, 국제 축구에서 가장 큰 행사입니다. [source: teddylee777@gmail.com]
[5] 애플 워치와 에어팟 같은 웨어러블 기기도 애플의 인기 제품군에 속합니다. [source: teddylee777@gmail.com]
[6] 비트코인은 디지털 금이라고도 불리며, 가치 저장 수단으로서 인기를 얻고 있습니다. [source: teddylee777@gmail.com]
[7] 이건 그냥 내가 아무렇게나 적어본 글입니다. [source: teddylee777@gmail.com]
[8] 사용자와 대화하는 것처럼 설계된 AI인 ChatGPT는 다양한 질문에 답할 수 있습니다. [source: teddylee777@gmail.com]
[9] ChatGPT는 복잡한 문제를 해결하거나 창의적인 아이디어를 제안하는 데에도 사용될 수 있습니다. [source: teddylee777@gmail.com]</code></pre>
<p>답변을 출력합니다.</p>
<div id="c721c488" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(answer)</span></code></pre></div></div>
</details>
</div>
<pre><code>ChatGPT는 OpenAI에 의해 개발된 인공지능으로, 사용자의 질문을 이해하고 적절한 답변을 생성하는 데 대량의 데이터를 학습했습니다. 이 AI는 지속적인 학습과 업데이트를 통해 더욱 발전하고 있으며, 다양한 질문에 답하거나 복잡한 문제를 해결하는 데에도 사용될 수 있습니다. 또한 창의적인 아이디어를 제안하는 기능도 갖추고 있습니다. 사용자는 ChatGPT와 대화하는 것처럼 상호작용할 수 있습니다.</code></pre>
</section>
<section id="성능-비교-및-결론" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="성능-비교-및-결론"><span class="header-section-number">5</span> 성능 비교 및 결론</h2>
<section id="longcontextreorder의-효과" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="longcontextreorder의-효과"><span class="header-section-number">5.1</span> LongContextReorder의 효과</h3>
<p><strong>기대 효과</strong> 1. <strong>답변 정확도 향상</strong>: 관련 문서를 시작과 끝에 배치하여 LLM이 핵심 정보를 놓치지 않도록 한다 2. <strong>환각(Hallucination) 감소</strong>: 제공된 컨텍스트를 더 잘 활용하여 사실 기반 답변 생성을 촉진한다 3. <strong>일관성 향상</strong>: 동일한 질문에 대해 더 안정적인 답변을 제공한다</p>
</section>
<section id="실무-적용-가이드" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="실무-적용-가이드"><span class="header-section-number">5.2</span> 실무 적용 가이드</h3>
<p><strong>언제 사용해야 하는가?</strong></p>
<p><strong>사용 권장 상황</strong> - 검색된 문서가 10개 이상일 때 - 긴 문서를 여러 개 처리해야 할 때 - 답변 품질이 일관되지 않을 때 - 중요 정보가 중간에 묻힐 가능성이 있을 때</p>
<p><strong>사용 불필요 상황</strong> - 검색 문서가 3-5개 이하일 때 - 모든 문서가 고도로 관련성이 있을 때 - 짧은 컨텍스트만 다룰 때</p>
</section>
<section id="추가-최적화-전략" class="level3" data-number="5.3">
<h3 data-number="5.3" class="anchored" data-anchor-id="추가-최적화-전략"><span class="header-section-number">5.3</span> 추가 최적화 전략</h3>
<p><code>LongContextReorder</code>와 함께 사용하면 좋은 기법들:</p>
<ol type="1">
<li><strong>하이브리드 검색</strong>: BM25 + 벡터 검색 조합으로 다양한 관련 문서 확보</li>
<li><strong>재순위화(Re-ranking)</strong>: Cross-encoder로 검색 결과 품질 향상 후 재정렬 적용</li>
<li><strong>청크 크기 최적화</strong>: 문서를 적절한 크기로 분할하여 관련성 높은 청크만 검색</li>
<li><strong>메타데이터 필터링</strong>: 재정렬 전에 무관한 문서를 사전 필터링</li>
</ol>
</section>
<section id="핵심-요약" class="level3" data-number="5.4">
<h3 data-number="5.4" class="anchored" data-anchor-id="핵심-요약"><span class="header-section-number">5.4</span> 핵심 요약</h3>
<p><strong>Lost in the Middle 문제</strong> - LLM은 긴 컨텍스트의 중간에 위치한 정보를 잘 활용하지 못한다 - 시작과 끝 위치에 더 높은 주의를 기울이는 학습된 편향이 원인이다</p>
<p><strong>해결책: LongContextReorder</strong> - 관련성 높은 문서를 시작과 끝에 배치한다 - 무관한 문서를 중간에 집중시킨다 - RAG 시스템의 답변 정확도와 일관성을 향상시킨다</p>
<p><strong>실무 적용</strong> - 10개 이상의 문서를 다룰 때 필수적이다 - 다른 최적화 기법(재순위화, 하이브리드 검색)과 조합하여 사용한다 - LangChain의 <code>LongContextReorder</code>로 간단히 구현할 수 있다</p>


</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>RAG</category>
  <category>LangChain</category>
  <category>Agent</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/04-LongContextReorder.html</guid>
  <pubDate>Thu, 04 Dec 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>시간 가중 벡터저장소 검색기(TimeWeightedVectorStoreRetriever)</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/09-TimeWeightedVectorStoreRetriever.html</link>
  <description><![CDATA[ 






<section id="timeweightedvectorstoreretriever-개요" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="timeweightedvectorstoreretriever-개요"><span class="header-section-number">1</span> TimeWeightedVectorStoreRetriever 개요</h2>
<section id="핵심-개념" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="핵심-개념"><span class="header-section-number">1.1</span> 핵심 개념</h3>
<p><code>TimeWeightedVectorStoreRetriever</code>는 의미론적 유사성(semantic similarity)과 시간에 따른 감쇠(time decay)를 결합하여 사용하는 검색 도구이다. 문서의 <strong>관련성(relevance)</strong>과 <strong>신선도(freshness)</strong>를 동시에 평가하여 가장 적합한 결과를 제공한다.</p>
</section>
<section id="적용-사례" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="적용-사례"><span class="header-section-number">1.2</span> 적용 사례</h3>
<ul>
<li><strong>뉴스 검색</strong>: 유사한 주제의 기사 중 최신 기사를 우선 검색<br>
</li>
<li><strong>규정집/법률 문서</strong>: 개정된 최신 조항을 우선 반환<br>
</li>
<li><strong>기술 문서</strong>: 업데이트된 최신 버전의 문서를 우선 검색<br>
</li>
<li><strong>고객 문의 응대</strong>: 최근 자주 참조되는 FAQ를 우선 제공</li>
</ul>
</section>
<section id="스코어링-알고리즘" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="스코어링-알고리즘"><span class="header-section-number">1.3</span> 스코어링 알고리즘</h3>
<p>검색 점수는 다음 공식으로 계산된다:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bscore%7D%20=%20%5Ctext%7Bsemantic%5C_similarity%7D%20+%20(1.0%20-%20%5Ctext%7Bdecay%5C_rate%7D)%5E%7B%5Ctext%7Bhours%5C_passed%7D%7D"></p>
<p><strong>수식 구성 요소</strong></p>
<ul>
<li><code>semantic_similarity</code>: 쿼리와 문서 간의 의미적 유사도 (벡터 임베딩 기반 코사인 유사도)<br>
</li>
<li><code>decay_rate</code>: 시간 감쇠율 (0 ~ 1 사이의 값, 높을수록 과거 문서에 큰 페널티)<br>
</li>
<li><code>hours_passed</code>: 마지막 접근 이후 경과한 시간 (시간 단위)</li>
</ul>
<p><strong>decay_rate 설정 효과</strong></p>
<ul>
<li><strong>높은 값 (0.999)</strong>: 과거 문서에 큰 페널티 → 최신 문서 우선 검색 (뉴스, 실시간 정보)<br>
</li>
<li><strong>낮은 값 (0.0001)</strong>: 시간 페널티 최소화 → 의미적 유사도 우선 (지식 베이스, 영구적 문서)<br>
</li>
<li><strong>중간 값 (0.5)</strong>: 최신성과 관련성의 균형 (일반적인 문서 검색)</li>
</ul>
</section>
<section id="주요-특징" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="주요-특징"><span class="header-section-number">1.4</span> 주요 특징</h3>
<p><strong>1. 마지막 접근 시간 기준</strong></p>
<p>문서 생성 시점이 아닌 <strong>마지막으로 접근된 시점</strong>을 기준으로 신선도를 평가한다. 자주 참조되는 문서는 계속 “최신” 상태를 유지하므로, 실제로 중요하고 유용한 정보가 상위에 노출된다.</p>
<p><strong>2. 동적 가중치 조정</strong></p>
<p>시간이 지남에 따라 자동으로 가중치가 감소하여, 별도의 재인덱싱 없이도 검색 결과가 최신 트렌드를 반영한다.</p>
<p><strong>3. 의미적 유사도와의 조합</strong></p>
<p>단순히 최신 문서만 반환하는 것이 아니라, 쿼리와의 관련성도 함께 고려하여 균형잡힌 검색 결과를 제공한다.</p>
</section>
</section>
<section id="환경-설정" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="환경-설정"><span class="header-section-number">2</span> 환경 설정</h2>
<section id="api-키-로드" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="api-키-로드"><span class="header-section-number">2.1</span> API 키 로드</h3>
<div id="917ae0a5" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일  </span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv  </span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드  </span></span>
<span id="cb1-5">load_dotenv()  </span></code></pre></div></div>
</details>
</div>
</section>
<section id="langsmith-추적-설정" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="langsmith-추적-설정"><span class="header-section-number">2.2</span> LangSmith 추적 설정</h3>
<p>LangSmith를 활용하면 시간 가중치 계산 과정과 검색 점수 변화를 시각적으로 추적할 수 있다.</p>
<div id="3521e5cf" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적 설정 (https://smith.langchain.com)  </span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote  </span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging  </span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름 입력  </span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)  </span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="낮은-감쇠율-의미적-유사도-우선" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="낮은-감쇠율-의미적-유사도-우선"><span class="header-section-number">3</span> 낮은 감쇠율 (의미적 유사도 우선)</h2>
<section id="개념-설명" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="개념-설명"><span class="header-section-number">3.1</span> 개념 설명</h3>
<p>낮은 <code>decay_rate</code> (0에 가까운 값)는 시간이 지나도 문서의 점수가 거의 감소하지 않음을 의미한다. 즉, <strong>시간보다 의미적 유사도가 검색 결과에 더 큰 영향</strong>을 미친다.</p>
<p><strong>특징</strong></p>
<ul>
<li><code>decay_rate = 0</code>: 시간 감쇠 없음 → 일반적인 벡터 유사도 검색과 동일<br>
</li>
<li><code>decay_rate ≈ 0.0000001</code>: 거의 감쇠 없음 → 과거 문서도 유사도가 높으면 상위 노출</li>
</ul>
<p><strong>적용 시나리오</strong></p>
<ul>
<li>시간에 구애받지 않는 지식 베이스 (수학 공식, 역사적 사실)<br>
</li>
<li>영구적인 참조 문서 (API 문서, 기술 사양서)<br>
</li>
<li>오래된 문서도 여전히 가치 있는 경우</li>
</ul>
</section>
<section id="retriever-초기화" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="retriever-초기화"><span class="header-section-number">3.2</span> Retriever 초기화</h3>
<p>벡터 저장소와 매우 낮은 감쇠율을 설정하여 retriever를 생성한다.</p>
<div id="04eb00ce" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datetime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime, timedelta  </span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> faiss  </span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.docstore <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> InMemoryDocstore  </span>
<span id="cb3-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TimeWeightedVectorStoreRetriever  </span>
<span id="cb3-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS  </span>
<span id="cb3-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.documents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Document  </span>
<span id="cb3-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings  </span>
<span id="cb3-9"></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임베딩 모델을 정의합니다.  </span></span>
<span id="cb3-11">embeddings_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-embedding-3-small"</span>)  </span>
<span id="cb3-12"></span>
<span id="cb3-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소를 빈 상태로 초기화합니다.  </span></span>
<span id="cb3-14">embedding_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1536</span>  </span>
<span id="cb3-15">index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> faiss.IndexFlatL2(embedding_size)  </span>
<span id="cb3-16">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS(embeddings_model, index, InMemoryDocstore({}), {})  </span>
<span id="cb3-17"></span>
<span id="cb3-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 시간 가중치가 적용된 벡터 저장소 검색기를 초기화합니다. (여기서는, 낮은 감쇠율을 적용합니다)  </span></span>
<span id="cb3-19">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TimeWeightedVectorStoreRetriever(  </span>
<span id="cb3-20">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore, decay_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0000000000000000000000001</span>, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>  </span>
<span id="cb3-21">)  </span></code></pre></div></div>
</details>
</div>
</section>
<section id="샘플-데이터-추가" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="샘플-데이터-추가"><span class="header-section-number">3.3</span> 샘플 데이터 추가</h3>
<p>두 개의 문서를 추가한다. 첫 번째 문서는 어제 작성된 것으로, 두 번째 문서는 방금 작성된 것으로 설정한다.</p>
<div id="7443dbd6" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 어제 날짜를 계산  </span></span>
<span id="cb4-2">yesterday <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.now() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> timedelta(days<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)  </span>
<span id="cb4-3"></span>
<span id="cb4-4">retriever.add_documents(  </span>
<span id="cb4-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 추가하고, metadata에 어제 날짜를 설정  </span></span>
<span id="cb4-6">    [  </span>
<span id="cb4-7">        Document(  </span>
<span id="cb4-8">            page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트 구독해 주세요."</span>,  </span>
<span id="cb4-9">            metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"last_accessed_at"</span>: yesterday},  </span>
<span id="cb4-10">        )  </span>
<span id="cb4-11">    ]  </span>
<span id="cb4-12">)  </span>
<span id="cb4-13"></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 다른 문서를 추가 (metadata는 별도로 설정하지 않음 = 현재 시간으로 자동 설정)  </span></span>
<span id="cb4-15">retriever.add_documents([Document(page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트 구독 해주실꺼죠? Please!"</span>)])  </span></code></pre></div></div>
</details>
</div>
<pre><code>['a6c732c4-adb2-45d1-bcbb-a5108a9778f7']  </code></pre>
</section>
<section id="검색-결과-확인" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="검색-결과-확인"><span class="header-section-number">3.4</span> 검색 결과 확인</h3>
<ul>
<li><code>decay_rate</code>가 거의 0에 가까우므로, 시간 페널티가 거의 없어 <strong>의미적으로 더 유사한 문서</strong>가 먼저 반환된다.
<ul>
<li>과거 문서가 최신 문서로 계산되는 효과가 있다</li>
</ul></li>
</ul>
<div id="dcd3caf1" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># "테디노트 구독해 주세요."가 먼저 반환됨  </span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 이유: 감쇠율이 0에 가까워 시간 페널티가 거의 없고,   </span></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#       의미적 유사도가 더 높기 때문  </span></span>
<span id="cb6-4">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트"</span>)  </span></code></pre></div></div>
</details>
</div>
<pre><code>[Document(metadata={'last_accessed_at': datetime.datetime(2024, 8, 30, 22, 1, 49, 841379), 'created_at': datetime.datetime(2024, 8, 30, 22, 1, 44, 410635), 'buffer_idx': 0}, page_content='테디노트 구독해 주세요.')]  </code></pre>
<p><strong>결과 분석</strong></p>
<ul>
<li>어제 작성된 문서가 반환되는 이유: <code>decay_rate ≈ 0</code>이므로 24시간이 지나도 점수 감소가 미미함<br>
</li>
<li>시간보다 콘텐츠의 관련성이 우선시됨</li>
</ul>
</section>
</section>
<section id="높은-감쇠율-최신성-우선" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="높은-감쇠율-최신성-우선"><span class="header-section-number">4</span> 높은 감쇠율 (최신성 우선)</h2>
<section id="개념-설명-1" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="개념-설명-1"><span class="header-section-number">4.1</span> 개념 설명</h3>
<p>높은 <code>decay_rate</code> (1에 가까운 값)는 시간이 지남에 따라 문서의 점수가 급격히 감소함을 의미한다. 즉, <strong>최신 문서가 검색 결과에 더 큰 영향</strong>을 미친다.</p>
<p><strong>특징</strong></p>
<ul>
<li><code>decay_rate = 1</code>: 모든 과거 문서의 시간 점수가 0 → 최신 문서만 반환<br>
</li>
<li><code>decay_rate ≈ 0.999</code>: 시간이 조금만 지나도 점수가 급격히 감소 → 최신성이 매우 중요</li>
</ul>
<p><strong>적용 시나리오</strong></p>
<ul>
<li>뉴스 기사 검색 (최신 뉴스 우선)<br>
</li>
<li>실시간 정보 (주식 시세, 날씨)<br>
</li>
<li>자주 업데이트되는 문서 (소프트웨어 릴리즈 노트)<br>
</li>
<li>시간에 민감한 정보 (이벤트 공지, 할인 정보)</li>
</ul>
</section>
<section id="retriever-초기화-1" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="retriever-초기화-1"><span class="header-section-number">4.2</span> Retriever 초기화</h3>
<p>벡터 저장소와 높은 감쇠율을 설정하여 retriever를 생성한다.</p>
<div id="4a487074" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임베딩 모델을 정의  </span></span>
<span id="cb8-2">embeddings_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-embedding-3-small"</span>)  </span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소를 빈 상태로 초기화  </span></span>
<span id="cb8-5">embedding_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1536</span>  </span>
<span id="cb8-6">index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> faiss.IndexFlatL2(embedding_size)  </span>
<span id="cb8-7">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS(embeddings_model, index, InMemoryDocstore({}), {})  </span>
<span id="cb8-8"></span>
<span id="cb8-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 시간 가중치가 적용된 벡터 저장소 검색기를 초기화 (높은 감쇠율 적용)  </span></span>
<span id="cb8-10">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TimeWeightedVectorStoreRetriever(  </span>
<span id="cb8-11">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore, decay_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.999</span>, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>  </span>
<span id="cb8-12">)  </span></code></pre></div></div>
</details>
</div>
</section>
<section id="샘플-데이터-추가-1" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="샘플-데이터-추가-1"><span class="header-section-number">4.3</span> 샘플 데이터 추가</h3>
<p>동일한 두 개의 문서를 추가한다. 첫 번째는 어제 작성, 두 번째는 방금 작성으로 설정한다.</p>
<div id="3f49d504" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 어제 날짜를 계산  </span></span>
<span id="cb9-2">yesterday <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.now() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> timedelta(days<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)  </span>
<span id="cb9-3"></span>
<span id="cb9-4">retriever.add_documents(  </span>
<span id="cb9-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서를 추가하고, metadata에 어제 날짜를 설정  </span></span>
<span id="cb9-6">    [  </span>
<span id="cb9-7">        Document(  </span>
<span id="cb9-8">            page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트 구독해 주세요."</span>,  </span>
<span id="cb9-9">            metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"last_accessed_at"</span>: yesterday},  </span>
<span id="cb9-10">        )  </span>
<span id="cb9-11">    ]  </span>
<span id="cb9-12">)  </span>
<span id="cb9-13"></span>
<span id="cb9-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 다른 문서를 추가 (metadata는 별도로 설정하지 않음)  </span></span>
<span id="cb9-15">retriever.add_documents([Document(page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트 구독 해주실꺼죠? Please!"</span>)])  </span></code></pre></div></div>
</details>
</div>
<pre><code>['c3349ba9-75c7-49ec-be7a-017bc0917fa2']  </code></pre>
</section>
<section id="검색-결과-확인-1" class="level3" data-number="4.4">
<h3 data-number="4.4" class="anchored" data-anchor-id="검색-결과-확인-1"><span class="header-section-number">4.4</span> 검색 결과 확인</h3>
<p><code>decay_rate</code>가 0.999로 높으므로, 24시간이 지난 문서는 시간 페널티를 크게 받아 <strong>최신 문서</strong>가 먼저 반환된다.</p>
<div id="fd970b72" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># "테디노트 구독 해주실꺼죠? Please!"가 먼저 반환됨  </span></span>
<span id="cb11-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 이유: 감쇠율이 0.999로 높아서 어제 작성된 문서는   </span></span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#       시간 페널티를 크게 받아 점수가 급격히 하락함  </span></span>
<span id="cb11-4">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트"</span>)  </span></code></pre></div></div>
</details>
</div>
<pre><code>[Document(metadata={'last_accessed_at': datetime.datetime(2024, 8, 30, 22, 3, 18, 331780), 'created_at': datetime.datetime(2024, 8, 30, 22, 2, 44, 618745), 'buffer_idx': 1}, page_content='테디노트 구독 해주실꺼죠? Please!')]  </code></pre>
<p><strong>결과 분석</strong></p>
<ul>
<li>방금 작성된 문서가 반환되는 이유: 높은 <code>decay_rate</code>로 인해 24시간 지난 문서의 시간 점수가 거의 0에 수렴<br>
</li>
<li>의미적 유사도가 낮더라도 최신성이 우선시됨<br>
</li>
<li>실제 계산: <img src="https://latex.codecogs.com/png.latex?(1.0%20-%200.999)%5E%7B24%7D%20%E2%89%88%200"> (24시간 경과 시 시간 점수가 거의 0)</li>
</ul>
</section>
</section>
<section id="decay_rate-설정-가이드" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="decay_rate-설정-가이드"><span class="header-section-number">5</span> decay_rate 설정 가이드</h2>
<section id="값에-따른-동작-비교" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="값에-따른-동작-비교"><span class="header-section-number">5.1</span> 값에 따른 동작 비교</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 21%">
<col style="width: 27%">
<col style="width: 18%">
<col style="width: 32%">
</colgroup>
<thead>
<tr class="header">
<th>decay_rate</th>
<th>시간 감쇠 속도</th>
<th>우선순위</th>
<th>적합한 사용 사례</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.0 ~ 0.1</td>
<td>매우 느림</td>
<td>의미적 유사도 우선</td>
<td>지식 베이스, 영구 문서, 역사적 자료</td>
</tr>
<tr class="even">
<td>0.1 ~ 0.5</td>
<td>느림</td>
<td>유사도와 최신성 균형</td>
<td>일반 문서 검색, FAQ</td>
</tr>
<tr class="odd">
<td>0.5 ~ 0.9</td>
<td>빠름</td>
<td>최신성 우선</td>
<td>업데이트되는 가이드, 제품 정보</td>
</tr>
<tr class="even">
<td>0.9 ~ 0.999</td>
<td>매우 빠름</td>
<td>최신성 강력 우선</td>
<td>뉴스, 실시간 정보</td>
</tr>
<tr class="odd">
<td>1.0</td>
<td>즉시 감쇠</td>
<td>최신 문서만</td>
<td>실시간 데이터 스트림</td>
</tr>
</tbody>
</table>
</section>
<section id="설정-원칙" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="설정-원칙"><span class="header-section-number">5.2</span> 설정 원칙</h3>
<p><strong>낮은 decay_rate (0 ~ 0.1)</strong></p>
<ul>
<li>정보를 거의 “잊지 않음”<br>
</li>
<li>시간이 지나도 점수 변화가 미미함<br>
</li>
<li>의미적 유사도가 검색의 주요 기준<br>
</li>
<li>예: 수학 공식, API 문서, 기술 사양</li>
</ul>
<p><strong>중간 decay_rate (0.1 ~ 0.5)</strong></p>
<ul>
<li>적절한 시간 감쇠 적용<br>
</li>
<li>최신성과 관련성의 균형<br>
</li>
<li>주기적으로 업데이트되지만 과거 정보도 유효한 경우<br>
</li>
<li>예: 블로그 포스트, 제품 리뷰, 사용자 가이드</li>
</ul>
<p><strong>높은 decay_rate (0.9 ~ 0.999)</strong></p>
<ul>
<li>과거 정보를 빠르게 “잊음”<br>
</li>
<li>최신 정보에 압도적으로 높은 점수<br>
</li>
<li>시간에 민감한 정보 검색<br>
</li>
<li>예: 뉴스 기사, 실시간 알림, 이벤트 공지</li>
</ul>
</section>
<section id="실무-권장값" class="level3" data-number="5.3">
<h3 data-number="5.3" class="anchored" data-anchor-id="실무-권장값"><span class="header-section-number">5.3</span> 실무 권장값</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 지식 베이스 (변하지 않는 정보)  </span></span>
<span id="cb13-2">decay_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>  </span>
<span id="cb13-3"></span>
<span id="cb13-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 일반 문서 검색 (균형)  </span></span>
<span id="cb13-5">decay_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>  </span>
<span id="cb13-6"></span>
<span id="cb13-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 뉴스/실시간 정보 (최신성 중시)  </span></span>
<span id="cb13-8">decay_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>  </span></code></pre></div></div>
</section>
</section>
<section id="고급-가상-시간을-이용한-테스트" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="고급-가상-시간을-이용한-테스트"><span class="header-section-number">6</span> 고급: 가상 시간을 이용한 테스트</h2>
<section id="개념-설명-2" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="개념-설명-2"><span class="header-section-number">6.1</span> 개념 설명</h3>
<p>LangChain의 <code>mock_now</code> 유틸리티를 사용하면 현재 시간을 임의로 설정하여 시간 감쇠 효과를 시뮬레이션할 수 있다. 이를 통해 실제로 시간이 경과하지 않아도 다양한 시간대에서의 검색 동작을 테스트할 수 있다.</p>
<p><strong>활용 목적</strong></p>
<ol type="1">
<li>최적의 <code>decay_rate</code> 값 탐색<br>
</li>
<li>시간 경과에 따른 검색 결과 변화 예측<br>
</li>
<li>프로덕션 배포 전 시간 기반 로직 검증<br>
</li>
<li>과거 시점의 검색 결과 재현</li>
</ol>
</section>
<section id="mock_now-사용법" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="mock_now-사용법"><span class="header-section-number">6.2</span> mock_now 사용법</h3>
<div id="33b56f07" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime  </span>
<span id="cb14-2"></span>
<span id="cb14-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.utils <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> mock_now  </span>
<span id="cb14-4"></span>
<span id="cb14-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 현재 시간을 특정 시점으로 설정  </span></span>
<span id="cb14-6">mock_now(datetime.datetime(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">00</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">00</span>))  </span>
<span id="cb14-7"></span>
<span id="cb14-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 현재 시간 출력  </span></span>
<span id="cb14-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(datetime.datetime.now())  </span></code></pre></div></div>
</details>
</div>
<pre><code>2024-08-30 22:05:01.844175  </code></pre>
</section>
<section id="시간-변경-테스트" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="시간-변경-테스트"><span class="header-section-number">6.3</span> 시간 변경 테스트</h3>
<p>다양한 시간대에서 검색 결과가 어떻게 달라지는지 확인하여 적절한 <code>decay_rate</code>를 찾을 수 있다.</p>
<div id="9a2e5515" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 과거 시점 (2024년 8월 29일)으로 설정하여 검색  </span></span>
<span id="cb16-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> mock_now(datetime.datetime(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">00</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">00</span>)):  </span>
<span id="cb16-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 해당 시점에서의 검색 결과 확인  </span></span>
<span id="cb16-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트"</span>))  </span></code></pre></div></div>
</details>
</div>
<p><strong>주의사항</strong></p>
<ul>
<li>너무 오래된 시간으로 설정하면 <code>decay_rate</code> 계산 시 오류가 발생할 수 있음 (지수 연산 오버플로우)<br>
</li>
<li>일반적으로 수년 이내의 시간 범위에서 테스트 권장</li>
</ul>
</section>
<section id="decay_rate-튜닝-예제" class="level3" data-number="6.4">
<h3 data-number="6.4" class="anchored" data-anchor-id="decay_rate-튜닝-예제"><span class="header-section-number">6.4</span> decay_rate 튜닝 예제</h3>
<p>다양한 시간 간격에서 검색 결과를 테스트하여 최적의 <code>decay_rate</code>를 찾는다.</p>
<div id="4e50d7ec" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 다양한 시간대 테스트  </span></span>
<span id="cb17-2">test_times <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [  </span>
<span id="cb17-3">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1시간 후"</span>, datetime.timedelta(hours<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  </span>
<span id="cb17-4">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1일 후"</span>, datetime.timedelta(days<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  </span>
<span id="cb17-5">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1주일 후"</span>, datetime.timedelta(weeks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  </span>
<span id="cb17-6">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1개월 후"</span>, datetime.timedelta(days<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)),  </span>
<span id="cb17-7">]  </span>
<span id="cb17-8"></span>
<span id="cb17-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> label, delta <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> test_times:  </span>
<span id="cb17-10">    future_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.datetime.now() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> delta  </span>
<span id="cb17-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> mock_now(future_time):  </span>
<span id="cb17-12">        result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트"</span>)  </span>
<span id="cb17-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>label<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)  </span></code></pre></div></div>
</details>
</div>
<pre><code>[Document(metadata={'last_accessed_at': MockDateTime(2024, 8, 29, 0, 0), 'created_at': datetime.datetime(2024, 8, 30, 22, 2, 44, 618745), 'buffer_idx': 1}, page_content='테디노트 구독 해주실꺼죠? Please!')]  </code></pre>
</section>
</section>
<section id="실전-활용-전략" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="실전-활용-전략"><span class="header-section-number">7</span> 실전 활용 전략</h2>
<section id="전략-1-하이브리드-검색-시스템" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="전략-1-하이브리드-검색-시스템"><span class="header-section-number">7.1</span> 전략 1: 하이브리드 검색 시스템</h3>
<p>서로 다른 <code>decay_rate</code>를 가진 여러 retriever를 조합하여 다양한 사용자 요구를 충족한다.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 최신성 우선 retriever  </span></span>
<span id="cb19-2">recent_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TimeWeightedVectorStoreRetriever(  </span>
<span id="cb19-3">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,  </span>
<span id="cb19-4">    decay_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 높은 감쇠율  </span></span>
<span id="cb19-5">    k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>  </span>
<span id="cb19-6">)  </span>
<span id="cb19-7"></span>
<span id="cb19-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 관련성 우선 retriever  </span></span>
<span id="cb19-9">relevant_retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TimeWeightedVectorStoreRetriever(  </span>
<span id="cb19-10">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,  </span>
<span id="cb19-11">    decay_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 낮은 감쇠율  </span></span>
<span id="cb19-12">    k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>  </span>
<span id="cb19-13">)  </span>
<span id="cb19-14"></span>
<span id="cb19-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 사용자 쿼리 의도에 따라 선택  </span></span>
<span id="cb19-16"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"최신"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> user_query <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"최근"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> user_query:  </span>
<span id="cb19-17">    results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> recent_retriever.invoke(user_query)  </span>
<span id="cb19-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:  </span>
<span id="cb19-19">    results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> relevant_retriever.invoke(user_query)  </span></code></pre></div></div>
<p><strong>적용 시나리오</strong>: 뉴스 플랫폼에서 “최신 뉴스”는 높은 decay_rate, “관련 뉴스”는 낮은 decay_rate 적용</p>
</section>
<section id="전략-2-동적-decay_rate-조정" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="전략-2-동적-decay_rate-조정"><span class="header-section-number">7.2</span> 전략 2: 동적 decay_rate 조정</h3>
<p>문서 유형이나 카테고리에 따라 자동으로 <code>decay_rate</code>를 조정한다.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 카테고리별 decay_rate 매핑  </span></span>
<span id="cb20-2">category_decay_rates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {  </span>
<span id="cb20-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"news"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>,        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 뉴스는 최신성 중요  </span></span>
<span id="cb20-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tutorial"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 튜토리얼은 시간 무관  </span></span>
<span id="cb20-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"api_doc"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 문서는 영구적  </span></span>
<span id="cb20-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blog"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>,         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 블로그는 중간  </span></span>
<span id="cb20-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"regulation"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 규정은 업데이트 빈번  </span></span>
<span id="cb20-8">}  </span>
<span id="cb20-9"></span>
<span id="cb20-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_retriever_for_category(category):  </span>
<span id="cb20-11">    decay_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> category_decay_rates.get(category, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)  </span>
<span id="cb20-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> TimeWeightedVectorStoreRetriever(  </span>
<span id="cb20-13">        vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,  </span>
<span id="cb20-14">        decay_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decay_rate,  </span>
<span id="cb20-15">        k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>  </span>
<span id="cb20-16">    )  </span></code></pre></div></div>
<p><strong>적용 시나리오</strong>: 통합 문서 관리 시스템에서 문서 카테고리를 자동 감지하여 최적의 검색 설정 적용</p>
</section>
<section id="전략-3-주기적-접근-시간-업데이트" class="level3" data-number="7.3">
<h3 data-number="7.3" class="anchored" data-anchor-id="전략-3-주기적-접근-시간-업데이트"><span class="header-section-number">7.3</span> 전략 3: 주기적 접근 시간 업데이트</h3>
<p>중요한 문서의 <code>last_accessed_at</code>를 주기적으로 업데이트하여 항상 상위에 유지한다.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime  </span>
<span id="cb21-2"></span>
<span id="cb21-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 중요 문서의 접근 시간 갱신  </span></span>
<span id="cb21-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> refresh_important_docs(important_doc_ids):  </span>
<span id="cb21-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc_id <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> important_doc_ids:  </span>
<span id="cb21-6">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서의 메타데이터 업데이트  </span></span>
<span id="cb21-7">        vectorstore.update_metadata(  </span>
<span id="cb21-8">            doc_id,  </span>
<span id="cb21-9">            {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"last_accessed_at"</span>: datetime.datetime.now()}  </span>
<span id="cb21-10">        )  </span>
<span id="cb21-11"></span>
<span id="cb21-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 주기적으로 실행 (예: 매일 자정)  </span></span>
<span id="cb21-13">refresh_important_docs([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"faq_main"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"policy_core"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"guide_essential"</span>])  </span></code></pre></div></div>
<p><strong>적용 시나리오</strong>: FAQ 시스템에서 핵심 질문들을 항상 상위에 노출</p>
</section>
<section id="전략-4-시간대별-가중치-조정" class="level3" data-number="7.4">
<h3 data-number="7.4" class="anchored" data-anchor-id="전략-4-시간대별-가중치-조정"><span class="header-section-number">7.4</span> 전략 4: 시간대별 가중치 조정</h3>
<p>업무 시간대와 비업무 시간대에 다른 검색 전략 적용</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime  </span>
<span id="cb22-2"></span>
<span id="cb22-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_time_aware_retriever():  </span>
<span id="cb22-4">    current_hour <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.datetime.now().hour  </span>
<span id="cb22-5">    </span>
<span id="cb22-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 업무 시간 (9-18시): 최신 문서 우선  </span></span>
<span id="cb22-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> current_hour <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>:  </span>
<span id="cb22-8">        decay_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>  </span>
<span id="cb22-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 비업무 시간: 관련성 우선  </span></span>
<span id="cb22-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:  </span>
<span id="cb22-11">        decay_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>  </span>
<span id="cb22-12">    </span>
<span id="cb22-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> TimeWeightedVectorStoreRetriever(  </span>
<span id="cb22-14">        vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,  </span>
<span id="cb22-15">        decay_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decay_rate,  </span>
<span id="cb22-16">        k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>  </span>
<span id="cb22-17">    )  </span></code></pre></div></div>
<p><strong>적용 시나리오</strong>: 고객 지원 챗봇에서 업무 시간에는 최신 공지사항 우선 제공</p>
</section>
<section id="전략-5-ab-테스팅을-통한-최적화" class="level3" data-number="7.5">
<h3 data-number="7.5" class="anchored" data-anchor-id="전략-5-ab-테스팅을-통한-최적화"><span class="header-section-number">7.5</span> 전략 5: A/B 테스팅을 통한 최적화</h3>
<p>다양한 <code>decay_rate</code> 값으로 A/B 테스팅을 수행하여 사용자 만족도가 높은 값을 찾는다.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random  </span>
<span id="cb23-2"></span>
<span id="cb23-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># A/B 테스트 그룹 설정  </span></span>
<span id="cb23-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_ab_test_retriever(user_id):  </span>
<span id="cb23-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 사용자 ID 기반 그룹 할당  </span></span>
<span id="cb23-6">    group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">hash</span>(user_id) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>  </span>
<span id="cb23-7">    </span>
<span id="cb23-8">    decay_rates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {  </span>
<span id="cb23-9">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 그룹 A: 낮은 감쇠  </span></span>
<span id="cb23-10">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 그룹 B: 중간 감쇠  </span></span>
<span id="cb23-11">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 그룹 C: 높은 감쇠  </span></span>
<span id="cb23-12">    }  </span>
<span id="cb23-13">    </span>
<span id="cb23-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> TimeWeightedVectorStoreRetriever(  </span>
<span id="cb23-15">        vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,  </span>
<span id="cb23-16">        decay_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decay_rates[group],  </span>
<span id="cb23-17">        k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>  </span>
<span id="cb23-18">    )  </span>
<span id="cb23-19"></span>
<span id="cb23-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 사용자 피드백 수집 후 최적값 선택  </span></span></code></pre></div></div>
<p><strong>적용 시나리오</strong>: 검색 서비스에서 클릭률(CTR)이 가장 높은 <code>decay_rate</code> 값 발견</p>
</section>
<section id="전략-6-계절성주기성-고려" class="level3" data-number="7.6">
<h3 data-number="7.6" class="anchored" data-anchor-id="전략-6-계절성주기성-고려"><span class="header-section-number">7.6</span> 전략 6: 계절성/주기성 고려</h3>
<p>특정 시즌이나 주기에 따라 검색 전략을 조정한다.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime  </span>
<span id="cb24-2"></span>
<span id="cb24-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_seasonal_retriever():  </span>
<span id="cb24-4">    current_month <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.datetime.now().month  </span>
<span id="cb24-5">    </span>
<span id="cb24-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 연말(11-12월): 연간 리포트 등 최신 정보 중요  </span></span>
<span id="cb24-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> current_month <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>]:  </span>
<span id="cb24-8">        decay_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.85</span>  </span>
<span id="cb24-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 연초(1-2월): 과거 데이터 참조 중요  </span></span>
<span id="cb24-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> current_month <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]:  </span>
<span id="cb24-11">        decay_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>  </span>
<span id="cb24-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 일반 기간  </span></span>
<span id="cb24-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:  </span>
<span id="cb24-14">        decay_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>  </span>
<span id="cb24-15">    </span>
<span id="cb24-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> TimeWeightedVectorStoreRetriever(  </span>
<span id="cb24-17">        vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,  </span>
<span id="cb24-18">        decay_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>decay_rate,  </span>
<span id="cb24-19">        k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>  </span>
<span id="cb24-20">    )  </span></code></pre></div></div>
<p><strong>적용 시나리오</strong>: 재무 문서 검색 시스템에서 분기별/연도별 보고서 우선순위 자동 조정</p>
</section>
</section>
<section id="요약" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="요약"><span class="header-section-number">8</span> 요약</h2>
<p><code>TimeWeightedVectorStoreRetriever</code>는 의미적 유사도와 시간 기반 신선도를 결합하여 상황에 맞는 최적의 검색 결과를 제공한다. <code>decay_rate</code> 값을 조정하여 최신성과 관련성의 균형을 세밀하게 제어할 수 있으며, 뉴스, 규정집, 기술 문서 등 다양한 도메인에서 활용 가능하다. 실전에서는 문서 특성, 사용자 의도, 시간대 등을 고려한 동적 전략을 수립하여 검색 품질을 극대화할 수 있다.</p>
<div id="659403bb" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> mock_now(datetime.datetime(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">00</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">00</span>)):  </span>
<span id="cb25-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 해당 시점에서의 검색 결과 확인  </span></span>
<span id="cb25-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트"</span>))  </span></code></pre></div></div>
</details>
</div>
<p><strong>주의사항</strong></p>
<ul>
<li>너무 오래된 시간으로 설정하면 <code>decay_rate</code> 계산 시 오류가 발생할 수 있음 (지수 연산 오버플로우)<br>
</li>
<li>일반적으로 수년 이내의 시간 범위에서 테스트 권장</li>
</ul>
<section id="decay_rate-튜닝-예제-1" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="decay_rate-튜닝-예제-1"><span class="header-section-number">8.1</span> decay_rate 튜닝 예제</h3>
<p>다양한 시간 간격에서 검색 결과를 테스트하여 최적의 <code>decay_rate</code>를 찾는다.</p>
<div id="01bab2c0" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 다양한 시간대 테스트  </span></span>
<span id="cb26-2">test_times <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [  </span>
<span id="cb26-3">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1시간 후"</span>, datetime.timedelta(hours<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  </span>
<span id="cb26-4">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1일 후"</span>, datetime.timedelta(days<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  </span>
<span id="cb26-5">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1주일 후"</span>, datetime.timedelta(weeks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  </span>
<span id="cb26-6">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1개월 후"</span>, datetime.timedelta(days<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)),  </span>
<span id="cb26-7">]  </span>
<span id="cb26-8"></span>
<span id="cb26-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> label, delta <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> test_times:  </span>
<span id="cb26-10">    future_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.datetime.now() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> delta  </span>
<span id="cb26-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> mock_now(future_time):  </span>
<span id="cb26-12">        result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"테디노트"</span>)  </span>
<span id="cb26-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>label<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)  </span></code></pre></div></div>
</details>
</div>


</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>RAG</category>
  <category>LangChain</category>
  <category>Agent</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/09-TimeWeightedVectorStoreRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>셀프 쿼리 검색기(Self-Query Retriever)</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/08-SelfQueryRetriever.html</link>
  <description><![CDATA[ 






<section id="selfqueryretriever-개요" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="selfqueryretriever-개요"><span class="header-section-number">1</span> SelfQueryRetriever 개요</h2>
<section id="핵심-개념" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="핵심-개념"><span class="header-section-number">1.1</span> 핵심 개념</h3>
<p><code>SelfQueryRetriever</code>는 자연어 질의를 구조화된 쿼리로 자동 변환하여 검색을 수행하는 지능형 검색 도구이다. 일반적인 벡터 검색과 달리, 메타데이터 필터링과 의미적 검색을 동시에 활용한다.</p>
</section>
<section id="작동-원리" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="작동-원리"><span class="header-section-number">1.2</span> 작동 원리</h3>
<ol type="1">
<li>질의 분석: 사용자의 자연어 질의를 LLM이 분석<br>
</li>
<li>쿼리 구조화: LLM이 Query-constructing LLM chain을 사용해 구조화된 질의 생성<br>
</li>
<li>필터 추출: 질의에서 메타데이터 필터 조건 추출<br>
</li>
<li>검색 수행: 구조화된 질의를 벡터 저장소(VectorStore)에 적용하여 검색</li>
</ol>
</section>
<section id="장단점" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="장단점"><span class="header-section-number">1.3</span> 장단점</h3>
<section id="장점" class="level4" data-number="1.3.1">
<h4 data-number="1.3.1" class="anchored" data-anchor-id="장점"><span class="header-section-number">1.3.1</span> 장점</h4>
<ul>
<li>정확도 향상: 메타데이터 필터링으로 검색 결과의 정밀도 증가<br>
</li>
<li>복합 조건 처리: 여러 메타데이터 조건을 조합한 검색 가능<br>
</li>
<li>자연어 인터페이스: 사용자가 복잡한 쿼리 문법을 몰라도 자연어로 질의 가능<br>
</li>
<li>테이블 데이터 활용: 구조화된 테이블 형식 데이터 처리에 효과적</li>
</ul>
</section>
<section id="단점" class="level4" data-number="1.3.2">
<h4 data-number="1.3.2" class="anchored" data-anchor-id="단점"><span class="header-section-number">1.3.2</span> 단점</h4>
<ul>
<li>메타데이터 의존성: 모든 문서에 적절한 메타데이터가 필요<br>
</li>
<li>초기 설정 비용: <code>AttributeInfo</code> 정의 등 초기 구성 작업 필요<br>
</li>
<li>LLM 호출 오버헤드: 질의마다 LLM을 통한 쿼리 변환 과정 필요</li>
</ul>
</section>
</section>
<section id="적용-사례" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="적용-사례"><span class="header-section-number">1.4</span> 적용 사례</h3>
<p>대기업이나 데이터가 성숙도가 높은 기업에서는 거의 모든 데이터가 정형이기 때문에 SQL쿼리 또는 DBMS 하에 관리가 될 가능성이 높다.<br>
이런 table형식으로 관리되는 데이터에 이 SelfQueryRetriever는 유용하게 활용될 수 있다.</p>
<ul>
<li>전자상거래 제품 검색 (가격, 카테고리, 평점 등 필터링)<br>
</li>
<li>문서 관리 시스템 (작성일, 저자, 문서 유형 등 조건 검색)<br>
</li>
<li>콘텐츠 추천 시스템 (장르, 연도, 평점 기반 추천)</li>
</ul>
<p><strong>참고 자료</strong></p>
<ul>
<li><a href="https://python.langchain.com/docs/integrations/retrievers/self_query">LangChain 공식 Self-Query Retriever 문서</a></li>
</ul>
</section>
</section>
<section id="환경-설정" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="환경-설정"><span class="header-section-number">2</span> 환경 설정</h2>
<section id="api-키-로드" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="api-키-로드"><span class="header-section-number">2.1</span> API 키 로드</h3>
<div id="8b5fa75c" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일  </span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv  </span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드  </span></span>
<span id="cb1-5">load_dotenv()  </span></code></pre></div></div>
</details>
</div>
</section>
<section id="langsmith-추적-설정" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="langsmith-추적-설정"><span class="header-section-number">2.2</span> LangSmith 추적 설정</h3>
<p>LangSmith를 활용하면 LLM 호출 과정과 쿼리 변환 과정을 시각적으로 추적할 수 있다.</p>
<div id="30ef66c6" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정 (https://smith.langchain.com)  </span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain-teddynote  </span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging  </span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력  </span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH10-Retriever"</span>)  </span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="샘플-데이터-생성" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="샘플-데이터-생성"><span class="header-section-number">3</span> 샘플 데이터 생성</h2>
<p>화장품 상품의 설명과 메타데이터를 기반으로 유사도 검색이 가능한 벡터 저장소를 구축한다. 각 문서는 제품 설명(<code>page_content</code>)과 구조화된 메타데이터(연도, 카테고리, 평점)를 포함한다.</p>
<p><strong>메타데이터 스키마</strong></p>
<ul>
<li><code>year</code> (정수): 제품 출시 연도<br>
</li>
<li><code>category</code> (문자열): 제품 카테고리 (스킨케어, 메이크업, 클렌징, 선케어)<br>
</li>
<li><code>user_rating</code> (실수): 사용자 평점 (1.0 ~ 5.0)</li>
</ul>
<div id="98284d50" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_chroma <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Chroma  </span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.documents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Document  </span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings  </span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 화장품 상품의 설명과 메타데이터 생성  </span></span>
<span id="cb3-6">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [  </span>
<span id="cb3-7">    Document(  </span>
<span id="cb3-8">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"수분 가득한 히알루론산 세럼으로 피부 속 깊은 곳까지 수분을 공급합니다."</span>,  </span>
<span id="cb3-9">        metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"스킨케어"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_rating"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.7</span>},  </span>
<span id="cb3-10">    ),  </span>
<span id="cb3-11">    Document(  </span>
<span id="cb3-12">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"24시간 지속되는 매트한 피니시의 파운데이션, 모공을 커버하고 자연스러운 피부 표현이 가능합니다."</span>,  </span>
<span id="cb3-13">        metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2023</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"메이크업"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_rating"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>},  </span>
<span id="cb3-14">    ),  </span>
<span id="cb3-15">    Document(  </span>
<span id="cb3-16">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"식물성 성분으로 만든 저자극 클렌징 오일, 메이크업과 노폐물을 부드럽게 제거합니다."</span>,  </span>
<span id="cb3-17">        metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2023</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"클렌징"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_rating"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.8</span>},  </span>
<span id="cb3-18">    ),  </span>
<span id="cb3-19">    Document(  </span>
<span id="cb3-20">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"비타민 C 함유 브라이트닝 크림, 칙칙한 피부톤을 환하게 밝혀줍니다."</span>,  </span>
<span id="cb3-21">        metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2023</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"스킨케어"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_rating"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.6</span>},  </span>
<span id="cb3-22">    ),  </span>
<span id="cb3-23">    Document(  </span>
<span id="cb3-24">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"롱래스팅 립스틱, 선명한 발색과 촉촉한 사용감으로 하루종일 편안하게 사용 가능합니다."</span>,  </span>
<span id="cb3-25">        metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"메이크업"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_rating"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.4</span>},  </span>
<span id="cb3-26">    ),  </span>
<span id="cb3-27">    Document(  </span>
<span id="cb3-28">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"자외선 차단 기능이 있는 톤업 선크림, SPF50+/PA++++ 높은 자외선 차단 지수로 피부를 보호합니다."</span>,  </span>
<span id="cb3-29">        metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"선케어"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_rating"</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.9</span>},  </span>
<span id="cb3-30">    ),  </span>
<span id="cb3-31">]  </span>
<span id="cb3-32"></span>
<span id="cb3-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소 생성  </span></span>
<span id="cb3-34">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Chroma.from_documents(  </span>
<span id="cb3-35">    docs,   </span>
<span id="cb3-36">    OpenAIEmbeddings(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-embedding-3-small"</span>)  </span>
<span id="cb3-37">)  </span></code></pre></div></div>
</details>
</div>
<section id="메타데이터-필드-정의" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="메타데이터-필드-정의"><span class="header-section-number">3.1</span> 메타데이터 필드 정의</h3>
<p><code>AttributeInfo</code> 클래스를 사용하여 화장품 메타데이터 필드에 대한 정보를 정의한다. 범주형 데이터는 모든 sample space를 적어줘야하고 필요시 업데이트를 주기적으로 해줘야한다.</p>
<ul>
<li>카테고리(<code>category</code>): 문자열 타입, 화장품의 카테고리를 나타내며 [‘스킨케어’, ‘메이크업’, ‘클렌징’, ‘선케어’] 중 하나의 값을 가진다.<br>
</li>
<li>연도(<code>year</code>): 정수 타입, 화장품이 출시된 연도를 나타낸다.<br>
</li>
<li>사용자 평점(<code>user_rating</code>): 실수 타입, 1-5 범위의 사용자 평점을 나타낸다.</li>
</ul>
<p>사실, 이 부분이 SelfQueryRetriever를 좀 더 규모있게 쓰기위해선 굉장히 번거롭고 데이터 모델링 들어가야하는 부분이라 사실 난이도가 높다. 데이터 모델링이 되기 위해선 주기적으로 서비스가 제공이되는 기획이 구체적으로 만들어져야하고 이를 바탕으로 데이터 모델링이 수행되어야 하기 때문에 상당한 자원이 투입되어야한다.</p>
<p><strong><code>AttributeInfo</code> 구성 요소</strong></p>
<p><code>AttributeInfo</code> 클래스를 사용하여 각 메타데이터 필드의 타입, 설명, 가능한 값을 정의한다. 이 정보는 LLM이 자연어 질의를 구조화된 쿼리로 변환할 때 참조하므로 명확하고 구체적으로 작성해야 한다.</p>
<ul>
<li><code>name</code>: 메타데이터 필드 이름<br>
</li>
<li><code>description</code>: 필드에 대한 상세 설명 (LLM이 참조하므로 명확하게 작성)<br>
</li>
<li><code>type</code>: 데이터 타입 (<code>string</code>, <code>integer</code>, <code>float</code> 등)</li>
</ul>
<div id="24cd5c5b" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.chains.query_constructor.base <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AttributeInfo  </span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 메타데이터 필드 정보 생성  </span></span>
<span id="cb4-4">metadata_field_info <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [  </span>
<span id="cb4-5">    AttributeInfo(  </span>
<span id="cb4-6">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>,  </span>
<span id="cb4-7">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The category of the cosmetic product. One of ['스킨케어', '메이크업', '클렌징', '선케어']"</span>,  </span>
<span id="cb4-8">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span>,  </span>
<span id="cb4-9">    ),  </span>
<span id="cb4-10">    AttributeInfo(  </span>
<span id="cb4-11">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>,  </span>
<span id="cb4-12">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The year the cosmetic product was released"</span>,  </span>
<span id="cb4-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"integer"</span>,  </span>
<span id="cb4-14">    ),  </span>
<span id="cb4-15">    AttributeInfo(  </span>
<span id="cb4-16">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_rating"</span>,  </span>
<span id="cb4-17">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A user rating for the cosmetic product, ranging from 1 to 5"</span>,  </span>
<span id="cb4-18">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"float"</span>,  </span>
<span id="cb4-19">    ),  </span>
<span id="cb4-20">]  </span></code></pre></div></div>
</details>
</div>
</section>
<section id="selfqueryretriever-생성" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="selfqueryretriever-생성"><span class="header-section-number">3.2</span> SelfQueryRetriever 생성</h3>
<p><code>SelfQueryRetriever.from_llm()</code> 메서드를 사용하여 retriever 객체를 생성한다.</p>
<p><strong>주요 매개변수</strong></p>
<ul>
<li><code>llm</code>: 질의를 분석하고 구조화된 쿼리로 변환할 언어 모델<br>
</li>
<li><code>vectorstore</code>: 문서가 저장된 벡터 저장소<br>
</li>
<li><code>document_contents</code>: 문서 내용에 대한 간략한 설명 (LLM이 쿼리 생성 시 참조)<br>
</li>
<li><code>metadata_field_info</code>: 앞서 정의한 메타데이터 필드 정보</li>
</ul>
<div id="b18a3abe" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.self_query.base <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SelfQueryRetriever  </span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI  </span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLM 정의  </span></span>
<span id="cb5-5">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)  </span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># SelfQueryRetriever 생성  </span></span>
<span id="cb5-8">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SelfQueryRetriever.from_llm(  </span>
<span id="cb5-9">    llm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm,  </span>
<span id="cb5-10">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,  </span>
<span id="cb5-11">    document_contents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Brief summary of a cosmetic product"</span>,  </span>
<span id="cb5-12">    metadata_field_info<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>metadata_field_info,  </span>
<span id="cb5-13">)  </span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="query-test" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="query-test"><span class="header-section-number">4</span> Query Test</h2>
<section id="단일-필터-검색" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="단일-필터-검색"><span class="header-section-number">4.1</span> 단일 필터 검색</h3>
<p>자연어 질의에서 메타데이터 조건을 자동으로 추출하여 필터링한다.</p>
<section id="평점-기반-검색" class="level4" data-number="4.1.1">
<h4 data-number="4.1.1" class="anchored" data-anchor-id="평점-기반-검색"><span class="header-section-number">4.1.1</span> 평점 기반 검색</h4>
<div id="2605bdc4" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 평점 4.8 이상 제품 검색  </span></span>
<span id="cb6-2">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"평점이 4.8 이상인 제품을 추천해주세요"</span>)  </span></code></pre></div></div>
</details>
</div>
<pre><code>[Document(metadata={'category': '선케어', 'user_rating': 4.9, 'year': 2024}, page_content='자외선 차단 기능이 있는 톤업 선크림, SPF50+/PA++++ 높은 자외선 차단 지수로 피부를 보호합니다.'), Document(metadata={'category': '클렌징', 'user_rating': 4.8, 'year': 2023}, page_content='식물성 성분으로 만든 저자극 클렌징 오일, 메이크업과 노폐물을 부드럽게 제거합니다.')]  </code></pre>
</section>
<section id="연도-기반-검색" class="level4" data-number="4.1.2">
<h4 data-number="4.1.2" class="anchored" data-anchor-id="연도-기반-검색"><span class="header-section-number">4.1.2</span> 연도 기반 검색</h4>
<div id="0968926b" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2023년 출시 제품 검색  </span></span>
<span id="cb8-2">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023년에 출시된 상품을 추천해주세요"</span>)  </span></code></pre></div></div>
</details>
</div>
<pre><code>[Document(metadata={'category': '메이크업', 'user_rating': 4.5, 'year': 2023}, page_content='24시간 지속되는 매트한 피니시의 파운데이션, 모공을 커버하고 자연스러운 피부 표현이 가능합니다.'), Document(metadata={'category': '스킨케어', 'user_rating': 4.6, 'year': 2023}, page_content='비타민 C 함유 브라이트닝 크림, 칙칙한 피부톤을 환하게 밝혀줍니다.'), Document(metadata={'category': '클렌징', 'user_rating': 4.8, 'year': 2023}, page_content='식물성 성분으로 만든 저자극 클렌징 오일, 메이크업과 노폐물을 부드럽게 제거합니다.')]  </code></pre>
</section>
<section id="카테고리-기반-검색" class="level4" data-number="4.1.3">
<h4 data-number="4.1.3" class="anchored" data-anchor-id="카테고리-기반-검색"><span class="header-section-number">4.1.3</span> 카테고리 기반 검색</h4>
<div id="de0c80ff" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 선케어 카테고리 제품 검색  </span></span>
<span id="cb10-2">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"카테고리가 선케어인 상품을 추천해주세요"</span>)  </span></code></pre></div></div>
</details>
</div>
<pre><code>[Document(metadata={'category': '선케어', 'user_rating': 4.9, 'year': 2024}, page_content='자외선 차단 기능이 있는 톤업 선크림, SPF50+/PA++++ 높은 자외선 차단 지수로 피부를 보호합니다.')]  </code></pre>
</section>
</section>
<section id="복합-필터-검색" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="복합-필터-검색"><span class="header-section-number">4.2</span> 복합 필터 검색</h3>
<p>여러 메타데이터 조건을 조합하여 정밀한 검색을 수행한다.</p>
<div id="046c890c" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 카테고리와 평점 조건을 동시에 적용  </span></span>
<span id="cb12-2">retriever.invoke(  </span>
<span id="cb12-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"카테고리가 메이크업인 상품 중에서 평점이 4.5 이상인 상품을 추천해주세요"</span>  </span>
<span id="cb12-4">)  </span></code></pre></div></div>
</details>
</div>
<pre><code>[Document(metadata={'category': '메이크업', 'user_rating': 4.5, 'year': 2023}, page_content='24시간 지속되는 매트한 피니시의 파운데이션, 모공을 커버하고 자연스러운 피부 표현이 가능합니다.')]  </code></pre>
</section>
</section>
<section id="검색-결과-제한-limit" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="검색-결과-제한-limit"><span class="header-section-number">5</span> 검색 결과 제한 (Limit)</h2>
<section id="코드-기반-제한-설정" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="코드-기반-제한-설정"><span class="header-section-number">5.1</span> 코드 기반 제한 설정</h3>
<p><code>enable_limit=True</code>와 <code>search_kwargs</code>를 사용하여 반환할 문서 개수를 제한한다.</p>
<div id="7602a8c9" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SelfQueryRetriever.from_llm(  </span>
<span id="cb14-2">    llm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm,  </span>
<span id="cb14-3">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,  </span>
<span id="cb14-4">    document_contents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Brief summary of a cosmetic product"</span>,  </span>
<span id="cb14-5">    metadata_field_info<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>metadata_field_info,  </span>
<span id="cb14-6">    enable_limit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과 제한 기능 활성화  </span></span>
<span id="cb14-7">    search_kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"k"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>},  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 최대 2개의 문서만 반환  </span></span>
<span id="cb14-8">)  </span></code></pre></div></div>
</details>
</div>
<p>2023년도 출시된 상품은 3개가 있지만 <code>k=2</code> 설정으로 인해 2개만 반환된다.</p>
<div id="4c568095" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과 2개로 제한  </span></span>
<span id="cb15-2">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023년에 출시된 상품을 추천해주세요"</span>)  </span></code></pre></div></div>
</details>
</div>
<pre><code>[Document(metadata={'category': '메이크업', 'user_rating': 4.5, 'year': 2023}, page_content='24시간 지속되는 매트한 피니시의 파운데이션, 모공을 커버하고 자연스러운 피부 표현이 가능합니다.'), Document(metadata={'category': '스킨케어', 'user_rating': 4.6, 'year': 2023}, page_content='비타민 C 함유 브라이트닝 크림, 칙칙한 피부톤을 환하게 밝혀줍니다.')]  </code></pre>
</section>
<section id="자연어-기반-제한-설정" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="자연어-기반-제한-설정"><span class="header-section-number">5.2</span> 자연어 기반 제한 설정</h3>
<p><code>search_kwargs</code>를 명시하지 않고 질의문에 개수를 포함하여 동적으로 제한할 수 있다.</p>
<div id="b4c9d3f9" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SelfQueryRetriever.from_llm(  </span>
<span id="cb17-2">    llm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm,  </span>
<span id="cb17-3">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,  </span>
<span id="cb17-4">    document_contents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Brief summary of a cosmetic product"</span>,  </span>
<span id="cb17-5">    metadata_field_info<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>metadata_field_info,  </span>
<span id="cb17-6">    enable_limit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 검색 결과 제한 기능 활성화  </span></span>
<span id="cb17-7">)  </span>
<span id="cb17-8"></span>
<span id="cb17-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질의문에 "1개" 명시  </span></span>
<span id="cb17-10">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023년에 출시된 상품 1개를 추천해주세요"</span>)  </span></code></pre></div></div>
</details>
</div>
<pre><code>[Document(metadata={'category': '메이크업', 'user_rating': 4.5, 'year': 2023}, page_content='24시간 지속되는 매트한 피니시의 파운데이션, 모공을 커버하고 자연스러운 피부 표현이 가능합니다.')]  </code></pre>
<div id="89992265" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질의문에 "2개" 명시  </span></span>
<span id="cb19-2">retriever.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023년에 출시된 상품 2개를 추천해주세요"</span>)  </span></code></pre></div></div>
</details>
</div>
<pre><code>[Document(metadata={'category': '메이크업', 'user_rating': 4.5, 'year': 2023}, page_content='24시간 지속되는 매트한 피니시의 파운데이션, 모공을 커버하고 자연스러운 피부 표현이 가능합니다.'), Document(metadata={'category': '스킨케어', 'user_rating': 4.6, 'year': 2023}, page_content='비타민 C 함유 브라이트닝 크림, 칙칙한 피부톤을 환하게 밝혀줍니다.')]  </code></pre>
</section>
</section>
<section id="고급-query-constructor-chain-커스터마이징" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="고급-query-constructor-chain-커스터마이징"><span class="header-section-number">6</span> 고급: Query Constructor Chain 커스터마이징</h2>
<ul>
<li><p>조건문 쿼리들을 만들어주는 chain을 생성하는 방법<br>
</p></li>
<li><p>여기에 메타데이터 (스키마)를 기준으로 lancgChain안에 이 조건문 쿼리를 만들어주는 프롬프트가 들어가 있음<br>
</p></li>
<li><p>핵심은 자연어를 구조화된 쿼리로 변환하는 <strong>Query Constructor Chain</strong>을 생성하는 것이다.<br>
</p></li>
<li><p>내부에서 어떤 일이 일어나는지 확인하고 더 많은 사용자 정의 제어를 하기 위해, 우리는 retriever를 처음부터 재구성할 수 있다.</p></li>
<li><p><a href="https://github.com/langchain-ai/langchain/blob/master/cookbook/self_query_hotel_search.ipynb">참고 튜토리얼</a></p></li>
</ul>
<section id="query-constructor-생성" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="query-constructor-생성"><span class="header-section-number">6.1</span> Query Constructor 생성</h3>
<p><code>get_query_constructor_prompt</code> 함수를 사용하여 LLM이 구조화된 쿼리를 생성하도록 하는 프롬프트를 가져온다.</p>
<div id="3485fe86" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.chains.query_constructor.base <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> (  </span>
<span id="cb21-2">    StructuredQueryOutputParser,  </span>
<span id="cb21-3">    get_query_constructor_prompt,  </span>
<span id="cb21-4">)  </span>
<span id="cb21-5"></span>
<span id="cb21-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 내용 설명과 메타데이터 필드 정보를 사용하여 쿼리 생성 프롬프트 가져오기  </span></span>
<span id="cb21-7">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_query_constructor_prompt(  </span>
<span id="cb21-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Brief summary of a cosmetic product"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 내용 설명  </span></span>
<span id="cb21-9">    metadata_field_info,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 메타데이터 필드 정보  </span></span>
<span id="cb21-10">)  </span>
<span id="cb21-11"></span>
<span id="cb21-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 구조화된 쿼리 출력을 파싱하는 Parser 생성  </span></span>
<span id="cb21-13">output_parser <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StructuredQueryOutputParser.from_components()  </span>
<span id="cb21-14"></span>
<span id="cb21-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Query Constructor Chain 구성: 프롬프트 → LLM → 파싱  </span></span>
<span id="cb21-16">query_constructor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> output_parser  </span></code></pre></div></div>
</details>
</div>
<p><code>prompt.format()</code> 메서드를 사용하여 <code>query</code> 매개변수에 “dummy question” 문자열을 전달하고, 그 결과를 출력하여 Prompt 내용을 확인해 보겠습니다.<br>
langChain에서 이 프롬프트를 스키마 형태로 작성해주는 것을 제공한다.</p>
<div id="907cab51" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트 템플릿 출력  </span></span>
<span id="cb22-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(prompt.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(query<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dummy question"</span>))  </span></code></pre></div></div>
</details>
</div>
</section>
<section id="쿼리-변환-테스트" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="쿼리-변환-테스트"><span class="header-section-number">6.2</span> 쿼리 변환 테스트</h3>
<p>자연어 질의가 어떻게 구조화된 쿼리로 변환되는지 확인한다.</p>
<div id="b3057348" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1">query_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> query_constructor.invoke(  </span>
<span id="cb23-2">    {  </span>
<span id="cb23-3">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"query"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023년도에 출시한 상품 중 평점이 4.5 이상인 상품중에서 스킨케어 제품을 추천해주세요"</span>  </span>
<span id="cb23-4">    }  </span>
<span id="cb23-5">)  </span></code></pre></div></div>
</details>
</div>
<p>생성된 구조화된 쿼리의 필터 조건을 확인한다.</p>
<div id="4f9ecf25" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 추출된 필터 조건 출력  </span></span>
<span id="cb24-2">query_output.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>.arguments  </span></code></pre></div></div>
</details>
</div>
<p>[Comparison(comparator=, attribute=‘year’, value=2023), Comparison(comparator=, attribute=‘user_rating’, value=4.5), Comparison(comparator=, attribute=‘category’, value=‘스킨케어’)]</p>
<p><strong>Query Constructor 최적화 팁</strong></p>
<p>Self-query retriever의 핵심은 query constructor의 품질이다. 효과적인 검색 시스템을 만들기 위해 다음을 조정해야 한다:</p>
<ol type="1">
<li><strong>프롬프트 튜닝</strong>: <code>get_query_constructor_prompt</code>의 문서 설명을 명확하게 작성<br>
</li>
<li><strong>Few-shot 예시 추가</strong>: 프롬프트에 질의-쿼리 변환 예시 추가<br>
</li>
<li><strong>AttributeInfo 정교화</strong>: 각 메타데이터 필드의 설명을 LLM이 이해하기 쉽게 작성<br>
</li>
<li><strong>LLM 모델 선택</strong>: 쿼리 변환 품질에 따라 더 강력한 모델 사용 고려</li>
</ol>
</section>
<section id="structured-query-translator-사용" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="structured-query-translator-사용"><span class="header-section-number">6.3</span> Structured Query Translator 사용</h3>
<p>구조화된 쿼리를 특정 벡터 저장소의 문법에 맞게 변환하는 translator를 사용한다. 각 벡터 저장소(Chroma, Pinecone, Weaviate 등)는 고유한 필터 문법을 가지므로 적절한 translator가 필요하다.</p>
<div id="30ccce91" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.retrievers.self_query.chroma <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChromaTranslator  </span>
<span id="cb25-2"></span>
<span id="cb25-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 커스텀 Query Constructor와 Translator를 사용한 Retriever 생성  </span></span>
<span id="cb25-4">retriever <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SelfQueryRetriever(  </span>
<span id="cb25-5">    query_constructor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>query_constructor,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 앞서 생성한 커스텀 query constructor  </span></span>
<span id="cb25-6">    vectorstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>vectorstore,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 벡터 저장소  </span></span>
<span id="cb25-7">    structured_query_translator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ChromaTranslator(),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Chroma 전용 쿼리 변환기  </span></span>
<span id="cb25-8">)  </span></code></pre></div></div>
</details>
</div>
<p><strong>주요 Translator 종류</strong></p>
<ul>
<li><code>ChromaTranslator</code>: Chroma 벡터 저장소용<br>
</li>
<li><code>PineconeTranslator</code>: Pinecone 벡터 저장소용<br>
</li>
<li><code>WeaviateTranslator</code>: Weaviate 벡터 저장소용<br>
</li>
<li><code>QdrantTranslator</code>: Qdrant 벡터 저장소용</li>
</ul>
</section>
<section id="커스텀-retriever-테스트" class="level3" data-number="6.4">
<h3 data-number="6.4" class="anchored" data-anchor-id="커스텀-retriever-테스트"><span class="header-section-number">6.4</span> 커스텀 Retriever 테스트</h3>
<p>복합 조건 검색을 수행하여 커스텀 retriever의 동작을 확인한다.</p>
<div id="206fc479" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1">retriever.invoke(  </span>
<span id="cb26-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023년도에 출시한 상품 중 평점이 4.5 이상인 상품중에서 스킨케어 제품을 추천해주세요"</span>  </span>
<span id="cb26-3">)  </span></code></pre></div></div>
</details>
</div>
<pre><code>[Document(metadata={'category': '스킨케어', 'user_rating': 4.6, 'year': 2023}, page_content='비타민 C 함유 브라이트닝 크림, 칙칙한 피부톤을 환하게 밝혀줍니다.')]  </code></pre>
</section>
</section>
<section id="실전-활용-가이드" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="실전-활용-가이드"><span class="header-section-number">7</span> 실전 활용 가이드</h2>
<section id="메타데이터-설계-원칙" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="메타데이터-설계-원칙"><span class="header-section-number">7.1</span> 메타데이터 설계 원칙</h3>
<ol type="1">
<li><strong>필터링 가능성</strong>: 사용자가 자주 질의하는 속성을 메타데이터로 설계<br>
</li>
<li><strong>타입 일관성</strong>: 같은 필드는 모든 문서에서 동일한 타입 유지<br>
</li>
<li><strong>값의 정규화</strong>: 카테고리 등은 미리 정의된 값 사용 (오타 방지)<br>
</li>
<li><strong>적절한 세분화</strong>: 너무 세밀하거나 너무 포괄적이지 않게 조정</li>
</ol>
</section>
<section id="성능-최적화" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="성능-최적화"><span class="header-section-number">7.2</span> 성능 최적화</h3>
<ol type="1">
<li><strong>LLM 모델 선택</strong>: 쿼리 변환 품질에 따라 gpt-4o-mini vs gpt-4o 선택<br>
</li>
<li><strong>캐싱 활용</strong>: 동일한 질의 패턴에 대해 결과 캐싱<br>
</li>
<li><strong>메타데이터 인덱싱</strong>: 벡터 저장소에서 메타데이터 필드 인덱싱 설정<br>
</li>
<li><strong>Batch 처리</strong>: 여러 질의를 한 번에 처리하여 LLM 호출 최소화</li>
</ol>
</section>
<section id="일반적인-문제와-해결책" class="level3" data-number="7.3">
<h3 data-number="7.3" class="anchored" data-anchor-id="일반적인-문제와-해결책"><span class="header-section-number">7.3</span> 일반적인 문제와 해결책</h3>
<section id="문제-1-llm이-메타데이터-필터를-잘못-추출" class="level4" data-number="7.3.1">
<h4 data-number="7.3.1" class="anchored" data-anchor-id="문제-1-llm이-메타데이터-필터를-잘못-추출"><span class="header-section-number">7.3.1</span> 문제 1: LLM이 메타데이터 필터를 잘못 추출</h4>
<ul>
<li>해결: <code>AttributeInfo</code>의 <code>description</code>을 더 명확하게 작성<br>
</li>
<li>해결: Few-shot 예시를 프롬프트에 추가</li>
</ul>
</section>
<section id="문제-2-특정-벡터-저장소에서-필터가-작동하지-않음" class="level4" data-number="7.3.2">
<h4 data-number="7.3.2" class="anchored" data-anchor-id="문제-2-특정-벡터-저장소에서-필터가-작동하지-않음"><span class="header-section-number">7.3.2</span> 문제 2: 특정 벡터 저장소에서 필터가 작동하지 않음</h4>
<ul>
<li>해결: 해당 벡터 저장소에 맞는 Translator 사용 확인<br>
</li>
<li>해결: 벡터 저장소가 해당 필터 연산자를 지원하는지 확인</li>
</ul>
</section>
<section id="문제-3-검색-결과가-너무-적거나-많음" class="level4" data-number="7.3.3">
<h4 data-number="7.3.3" class="anchored" data-anchor-id="문제-3-검색-결과가-너무-적거나-많음"><span class="header-section-number">7.3.3</span> 문제 3: 검색 결과가 너무 적거나 많음</h4>
<ul>
<li>해결: <code>enable_limit=True</code>와 함께 적절한 <code>k</code> 값 설정<br>
</li>
<li>해결: 필터 조건을 완화하거나 강화</li>
</ul>
</section>
<section id="문제-4-메타데이터-입력에-너무-많은-자원-소모" class="level4" data-number="7.3.4">
<h4 data-number="7.3.4" class="anchored" data-anchor-id="문제-4-메타데이터-입력에-너무-많은-자원-소모"><span class="header-section-number">7.3.4</span> 문제 4: 메타데이터 입력에 너무 많은 자원 소모</h4>
<ul>
<li>문서에서 가정하는 것처럼 “메타데이터가 이미 구조화되어 있다”는 시나리오는 실제로는 매우 제한적.<br>
</li>
<li>다음의 경우가 실제로 마주칠 경우들인데 이 self query를 사용하기 위해 아래의 시스템을 구축해야함 (배보다 배꼽이 더큼)
<ol type="1">
<li><strong>신규 문서 수집</strong>: 웹 크롤링, 자동 데이터 수집, 사용자 업로드 등<br>
</li>
<li><strong>기존 비정형 데이터</strong>: 과거에 구조화되지 않은 텍스트 문서들<br>
</li>
<li><strong>지속적인 유지보수</strong>: 메타데이터 스키마가 변경되면 기존 데이터도 갱신해야 함</li>
</ol></li>
<li>전략 1: 메타데이터를 사람이 작성하지 말고 LLM이 자동으로 추출 (가장 실용적)
<ul>
<li>장점
<ul>
<li>자동화됨 (사람의 개입 최소화)<br>
</li>
<li>스케일에 관계없이 일관성 유지<br>
</li>
<li>배치 처리로 비용 최적화 가능<br>
</li>
</ul></li>
<li>단점
<ul>
<li>LLM의 추출 오류 가능성 (정확도 90~95% 정도)<br>
</li>
<li>LLM 호출 비용 발생<br>
</li>
<li>중요도 높은 도메인에서는 품질 관리 필요</li>
</ul></li>
</ul></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 문서 수집 파이프라인  </span></span>
<span id="cb28-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> process_document_with_metadata(raw_doc: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, schema: AttributeInfo) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Document:  </span>
<span id="cb28-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""문서 입수 시점에 메타데이터를 자동 추출"""</span>  </span>
<span id="cb28-4">    </span>
<span id="cb28-5">    extraction_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PromptTemplate.from_template(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""  </span></span>
<span id="cb28-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    다음 문서에서 메타데이터를 추출하세요.  </span></span>
<span id="cb28-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb28-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    메타데이터 스키마:  </span></span>
<span id="cb28-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    - category: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{categories}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb28-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    - year: 정수형 (문서가 언급하는 연도)  </span></span>
<span id="cb28-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    - user_rating: 1.0~5.0 범위의 숫자 (평가가 없으면 null)  </span></span>
<span id="cb28-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb28-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    문서:  </span></span>
<span id="cb28-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{doc_content}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb28-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb28-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    JSON 형식으로 반환:  </span></span>
<span id="cb28-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{{</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category": "...", "year": ..., "user_rating": ...</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb28-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span>)  </span>
<span id="cb28-19">    </span>
<span id="cb28-20">    extractor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> extraction_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> JsonOutputParser()  </span>
<span id="cb28-21">    metadata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> extractor.ainvoke({  </span>
<span id="cb28-22">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_content"</span>: raw_doc,  </span>
<span id="cb28-23">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"categories"</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"스킨케어"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"메이크업"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"클렌징"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"선케어"</span>]  </span>
<span id="cb28-24">    })  </span>
<span id="cb28-25">    </span>
<span id="cb28-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> Document(  </span>
<span id="cb28-27">        page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>raw_doc,  </span>
<span id="cb28-28">        metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>metadata  </span>
<span id="cb28-29">    )  </span></code></pre></div></div>
<ul>
<li>전략 2: Hybrid 접근으로 자동 추출 + 사람의 검증을 조합 (가장 현실적)
<ul>
<li>비율 예시 (실제 기업에서 적용):
<ul>
<li>자동 추출으로 신뢰도 &gt;= 0.85: 100% 자동 반영 (80~85%)<br>
</li>
<li>신뢰도 0.7~0.85: 샘플링해서 사람이 검증 (10~15%)<br>
</li>
<li>신뢰도 &lt; 0.7: 수동 처리 (5~10%)</li>
</ul></li>
</ul></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 데이터 파이프라인 단계별 처리  </span></span>
<span id="cb29-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> MetadataProcessingPipeline:  </span>
<span id="cb29-3">    </span>
<span id="cb29-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> ingest_batch(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, documents: List[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]):  </span>
<span id="cb29-5">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""배치 입수"""</span>  </span>
<span id="cb29-6">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 단계 1: LLM 자동 추출  </span></span>
<span id="cb29-7">        with_auto_metadata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [  </span>
<span id="cb29-8">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.extract_metadata_llm(doc)   </span>
<span id="cb29-9">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> documents  </span>
<span id="cb29-10">        ]  </span>
<span id="cb29-11">        </span>
<span id="cb29-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 단계 2: 신뢰도 점수 계산 (LLM에게 추출 신뢰도 함께 요청)  </span></span>
<span id="cb29-13">        with_confidence <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [  </span>
<span id="cb29-14">            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.add_confidence_score(doc_meta)  </span>
<span id="cb29-15">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc_meta <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> with_auto_metadata  </span>
<span id="cb29-16">        ]  </span>
<span id="cb29-17">        </span>
<span id="cb29-18">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 단계 3: 신뢰도 낮은 것만 큐에 추가 (사람 검증용)  </span></span>
<span id="cb29-19">        requires_review <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [  </span>
<span id="cb29-20">            item <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> item <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> with_confidence   </span>
<span id="cb29-21">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> item[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'confidence'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>  </span>
<span id="cb29-22">        ]  </span>
<span id="cb29-23">        </span>
<span id="cb29-24">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 단계 4: 사람 검증 (선택적)  </span></span>
<span id="cb29-25">        reviewed_items <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.human_review_queue(requires_review)  </span>
<span id="cb29-26">        </span>
<span id="cb29-27">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 단계 5: DB에 저장  </span></span>
<span id="cb29-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.save_to_vectorstore(with_confidence <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> reviewed_items)  </span></code></pre></div></div>
<ul>
<li>전략 3: <strong>도메인 특화 Rule + LLM</strong> (데이터 거버넌스 맞음)
<ul>
<li>이미 데이터 표준화 프레임워크(word dictionary, domain dictionary, code dictionary)가 있다면<br>
</li>
<li>이 표준화된 용어들을 LLM에 제공하면 정확도 크게 향상<br>
</li>
<li>데이터 거버넌스 원칙이 메타데이터 추출에도 자동으로 반영됨<br>
</li>
<li>하지만, 그래도 데이터 모델링이라는 큰 허들이 있긴 함</li>
</ul></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> StructuredMetadataExtractor:  </span>
<span id="cb30-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""이미 데이터 거버넌스 시스템이 있다면 활용"""</span>  </span>
<span id="cb30-3">    </span>
<span id="cb30-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, data_catalog: DataCatalog):  </span>
<span id="cb30-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.catalog <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data_catalog  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 기존 메타데이터 저장소  </span></span>
<span id="cb30-6">    </span>
<span id="cb30-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> extract_metadata(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,   </span>
<span id="cb30-8">                               doc: Document,   </span>
<span id="cb30-9">                               doc_source: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:  </span>
<span id="cb30-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""  </span></span>
<span id="cb30-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        1. 소스 시스템에서 구조화된 메타데이터 먼저 조회  </span></span>
<span id="cb30-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        2. 없으면 LLM이 추출  </span></span>
<span id="cb30-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        3. 데이터 카탈로그에 등록된 사전(dictionary) 활용  </span></span>
<span id="cb30-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span>  </span>
<span id="cb30-15">        </span>
<span id="cb30-16">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 단계 1: 카탈로그에서 기존 메타데이터 확인  </span></span>
<span id="cb30-17">        known_metadata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.catalog.lookup(doc_source)  </span>
<span id="cb30-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> known_metadata:  </span>
<span id="cb30-19">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> known_metadata  </span>
<span id="cb30-20">        </span>
<span id="cb30-21">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 단계 2: 표준화된 코드/용어 사전을 LLM에 제공  </span></span>
<span id="cb30-22">        dictionaries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {  </span>
<span id="cb30-23">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category_dict"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.catalog.get_category_dictionary(),  </span>
<span id="cb30-24">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year_range"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.catalog.get_year_range(),  </span>
<span id="cb30-25">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"valid_ratings"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.catalog.get_rating_scale()  </span>
<span id="cb30-26">        }  </span>
<span id="cb30-27">        </span>
<span id="cb30-28">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 단계 3: LLM이 이 사전을 기준으로 추출  </span></span>
<span id="cb30-29">        extracted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.llm_extract_with_standards(  </span>
<span id="cb30-30">            doc.page_content,  </span>
<span id="cb30-31">            dictionaries  </span>
<span id="cb30-32">        )  </span>
<span id="cb30-33">        </span>
<span id="cb30-34">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 단계 4: 표준 메타데이터로 정규화  </span></span>
<span id="cb30-35">        normalized <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.catalog.normalize_metadata(extracted)  </span>
<span id="cb30-36">        </span>
<span id="cb30-37">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 단계 5: 다시 카탈로그에 등록 (다음 번에 재사용)  </span></span>
<span id="cb30-38">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.catalog.register(doc_source, normalized)  </span>
<span id="cb30-39">        </span>
<span id="cb30-40">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> normalized  </span></code></pre></div></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 플랫폼에 적용하는 방식: 100-200명 사용자 배포 시나리오  </span></span>
<span id="cb31-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> EnterpriseMetadataRetriever:  </span>
<span id="cb31-3">    </span>
<span id="cb31-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,   </span>
<span id="cb31-5">                 standardization_framework,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 기존 4-tier dictionary  </span></span>
<span id="cb31-6">                 vectorstore,  </span>
<span id="cb31-7">                 llm_model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>):  </span>
<span id="cb31-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.standards <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> standardization_framework  </span>
<span id="cb31-9">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vectorstore  </span>
<span id="cb31-10">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm_model  </span>
<span id="cb31-11">    </span>
<span id="cb31-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> ingest_dataset(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, dataset: DataFrame):  </span>
<span id="cb31-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""데이터셋 입수 시 메타데이터 자동 생성"""</span>  </span>
<span id="cb31-14">        </span>
<span id="cb31-15">        documents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []  </span>
<span id="cb31-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dataset.iterrows():  </span>
<span id="cb31-17">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 기존 데이터 거버넌스 시스템의 메타데이터 활용  </span></span>
<span id="cb31-18">            metadata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {  </span>
<span id="cb31-19">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"domain"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.standards.infer_domain(row),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Domain dict 활용  </span></span>
<span id="cb31-20">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data_type"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.standards.infer_type(row),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Term dict 활용  </span></span>
<span id="cb31-21">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quality_score"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.standards.assess_quality(row),  </span>
<span id="cb31-22">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"standardization_status"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._check_standard(row),  </span>
<span id="cb31-23">            }  </span>
<span id="cb31-24">            </span>
<span id="cb31-25">            documents.append(Document(  </span>
<span id="cb31-26">                page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'description'</span>],  </span>
<span id="cb31-27">                metadata<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>metadata  </span>
<span id="cb31-28">            ))  </span>
<span id="cb31-29">        </span>
<span id="cb31-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.vectorstore.add_documents(documents)  </span>
<span id="cb31-31">    </span>
<span id="cb31-32">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> _check_standard(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, row):  </span>
<span id="cb31-33">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""표준화 여부 판단 (기존 시스템 활용)"""</span>  </span>
<span id="cb31-34">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.standards.is_standardized(row)  </span></code></pre></div></div>
<ul>
<li>각 전략의 비용-정확도 트레이드오프</li>
</ul>
<table class="caption-top table">
<colgroup>
<col style="width: 12%">
<col style="width: 18%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th>전략</th>
<th>자동화율</th>
<th>정확도</th>
<th>유지비</th>
<th>스케일</th>
<th>추천 상황</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>전략 1 (LLM 자동)</td>
<td>100%</td>
<td>90~95%</td>
<td>낮음</td>
<td>매우 높음</td>
<td>비정형 데이터 대량, 품질 요구 낮음</td>
</tr>
<tr class="even">
<td>전략 2 (Hybrid)</td>
<td>85~90%</td>
<td>95~98%</td>
<td>중간</td>
<td>높음</td>
<td>균형잡힌 운영</td>
</tr>
<tr class="odd">
<td>전략 3 (거버넌스 연계)</td>
<td>90~95%</td>
<td>98~99%</td>
<td>중간</td>
<td>중간-높음</td>
<td>거버넌스 상황</td>
</tr>
</tbody>
</table>
</section>
</section>
</section>
<section id="참고-자료" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="참고-자료"><span class="header-section-number">8</span> 참고 자료</h2>
<ul>
<li><a href="https://python.langchain.com/docs/integrations/retrievers/self_query">LangChain 공식 Self-Query Retriever 통합 목록</a><br>
</li>
<li><a href="https://github.com/langchain-ai/langchain/blob/master/cookbook/self_query_hotel_search.ipynb">LangChain Self-Query Hotel Search 튜토리얼</a><br>
</li>
<li><a href="https://python.langchain.com/docs/how_to/query_constructing_filters/">Query Constructor 커스터마이징 가이드</a></li>
</ul>
</section>
<section id="요약" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="요약"><span class="header-section-number">9</span> 요약</h2>
<p><code>SelfQueryRetriever</code>는 메타데이터 기반 필터링과 의미적 검색을 결합한 강력한 도구이다. 초기 메타데이터 설계와 <code>AttributeInfo</code> 정의에 투자하면, 사용자가 자연어로 복잡한 조건 검색을 수행할 수 있는 시스템을 구축할 수 있다. 특히 전자상거래, 문서 관리, 콘텐츠 추천 등 구조화된 메타데이터를 가진 도메인에서 높은 검색 정확도를 제공한다.</p>


</section>

 ]]></description>
  <category>AI</category>
  <category>RAG</category>
  <category>LangChain</category>
  <category>Agent</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/10-Retriever/08-SelfQueryRetriever.html</guid>
  <pubDate>Thu, 04 Dec 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Azure Cloud</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/</link>
  <description><![CDATA[ 






<section id="azure-cloud" class="level2" data-number="1">

<section id="클라우드-인프라-설정" class="level3" data-number="1.1">

<ol type="1">
<li><a href="../../../../docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/01-Data_Lake_Storage.html">01-Data Lake Storage</a></li>
</ol>


</section>
</section>

 ]]></description>
  <category>Azure Cloud</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/</guid>
  <pubDate>Fri, 31 Oct 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>RAG</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/</link>
  <description><![CDATA[ 






<section id="rag" class="level2" data-number="1">

<section id="retriever" class="level3" data-number="1.1">

<ol type="1">
<li><a href="../../../../docs/blog/posts/RAG/10-Retriever/01-VectorStoreRetriever.html">01-VectorStoreRetriever</a></li>
<li><a href="../../../../docs/blog/posts/RAG/10-Retriever/02-ContextualCompressionRetriever.html">02-ContextualCompressionRetriever</a></li>
<li><a href="../../../../docs/blog/posts/RAG/10-Retriever/03-EnsembleRetriever.html">03-EnsembleRetriever</a></li>
<li><a href="../../../../docs/blog/posts/RAG/10-Retriever/04-LongContextReorder.html">04-LongContextReorder.qmd</a></li>
<li><a href="../../../../docs/blog/posts/RAG/10-Retriever/05-ParentDocumentRetriever.html">05-ParentDocumentRetriever</a></li>
<li><a href="../../../../docs/blog/posts/RAG/10-Retriever/06-MultiQueryRetriever.html">06-MultiQueryRetriever</a></li>
<li><a href="../../../../docs/blog/posts/RAG/10-Retriever/07-MultiVectorRetriever.html">07-MultiVectorRetriever</a></li>
<li><a href="../../../../docs/blog/posts/RAG/10-Retriever/08-SelfQueryRetriever.html">08-SelfQueryRetriever</a></li>
<li><a href="../../../../docs/blog/posts/RAG/10-Retriever/09-TimeWeightedVectorStoreRetriever.html">09-TimeWeightedVectorStoreRetriever</a></li>
</ol>
</section>
<section id="agent" class="level3" data-number="1.2">

<ol type="1">
<li><a href="../../../../docs/blog/posts/RAG/15-Agent/01-Tools.html">01-Tools</a></li>
<li><a href="../../../../docs/blog/posts/RAG/15-Agent/02-Bind-Tools.html">02-Bind-Tools</a></li>
<li><a href="../../../../docs/blog/posts/RAG/15-Agent/03-Agent.html">03-Agent</a></li>
<li><a href="../../../../docs/blog/posts/RAG/15-Agent/04-Agent-More-LLMs.html">04-Agent-More-LLMs</a></li>
<li><a href="../../../../docs/blog/posts/RAG/15-Agent/05-Iter-Human-In-the-Loop.html">05-Iter-Human-In-the-Loop</a></li>
</ol>


</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>LangChain</category>
  <category>RAG</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/</guid>
  <pubDate>Fri, 31 Oct 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Prompt_Engineering</title>
  <dc:creator>Junhyun Lee</dc:creator>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/Prompt_Engineering/</link>
  <description><![CDATA[ 






<section id="prompt_engineering" class="level2" data-number="1">

<section id="prompt-structure" class="level3" data-number="1.1">

<ol type="1">
<li><a href="../../../../docs/blog/posts/Prompt_Engineering/01-Prompt-Structure/01-Prompt-Structure.html">01-프롬프트 구조(1)</a></li>
<li><a href="../../../../docs/blog/posts/Prompt_Engineering/01-Prompt-Structure/02-Prompt-Structure.html">02-프롬프트 구조(2)</a></li>
</ol>
</section>
<section id="프롬프트의-이해" class="level3" data-number="1.2">

<ol type="1">
<li><a href="../../../../docs/blog/posts/Prompt_Engineering/02-프롬프트의_이해/01-프롬프트분석.html">01-프롬프트 분석의 필요성과 가치</a></li>
<li><a href="../../../../docs/blog/posts/Prompt_Engineering/02-프롬프트의_이해/02-사용자언어읽기.html">02-사용자 언어 읽기(프롬프트 구조와 유형)</a></li>
<li><a href="../../../../docs/blog/posts/Prompt_Engineering/02-프롬프트의_이해/03-대화분석.html">03-대화 분석(사용자-AI 상호작용 매커니즘)</a></li>
</ol>
</section>
<section id="프롬프트-기획-전략" class="level3" data-number="1.3">

<ol type="1">
<li><a href="../../../../docs/blog/posts/Prompt_Engineering/03-프롬프트_기획_전략/01-세그먼트별_프롬프트_기획.html">01-세그먼트별 프롬프트 기획</a></li>
<li><a href="../../../../docs/blog/posts/Prompt_Engineering/03-프롬프트_기획_전략/02-프롬프트_기획_사례.html">02-프롬프트 기획 사례</a></li>
</ol>
</section>
<section id="프롬프트-제작의-기초" class="level3" data-number="1.4">

<ol type="1">
<li><a href="../../../../docs/blog/posts/Prompt_Engineering/04-프롬프트_제작의_기초/01-프롬프트_제작의_기초.html">01-프롬프트 제작의 기초</a></li>
</ol>


</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>Prompt_Engineering</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/Prompt_Engineering/</guid>
  <pubDate>Fri, 31 Oct 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>01-Data Lake Storage</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/01-Data_Lake_Storage.html</link>
  <description><![CDATA[ 






<section id="스토리지-계정-생성" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> 스토리지 계정 생성</h1>
<p>Azure Portal에서 Storage Account를 생성합니다.</p>
<section id="기본-설정" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="기본-설정"><span class="header-section-number">1.1</span> 기본 설정</h2>
<section id="프로젝트-세부-정보" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="프로젝트-세부-정보"><span class="header-section-number">1.1.1</span> 프로젝트 세부 정보</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/images/01-Data_Lake_Storage/1.png" class="img-fluid figure-img"></p>
<figcaption>image</figcaption>
</figure>
</div>
<p><strong>구독(Subscription)</strong> - 설명: 사용할 Azure 구독을 선택합니다. - 입력 값: <code>swlab-test-subs</code></p>
<p><strong>리소스 그룹(Resource Group)</strong> - 설명: 스토리지 계정을 포함할 리소스 그룹을 선택하거나 새로 만듭니다. - 입력 값: <code>rg-aipoc-test-krc-001</code></p>
</section>
<section id="인스턴스-세부-정보" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="인스턴스-세부-정보"><span class="header-section-number">1.1.2</span> 인스턴스 세부 정보</h3>
<p><strong>스토리지 계정 이름</strong> - 설명: 전역적으로 고유한 스토리지 계정 이름을 입력합니다 (3-24자, 소문자와 숫자만 사용 가능). - 입력 값: <code>saaipoctestkrc001</code></p>
<p><strong>지역(Region)</strong> - 설명: 스토리지 계정이 생성될 Azure 데이터 센터 위치를 선택합니다. - 입력 값: <code>(Asia Pacific) Korea Central</code></p>
<p><strong>기본 스토리지 유형</strong> - 설명: 사용할 스토리지 서비스 유형을 선택합니다. - 입력 값: <code>Azure Blob Storage 또는 Azure Data Lake Storage Gen 2</code> - 참고: 관련 지침을 제공하는 데 도움이 됩니다. 스토리지를 이 리스크 유형으로 제한하지 않습니다.</p>
<p><strong>기본 워크로드</strong> - 설명: 빅 데이터 분석을 위해 데이터 레이크를 호스트하는 데 가장 적합한 워크로드와 가장 일치하는 항목을 선택하여 모범 사례를 기반으로 구축된 권장 구성을 가져옵니다. 안제든지 이 구성을 변경할 수 있습니다. - 입력 값: <code>빅 데이터 분석</code> - 참고: 📊 빅 데이터 분석을 위해 데이터 레이크를 호스트하는 데 가장 적합</p>
<p><strong>성능(Performance)</strong> - 설명: 스토리지 계정의 성능 계층을 선택합니다. - <strong>표준</strong>: 대부분 시나리오에 권장됨 (범용 v2 계정) - <strong>프리미엄</strong>: 짧은 대기 시간이 필요한 경우에 권장됨 - 선택 값: <code>표준: 대부분 시나리오에 권장됨(범용 v2 계정)</code> - 참고: 📊 표준 성능 워크로드에는 빅 데이터 분석(를) 사용하는 것이 좋습니다.</p>
<p><strong>중복도(Redundancy)</strong> - 설명: 데이터 내구성을 위한 복제 전략을 선택합니다. - <strong>LRS</strong>: 로컬 중복 스토리지 - <strong>ZRS</strong>: 영역 중복 스토리지 - <strong>GRS</strong>: 지역 중복 스토리지 - <strong>RA-GRS</strong>: 읽기 액세스 지역 중복 스토리지 - 선택 값: <code>LRS(로컬 중복 스토리지)</code> - 참고: 📊 ZRS 워크로드에는 빅 데이터 분석(를) 사용하는 것이 좋습니다.</p>
</section>
</section>
<section id="고급-설정" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="고급-설정"><span class="header-section-number">1.2</span> 고급 설정</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/images/01-Data_Lake_Storage/2.png" class="img-fluid figure-img"></p>
<figcaption>image</figcaption>
</figure>
</div>
<section id="보안" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="보안"><span class="header-section-number">1.2.1</span> 보안</h3>
<p><strong>REST API 작업을 위한 보안 전송 필요</strong> - 설명: HTTPS를 통한 보안 연결만 허용합니다. - 선택 값: ☑ 체크됨</p>
<p><strong>개별 컨테이너에 대한 익명 액세스 허용</strong> - 설명: 익명 Blob 액세스를 컨테이너 수준에서 허용할지 여부를 설정합니다. - 선택 값: ☐ 체크 안 됨</p>
<p><strong>스토리지 계정 키 액세스 사용</strong> - 설명: 공유 키를 통한 스토리지 계정 액세스를 허용합니다. - 선택 값: ☑ 체크됨</p>
<p><strong>Azure Portal에서 Microsoft Entra 인증 기본값 사용</strong> - 설명: Azure Portal 액세스 시 Microsoft Entra ID를 기본 인증 방법으로 사용합니다. - 선택 값: ☐ 체크 안 됨</p>
<p><strong>최소 TLS 버전</strong> - 설명: 클라이언트에서 요청하는 최소 TLS(전송 계층 보안) 버전을 설정합니다. - 선택 값: <code>버전 1.2</code></p>
<p><strong>복사 작업에 대해 허용된 범위(미리 보기)</strong> - 설명: 데이터 복사 작업의 허용 범위를 지정합니다. - 선택 값: <code>모든 스토리지 계정에서</code></p>
</section>
<section id="계층-구조-네임스페이스" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="계층-구조-네임스페이스"><span class="header-section-number">1.2.2</span> 계층 구조 네임스페이스</h3>
<p>Data Lake Storage Gen2 엔드포인트로 보안되는 계층 구조 네임스페이스는 파일 및 디렉터리 의미 체계를 사용하고, 빅 데이터 분석 워크로드를 가속화하고, ACL(액세스 제어 목록)을 사용합니다.</p>
<p><strong>계층 구조 네임스페이스 사용</strong> - 설명: Data Lake Storage Gen2 엔드포인트를 보안되는 계층 구조 네임스페이스입니다. 파일 및 디렉터리 의미 체계를 사용하고, ACL(액세스 제어 목록)을 사용합니다. - 선택 값: ☑ 체크됨 - 참고: 📊 계층 구조 네임스페이스 워크로드에는 빅 데이터 분석(를) 사용하는 것이 좋습니다.</p>
</section>
<section id="액세스-프로토콜" class="level3" data-number="1.2.3">
<h3 data-number="1.2.3" class="anchored" data-anchor-id="액세스-프로토콜"><span class="header-section-number">1.2.3</span> 액세스 프로토콜</h3>
<p>BLOB 및 Data Lake Gen2 엔드포인트는 기본적으로 프로토비전됨</p>
<p><strong>SFTP 사용</strong> - 설명: SFTP 프로토콜을 통한 파일 전송을 활성화합니다. - 선택 값: ☑ 체크됨 - 참고: ℹ️ 로컬 사용자 기능은 SFTP로 활성화됩니다. 스토리지 계정을 만든 후 SFTP 끝점에 액세스할 로컬 사용자 ID를 만듭니다.</p>
<p><strong>네트워크 파일 시스템 v3 사용</strong> - 설명: NFS v3 프로토콜을 사용하여 파일 시스템을 마운트합니다. - 선택 값: ☑ 체크됨</p>
</section>
<section id="blob-storage" class="level3" data-number="1.2.4">
<h3 data-number="1.2.4" class="anchored" data-anchor-id="blob-storage"><span class="header-section-number">1.2.4</span> Blob Storage</h3>
<p><strong>테넌트 간 복제 허용</strong> - 설명: 다른 Azure AD 테넌트 간 Blob 복제를 허용합니다. - 선택 값: ☐ 체크 안 됨 - 참고: ℹ️ 테넌트 간 복제 및 계층 구조 네임스페이스를 동시에 사용하도록 설정할 수 없습니다.</p>
<p><strong>액세스 계층</strong> - 설명: 데이터 액세스 빈도에 따른 기본 저장소 계층을 선택합니다. - <strong>핫</strong>: 자주 액세스하는 데이터 및 일상적인 사용 시나리오에 최적화됨 - <strong>쿨</strong>: 자주 액세스하지 않는 데이터 및 백업 시나리오에 최적화됨 - <strong>콜드</strong>: 거의 액세스하지 않는 데이터 및 백업 시나리오에 최적화됨 - 선택 값: <code>핫</code> - 참고: 📊 핫 Blob 액세스 계층 워크로드에는 빅 데이터 분석(를) 사용하는 것이 좋습니다.</p>
</section>
<section id="azure-files" class="level3" data-number="1.2.5">
<h3 data-number="1.2.5" class="anchored" data-anchor-id="azure-files"><span class="header-section-number">1.2.5</span> Azure Files</h3>
<p><strong>큰 파일 공유 사용</strong> - 설명: 최대 100TiB 용량의 대용량 파일 공유를 지원합니다. - 선택 값: ☑ 체크됨 (비활성화됨)</p>
</section>
</section>
<section id="네트워킹-설정" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="네트워킹-설정"><span class="header-section-number">1.3</span> 네트워킹 설정</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/images/01-Data_Lake_Storage/3.png" class="img-fluid figure-img"></p>
<figcaption>image</figcaption>
</figure>
</div>
<section id="공용-액세스" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="공용-액세스"><span class="header-section-number">1.3.1</span> 공용 액세스</h3>
<p>공용 네트워크를 통해 어디서나 리소스에 액세스합니다.</p>
<p>참고: 공용 네트워크를 통해 리소스에 액세스할 수 있게 되면 보안 위험이 증가합니다.</p>
<p><strong>공용 네트워크 액세스</strong> - 설명: 공용 인터넷에서 스토리지 계정에 대한 액세스 권한을 설정합니다. - 선택 값: <code>사용</code> - 이 리소스에 대한 리스크 액세스 구성을 사용하여 선택 인바운드 엔드포인트를 제한하는 옵션을 사용하며 인바운드 및 아웃바운드 엔드포인트를 허용합니다. - 옵션: - ⭕ <strong>사용</strong>: 이 리소스에 대한 리스크 액세스 구성을 사용하여 선택 인바운드 엔드포인트를 제한하는 옵션을 사용하며 인바운드 및 아웃바운드 엔드포인트를 허용합니다. - ⚪ <strong>사용 안 함</strong>: 아웃바운드 엔드포인트를 허용하면서 인바운드 엔드포인트를 제한합니다. - ⚪ <strong>경계로 보호(가장 제한됨)</strong>: 네트워크 보안 경계를 사용하여 인바운드 및 아웃바운드 엔드포인트를 제한합니다. 경계로 보호는 리소스를 보호하기 위해 가장 높은 수준의 인바운드 및 아웃바운드 제한을 제공합니다.</p>
<p><strong>공용 네트워크 액세스 범위</strong> - 설명: 공용 네트워크를 통해 액세스할 수 있는 리소스의 범위를 지정합니다. - 선택 값: <code>선택한 가상 네트워크 및 IP 주소에서 사용</code> - 옵션: - ⚪ <strong>모든 네트워크에서 사용</strong> - ⭕ <strong>선택한 가상 네트워크 및 IP 주소에서 사용</strong></p>
</section>
<section id="가상-네트워크" class="level3" data-number="1.3.2">
<h3 data-number="1.3.2" class="anchored" data-anchor-id="가상-네트워크"><span class="header-section-number">1.3.2</span> 가상 네트워크</h3>
<p>선택한 네트워크만 이 스토리지 계정에 액세스할 수 있습니다.</p>
<p><strong>가상 네트워크 구독</strong> - 설명: 가상 네트워크가 속한 Azure 구독을 선택합니다. - 입력 값: <code>swlab-test-subs</code></p>
<p><strong>가상 네트워크</strong> - 설명: 스토리지 계정에 액세스할 수 있는 가상 네트워크를 선택합니다. - 입력 값: <code>vnet-aipoc-test-krc-insilico-001</code> - 링크: [가상 네트워크 만들기] / [선택한 가상 네트워크 관리]</p>
<p><strong>서브넷</strong> - 설명: 가상 네트워크 내에서 액세스를 허용할 서브넷을 선택합니다. - 입력 값: <code>subnet-aipoc-test-krc-insilico-001(172.16.0.0/24)</code></p>
</section>
<section id="ipv4-addresses" class="level3" data-number="1.3.3">
<h3 data-number="1.3.3" class="anchored" data-anchor-id="ipv4-addresses"><span class="header-section-number">1.3.3</span> IPv4 Addresses</h3>
<p>Allow select public internet IP addresses to access your resource.</p>
<p><strong>허용된 IP 주소</strong> - 설명: 스토리지 계정에 액세스할 수 있는 공용 IP 주소를 지정합니다. - 입력 값: <code>61.74.175.54</code></p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">경고</span>⚠️ 중요
</div>
</div>
<div class="callout-body-container callout-body">
<p>이 값을 <strong>자신의 로컬 PC Public IP</strong>로 설정을 해 주어야지만, 추후 <strong>Azure Portal을 통해 파일 업로드가 가능</strong>합니다.</p>
</div>
</div>
</section>
<section id="프라이빗-엔드포인트" class="level3" data-number="1.3.4">
<h3 data-number="1.3.4" class="anchored" data-anchor-id="프라이빗-엔드포인트"><span class="header-section-number">1.3.4</span> 프라이빗 엔드포인트</h3>
<p><strong>프라이빗 엔드포인트</strong> - 설명: 프라이빗 엔드포인트를 만들어 이 리소스에 대한 프라이빗 연결을 허용합니다. 추가 프라이빗 엔드포인트 연결은 스토리지 계정 또는 프라이빗 링크 센터 내에서 만들 수 있습니다. - 선택 값: [+ 프라이빗 엔드포인트 추가] 클릭 가능 - 상태: 프라이빗 엔드포인트를 만들려면 (추가를 클릭합니다)</p>
</section>
<section id="네트워크-라우팅" class="level3" data-number="1.3.5">
<h3 data-number="1.3.5" class="anchored" data-anchor-id="네트워크-라우팅"><span class="header-section-number">1.3.5</span> 네트워크 라우팅</h3>
<p>트래픽이 원본에서 Azure 엔드포인트로 이동하는 과정에서 트래픽을 라우팅할 방법을 결정하세요. 대부분의 고객의 경우 Microsoft 네트워크 라우팅이 권장됩니다.</p>
<p><strong>라우팅 기본 설정</strong> - 설명: 트래픽이 원본에서 Azure 엔드포인트로 이동하는 과정에서 트래픽을 라우팅할 방법을 결정합니다. - 선택 값: <code>Microsoft 네트워크 라우팅</code> - 옵션: - ⭕ <strong>Microsoft 네트워크 라우팅</strong> - ⚪ <strong>인터넷 라우팅</strong></p>
</section>
</section>
<section id="데이터-보호-설정" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="데이터-보호-설정"><span class="header-section-number">1.4</span> 데이터 보호 설정</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/images/01-Data_Lake_Storage/4.png" class="img-fluid figure-img"></p>
<figcaption>image</figcaption>
</figure>
</div>
<section id="복구" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="복구"><span class="header-section-number">1.4.1</span> 복구</h3>
<ul>
<li>전부 디폴트 설정으로 진행</li>
</ul>
<p><strong>Blob에 일시 삭제 사용</strong> - 설명: 일시 삭제를 사용하면 덮어쓴 Blob을 포함하여 이전에 삭제로 표시되었던 Blob을 복구할 수 있습니다. - 선택 값: ☑ 체크됨 - <strong>삭제된 Blob 보존 기간(일)</strong>: <code>7</code></p>
<p><strong>컨테이너에 일시 삭제 사용</strong> - 설명: 일시 삭제를 사용하면 이전에 삭제로 표시된 컨테이너를 복구할 수 있습니다. - 선택 값: ☑ 체크됨 - <strong>삭제된 컨테이너 보존 기간(일)</strong>: <code>7</code> - 참고: 자주 덮어쓰는 데이터에 대해 일시 삭제를 사용하도록 설정하면 스토리지 비용이 증가할 수 있습니다.</p>
<p><strong>파일 공유에 일시 삭제 사용</strong> - 설명: 일시 삭제를 사용하면 이전에 삭제로 표시된 파일 공유를 복구할 수 있습니다. - 선택 값: ☑ 체크됨 - <strong>삭제된 파일 공유 보존 기간(일)</strong>: <code>7</code></p>
</section>
<section id="추적" class="level3" data-number="1.4.2">
<h3 data-number="1.4.2" class="anchored" data-anchor-id="추적"><span class="header-section-number">1.4.2</span> 추적</h3>
<p><strong>Blob에 버전 관리 사용</strong> - 설명: 버전 관리를 사용하여 Blob의 이전 버전을 자동으로 유지합니다. - 선택 값: ☐ 체크 안 됨 - 참고: 워크로드, 생성된 버전 수에 미치는 영향, 결과 비용을 고려하세요. 데이터 수명 주기를 자동으로 관리하여 비용을 최적화합니다.</p>
<p><strong>Blob 변경 피드 사용</strong> - 설명: 계정의 Blob에 대한 만들기, 수정 및 삭제 변경 내용을 추적합니다. - 선택 값: ☐ 체크 안 됨</p>
</section>
<section id="액세스-제어" class="level3" data-number="1.4.3">
<h3 data-number="1.4.3" class="anchored" data-anchor-id="액세스-제어"><span class="header-section-number">1.4.3</span> 액세스 제어</h3>
<p><strong>버전 수준 불변성 지원 사용</strong> - 설명: 모든 Blob 버전에 적용할 계정 수준에서 시간 기반 보존 정책을 설정할 수 있습니다. - 선택 값: ☐ 체크 안 됨 - 참고: 계정 수준에서 기본 정책을 설정하려면 이 기능을 사용하여 도록 설정합니다. 이 기능을 사용하지 않고도 컨테이너 수준에서 기본 정책을 설정하거나 특정 Blob 버전에 대한 정책을 설정할 수 있습니다. 이 속성을 사용하려면 버전 관리를 필요합니다.</p>
</section>
</section>
</section>
<section id="컨테이너-생성-blob-파일-업로드" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> 컨테이너 생성 &amp; Blob 파일 업로드</h1>
<section id="azure-portal에서-컨테이너를-생성합니다." class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="azure-portal에서-컨테이너를-생성합니다."><span class="header-section-number">2.1</span> Azure Portal에서 컨테이너를 생성합니다.</h2>
<p>bc-aipoc-test-krc001 이름의 컨테이너가 이미 존재하여 생성되지 않지만 아래와 같은 방법으로 컨테이너를 생성할 수 있습니다. <img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/images/01-Data_Lake_Storage/5.png" class="img-fluid" alt="image"></p>
</section>
<section id="디렉터리-추가" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="디렉터리-추가"><span class="header-section-number">2.2</span> 디렉터리 추가</h2>
<p>컨테이너 내부로 접속하여 디렉터리를 추가할 수 있습니다. ::: {.callout-important} ## ⚠️ 주의사항</p>
<p>네트워크 설정 중 <strong>Public network access</strong>가 <strong>Enabled from selected networks</strong>로 설정되어 있어야 합니다.</p>
<p><code>Disable</code> 또는 <code>Secured by perimeter(Most restricted)</code>로 설정되어 있으면 <strong>컨테이너 내부로 접속할 수 없습니다</strong>. :::</p>
<p>폴더 구조는 아래와 같은 구조로 되어있습니다.</p>
<pre><code>rag-container
 ├─ code
 │   ├─ moduleA
 │   ├─ moduleB
 │   └─ moduleC
 └─ docs
     ├─ moduleA
     ├─ moduleB
     └─ moduleC</code></pre>
</section>
<section id="blob-파일을-업로드합니다." class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="blob-파일을-업로드합니다."><span class="header-section-number">2.3</span> Blob 파일을 업로드합니다.</h2>
<p><img src="https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/images/01-Data_Lake_Storage/6.png" class="img-fluid" alt="image"> 업로드 버튼을 이용해서 미리 다운로드 받은 코드 파일을 업로드합니다.</p>
</section>
</section>
<section id="vm-내부에서-blob-파일-접근" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> VM 내부에서 Blob 파일 접근</h1>
<p>vm 내부에 접속 후 아래와 같은 작업을 통해 영구적으로 Blob 파일에 마운트를 할 수 있습니다.</p>
<p>Azure nfs 패키지를 설치합니다.</p>
<pre><code>sudo apt-get update
sudo apt-get install nfs-common</code></pre>
<p>fstab 파일에 아래와 같이 추가합니다.</p>
<pre><code>sudo vi /etc/fstab

saaipoctestkrc001.blob.core.windows.net:/saaipoctestkrc001/bc-aipoc-test-krc001 /mnt/bc-aipoc-test-krc001 aznfs defaults,sec=sys,vers=3,nolock,proto=tcp,nofail,_netdev    0 0</code></pre>
<p>saaipoctestkrc001 : Storage Account 이름 bc-aipoc-test-krc001 : Container 이름 /mnt/bc-aipoc-test-krc001 : 마운트 폴더 aznfs : Azure NFS 패키지 defaults,sec=sys,vers=3,nolock,proto=tcp,nofail,_netdev : NFS 패키지 설정 0 0 : 마운트 설정</p>
<p>마운트를 합니다.</p>
<pre><code>sudo mount -a</code></pre>


</section>

 ]]></description>
  <category>Azure Cloud</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/Azure_Cloud/01-클라우드_인프라_설정/01-Data_Lake_Storage.html</guid>
  <pubDate>Thu, 19 Feb 2026 02:11:29 GMT</pubDate>
</item>
<item>
  <title>OpenAI 외 도구 호출 에이전트(Tool Calling Agent)</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/04-Agent-More-LLMs.html</link>
  <description><![CDATA[ 






<p>OpenAI 외에도 <code>Anthropic</code>, <code>Google Gemini</code>, <code>Together.ai</code>, <code>Ollama</code>, <code>Mistral</code>과 같은 더 광범위한 공급자 구현을 지원합니다.</p>
<p>이번 챕터에서는 다양한 LLM 을 사용하여 도구 호출 에이전트를 생성하고 실행하는 방법을 살펴보겠습니다.</p>
<p><strong>참고 링크</strong></p>
<ul>
<li><a href="https://python.langchain.com/v0.1/docs/modules/agents/agent_types/tool_calling/">LangChain 공식 도큐먼트</a></li>
</ul>
<div id="22f90e6c" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="fe2ad291" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install -qU langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH15-Agents"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="18768361" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tool</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> List, Dict</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> GoogleNews</span>
<span id="cb3-4"></span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 정의</span></span>
<span id="cb3-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb3-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> search_news(query: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]]:</span>
<span id="cb3-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Search Google News by input keyword"""</span></span>
<span id="cb3-10">    news_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GoogleNews()</span>
<span id="cb3-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> news_tool.search_by_keyword(query, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb3-12"></span>
<span id="cb3-13"></span>
<span id="cb3-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"도구 이름: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>search_news<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"도구 설명: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>search_news<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>description<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="1259208a" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tools 정의</span></span>
<span id="cb4-2">tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [search_news]</span></code></pre></div></div>
</details>
</div>
<section id="agent-용-프롬프트-생성" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="agent-용-프롬프트-생성"><span class="header-section-number">1</span> Agent 용 프롬프트 생성</h2>
<ul>
<li><code>chat_history</code> : 이전 대화 내용을 저장하는 변수 (멀티턴을 지원하지 않는다면, 생략 가능합니다.)</li>
<li><code>agent_scratchpad</code> : 에이전트가 임시로 저장하는 변수</li>
<li><code>input</code> : 사용자의 입력</li>
</ul>
<div id="f2a23c1c" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate</span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> create_tool_calling_agent</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트 생성</span></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트는 에이전트에게 모델이 수행할 작업을 설명하는 텍스트를 제공합니다. (도구의 이름과 역할을 입력)</span></span>
<span id="cb5-6">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_messages(</span>
<span id="cb5-7">    [</span>
<span id="cb5-8">        (</span>
<span id="cb5-9">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>,</span>
<span id="cb5-10">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant. "</span></span>
<span id="cb5-11">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Make sure to use the `search_news` tool for searching keyword related news."</span>,</span>
<span id="cb5-12">        ),</span>
<span id="cb5-13">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"placeholder"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{chat_history}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb5-14">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"human"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{input}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb5-15">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"placeholder"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{agent_scratchpad}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb5-16">    ]</span>
<span id="cb5-17">)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="tool-calling-을-지원하는-다양한-llm-목록" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="tool-calling-을-지원하는-다양한-llm-목록"><span class="header-section-number">2</span> Tool Calling 을 지원하는 다양한 LLM 목록</h2>
<p>실습 진행을 위해서는 아래 내용을 설정해야 합니다.</p>
<p><strong>Anthropic</strong></p>
<ul>
<li><a href="https://console.anthropic.com/settings/keys">Anthropic API 키 발급 관련</a></li>
<li><code>.env</code> 파일 내 <code>ANTHROPIC_API_KEY</code> 에 발급받은 키를 설정하세요</li>
</ul>
<p><strong>Gemini</strong></p>
<ul>
<li><a href="https://aistudio.google.com/app/apikey?hl=ko">Gemini API 키 발급 관련</a></li>
<li><code>.env</code> 파일 내 <code>GOOGLE_API_KEY</code> 에 발급받은 키를 설정하세요</li>
</ul>
<p><strong>Together AI</strong></p>
<ul>
<li><a href="https://api.together.ai/">Together AI API 키 발급 관련</a></li>
<li><code>.env</code> 파일 내 <code>TOGETHER_API_KEY</code> 에 발급받은 키를 설정하세요</li>
</ul>
<p><strong>Ollama</strong></p>
<ul>
<li><a href="https://ollama.com/search?c=tools">Ollama Tool Calling 지원 모델 리스트</a></li>
<li><a href="https://ollama.com/library/llama3.1">이번 실습에 사용할 llama3.1 모델</a></li>
<li>터미널 창에 <code>ollama pull llama3.1</code> 명령어를 입력하여 모델을 다운로드 받습니다.</li>
<li>이전에 Ollama 를 사용하지 않았다면, <a href="https://wikidocs.net/233805">Ollama</a> 를 참고해 주세요.</li>
</ul>
<p>langchain-ollama 설치를 한 뒤 진행해 주세요.</p>
<div id="b94cad71" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install -qU langchain-ollama==0.1.3</span></span></code></pre></div></div>
</details>
</div>
<div id="efd4a3ed" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_anthropic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatAnthropic</span>
<span id="cb7-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_google_genai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatGoogleGenerativeAI</span>
<span id="cb7-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb7-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_ollama <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOllama</span>
<span id="cb7-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb7-6"></span>
<span id="cb7-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># GPT-4o-mini</span></span>
<span id="cb7-8">gpt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>)</span>
<span id="cb7-9"></span>
<span id="cb7-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Claude-3-5-sonnet</span></span>
<span id="cb7-11">claude <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatAnthropic(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"claude-3-5-sonnet-20240620"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-12"></span>
<span id="cb7-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Gemini-1.5-pro-latest</span></span>
<span id="cb7-14">gemini <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatGoogleGenerativeAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gemini-1.5-pro"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-15"></span>
<span id="cb7-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Llama-3.1-70B-Instruct-Turbo</span></span>
<span id="cb7-17">llama <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(</span>
<span id="cb7-18">    base_url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://api.together.xyz/v1"</span>,</span>
<span id="cb7-19">    api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"TOGETHER_API_KEY"</span>],</span>
<span id="cb7-20">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"meta-llama/Meta-Llama-3.1-70B-Instruct-Turbo"</span>,</span>
<span id="cb7-21">)</span>
<span id="cb7-22"></span>
<span id="cb7-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Llama-3.1</span></span>
<span id="cb7-24">ollama <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOllama(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llama3.1"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-25"></span>
<span id="cb7-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Qwen2.5 7B (한글 성능 괜찮은 편)</span></span>
<span id="cb7-27">qwen <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOllama(</span>
<span id="cb7-28">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen2.5:latest"</span>,</span>
<span id="cb7-29">)</span></code></pre></div></div>
</details>
</div>
<p>LLM 기반으로 Agent 를 생성합니다.</p>
<div id="fc717e7d" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> create_tool_calling_agent</span>
<span id="cb8-2"></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Agent 생성</span></span>
<span id="cb8-4">gpt_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(gpt, tools, prompt)</span>
<span id="cb8-5">claude_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(claude, tools, prompt)</span>
<span id="cb8-6">gemini_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(gemini, tools, prompt)</span>
<span id="cb8-7">llama_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(llama, tools, prompt)</span>
<span id="cb8-8">ollama_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(ollama, tools, prompt)</span>
<span id="cb8-9">qwen_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(qwen, tools, prompt)</span></code></pre></div></div>
</details>
</div>
</section>
<section id="agentexecutor-생성-후-실행-및-결과-확인" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="agentexecutor-생성-후-실행-및-결과-확인"><span class="header-section-number">3</span> AgentExecutor 생성 후 실행 및 결과 확인</h2>
<div id="0e56d590" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AgentExecutor</span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gpt_agent 실행</span></span>
<span id="cb9-4">agent_executor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AgentExecutor(</span>
<span id="cb9-5">    agent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gpt_agent,</span>
<span id="cb9-6">    tools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tools,</span>
<span id="cb9-7">    verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb9-8">    handle_parsing_errors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb9-9">)</span>
<span id="cb9-10"></span>
<span id="cb9-11">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_executor.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI 투자와 관련된 뉴스를 검색해 주세요."</span>})</span>
<span id="cb9-12"></span>
<span id="cb9-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Agent 실행 결과:"</span>)</span>
<span id="cb9-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>])</span></code></pre></div></div>
</details>
</div>
<p>다양한 llm을 사용하여 에이전트를 실행합니다.</p>
<p>다음은 입력받은 llm을 사용하여 Agent 를 생성하고 실행하여 결과를 출력하는 함수입니다.</p>
<div id="48d62f30" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> execute_agent(llm, tools, input_text, label):</span>
<span id="cb10-2">    agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_tool_calling_agent(llm, tools, prompt)</span>
<span id="cb10-3">    executor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AgentExecutor(agent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>agent, tools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tools, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb10-4">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> executor.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: input_text})</span>
<span id="cb10-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"[</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>label<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">] 결과입니다."</span>)</span>
<span id="cb10-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>], <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb10-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> item <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>]:</span>
<span id="cb10-8">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> item:</span>
<span id="cb10-9">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(item[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>])</span>
<span id="cb10-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>], <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb10-11">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>])</span>
<span id="cb10-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb10-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(result[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>])</span></code></pre></div></div>
</details>
</div>
<p>각 llm 별로 에이전트를 생성하고 실행하여 결과를 출력합니다.</p>
<div id="ae5371d1" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb11-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI 투자와 관련된 뉴스를 검색하고, 결과를 Instagram 게시글 형식으로 작성해 주세요."</span></span>
<span id="cb11-3">)</span></code></pre></div></div>
</details>
</div>
<div id="8d47e6a7" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gpt</span></span>
<span id="cb12-2">execute_agent(gpt, tools, query, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="89e363a1" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># claude</span></span>
<span id="cb13-2">execute_agent(claude, tools, query, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"claude"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="58944514" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gemini</span></span>
<span id="cb14-2">execute_agent(gemini, tools, query, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gemini"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="2283f0c4" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># llama3.1 70B (Together.ai)</span></span>
<span id="cb15-2">execute_agent(</span>
<span id="cb15-3">    llama,</span>
<span id="cb15-4">    tools,</span>
<span id="cb15-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Search AI related news and write it in Instagram post format"</span>,</span>
<span id="cb15-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llama3.1 70B"</span>,</span>
<span id="cb15-7">)</span></code></pre></div></div>
</details>
</div>
<div id="fe70f105" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># llama3.1 8B (ollama)</span></span>
<span id="cb16-2">execute_agent(ollama, tools, query, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llama3.1(Ollama)"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="baef686c" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># qwen2.5 7B (ollama)</span></span>
<span id="cb17-2">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI 투자와 관련된 뉴스를 검색하고, 결과를 Instagram 게시글 형식으로 작성해 주세요. 한글로 답변하세요!"</span></span>
<span id="cb17-3"></span>
<span id="cb17-4">execute_agent(qwen, tools, query, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"qwen2.5(Ollama)"</span>)</span></code></pre></div></div>
</details>
</div>


</section>

 ]]></description>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/04-Agent-More-LLMs.html</guid>
  <pubDate>Thu, 19 Feb 2026 02:11:29 GMT</pubDate>
</item>
<item>
  <title>도구 (Tools)</title>
  <link>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/01-Tools.html</link>
  <description><![CDATA[ 






<p>도구(Tool)는 에이전트, 체인 또는 LLM이 외부 세계와 상호작용하기 위한 인터페이스입니다.</p>
<p>LangChain 에서 기본 제공하는 도구를 사용하여 쉽게 도구를 활용할 수 있으며, 사용자 정의 도구(Custom Tool) 를 쉽게 구축하는 것도 가능합니다.</p>
<p><strong>LangChain 에 통합된 도구 리스트는 아래 링크에서 확인할 수 있습니다.</strong></p>
<ul>
<li><a href="https://python.langchain.com/v0.1/docs/integrations/tools/">LangChain 통합된 도구 리스트</a></li>
</ul>
<div id="162928bb" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키를 환경변수로 관리하기 위한 설정 파일</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># API 키 정보 로드</span></span>
<span id="cb1-5">load_dotenv()</span></code></pre></div></div>
</details>
</div>
<div id="adba0a4e" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LangSmith 추적을 설정합니다. https://smith.langchain.com</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install -qU langchain-teddynote</span></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logging</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프로젝트 이름을 입력합니다.</span></span>
<span id="cb2-6">logging.langsmith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CH15-Tools"</span>)</span></code></pre></div></div>
</details>
</div>
<div id="73f66311" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> warnings</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 경고 메시지 무시</span></span>
<span id="cb3-4">warnings.filterwarnings(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ignore"</span>)</span></code></pre></div></div>
</details>
</div>
<section id="빌트인-도구built-in-tools" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="빌트인-도구built-in-tools"><span class="header-section-number">1</span> 빌트인 도구(built-in tools)</h2>
<p>랭체인에서 제공하는 사전에 정의된 도구(tool) 와 툴킷(toolkit) 을 사용할 수 있습니다.</p>
<p>tool 은 단일 도구를 의미하며, toolkit 은 여러 도구를 묶어서 하나의 도구로 사용할 수 있습니다.</p>
<p>관련 도구는 아래의 링크에서 참고하실 수 있습니다.</p>
<p><strong>참고</strong> - <a href="https://python.langchain.com/docs/integrations/tools/">LangChain Tools/Toolkits</a></p>
<section id="python-repl-도구" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="python-repl-도구"><span class="header-section-number">1.1</span> Python REPL 도구</h3>
<p>이 도구는 Python 코드를 REPL(Read-Eval-Print Loop) 환경에서 실행하기 위한 클래스를 제공합니다 어떤 코드를 만들어서 실행하는 것이다. - PythonREPLTool</p>
<p><strong>설명</strong></p>
<ul>
<li>Python 셸 환경을 제공합니다.</li>
<li>유효한 Python 명령어를 입력으로 받아 실행합니다.</li>
<li>결과를 보려면 print(…) 함수를 사용해야 합니다.</li>
</ul>
<p><strong>주요 특징</strong></p>
<ul>
<li>sanitize_input: 입력을 정제하는 옵션 (기본값: True)</li>
<li>python_repl: PythonREPL 인스턴스 (기본값: 전역 범위에서 실행)</li>
</ul>
<p><strong>사용 방법</strong></p>
<ul>
<li>PythonREPLTool 인스턴스 생성</li>
<li>run 또는 arun, invoke 메서드를 사용하여 Python 코드 실행</li>
</ul>
<p><strong>입력 정제</strong></p>
<ul>
<li>입력 문자열에서 불필요한 공백, 백틱, ‘python’ 키워드 등을 제거합니다.</li>
</ul>
<div id="d943ee9e" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_experimental.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PythonREPLTool</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 파이썬 코드를 실행하는 도구를 생성합니다.</span></span>
<span id="cb4-4">python_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PythonREPLTool()</span></code></pre></div></div>
</details>
</div>
<div id="5c92c03c" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 파이썬 코드를 실행하고 결과를 반환합니다.</span></span>
<span id="cb5-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(python_tool.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"print(100 + 200)"</span>))</span></code></pre></div></div>
</details>
</div>
<p>아래는 LLM 에게 파이썬 코드를 작성하도록 요청하고 결과를 반환하는 예제입니다.</p>
<p><strong>흐름 정리</strong> 1. LLM 모델에게 특정 작업을 수행하는 Python 코드를 작성하도록 요청합니다. 2. 작성된 코드를 실행하여 결과를 얻습니다. 3. 결과를 출력합니다.</p>
<div id="544403e4" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate</span>
<span id="cb6-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.output_parsers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StrOutputParser</span>
<span id="cb6-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.runnables <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RunnableLambda</span>
<span id="cb6-5"></span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 파이썬 코드를 실행하고 중간 과정을 출력하고 도구 실행 결과를 반환하는 함수</span></span>
<span id="cb6-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> print_and_execute(code, debug<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb6-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> debug:</span>
<span id="cb6-10">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CODE:"</span>)</span>
<span id="cb6-11">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(code)</span>
<span id="cb6-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> python_tool.invoke(code)</span>
<span id="cb6-13"></span>
<span id="cb6-14"></span>
<span id="cb6-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 파이썬 코드를 작성하도록 요청하는 프롬프트</span></span>
<span id="cb6-16">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_messages(</span>
<span id="cb6-17">    [</span>
<span id="cb6-18">        (</span>
<span id="cb6-19">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>,</span>
<span id="cb6-20">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are Raymond Hetting, an expert python programmer, well versed in meta-programming and elegant, concise and short but well documented code. You follow the PEP8 style guide. "</span></span>
<span id="cb6-21">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Return only the code, no intro, no explanation, no chatty, no markdown, no code block, no nothing. Just the code."</span>,</span>
<span id="cb6-22">        ),</span>
<span id="cb6-23">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"human"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{input}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb6-24">    ]</span>
<span id="cb6-25">)</span>
<span id="cb6-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLM 모델 생성</span></span>
<span id="cb6-27">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb6-28"></span>
<span id="cb6-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트와 LLM 모델을 사용하여 체인 생성</span></span>
<span id="cb6-30">chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> RunnableLambda(print_and_execute)</span></code></pre></div></div>
</details>
</div>
<div id="407d9735" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 결과 출력</span></span>
<span id="cb7-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(chain.invoke(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"로또 번호 생성기를 출력하는 코드를 작성하세요."</span>))</span></code></pre></div></div>
</details>
</div>
</section>
<section id="검색-api-도구" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="검색-api-도구"><span class="header-section-number">1.2</span> 검색 API 도구</h3>
<p>Tavily 검색 API를 활용하여 검색 기능을 구현하는 도구입니다. 이 도구는 두 가지 주요 클래스를 제공합니다: <code>TavilySearchResults</code>와 <code>TavilyAnswer</code>.</p>
<p><strong>API 키 발급 주소</strong> - https://app.tavily.com/</p>
<p>발급한 API 키를 환경변수에 설정합니다.</p>
<p><code>.env</code> 파일에 아래와 같이 설정합니다.</p>
<pre><code>TAVILY_API_KEY=tvly-abcdefghijklmnopqrstuvwxyz</code></pre>
</section>
<section id="tavilysearchresults" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="tavilysearchresults"><span class="header-section-number">1.3</span> TavilySearchResults</h3>
<p><strong>설명</strong> - Tavily 검색 API를 쿼리하고 JSON 형식의 결과를 반환합니다. - 포괄적이고 정확하며 신뢰할 수 있는 결과에 최적화된 검색 엔진입니다. - 현재 이벤트에 대한 질문에 답변할 때 유용합니다. - 사용자가 LLM/RAG 에서도 없는 최신 정보가 불만족스럽거나, 그럴때 사용하는것.</p>
<p><strong>주요 매개변수</strong> - <code>max_results</code> (int): 반환할 최대 검색 결과 수 (기본값: 5) - <code>search_depth</code> (str): 검색 깊이 (“basic” 또는 “advanced”) - <code>include_domains</code> (List[str]): 검색 결과에 포함할 도메인 목록 - <code>exclude_domains</code> (List[str]): 검색 결과에서 제외할 도메인 목록 - <code>include_answer</code> (bool): 원본 쿼리에 대한 짧은 답변 포함 여부 - <code>include_raw_content</code> (bool): 각 사이트의 정제된 HTML 콘텐츠 포함 여부 - <code>include_images</code> (bool): 쿼리 관련 이미지 목록 포함 여부</p>
<p><strong>반환 값</strong> - 검색 결과를 포함하는 JSON 형식의 문자열(url, content)</p>
<p>혹은 아래의 주석을 해제하고 발급받은 API 키를 입력합니다.</p>
<div id="2bb4df80" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import os</span></span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># os.environ["TAVILY_API_KEY"] = "TAVILY API 키 입력"</span></span></code></pre></div></div>
</details>
</div>
<div id="7d2ec10b" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.tools.tavily_search <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TavilySearchResults</span>
<span id="cb10-2"></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 생성</span></span>
<span id="cb10-4">tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TavilySearchResults(</span>
<span id="cb10-5">    max_results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,</span>
<span id="cb10-6">    include_answer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb10-7">    include_raw_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb10-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># include_images=True,</span></span>
<span id="cb10-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># search_depth="advanced", # or "basic"</span></span>
<span id="cb10-10">    include_domains<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"github.io"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wikidocs.net"</span>],</span>
<span id="cb10-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># exclude_domains = []</span></span>
<span id="cb10-12">)</span></code></pre></div></div>
</details>
</div>
<div id="a640a496" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 실행</span></span>
<span id="cb11-2">tool.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"query"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LangChain Tools 에 대해서 알려주세요"</span>})</span></code></pre></div></div>
</details>
</div>
</section>
<section id="image-생성-도구-dall-e" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="image-생성-도구-dall-e"><span class="header-section-number">1.4</span> Image 생성 도구 (DALL-E)</h3>
<ul>
<li><code>DallEAPIWrapper 클래스</code>: OpenAI의 DALL-E 이미지 생성기를 위한 래퍼(wrapper)입니다.</li>
</ul>
<p>이 도구를 사용하면 DALL-E API를 쉽게 통합하여 텍스트 기반 이미지 생성 기능을 구현할 수 있습니다. 다양한 설정 옵션을 통해 유연하고 강력한 이미지 생성 도구로 활용할 수 있습니다.</p>
<p><strong>주요 속성</strong></p>
<ul>
<li><p><code>model</code>: 사용할 DALL-E 모델 이름 (기본값: “dall-e-2”, “dall-e-3”)</p></li>
<li><p><code>n</code>: 생성할 이미지 수 (기본값: 1)</p></li>
<li><p><code>size</code>: 생성할 이미지 크기</p>
<ul>
<li>“dall-e-2”: “1024x1024”, “512x512”, “256x256”</li>
<li>“dall-e-3”: “1024x1024”, “1792x1024”, “1024x1792”</li>
</ul></li>
<li><p><code>style</code>: 생성될 이미지의 스타일 (기본값: “natural”, “vivid”)</p></li>
<li><p><code>quality</code>: 생성될 이미지의 품질 (기본값: “standard”, “hd”)</p></li>
<li><p><code>max_retries</code>: 생성 시 최대 재시도 횟수</p></li>
</ul>
<p><strong>주요 기능</strong> - DALL-E API를 사용하여 텍스트 설명에 기반한 이미지 생성</p>
<p><strong>흐름 정리</strong></p>
<p>다음은 DALL-E Image Generator 를 사용하여 이미지를 생성하는 예제입니다.</p>
<p>이번에는 <code>DallEAPIWrapper</code> 를 사용하여 이미지를 생성해 보겠습니다.</p>
<p>이때 입력 프롬프트는 LLM 모델에게 이미지를 생성하는 프롬프트를 작성하도록 요청합니다.</p>
<div id="ce07ac5e" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.output_parsers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StrOutputParser</span>
<span id="cb12-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PromptTemplate</span>
<span id="cb12-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb12-4"></span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ChatOpenAI 모델 초기화</span></span>
<span id="cb12-6">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span>
<span id="cb12-7"></span>
<span id="cb12-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DALL-E 이미지 생성을 위한 프롬프트 템플릿 정의</span></span>
<span id="cb12-9">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PromptTemplate.from_template(</span>
<span id="cb12-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Generate a detailed IMAGE GENERATION prompt for DALL-E based on the following description. "</span></span>
<span id="cb12-11">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Return only the prompt, no intro, no explanation, no chatty, no markdown, no code block, no nothing. Just the prompt"</span></span>
<span id="cb12-12">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Output should be less than 1000 characters. Write in English only."</span></span>
<span id="cb12-13">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Image Description: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{image_desc}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb12-14">)</span>
<span id="cb12-15"></span>
<span id="cb12-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 프롬프트, LLM, 출력 파서를 연결하는 체인 생성</span></span>
<span id="cb12-17">chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> StrOutputParser()</span>
<span id="cb12-18"></span>
<span id="cb12-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 체인 실행</span></span>
<span id="cb12-20">image_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chain.invoke(</span>
<span id="cb12-21">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_desc"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"스마트폰을 바라보는 사람들을 풍자한 neo-classicism painting"</span>}</span>
<span id="cb12-22">)</span>
<span id="cb12-23"></span>
<span id="cb12-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 이미지 프롬프트 출력</span></span>
<span id="cb12-25"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(image_prompt)</span></code></pre></div></div>
</details>
</div>
<p>그럼, 이전에 생성한 이미지 프롬프트를 <code>DallEAPIWrapper</code> 에 입력하여 이미지를 생성해 보겠습니다.</p>
<p><strong><code>DallEAPIWrapper</code> 에 대한 임시 버그 안내사항</strong> (작성일: 2024-10-13)</p>
<ul>
<li>현재 langchain 0.3.x 이상 버전에서 <code>DallEAPIWrapper</code> 에 대한 임시 버그가 있습니다. (<code>401 오류: invalid API key</code>)</li>
</ul>
<p>따라서, 아래의 코드를 오류 없이 실행하기 위해서는 LangChain 버전을 0.2.16 으로 변경해야 합니다.</p>
<p>아래의 주석을 해제하고 실행하면 LangChain 버전을 0.2.16 으로 변경됩니다.</p>
<p>하지만, 이후 내용에서는 LangChain 버전을 0.3.x 이상으로 변경하여 사용하기 때문에</p>
<p><code>poetry shell</code> 명령어를 통해 다시 최신 langchain 버전으로 변경해야 합니다.</p>
<p>이 과정이 번거로운 분들은 일단 <code>DallEAPIWrapper</code> 를 사용하지 않고 진행하셔도 무방합니다.</p>
<p><strong>업그레이드/다운그레이드</strong> 후에는 반드시 상단 메뉴의 “Restart” 버튼을 클릭한 뒤 진행해야 합니다.</p>
<div id="b2aaca2d" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 임시 버전 다운그레이드 명령어 (실행 후 restart)</span></span>
<span id="cb13-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install langchain==0.2.16 langchain-community==0.2.16 langchain-text-splitters==0.2.4 langchain-experimental==0.0.65 langchain-openai==0.1.20</span></span></code></pre></div></div>
</details>
</div>
<div id="669cbaae" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DALL-E API 래퍼 가져오기</span></span>
<span id="cb14-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.utilities.dalle_image_generator <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DallEAPIWrapper</span>
<span id="cb14-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> IPython.display <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb14-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb14-5"></span>
<span id="cb14-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DALL-E API 래퍼 초기화</span></span>
<span id="cb14-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># model: 사용할 DALL-E 모델 버전</span></span>
<span id="cb14-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># size: 생성할 이미지 크기</span></span>
<span id="cb14-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># quality: 이미지 품질</span></span>
<span id="cb14-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># n: 생성할 이미지 수</span></span>
<span id="cb14-11">dalle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DallEAPIWrapper(</span>
<span id="cb14-12">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dall-e-3"</span>,</span>
<span id="cb14-13">    size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1024x1024"</span>,</span>
<span id="cb14-14">    quality<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"standard"</span>,</span>
<span id="cb14-15">    n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb14-16">)</span>
<span id="cb14-17"></span>
<span id="cb14-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 질문</span></span>
<span id="cb14-19">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"스마트폰을 바라보는 사람들을 풍자한 neo-classicism painting"</span></span>
<span id="cb14-20"></span>
<span id="cb14-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 이미지 생성 및 URL 받기</span></span>
<span id="cb14-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># chain.invoke()를 사용하여 이미지 설명을 DALL-E 프롬프트로 변환</span></span>
<span id="cb14-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dalle.run()을 사용하여 실제 이미지 생성</span></span>
<span id="cb14-24">image_url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dalle.run(chain.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_desc"</span>: query}))</span>
<span id="cb14-25"></span>
<span id="cb14-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 생성된 이미지를 표시합니다.</span></span>
<span id="cb14-27">Image(url<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>image_url, width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="사용자-정의-도구custom-tool" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="사용자-정의-도구custom-tool"><span class="header-section-number">2</span> 사용자 정의 도구(Custom Tool)</h2>
<p>LangChain 에서 제공하는 빌트인 도구 외에도 사용자가 직접 도구를 정의하여 사용할 수 있습니다.</p>
<p>이를 위해서는 <code>langchain.tools</code> 모듈에서 제공하는 <code>tool</code> 데코레이터를 사용하여 함수를 도구로 변환합니다.</p>
<section id="tool-데코레이터" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="tool-데코레이터"><span class="header-section-number">2.1</span> <span class="citation" data-cites="tool">@tool</span> 데코레이터</h3>
<p>이 데코레이터는 함수를 도구로 변환하는 기능을 제공합니다. 다양한 옵션을 통해 도구의 동작을 커스터마이즈할 수 있습니다.</p>
<p><strong>사용 방법</strong> 1. 함수 위에 <code>@tool</code> 데코레이터 적용 2. 필요에 따라 데코레이터 매개변수 설정</p>
<p>이 데코레이터를 사용하면 일반 Python 함수를 강력한 도구로 쉽게 변환할 수 있으며, 자동화된 문서화와 유연한 인터페이스 생성이 가능합니다.</p>
<div id="bb173b35" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tool</span>
<span id="cb15-2"></span>
<span id="cb15-3"></span>
<span id="cb15-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 데코레이터를 사용하여 함수를 도구로 변환합니다.</span></span>
<span id="cb15-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb15-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> add_numbers(a: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, b: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>:</span>
<span id="cb15-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Add two numbers"""</span></span>
<span id="cb15-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span>
<span id="cb15-9"></span>
<span id="cb15-10"></span>
<span id="cb15-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb15-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> multiply_numbers(a: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, b: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>:</span>
<span id="cb15-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Multiply two numbers"""</span></span>
<span id="cb15-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b</span></code></pre></div></div>
</details>
</div>
<div id="58c9189a" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 실행</span></span>
<span id="cb16-2">add_numbers.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>})</span></code></pre></div></div>
</details>
</div>
<div id="dd962b45" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 실행</span></span>
<span id="cb17-2">multiply_numbers.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>})</span></code></pre></div></div>
</details>
</div>
</section>
<section id="구글-뉴스기사-검색-도구" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="구글-뉴스기사-검색-도구"><span class="header-section-number">2.2</span> 구글 뉴스기사 검색 도구</h3>
<p><code>langchain-teddynote</code> 패키지에서 제공하는 <code>GoogleNews</code> 도구를 사용하여 구글 뉴스기사를 검색하는 도구입니다.</p>
<p><strong>참고</strong> - API 키가 필요하지 않습니다. (RSS 피드를 사용하기 때문)</p>
<p>news.google.com 에서 제공하는 뉴스기사를 검색하는 도구입니다.</p>
<p><strong>설명</strong> - 구글 뉴스 검색 API를 사용하여 최신 뉴스를 검색합니다. - 키워드를 기반으로 뉴스를 검색할 수 있습니다. - 최신 뉴스를 검색할 수 있습니다.</p>
<p><strong>주요 매개변수</strong> - <code>k</code> (int): 반환할 최대 검색 결과 수 (기본값: 5)</p>
<p>사용하기 전 패키지를 업데이트 해주세요.</p>
<div id="d1d36cd5" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !pip install -qU langchain-teddynote</span></span></code></pre></div></div>
</details>
</div>
<div id="91d4596c" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> GoogleNews</span>
<span id="cb19-2"></span>
<span id="cb19-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 도구 생성</span></span>
<span id="cb19-4">news_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GoogleNews()</span></code></pre></div></div>
</details>
</div>
<div id="28908a00" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 최신 뉴스 검색</span></span>
<span id="cb20-2">news_tool.search_latest(k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
</details>
</div>
<div id="38f973dd" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 키워드로 뉴스 검색</span></span>
<span id="cb21-2">news_tool.search_by_keyword(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI 투자"</span>, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div></div>
</details>
</div>
<div id="5b5c4a92" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_teddynote.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> GoogleNews</span>
<span id="cb22-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tool</span>
<span id="cb22-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> List, Dict</span>
<span id="cb22-4"></span>
<span id="cb22-5"></span>
<span id="cb22-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 키워드로 뉴스 검색하는 도구 생성</span></span>
<span id="cb22-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb22-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> search_keyword(query: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> List[Dict[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>]]:</span>
<span id="cb22-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Look up news by keyword"""</span></span>
<span id="cb22-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(query)</span>
<span id="cb22-11">    news_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GoogleNews()</span>
<span id="cb22-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> news_tool.search_by_keyword(query, k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div></div>
</details>
</div>
<div id="5db5b311" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>코드</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 실행 결과</span></span>
<span id="cb23-2">search_keyword.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"query"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LangChain AI"</span>})</span></code></pre></div></div>
</details>
</div>


</section>
</section>

 ]]></description>
  <category>AI</category>
  <category>LangChain</category>
  <category>Prompt_Engineering</category>
  <guid>https://dlwns0719.github.io/my_blog/docs/blog/posts/RAG/15-Agent/01-Tools.html</guid>
  <pubDate>Thu, 19 Feb 2026 02:11:29 GMT</pubDate>
</item>
</channel>
</rss>
